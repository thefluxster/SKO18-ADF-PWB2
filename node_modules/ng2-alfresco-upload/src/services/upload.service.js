/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var Rx_1 = require("rxjs/Rx");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var file_model_1 = require("../models/file.model");
var UploadService = (function () {
    function UploadService(apiService, logService) {
        var _this = this;
        this.apiService = apiService;
        this.logService = logService;
        this.formFields = {};
        this.queue = [];
        this.versioning = false;
        this.totalCompleted = 0;
        this.filesUpload$ = new Rx_1.Observable(function (observer) { return _this.filesUploadObserverProgressBar = observer; }).share();
        this.totalCompleted$ = new Rx_1.Observable(function (observer) { return _this.totalCompletedObserver = observer; }).share();
    }
    UploadService.prototype.setOptions = function (options, versioning) {
        this.formFields = options.formFields != null ? options.formFields : this.formFields;
        this.versioning = versioning != null ? versioning : this.versioning;
    };
    UploadService.prototype.addToQueue = function (files) {
        var latestFilesAdded = [];
        for (var _i = 0, files_1 = files; _i < files_1.length; _i++) {
            var file = files_1[_i];
            if (this.isFile(file)) {
                var uploadingFileModel = new file_model_1.FileModel(file);
                latestFilesAdded.push(uploadingFileModel);
                this.queue.push(uploadingFileModel);
                if (this.filesUploadObserverProgressBar) {
                    this.filesUploadObserverProgressBar.next(this.queue);
                }
            }
        }
        return latestFilesAdded;
    };
    UploadService.prototype.uploadFilesInTheQueue = function (rootId, directory, elementEmit) {
        var _this = this;
        var filesToUpload = this.queue.filter(function (uploadingFileModel) {
            return !uploadingFileModel.uploading && !uploadingFileModel.done && !uploadingFileModel.abort && !uploadingFileModel.error;
        });
        var opts = {};
        opts.renditions = 'doclib';
        if (this.versioning) {
            opts.overwrite = true;
            opts.majorVersion = true;
        }
        else {
            opts.autoRename = true;
        }
        filesToUpload.forEach(function (uploadingFileModel) {
            uploadingFileModel.setUploading();
            var promiseUpload = _this.apiService.getInstance().upload.uploadFile(uploadingFileModel.file, directory, rootId, null, opts)
                .on('progress', function (progress) {
                uploadingFileModel.setProgres(progress);
                _this.updateFileListStream(_this.queue);
            })
                .on('abort', function () {
                uploadingFileModel.setAbort();
                elementEmit.emit({
                    value: 'File aborted'
                });
            })
                .on('error', function () {
                uploadingFileModel.setError();
                elementEmit.emit({
                    value: 'Error file uploaded'
                });
            })
                .on('success', function (data) {
                elementEmit.emit({
                    value: data
                });
                uploadingFileModel.onFinished(data.status, data.statusText, data.response);
                _this.updateFileListStream(_this.queue);
                if (!uploadingFileModel.abort && !uploadingFileModel.error) {
                    _this.updateFileCounterStream(++_this.totalCompleted);
                }
            });
            uploadingFileModel.setPromiseUpload(promiseUpload);
        });
    };
    UploadService.prototype.getQueue = function () {
        return this.queue;
    };
    UploadService.prototype.isFile = function (file) {
        return file !== null && (file instanceof Blob || (file.name && file.size));
    };
    UploadService.prototype.createFolder = function (relativePath, name) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.callApiCreateFolder(relativePath, name))
            .map(function (res) {
            return res;
        })
            .do(function (data) { return _this.logService.info('Node data', data); })
            .catch(function (err) { return _this.handleError(err); });
    };
    UploadService.prototype.callApiCreateFolder = function (relativePath, name) {
        return this.apiService.getInstance().nodes.createFolder(name, relativePath);
    };
    UploadService.prototype.handleError = function (error) {
        this.logService.error(error);
        return Rx_1.Observable.throw(error || 'Server error');
    };
    UploadService.prototype.updateFileListStream = function (fileList) {
        if (this.filesUploadObserverProgressBar) {
            this.filesUploadObserverProgressBar.next(fileList);
        }
    };
    UploadService.prototype.updateFileCounterStream = function (total) {
        if (this.totalCompletedObserver) {
            this.totalCompletedObserver.next(total);
        }
    };
    return UploadService;
}());
UploadService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [ng2_alfresco_core_1.AlfrescoApiService,
        ng2_alfresco_core_1.LogService])
], UploadService);
exports.UploadService = UploadService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL3VwbG9hZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRzs7Ozs7Ozs7Ozs7QUFFSCxzQ0FBeUQ7QUFFekQsOEJBQStDO0FBQy9DLHVEQUFtRTtBQUNuRSxtREFBaUQ7QUFTakQsSUFBYSxhQUFhO0lBWXRCLHVCQUFvQixVQUE4QixFQUM5QixVQUFzQjtRQUQxQyxpQkFJQztRQUptQixlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUM5QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBWGxDLGVBQVUsR0FBVyxFQUFFLENBQUM7UUFDeEIsVUFBSyxHQUFnQixFQUFFLENBQUM7UUFDeEIsZUFBVSxHQUFZLEtBQUssQ0FBQztRQUlwQyxtQkFBYyxHQUFXLENBQUMsQ0FBQztRQU12QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksZUFBVSxDQUFjLFVBQUEsUUFBUSxJQUFJLE9BQUEsS0FBSSxDQUFDLDhCQUE4QixHQUFHLFFBQVEsRUFBOUMsQ0FBOEMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3BILElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxlQUFVLENBQVMsVUFBQSxRQUFRLElBQUksT0FBQSxLQUFJLENBQUMsc0JBQXNCLEdBQUcsUUFBUSxFQUF0QyxDQUFzQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDOUcsQ0FBQztJQVNELGtDQUFVLEdBQVYsVUFBVyxPQUFZLEVBQUUsVUFBbUI7UUFDeEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUMsVUFBVSxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7UUFDcEYsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLElBQUksSUFBSSxHQUFHLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQ3hFLENBQUM7SUFTRCxrQ0FBVSxHQUFWLFVBQVcsS0FBWTtRQUNuQixJQUFJLGdCQUFnQixHQUFnQixFQUFFLENBQUM7UUFFdkMsR0FBRyxDQUFDLENBQWEsVUFBSyxFQUFMLGVBQUssRUFBTCxtQkFBSyxFQUFMLElBQUs7WUFBakIsSUFBSSxJQUFJLGNBQUE7WUFDVCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDcEIsSUFBSSxrQkFBa0IsR0FBRyxJQUFJLHNCQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzdDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO2dCQUMxQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO2dCQUNwQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsOEJBQThCLENBQUMsQ0FBQyxDQUFDO29CQUN0QyxJQUFJLENBQUMsOEJBQThCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDekQsQ0FBQztZQUNMLENBQUM7U0FDSjtRQUNELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztJQUM1QixDQUFDO0lBS0QsNkNBQXFCLEdBQXJCLFVBQXNCLE1BQWMsRUFBRSxTQUFpQixFQUFFLFdBQThCO1FBQXZGLGlCQXFEQztRQXBERyxJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFDLGtCQUFrQjtZQUNyRCxNQUFNLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUM7UUFDL0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLElBQUksR0FBUSxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUM7UUFFM0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDbEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7WUFDdEIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDN0IsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFDM0IsQ0FBQztRQUVELGFBQWEsQ0FBQyxPQUFPLENBQUMsVUFBQyxrQkFBNkI7WUFDaEQsa0JBQWtCLENBQUMsWUFBWSxFQUFFLENBQUM7WUFFbEMsSUFBSSxhQUFhLEdBQUcsS0FBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUM7aUJBQ3RILEVBQUUsQ0FBQyxVQUFVLEVBQUUsVUFBQyxRQUFhO2dCQUMxQixrQkFBa0IsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ3hDLEtBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDMUMsQ0FBQyxDQUFDO2lCQUNELEVBQUUsQ0FBQyxPQUFPLEVBQUU7Z0JBQ1Qsa0JBQWtCLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQzlCLFdBQVcsQ0FBQyxJQUFJLENBQUM7b0JBQ2IsS0FBSyxFQUFFLGNBQWM7aUJBQ3hCLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQztpQkFDRCxFQUFFLENBQUMsT0FBTyxFQUFFO2dCQUNULGtCQUFrQixDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUM5QixXQUFXLENBQUMsSUFBSSxDQUFDO29CQUNiLEtBQUssRUFBRSxxQkFBcUI7aUJBQy9CLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQztpQkFDRCxFQUFFLENBQUMsU0FBUyxFQUFFLFVBQUMsSUFBUztnQkFDckIsV0FBVyxDQUFDLElBQUksQ0FBQztvQkFDYixLQUFLLEVBQUUsSUFBSTtpQkFDZCxDQUFDLENBQUM7Z0JBQ0gsa0JBQWtCLENBQUMsVUFBVSxDQUN6QixJQUFJLENBQUMsTUFBTSxFQUNYLElBQUksQ0FBQyxVQUFVLEVBQ2YsSUFBSSxDQUFDLFFBQVEsQ0FDaEIsQ0FBQztnQkFFRixLQUFJLENBQUMsb0JBQW9CLENBQUMsS0FBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN0QyxFQUFFLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLEtBQUssSUFBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7b0JBQ3pELEtBQUksQ0FBQyx1QkFBdUIsQ0FBQyxFQUFFLEtBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztnQkFDeEQsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBRVAsa0JBQWtCLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDdkQsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBT0QsZ0NBQVEsR0FBUjtRQUNJLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQ3RCLENBQUM7SUFPTyw4QkFBTSxHQUFkLFVBQWUsSUFBUztRQUNwQixNQUFNLENBQUMsSUFBSSxLQUFLLElBQUksSUFBSSxDQUFDLElBQUksWUFBWSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFNRCxvQ0FBWSxHQUFaLFVBQWEsWUFBb0IsRUFBRSxJQUFZO1FBQS9DLGlCQU9DO1FBTkcsTUFBTSxDQUFDLGVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQzthQUN0RSxHQUFHLENBQUMsVUFBQSxHQUFHO1lBQ0osTUFBTSxDQUFDLEdBQUcsQ0FBQztRQUNmLENBQUMsQ0FBQzthQUNELEVBQUUsQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLEtBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBdkMsQ0FBdUMsQ0FBQzthQUNuRCxLQUFLLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxLQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxFQUFyQixDQUFxQixDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVPLDJDQUFtQixHQUEzQixVQUE0QixZQUFvQixFQUFFLElBQVk7UUFDMUQsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDaEYsQ0FBQztJQU9PLG1DQUFXLEdBQW5CLFVBQW9CLEtBQWU7UUFHL0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0IsTUFBTSxDQUFDLGVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxJQUFJLGNBQWMsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFTyw0Q0FBb0IsR0FBNUIsVUFBNkIsUUFBcUI7UUFDOUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLDhCQUE4QixDQUFDLENBQUMsQ0FBQztZQUN0QyxJQUFJLENBQUMsOEJBQThCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZELENBQUM7SUFDTCxDQUFDO0lBRUQsK0NBQXVCLEdBQXZCLFVBQXdCLEtBQWE7UUFDakMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQztZQUM5QixJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzVDLENBQUM7SUFDTCxDQUFDO0lBQ0wsb0JBQUM7QUFBRCxDQXpLQSxBQXlLQyxJQUFBO0FBektZLGFBQWE7SUFEekIsaUJBQVUsRUFBRTtxQ0FhdUIsc0NBQWtCO1FBQ2xCLDhCQUFVO0dBYmpDLGFBQWEsQ0F5S3pCO0FBektZLHNDQUFhIiwiZmlsZSI6InNlcnZpY2VzL3VwbG9hZC5zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTYgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2h0dHAnO1xuaW1wb3J0IHsgT2JzZXJ2ZXIsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzL1J4JztcbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSwgTG9nU2VydmljZSB9IGZyb20gJ25nMi1hbGZyZXNjby1jb3JlJztcbmltcG9ydCB7IEZpbGVNb2RlbCB9IGZyb20gJy4uL21vZGVscy9maWxlLm1vZGVsJztcblxuLyoqXG4gKlxuICogVXBsb2FkU2VydmljZSBrZWVwIHRoZSBxdWV1ZSBvZiB0aGUgZmlsZSB0byB1cGxvYWQgYW5kIHVwbG9hZHMgdGhlbS5cbiAqXG4gKiBAcmV0dXJucyB7VXBsb2FkU2VydmljZX0gLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVXBsb2FkU2VydmljZSB7XG5cbiAgICBwcml2YXRlIGZvcm1GaWVsZHM6IE9iamVjdCA9IHt9O1xuICAgIHByaXZhdGUgcXVldWU6IEZpbGVNb2RlbFtdID0gW107XG4gICAgcHJpdmF0ZSB2ZXJzaW9uaW5nOiBib29sZWFuID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBmaWxlc1VwbG9hZE9ic2VydmVyUHJvZ3Jlc3NCYXI6IE9ic2VydmVyPEZpbGVNb2RlbFtdPjtcbiAgICBwcml2YXRlIHRvdGFsQ29tcGxldGVkT2JzZXJ2ZXI6IE9ic2VydmVyPG51bWJlcj47XG5cbiAgICB0b3RhbENvbXBsZXRlZDogbnVtYmVyID0gMDtcbiAgICBmaWxlc1VwbG9hZCQ6IE9ic2VydmFibGU8RmlsZU1vZGVsW10+O1xuICAgIHRvdGFsQ29tcGxldGVkJDogT2JzZXJ2YWJsZTxhbnk+O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMuZmlsZXNVcGxvYWQkID0gbmV3IE9ic2VydmFibGU8RmlsZU1vZGVsW10+KG9ic2VydmVyID0+IHRoaXMuZmlsZXNVcGxvYWRPYnNlcnZlclByb2dyZXNzQmFyID0gb2JzZXJ2ZXIpLnNoYXJlKCk7XG4gICAgICAgIHRoaXMudG90YWxDb21wbGV0ZWQkID0gbmV3IE9ic2VydmFibGU8bnVtYmVyPihvYnNlcnZlciA9PiB0aGlzLnRvdGFsQ29tcGxldGVkT2JzZXJ2ZXIgPSBvYnNlcnZlcikuc2hhcmUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDb25maWd1cmUgdGhlIHNlcnZpY2VcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSAtIG9wdGlvbnMgZm9ybUZpZWxkcyB0byBpbml0IHRoZSBvYmplY3RcbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IC0gdmVyc2lvbmluZyB0cnVlIHRvIGluZGljYXRlIHRoYXQgYSBtYWpvciB2ZXJzaW9uIHNob3VsZCBiZSBjcmVhdGVkXG4gICAgICpcbiAgICAgKi9cbiAgICBzZXRPcHRpb25zKG9wdGlvbnM6IGFueSwgdmVyc2lvbmluZzogYm9vbGVhbik6IHZvaWQge1xuICAgICAgICB0aGlzLmZvcm1GaWVsZHMgPSBvcHRpb25zLmZvcm1GaWVsZHMgIT0gbnVsbCA/IG9wdGlvbnMuZm9ybUZpZWxkcyA6IHRoaXMuZm9ybUZpZWxkcztcbiAgICAgICAgdGhpcy52ZXJzaW9uaW5nID0gdmVyc2lvbmluZyAhPSBudWxsID8gdmVyc2lvbmluZyA6IHRoaXMudmVyc2lvbmluZztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgZmlsZXMgdG8gdGhlIHVwbG9hZGluZyBxdWV1ZSB0byBiZSB1cGxvYWRlZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7RmlsZVtdfSAtIGZpbGVzIHRvIGFkZCB0byB0aGUgdXBsb2FkIHF1ZXVlLlxuICAgICAqXG4gICAgICogcmV0dXJuIHtGaWxlTW9kZWxbXX0gLSByZXR1cm4gdGhlIGZpbGUgYWRkZWQgdG8gdGhlIHF1ZXVlIGluIHRoaXMgY2FsbC5cbiAgICAgKi9cbiAgICBhZGRUb1F1ZXVlKGZpbGVzOiBhbnlbXSk6IEZpbGVNb2RlbFtdIHtcbiAgICAgICAgbGV0IGxhdGVzdEZpbGVzQWRkZWQ6IEZpbGVNb2RlbFtdID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNGaWxlKGZpbGUpKSB7XG4gICAgICAgICAgICAgICAgbGV0IHVwbG9hZGluZ0ZpbGVNb2RlbCA9IG5ldyBGaWxlTW9kZWwoZmlsZSk7XG4gICAgICAgICAgICAgICAgbGF0ZXN0RmlsZXNBZGRlZC5wdXNoKHVwbG9hZGluZ0ZpbGVNb2RlbCk7XG4gICAgICAgICAgICAgICAgdGhpcy5xdWV1ZS5wdXNoKHVwbG9hZGluZ0ZpbGVNb2RlbCk7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZmlsZXNVcGxvYWRPYnNlcnZlclByb2dyZXNzQmFyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmlsZXNVcGxvYWRPYnNlcnZlclByb2dyZXNzQmFyLm5leHQodGhpcy5xdWV1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsYXRlc3RGaWxlc0FkZGVkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBpY2sgYWxsIHRoZSBmaWxlcyBpbiB0aGUgcXVldWUgdGhhdCBhcmUgbm90IGJlZW4gdXBsb2FkZWQgeWV0IGFuZCB1cGxvYWQgaXQgaW50byB0aGUgZGlyZWN0b3J5IGZvbGRlci5cbiAgICAgKi9cbiAgICB1cGxvYWRGaWxlc0luVGhlUXVldWUocm9vdElkOiBzdHJpbmcsIGRpcmVjdG9yeTogc3RyaW5nLCBlbGVtZW50RW1pdDogRXZlbnRFbWl0dGVyPGFueT4pOiB2b2lkIHtcbiAgICAgICAgbGV0IGZpbGVzVG9VcGxvYWQgPSB0aGlzLnF1ZXVlLmZpbHRlcigodXBsb2FkaW5nRmlsZU1vZGVsKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gIXVwbG9hZGluZ0ZpbGVNb2RlbC51cGxvYWRpbmcgJiYgIXVwbG9hZGluZ0ZpbGVNb2RlbC5kb25lICYmICF1cGxvYWRpbmdGaWxlTW9kZWwuYWJvcnQgJiYgIXVwbG9hZGluZ0ZpbGVNb2RlbC5lcnJvcjtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IG9wdHM6IGFueSA9IHt9O1xuICAgICAgICBvcHRzLnJlbmRpdGlvbnMgPSAnZG9jbGliJztcblxuICAgICAgICBpZiAodGhpcy52ZXJzaW9uaW5nKSB7XG4gICAgICAgICAgICBvcHRzLm92ZXJ3cml0ZSA9IHRydWU7XG4gICAgICAgICAgICBvcHRzLm1ham9yVmVyc2lvbiA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvcHRzLmF1dG9SZW5hbWUgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgZmlsZXNUb1VwbG9hZC5mb3JFYWNoKCh1cGxvYWRpbmdGaWxlTW9kZWw6IEZpbGVNb2RlbCkgPT4ge1xuICAgICAgICAgICAgdXBsb2FkaW5nRmlsZU1vZGVsLnNldFVwbG9hZGluZygpO1xuXG4gICAgICAgICAgICBsZXQgcHJvbWlzZVVwbG9hZCA9IHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLnVwbG9hZC51cGxvYWRGaWxlKHVwbG9hZGluZ0ZpbGVNb2RlbC5maWxlLCBkaXJlY3RvcnksIHJvb3RJZCwgbnVsbCwgb3B0cylcbiAgICAgICAgICAgICAgICAub24oJ3Byb2dyZXNzJywgKHByb2dyZXNzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdXBsb2FkaW5nRmlsZU1vZGVsLnNldFByb2dyZXMocHJvZ3Jlc3MpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUZpbGVMaXN0U3RyZWFtKHRoaXMucXVldWUpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLm9uKCdhYm9ydCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdXBsb2FkaW5nRmlsZU1vZGVsLnNldEFib3J0KCk7XG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnRFbWl0LmVtaXQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICdGaWxlIGFib3J0ZWQnXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLm9uKCdlcnJvcicsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdXBsb2FkaW5nRmlsZU1vZGVsLnNldEVycm9yKCk7XG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnRFbWl0LmVtaXQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICdFcnJvciBmaWxlIHVwbG9hZGVkJ1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5vbignc3VjY2VzcycsIChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudEVtaXQuZW1pdCh7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZGF0YVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgdXBsb2FkaW5nRmlsZU1vZGVsLm9uRmluaXNoZWQoXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnN0YXR1cyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuc3RhdHVzVGV4dCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucmVzcG9uc2VcbiAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUZpbGVMaXN0U3RyZWFtKHRoaXMucXVldWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXVwbG9hZGluZ0ZpbGVNb2RlbC5hYm9ydCAmJiAhdXBsb2FkaW5nRmlsZU1vZGVsLmVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUZpbGVDb3VudGVyU3RyZWFtKCsrdGhpcy50b3RhbENvbXBsZXRlZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdXBsb2FkaW5nRmlsZU1vZGVsLnNldFByb21pc2VVcGxvYWQocHJvbWlzZVVwbG9hZCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBhbGwgdGhlIGZpbGVzIGluIHRoZSB1cGxvYWRpbmcgcXVldWUuXG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtGaWxlTW9kZWxbXX0gLSBmaWxlcyBpbiB0aGUgdXBsb2FkIHF1ZXVlLlxuICAgICAqL1xuICAgIGdldFF1ZXVlKCk6IEZpbGVNb2RlbFtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucXVldWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgaWYgYW4gaXRlbSBpcyBhIGZpbGUuXG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtib29sZWFufVxuICAgICAqL1xuICAgIHByaXZhdGUgaXNGaWxlKGZpbGU6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZmlsZSAhPT0gbnVsbCAmJiAoZmlsZSBpbnN0YW5jZW9mIEJsb2IgfHwgKGZpbGUubmFtZSAmJiBmaWxlLnNpemUpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBmb2xkZXJcbiAgICAgKiBAcGFyYW0gbmFtZSAtIHRoZSBmb2xkZXIgbmFtZVxuICAgICAqL1xuICAgIGNyZWF0ZUZvbGRlcihyZWxhdGl2ZVBhdGg6IHN0cmluZywgbmFtZTogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuY2FsbEFwaUNyZWF0ZUZvbGRlcihyZWxhdGl2ZVBhdGgsIG5hbWUpKVxuICAgICAgICAgICAgLm1hcChyZXMgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXM7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmRvKGRhdGEgPT4gdGhpcy5sb2dTZXJ2aWNlLmluZm8oJ05vZGUgZGF0YScsIGRhdGEpKSAvLyBleWViYWxsIHJlc3VsdHMgaW4gdGhlIGNvbnNvbGVcbiAgICAgICAgICAgIC5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGxBcGlDcmVhdGVGb2xkZXIocmVsYXRpdmVQYXRoOiBzdHJpbmcsIG5hbWU6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkubm9kZXMuY3JlYXRlRm9sZGVyKG5hbWUsIHJlbGF0aXZlUGF0aCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhyb3cgdGhlIGVycm9yXG4gICAgICogQHBhcmFtIGVycm9yXG4gICAgICogQHJldHVybnMge0Vycm9yT2JzZXJ2YWJsZX1cbiAgICAgKi9cbiAgICBwcml2YXRlIGhhbmRsZUVycm9yKGVycm9yOiBSZXNwb25zZSkge1xuICAgICAgICAvLyBpbiBhIHJlYWwgd29ybGQgYXBwLCB3ZSBtYXkgc2VuZCB0aGUgZXJyb3IgdG8gc29tZSByZW1vdGUgbG9nZ2luZyBpbmZyYXN0cnVjdHVyZVxuICAgICAgICAvLyBpbnN0ZWFkIG9mIGp1c3QgbG9nZ2luZyBpdCB0byB0aGUgY29uc29sZVxuICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoZXJyb3IpO1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhlcnJvciB8fCAnU2VydmVyIGVycm9yJyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVGaWxlTGlzdFN0cmVhbShmaWxlTGlzdDogRmlsZU1vZGVsW10pIHtcbiAgICAgICAgaWYgKHRoaXMuZmlsZXNVcGxvYWRPYnNlcnZlclByb2dyZXNzQmFyKSB7XG4gICAgICAgICAgICB0aGlzLmZpbGVzVXBsb2FkT2JzZXJ2ZXJQcm9ncmVzc0Jhci5uZXh0KGZpbGVMaXN0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHVwZGF0ZUZpbGVDb3VudGVyU3RyZWFtKHRvdGFsOiBudW1iZXIpIHtcbiAgICAgICAgaWYgKHRoaXMudG90YWxDb21wbGV0ZWRPYnNlcnZlcikge1xuICAgICAgICAgICAgdGhpcy50b3RhbENvbXBsZXRlZE9ic2VydmVyLm5leHQodG90YWwpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19
