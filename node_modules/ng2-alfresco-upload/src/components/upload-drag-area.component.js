/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var upload_service_1 = require("../services/upload.service");
var ERROR_FOLDER_ALREADY_EXIST = 409;
var UploadDragAreaComponent = UploadDragAreaComponent_1 = (function () {
    function UploadDragAreaComponent(uploadService, translateService, logService, notificationService) {
        this.uploadService = uploadService;
        this.translateService = translateService;
        this.logService = logService;
        this.notificationService = notificationService;
        this.showNotificationBar = true;
        this.versioning = false;
        this.currentFolderPath = '/';
        this.rootFolderId = UploadDragAreaComponent_1.DEFAULT_ROOT_ID;
        this.onSuccess = new core_1.EventEmitter();
        if (translateService) {
            translateService.addTranslationFolder('ng2-alfresco-upload', 'node_modules/ng2-alfresco-upload/src');
        }
    }
    UploadDragAreaComponent.prototype.ngOnChanges = function (changes) {
        var formFields = this.createFormFields();
        this.uploadService.setOptions(formFields, this.versioning);
    };
    UploadDragAreaComponent.prototype.onFilesDropped = function (files) {
        if (files.length) {
            if (this.checkValidity(files)) {
                this.uploadService.addToQueue(files);
                this.uploadService.uploadFilesInTheQueue(this.rootFolderId, this.currentFolderPath, this.onSuccess);
                var latestFilesAdded = this.uploadService.getQueue();
                if (this.showNotificationBar) {
                    this.showUndoNotificationBar(latestFilesAdded);
                }
            }
            else {
                var errorMessage = void 0;
                errorMessage = this.translateService.get('FILE_UPLOAD.MESSAGES.FOLDER_NOT_SUPPORTED');
                if (this.showNotificationBar) {
                    this.showErrorNotificationBar(errorMessage.value);
                }
                else {
                    this.logService.error(errorMessage.value);
                }
            }
        }
    };
    UploadDragAreaComponent.prototype.checkValidity = function (files) {
        if (files.length && files[0].type === '') {
            return false;
        }
        return true;
    };
    UploadDragAreaComponent.prototype.onFilesEntityDropped = function (item) {
        var _this = this;
        item.file(function (file) {
            _this.uploadService.addToQueue([file]);
            var path = item.fullPath.replace(item.name, '');
            var filePath = _this.currentFolderPath + path;
            _this.uploadService.uploadFilesInTheQueue(_this.rootFolderId, filePath, _this.onSuccess);
        });
    };
    UploadDragAreaComponent.prototype.onFolderEntityDropped = function (folder) {
        var _this = this;
        if (folder.isDirectory) {
            var relativePath = folder.fullPath.replace(folder.name, '');
            relativePath = this.currentFolderPath + relativePath;
            this.uploadService.createFolder(relativePath, folder.name)
                .subscribe(function (message) {
                _this.onSuccess.emit({
                    value: 'Created folder'
                });
                var dirReader = folder.createReader();
                dirReader.readEntries(function (entries) {
                    for (var i = 0; i < entries.length; i++) {
                        _this._traverseFileTree(entries[i]);
                    }
                    if (_this.showNotificationBar) {
                        var latestFilesAdded = _this.uploadService.getQueue();
                        _this.showUndoNotificationBar(latestFilesAdded);
                    }
                });
            }, function (error) {
                var errorMessagePlaceholder = _this.getErrorMessage(error.response);
                var errorMessage = _this.formatString(errorMessagePlaceholder, [folder.name]);
                if (_this.showNotificationBar) {
                    _this.showErrorNotificationBar(errorMessage);
                }
                else {
                    _this.logService.error(errorMessage);
                }
            });
        }
    };
    UploadDragAreaComponent.prototype._traverseFileTree = function (item) {
        if (item.isFile) {
            this.onFilesEntityDropped(item);
        }
        else {
            if (item.isDirectory) {
                this.onFolderEntityDropped(item);
            }
        }
    };
    UploadDragAreaComponent.prototype.showUndoNotificationBar = function (latestFilesAdded) {
        var messageTranslate, actionTranslate;
        messageTranslate = this.translateService.get('FILE_UPLOAD.MESSAGES.PROGRESS');
        actionTranslate = this.translateService.get('FILE_UPLOAD.ACTION.UNDO');
        this.notificationService.openSnackMessageAction(messageTranslate.value, actionTranslate.value, 3000).afterDismissed().subscribe(function () {
            latestFilesAdded.forEach(function (uploadingFileModel) {
                uploadingFileModel.emitAbort();
            });
        });
    };
    UploadDragAreaComponent.prototype.showErrorNotificationBar = function (errorMessage) {
        this.notificationService.openSnackMessage(errorMessage, 3000);
    };
    UploadDragAreaComponent.prototype.getErrorMessage = function (response) {
        if (response.body.error.statusCode === ERROR_FOLDER_ALREADY_EXIST) {
            var errorMessage = void 0;
            errorMessage = this.translateService.get('FILE_UPLOAD.MESSAGES.FOLDER_ALREADY_EXIST');
            return errorMessage.value;
        }
    };
    UploadDragAreaComponent.prototype.formatString = function (message, keys) {
        if (message) {
            var i = keys.length;
            while (i--) {
                message = message.replace(new RegExp('\\{' + i + '\\}', 'gm'), keys[i]);
            }
        }
        return message;
    };
    UploadDragAreaComponent.prototype.createFormFields = function () {
        return {
            formFields: {
                overwrite: true
            }
        };
    };
    return UploadDragAreaComponent;
}());
UploadDragAreaComponent.DEFAULT_ROOT_ID = '-root-';
__decorate([
    core_1.Input(),
    __metadata("design:type", Boolean)
], UploadDragAreaComponent.prototype, "showNotificationBar", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", Boolean)
], UploadDragAreaComponent.prototype, "versioning", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], UploadDragAreaComponent.prototype, "currentFolderPath", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], UploadDragAreaComponent.prototype, "rootFolderId", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", Object)
], UploadDragAreaComponent.prototype, "onSuccess", void 0);
UploadDragAreaComponent = UploadDragAreaComponent_1 = __decorate([
    core_1.Component({
        selector: 'alfresco-upload-drag-area',
        moduleId: module.id,
        template: "<div file-draggable id='UploadBorder' class=\"upload-border\"      (onFilesDropped)=\"onFilesDropped($event)\"      (onFilesEntityDropped)=\"onFilesEntityDropped($event)\"      (onFolderEntityDropped)=\"onFolderEntityDropped($event)\"      dropzone=\"\" webkitdropzone=\"*\" #droparea>     <ng-content></ng-content> </div>",
        styles: [".upload-border {     vertical-align: middle;     color: #555;     text-align: center; }  .input-focus {     color: #2196F3;     margin-left: 3px;     border: 3px dashed #2196F3; }"]
    }),
    __metadata("design:paramtypes", [upload_service_1.UploadService,
        ng2_alfresco_core_1.AlfrescoTranslationService,
        ng2_alfresco_core_1.LogService,
        ng2_alfresco_core_1.NotificationService])
], UploadDragAreaComponent);
exports.UploadDragAreaComponent = UploadDragAreaComponent;
var UploadDragAreaComponent_1;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvdXBsb2FkLWRyYWctYXJlYS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7OztHQWVHOzs7Ozs7Ozs7OztBQUVILHNDQUF1RTtBQUN2RSx1REFBZ0c7QUFDaEcsNkRBQTJEO0FBSzNELElBQU0sMEJBQTBCLEdBQUcsR0FBRyxDQUFDO0FBaUJ2QyxJQUFhLHVCQUF1QjtJQW1CaEMsaUNBQW9CLGFBQTRCLEVBQzVCLGdCQUE0QyxFQUM1QyxVQUFzQixFQUN0QixtQkFBd0M7UUFIeEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUE0QjtRQUM1QyxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFqQjVELHdCQUFtQixHQUFZLElBQUksQ0FBQztRQUdwQyxlQUFVLEdBQVksS0FBSyxDQUFDO1FBRzVCLHNCQUFpQixHQUFXLEdBQUcsQ0FBQztRQUdoQyxpQkFBWSxHQUFXLHlCQUF1QixDQUFDLGVBQWUsQ0FBQztRQUcvRCxjQUFTLEdBQUcsSUFBSSxtQkFBWSxFQUFFLENBQUM7UUFNM0IsRUFBRSxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO1lBQ25CLGdCQUFnQixDQUFDLG9CQUFvQixDQUFDLHFCQUFxQixFQUFFLHNDQUFzQyxDQUFDLENBQUM7UUFDekcsQ0FBQztJQUNMLENBQUM7SUFFRCw2Q0FBVyxHQUFYLFVBQVksT0FBTztRQUNmLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDL0QsQ0FBQztJQU9ELGdEQUFjLEdBQWQsVUFBZSxLQUFhO1FBQ3hCLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxD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UUFDViw4Q0FBMEI7UUFDaEMsOEJBQVU7UUFDRCx1Q0FBbUI7R0F0Qm5ELHVCQUF1QixDQXlNbkM7QUF6TVksMERBQXVCIiwiZmlsZSI6ImNvbXBvbmVudHMvdXBsb2FkLWRyYWctYXJlYS5jb21wb25lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxNiBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWxmcmVzY29UcmFuc2xhdGlvblNlcnZpY2UsIExvZ1NlcnZpY2UsIE5vdGlmaWNhdGlvblNlcnZpY2UgfSBmcm9tICduZzItYWxmcmVzY28tY29yZSc7XG5pbXBvcnQgeyBVcGxvYWRTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvdXBsb2FkLnNlcnZpY2UnO1xuaW1wb3J0IHsgRmlsZU1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2ZpbGUubW9kZWwnO1xuXG5kZWNsYXJlIGxldCBjb21wb25lbnRIYW5kbGVyOiBhbnk7XG5cbmNvbnN0IEVSUk9SX0ZPTERFUl9BTFJFQURZX0VYSVNUID0gNDA5O1xuXG4vKipcbiAqIDxhbGZyZXNjby11cGxvYWQtZHJhZy1hcmVhIChvblN1Y2Nlc3MpPVwiY3VzdG9tTWV0aG9kKCRldmVudCk+PC9hbGZyZXNjby11cGxvYWQtZHJhZy1hcmVhPlxuICpcbiAqIFRoaXMgY29tcG9uZW50LCBwcm92aWRlIGEgZHJhZyBhbmQgZHJvcCBhcmUgdG8gdXBsb2FkIGZpbGVzIHRvIGFsZnJlc2NvLlxuICpcbiAqIEBPdXRwdXQgLSBvblN1Y2Nlc3MgLSBUaGUgZXZlbnQgaXMgZW1pdHRlZCB3aGVuIHRoZSBmaWxlIGlzIHVwbG9hZGVkXG4gKlxuICogQHJldHVybnMge1VwbG9hZERyYWdBcmVhQ29tcG9uZW50fSAuXG4gKi9cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnYWxmcmVzY28tdXBsb2FkLWRyYWctYXJlYScsXG4gICAgbW9kdWxlSWQ6IG1vZHVsZS5pZCxcbiAgICB0ZW1wbGF0ZTogXCI8ZGl2IGZpbGUtZHJhZ2dhYmxlIGlkPSdVcGxvYWRCb3JkZXInIGNsYXNzPVxcXCJ1cGxvYWQtYm9yZGVyXFxcIiAgICAgIChvbkZpbGVzRHJvcHBlZCk9XFxcIm9uRmlsZXNEcm9wcGVkKCRldmVudClcXFwiICAgICAgKG9uRmlsZXNFbnRpdHlEcm9wcGVkKT1cXFwib25GaWxlc0VudGl0eURyb3BwZWQoJGV2ZW50KVxcXCIgICAgICAob25Gb2xkZXJFbnRpdHlEcm9wcGVkKT1cXFwib25Gb2xkZXJFbnRpdHlEcm9wcGVkKCRldmVudClcXFwiICAgICAgZHJvcHpvbmU9XFxcIlxcXCIgd2Via2l0ZHJvcHpvbmU9XFxcIipcXFwiICNkcm9wYXJlYT4gICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD4gPC9kaXY+XCIsXG4gICAgc3R5bGVzOiBbXCIudXBsb2FkLWJvcmRlciB7ICAgICB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlOyAgICAgY29sb3I6ICM1NTU7ICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7IH0gIC5pbnB1dC1mb2N1cyB7ICAgICBjb2xvcjogIzIxOTZGMzsgICAgIG1hcmdpbi1sZWZ0OiAzcHg7ICAgICBib3JkZXI6IDNweCBkYXNoZWQgIzIxOTZGMzsgfVwiXVxufSlcbmV4cG9ydCBjbGFzcyBVcGxvYWREcmFnQXJlYUNvbXBvbmVudCB7XG5cbiAgICBwcml2YXRlIHN0YXRpYyBERUZBVUxUX1JPT1RfSUQ6IHN0cmluZyA9ICctcm9vdC0nO1xuXG4gICAgQElucHV0KClcbiAgICBzaG93Tm90aWZpY2F0aW9uQmFyOiBib29sZWFuID0gdHJ1ZTtcblxuICAgIEBJbnB1dCgpXG4gICAgdmVyc2lvbmluZzogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgQElucHV0KClcbiAgICBjdXJyZW50Rm9sZGVyUGF0aDogc3RyaW5nID0gJy8nO1xuXG4gICAgQElucHV0KClcbiAgICByb290Rm9sZGVySWQ6IHN0cmluZyA9IFVwbG9hZERyYWdBcmVhQ29tcG9uZW50LkRFRkFVTFRfUk9PVF9JRDtcblxuICAgIEBPdXRwdXQoKVxuICAgIG9uU3VjY2VzcyA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgdXBsb2FkU2VydmljZTogVXBsb2FkU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IEFsZnJlc2NvVHJhbnNsYXRpb25TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbG9nU2VydmljZTogTG9nU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIG5vdGlmaWNhdGlvblNlcnZpY2U6IE5vdGlmaWNhdGlvblNlcnZpY2UpIHtcbiAgICAgICAgaWYgKHRyYW5zbGF0ZVNlcnZpY2UpIHtcbiAgICAgICAgICAgIHRyYW5zbGF0ZVNlcnZpY2UuYWRkVHJhbnNsYXRpb25Gb2xkZXIoJ25nMi1hbGZyZXNjby11cGxvYWQnLCAnbm9kZV9tb2R1bGVzL25nMi1hbGZyZXNjby11cGxvYWQvc3JjJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBuZ09uQ2hhbmdlcyhjaGFuZ2VzKSB7XG4gICAgICAgIGxldCBmb3JtRmllbGRzID0gdGhpcy5jcmVhdGVGb3JtRmllbGRzKCk7XG4gICAgICAgIHRoaXMudXBsb2FkU2VydmljZS5zZXRPcHRpb25zKGZvcm1GaWVsZHMsIHRoaXMudmVyc2lvbmluZyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTWV0aG9kIGNhbGxlZCB3aGVuIGZpbGVzIGFyZSBkcm9wcGVkIGluIHRoZSBkcmFnIGFyZWEuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge0ZpbGVbXX0gZmlsZXMgLSBmaWxlcyBkcm9wcGVkIGluIHRoZSBkcmFnIGFyZWEuXG4gICAgICovXG4gICAgb25GaWxlc0Ryb3BwZWQoZmlsZXM6IEZpbGVbXSk6IHZvaWQge1xuICAgICAgICBpZiAoZmlsZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5jaGVja1ZhbGlkaXR5KGZpbGVzKSkge1xuICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkU2VydmljZS5hZGRUb1F1ZXVlKGZpbGVzKTtcbiAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZFNlcnZpY2UudXBsb2FkRmlsZXNJblRoZVF1ZXVlKHRoaXMucm9vdEZvbGRlcklkLCB0aGlzLmN1cnJlbnRGb2xkZXJQYXRoLCB0aGlzLm9uU3VjY2Vzcyk7XG4gICAgICAgICAgICAgICAgbGV0IGxhdGVzdEZpbGVzQWRkZWQgPSB0aGlzLnVwbG9hZFNlcnZpY2UuZ2V0UXVldWUoKTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG93Tm90aWZpY2F0aW9uQmFyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1VuZG9Ob3RpZmljYXRpb25CYXIobGF0ZXN0RmlsZXNBZGRlZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsZXQgZXJyb3JNZXNzYWdlOiBhbnk7XG4gICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmdldCgnRklMRV9VUExPQUQuTUVTU0FHRVMuRk9MREVSX05PVF9TVVBQT1JURUQnKTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG93Tm90aWZpY2F0aW9uQmFyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Vycm9yTm90aWZpY2F0aW9uQmFyKGVycm9yTWVzc2FnZS52YWx1ZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVycm9yTWVzc2FnZS52YWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgaWwgdGhlIGZpbGUgaXMgdmFsaWQgb3Igbm90XG4gICAgICogQHBhcmFtIGZpbGVzXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgY2hlY2tWYWxpZGl0eShmaWxlczogRmlsZVtdKTogYm9vbGVhbiB7XG4gICAgICAgIGlmIChmaWxlcy5sZW5ndGggJiYgZmlsZXNbMF0udHlwZSA9PT0gJycpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxsZWQgd2hlbiB0aGUgZmlsZSBhcmUgZHJvcHBlZCBpbiB0aGUgZHJhZyBhcmVhXG4gICAgICogQHBhcmFtIGl0ZW0gLSBGaWxlRW50aXR5XG4gICAgICovXG4gICAgb25GaWxlc0VudGl0eURyb3BwZWQoaXRlbTogYW55KTogdm9pZCB7XG4gICAgICAgIGl0ZW0uZmlsZSgoZmlsZTogYW55KSA9PiB7XG4gICAgICAgICAgICB0aGlzLnVwbG9hZFNlcnZpY2UuYWRkVG9RdWV1ZShbZmlsZV0pO1xuICAgICAgICAgICAgbGV0IHBhdGggPSBpdGVtLmZ1bGxQYXRoLnJlcGxhY2UoaXRlbS5uYW1lLCAnJyk7XG4gICAgICAgICAgICBsZXQgZmlsZVBhdGggPSB0aGlzLmN1cnJlbnRGb2xkZXJQYXRoICsgcGF0aDtcbiAgICAgICAgICAgIHRoaXMudXBsb2FkU2VydmljZS51cGxvYWRGaWxlc0luVGhlUXVldWUodGhpcy5yb290Rm9sZGVySWQsIGZpbGVQYXRoLCB0aGlzLm9uU3VjY2Vzcyk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGxlZCB3aGVuIGEgZm9sZGVyIGFyZSBkcm9wcGVkIGluIHRoZSBkcmFnIGFyZWFcbiAgICAgKiBAcGFyYW0gZm9sZGVyIC0gbmFtZSBvZiB0aGUgZHJvcHBlZCBmb2xkZXJcbiAgICAgKi9cbiAgICBvbkZvbGRlckVudGl0eURyb3BwZWQoZm9sZGVyOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgaWYgKGZvbGRlci5pc0RpcmVjdG9yeSkge1xuICAgICAgICAgICAgbGV0IHJlbGF0aXZlUGF0aCA9IGZvbGRlci5mdWxsUGF0aC5yZXBsYWNlKGZvbGRlci5uYW1lLCAnJyk7XG4gICAgICAgICAgICByZWxhdGl2ZVBhdGggPSB0aGlzLmN1cnJlbnRGb2xkZXJQYXRoICsgcmVsYXRpdmVQYXRoO1xuXG4gICAgICAgICAgICB0aGlzLnVwbG9hZFNlcnZpY2UuY3JlYXRlRm9sZGVyKHJlbGF0aXZlUGF0aCwgZm9sZGVyLm5hbWUpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uU3VjY2Vzcy5lbWl0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogJ0NyZWF0ZWQgZm9sZGVyJ1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGlyUmVhZGVyID0gZm9sZGVyLmNyZWF0ZVJlYWRlcigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGlyUmVhZGVyLnJlYWRFbnRyaWVzKChlbnRyaWVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVudHJpZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdHJhdmVyc2VGaWxlVHJlZShlbnRyaWVzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvd05vdGlmaWNhdGlvbkJhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbGF0ZXN0RmlsZXNBZGRlZCA9IHRoaXMudXBsb2FkU2VydmljZS5nZXRRdWV1ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dVbmRvTm90aWZpY2F0aW9uQmFyKGxhdGVzdEZpbGVzQWRkZWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZXJyb3JNZXNzYWdlUGxhY2Vob2xkZXIgPSB0aGlzLmdldEVycm9yTWVzc2FnZShlcnJvci5yZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZXJyb3JNZXNzYWdlID0gdGhpcy5mb3JtYXRTdHJpbmcoZXJyb3JNZXNzYWdlUGxhY2Vob2xkZXIsIFtmb2xkZXIubmFtZV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvd05vdGlmaWNhdGlvbkJhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Vycm9yTm90aWZpY2F0aW9uQmFyKGVycm9yTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcihlcnJvck1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJhdmVycyBhbGwgdGhlIGZpbGVzIGFuZCBmb2xkZXJzLCBhbmQgY3JlYXRlIGl0IG9uIHRoZSBhbGZyZXNjby5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBpdGVtIC0gY2FuIGNvbnRhaW5zIGZpbGVzIG9yIGZvbGRlcnMuXG4gICAgICovXG4gICAgcHJpdmF0ZSBfdHJhdmVyc2VGaWxlVHJlZShpdGVtOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgaWYgKGl0ZW0uaXNGaWxlKSB7XG4gICAgICAgICAgICB0aGlzLm9uRmlsZXNFbnRpdHlEcm9wcGVkKGl0ZW0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGl0ZW0uaXNEaXJlY3RvcnkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uRm9sZGVyRW50aXR5RHJvcHBlZChpdGVtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNob3cgdW5kbyBub3RpZmljYXRpb24gYmFyLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtGaWxlTW9kZWxbXX0gbGF0ZXN0RmlsZXNBZGRlZCAtIGZpbGVzIGluIHRoZSB1cGxvYWQgcXVldWUgZW5yaWNoZWQgd2l0aCBzdGF0dXMgZmxhZyBhbmQgeGhyIG9iamVjdC5cbiAgICAgKi9cbiAgICBzaG93VW5kb05vdGlmaWNhdGlvbkJhcihsYXRlc3RGaWxlc0FkZGVkOiBGaWxlTW9kZWxbXSkge1xuICAgICAgICBsZXQgbWVzc2FnZVRyYW5zbGF0ZTogYW55LCBhY3Rpb25UcmFuc2xhdGU6IGFueTtcbiAgICAgICAgbWVzc2FnZVRyYW5zbGF0ZSA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5nZXQoJ0ZJTEVfVVBMT0FELk1FU1NBR0VTLlBST0dSRVNTJyk7XG4gICAgICAgIGFjdGlvblRyYW5zbGF0ZSA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5nZXQoJ0ZJTEVfVVBMT0FELkFDVElPTi5VTkRPJyk7XG5cbiAgICAgICAgdGhpcy5ub3RpZmljYXRpb25TZXJ2aWNlLm9wZW5TbmFja01lc3NhZ2VBY3Rpb24obWVzc2FnZVRyYW5zbGF0ZS52YWx1ZSwgYWN0aW9uVHJhbnNsYXRlLnZhbHVlLCAzMDAwKS5hZnRlckRpc21pc3NlZCgpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICBsYXRlc3RGaWxlc0FkZGVkLmZvckVhY2goKHVwbG9hZGluZ0ZpbGVNb2RlbDogRmlsZU1vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgdXBsb2FkaW5nRmlsZU1vZGVsLmVtaXRBYm9ydCgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNob3cgdGhlIGVycm9yIGluc2lkZSBOb3RpZmljYXRpb24gYmFyXG4gICAgICogQHBhcmFtIEVycm9yIG1lc3NhZ2VcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHNob3dFcnJvck5vdGlmaWNhdGlvbkJhcihlcnJvck1lc3NhZ2U6IHN0cmluZykge1xuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvblNlcnZpY2Uub3BlblNuYWNrTWVzc2FnZShlcnJvck1lc3NhZ2UsIDMwMDApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHJpdmUgdGhlIGVycm9yIG1lc3NhZ2UgdXNpbmcgdGhlIGVycm9yIHN0YXR1cyBjb2RlXG4gICAgICogQHBhcmFtIHJlc3BvbnNlIC0gb2JqZWN0IHRoYXQgY29udGFpbiB0aGUgSFRUUCByZXNwb25zZVxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXRFcnJvck1lc3NhZ2UocmVzcG9uc2U6IGFueSk6IHN0cmluZyB7XG4gICAgICAgIGlmIChyZXNwb25zZS5ib2R5LmVycm9yLnN0YXR1c0NvZGUgPT09IEVSUk9SX0ZPTERFUl9BTFJFQURZX0VYSVNUKSB7XG4gICAgICAgICAgICBsZXQgZXJyb3JNZXNzYWdlOiBhbnk7XG4gICAgICAgICAgICBlcnJvck1lc3NhZ2UgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuZ2V0KCdGSUxFX1VQTE9BRC5NRVNTQUdFUy5GT0xERVJfQUxSRUFEWV9FWElTVCcpO1xuICAgICAgICAgICAgcmV0dXJuIGVycm9yTWVzc2FnZS52YWx1ZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgYSBwbGFjZWhvbGRlciB7MH0gaW4gYSBtZXNzYWdlIHdpdGggdGhlIGlucHV0IGtleXNcbiAgICAgKiBAcGFyYW0gbWVzc2FnZSAtIHRoZSBtZXNzYWdlIHRoYXQgY29uYWlucyB0aGUgcGxhY2Vob2xkZXJcbiAgICAgKiBAcGFyYW0ga2V5cyAtIGFycmF5IG9mIHZhbHVlXG4gICAgICogQHJldHVybnMge3N0cmluZ30gLSBUaGUgbWVzc2FnZSB3aXRob3V0IHBsYWNlaG9sZGVyXG4gICAgICovXG4gICAgcHJpdmF0ZSBmb3JtYXRTdHJpbmcobWVzc2FnZTogc3RyaW5nLCBrZXlzOiBhbnkgW10pIHtcbiAgICAgICAgaWYgKG1lc3NhZ2UpIHtcbiAgICAgICAgICAgIGxldCBpID0ga2V5cy5sZW5ndGg7XG4gICAgICAgICAgICB3aGlsZSAoaS0tKSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UucmVwbGFjZShuZXcgUmVnRXhwKCdcXFxceycgKyBpICsgJ1xcXFx9JywgJ2dtJyksIGtleXNbaV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBtZXNzYWdlO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlRm9ybUZpZWxkcygpOiBhbnkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZm9ybUZpZWxkczoge1xuICAgICAgICAgICAgICAgIG92ZXJ3cml0ZTogdHJ1ZVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cbn1cbiJdfQ==
