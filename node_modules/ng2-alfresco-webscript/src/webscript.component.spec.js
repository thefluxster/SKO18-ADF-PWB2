/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var testing_1 = require("@angular/core/testing");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var ng2_alfresco_datatable_1 = require("ng2-alfresco-datatable");
var webscript_component_1 = require("../src/webscript.component");
describe('Test ng2-alfresco-webscript', function () {
    var component;
    var fixture;
    var debug;
    var element;
    beforeEach(testing_1.async(function () {
        testing_1.TestBed.configureTestingModule({
            imports: [
                ng2_alfresco_core_1.CoreModule.forRoot(),
                ng2_alfresco_datatable_1.DataTableModule
            ],
            declarations: [
                webscript_component_1.WebscriptComponent
            ]
        }).compileComponents();
    }));
    beforeEach(function () {
        fixture = testing_1.TestBed.createComponent(webscript_component_1.WebscriptComponent);
        component = fixture.componentInstance;
        debug = fixture.debugElement;
        element = fixture.nativeElement;
        component = fixture.componentInstance;
        component.scriptPath = 'fakePath';
        component.showData = true;
        fixture.detectChanges();
    });
    describe('View', function () {
        it('html wrapper should be present', function () {
            expect(element.querySelector('#webscript-html-wrapper')).toBeDefined();
        });
        it('wrapper should be hide if showData is false', function () {
            expect(element.querySelector('#webscript-html-wrapper')).toBeDefined();
        });
        it('JSON datatable wrapper should be present', function () {
            expect(element.querySelector('#webscript-json-wrapper')).toBeDefined();
        });
        it('plain text datatable wrapper should be present', function () {
            expect(element.querySelector('#webscript-plaintext-wrapper')).toBeDefined();
        });
    });
    describe('Content tests', function () {
        beforeEach(function () {
            jasmine.Ajax.install();
        });
        afterEach(function () {
            jasmine.Ajax.uninstall();
        });
        it('url should be the one configured by the input param', function (done) {
            component.scriptPath = 'sample/folder/Company%20Home';
            component.ngOnChanges(null).then(function () {
                fixture.detectChanges();
                expect(jasmine.Ajax.requests.mostRecent().url).toBe('http://localhost:8080/alfresco/service/sample/folder/Company%20Home');
                done();
            });
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'text/plain',
                responseText: '<div></div>'
            });
        });
        it('TEXT response should be displayed', function (done) {
            component.scriptPath = 'sample/folder/Company%20Home';
            component.contentType = 'TEXT';
            component.ngOnChanges(null).then(function () {
                fixture.detectChanges();
                expect(element.querySelector('#webscript-data-TEXT').innerHTML)
                    .toBe('text test');
                done();
            });
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'text/html',
                responseText: 'text test'
            });
        });
        it('JSON response should be displayed', function (done) {
            component.scriptPath = 'sample/folder/Company%20Home';
            component.contentType = 'JSON';
            component.ngOnChanges(null).then(function () {
                fixture.detectChanges();
                expect(JSON.parse(element.querySelector('#webscript-data-JSON').innerHTML)[0].name).toBe('Name 1');
                expect(JSON.parse(element.querySelector('#webscript-data-JSON').innerHTML)[1].name).toBe('Name 2');
                done();
            });
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'json',
                responseText: [{ id: 1, name: 'Name 1' },
                    { id: 2, name: 'Name 2' }]
            });
        });
        xit('HTML response should be displayed', function (done) {
            component.scriptPath = 'sample/folder/Company%20Home';
            component.contentType = 'HTML';
            component.ngOnChanges(null).then(function () {
                fixture.detectChanges();
                expect(element.querySelector('#webscript-data-HTML').innerHTML)
                    .toBe('&lt;test-element-id&gt;&lt;test-elemt-id&gt;');
                done();
            });
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'text/html',
                responseText: '<test-element-id><test-elemt-id>'
            });
        });
        it('datatable response should be displayed', function (done) {
            window['componentHandler'] = null;
            component.scriptPath = 'sample/folder/Company%20Home';
            component.contentType = 'DATATABLE';
            component.ngOnChanges(null).then(function () {
                fixture.detectChanges();
                expect(element.querySelector('#webscript-datatable-wrapper').innerHTML).toBeDefined();
                done();
            });
            var dataTable = {
                data: [
                    { id: 1, name: 'Name 1' },
                    { id: 2, name: 'Name 2' }
                ],
                schema: [{
                        type: 'text',
                        key: 'id',
                        title: 'Id',
                        sortable: true
                    }, {
                        type: 'text',
                        key: 'name',
                        title: 'Name',
                        sortable: true
                    }]
            };
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'json',
                responseText: dataTable
            });
        });
        it('datatable response should be displayed also if no schema is provided', function (done) {
            window['componentHandler'] = null;
            component.scriptPath = 'sample/folder/Company%20Home';
            component.contentType = 'DATATABLE';
            component.ngOnChanges(null).then(function () {
                fixture.detectChanges();
                expect(element.querySelector('#webscript-datatable-wrapper').innerHTML).toBeDefined();
                done();
            });
            var dataTable = {
                data: [
                    { id: 1, name: 'Name 1' },
                    { id: 2, name: 'Name 2' }
                ]
            };
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'json',
                responseText: dataTable
            });
        });
    });
});
//# sourceMappingURL=webscript.component.spec.js.map