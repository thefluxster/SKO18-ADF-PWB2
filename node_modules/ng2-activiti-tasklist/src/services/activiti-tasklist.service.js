/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var Rx_1 = require("rxjs/Rx");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var filter_model_1 = require("../models/filter.model");
var comment_model_1 = require("../models/comment.model");
var user_model_1 = require("../models/user.model");
var task_details_model_1 = require("../models/task-details.model");
var form_model_1 = require("../models/form.model");
var ActivitiTaskListService = (function () {
    function ActivitiTaskListService(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
    }
    ActivitiTaskListService.prototype.getDeployedApplications = function (name) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.appsApi.getAppDefinitions())
            .map(function (response) {
            if (name) {
                return response.data.find(function (p) { return p.name === name; });
            }
            return response.data;
        })
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.getTaskListFilters = function (appId) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.callApiTaskFilters(appId))
            .map(function (response) {
            var filters = [];
            response.data.forEach(function (filter) {
                var filterModel = new filter_model_1.FilterRepresentationModel(filter);
                filters.push(filterModel);
            });
            if (response && response.data && response.data.length === 0) {
                return _this.createDefaultFilter(appId);
            }
            return filters;
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.getTasks = function (requestNode) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.callApiTasksFiltered(requestNode))
            .map(function (res) {
            if (requestNode.processDefinitionKey) {
                return res.data.filter(function (p) { return p.processDefinitionKey === requestNode.processDefinitionKey; });
            }
            else {
                return res.data;
            }
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.getTaskDetails = function (id) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.callApiTaskDetails(id))
            .map(function (res) { return res; })
            .map(function (details) {
            return new task_details_model_1.TaskDetailsModel(details);
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.getTaskComments = function (id) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.callApiTaskComments(id))
            .map(function (res) { return res; })
            .map(function (response) {
            var comments = [];
            response.data.forEach(function (comment) {
                var user = new user_model_1.User(comment.createdBy);
                comments.push(new comment_model_1.Comment(comment.id, comment.message, comment.created, user));
            });
            return comments;
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.getTaskChecklist = function (id) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.callApiTaskChecklist(id))
            .map(function (res) { return res; })
            .map(function (response) {
            var checklists = [];
            response.data.forEach(function (checklist) {
                checklists.push(new task_details_model_1.TaskDetailsModel(checklist));
            });
            return checklists;
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.getFormList = function () {
        var _this = this;
        var opts = {
            'filter': 'myReusableForms',
            'sort': 'modifiedDesc',
            'modelType': 2
        };
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.modelsApi.getModels(opts)).map(function (res) { return res; })
            .map(function (response) {
            var forms = [];
            response.data.forEach(function (form) {
                forms.push(new form_model_1.Form(form.id, form.name));
            });
            return forms;
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.attachFormToATask = function (taskId, formId) {
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.taskApi.attachForm(taskId, { 'formId': formId }));
    };
    ActivitiTaskListService.prototype.createDefaultFilter = function (appId) {
        var filters = [];
        var involvedTasksFilter = this.getInvolvedTasksFilterInstance(appId);
        this.addFilter(involvedTasksFilter);
        filters.push(involvedTasksFilter);
        var myTasksFilter = this.getMyTasksFilterInstance(appId);
        this.addFilter(myTasksFilter);
        filters.push(myTasksFilter);
        var queuedTasksFilter = this.getQueuedTasksFilterInstance(appId);
        this.addFilter(queuedTasksFilter);
        filters.push(queuedTasksFilter);
        var completedTasksFilter = this.getCompletedTasksFilterInstance(appId);
        this.addFilter(completedTasksFilter);
        filters.push(completedTasksFilter);
        return filters;
    };
    ActivitiTaskListService.prototype.addTask = function (task) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.callApiAddTask(task))
            .map(function (res) { return res; })
            .map(function (response) {
            return new task_details_model_1.TaskDetailsModel(response);
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.addFilter = function (filter) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.callApiAddFilter(filter))
            .map(function (res) { return res; })
            .map(function (response) {
            return response;
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.addTaskComment = function (id, message) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.callApiAddTaskComment(id, message))
            .map(function (res) { return res; })
            .map(function (response) {
            return new comment_model_1.Comment(response.id, response.message, response.created, response.createdBy);
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.completeTask = function (id) {
        return Rx_1.Observable.fromPromise(this.callApiCompleteTask(id))
            .map(function (res) { return res; });
    };
    ActivitiTaskListService.prototype.getTotalTasks = function (requestNode) {
        var _this = this;
        requestNode.size = 0;
        return Rx_1.Observable.fromPromise(this.callApiTasksFiltered(requestNode))
            .map(function (res) {
            return res;
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.createNewTask = function (task) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.callApiCreateTask(task))
            .map(function (res) { return res; })
            .map(function (response) {
            return new task_details_model_1.TaskDetailsModel(response);
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.claimTask = function (taskId) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.taskApi.claimTask(taskId))
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiTaskListService.prototype.callApiTasksFiltered = function (requestNode) {
        return this.apiService.getInstance().activiti.taskApi.listTasks(requestNode);
    };
    ActivitiTaskListService.prototype.callApiTaskFilters = function (appId) {
        if (appId) {
            return this.apiService.getInstance().activiti.userFiltersApi.getUserTaskFilters({ appId: appId });
        }
        else {
            return this.apiService.getInstance().activiti.userFiltersApi.getUserTaskFilters();
        }
    };
    ActivitiTaskListService.prototype.callApiTaskDetails = function (id) {
        return this.apiService.getInstance().activiti.taskApi.getTask(id);
    };
    ActivitiTaskListService.prototype.callApiTaskComments = function (id) {
        return this.apiService.getInstance().activiti.taskApi.getTaskComments(id);
    };
    ActivitiTaskListService.prototype.callApiAddTaskComment = function (id, message) {
        return this.apiService.getInstance().activiti.taskApi.addTaskComment({ message: message }, id);
    };
    ActivitiTaskListService.prototype.callApiAddTask = function (task) {
        return this.apiService.getInstance().activiti.taskApi.addSubtask(task.parentTaskId, task);
    };
    ActivitiTaskListService.prototype.callApiAddFilter = function (filter) {
        return this.apiService.getInstance().activiti.userFiltersApi.createUserTaskFilter(filter);
    };
    ActivitiTaskListService.prototype.callApiTaskChecklist = function (id) {
        return this.apiService.getInstance().activiti.taskApi.getChecklist(id);
    };
    ActivitiTaskListService.prototype.callApiCompleteTask = function (id) {
        return this.apiService.getInstance().activiti.taskApi.completeTask(id);
    };
    ActivitiTaskListService.prototype.callApiCreateTask = function (task) {
        return this.apiService.getInstance().activiti.taskApi.createNewTask(task);
    };
    ActivitiTaskListService.prototype.handleError = function (error) {
        this.logService.error(error);
        return Rx_1.Observable.throw(error || 'Server error');
    };
    ActivitiTaskListService.prototype.getInvolvedTasksFilterInstance = function (appId) {
        return new filter_model_1.FilterRepresentationModel({
            'name': 'Involved Tasks',
            'appId': appId,
            'recent': false,
            'icon': 'glyphicon-align-left',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'open', 'assignment': 'involved' }
        });
    };
    ActivitiTaskListService.prototype.getMyTasksFilterInstance = function (appId) {
        return new filter_model_1.FilterRepresentationModel({
            'name': 'My Tasks',
            'appId': appId,
            'recent': false,
            'icon': 'glyphicon-inbox',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'open', 'assignment': 'assignee' }
        });
    };
    ActivitiTaskListService.prototype.getQueuedTasksFilterInstance = function (appId) {
        return new filter_model_1.FilterRepresentationModel({
            'name': 'Queued Tasks',
            'appId': appId,
            'recent': false,
            'icon': 'glyphicon-record',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'open', 'assignment': 'candidate' }
        });
    };
    ActivitiTaskListService.prototype.getCompletedTasksFilterInstance = function (appId) {
        return new filter_model_1.FilterRepresentationModel({
            'name': 'Completed Tasks',
            'appId': appId,
            'recent': true,
            'icon': 'glyphicon-ok-sign',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'completed', 'assignment': 'involved' }
        });
    };
    return ActivitiTaskListService;
}());
ActivitiTaskListService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [ng2_alfresco_core_1.AlfrescoApiService,
        ng2_alfresco_core_1.LogService])
], ActivitiTaskListService);
exports.ActivitiTaskListService = ActivitiTaskListService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL2FjdGl2aXRpLXRhc2tsaXN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7OztHQWVHOzs7Ozs7Ozs7OztBQUVILHNDQUEyQztBQUMzQyw4QkFBcUM7QUFDckMsdURBQW1FO0FBQ25FLHVEQUF3RztBQUN4Ryx5REFBa0Q7QUFDbEQsbURBQTRDO0FBQzVDLG1FQUFnRTtBQUNoRSxtREFBNEM7QUFHNUMsSUFBYSx1QkFBdUI7SUFFaEMsaUNBQW9CLFVBQThCLEVBQzlCLFVBQXNCO1FBRHRCLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQzlCLGVBQVUsR0FBVixVQUFVLENBQVk7SUFDMUMsQ0FBQztJQU1ELHlEQUF1QixHQUF2QixVQUF3QixJQUFhO1FBQXJDLGlCQVNDO1FBUkcsTUFBTSxDQUFDLGVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUM7YUFDNUYsR0FBRyxDQUFDLFVBQUMsUUFBYTtZQUNmLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQ1AsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLElBQUksS0FBSyxJQUFJLEVBQWYsQ0FBZSxDQUFDLENBQUM7WUFDcEQsQ0FBQztZQUNELE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ3pCLENBQUMsQ0FBQzthQUNELEtBQUssQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQXJCLENBQXFCLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBTUQsb0RBQWtCLEdBQWxCLFVBQW1CLEtBQWM7UUFBakMsaUJBYUM7UUFaRyxNQUFNLENBQUMsZUFBVSxDQUFDLFdBQVcsQ0FBQyxJ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RSxtQkFBbUI7WUFDM0IsUUFBUSxFQUFFLEVBQUMsTUFBTSxFQUFFLGNBQWMsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBQztTQUNqRyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0wsOEJBQUM7QUFBRCxDQTlWQSxBQThWQyxJQUFBO0FBOVZZLHVCQUF1QjtJQURuQyxpQkFBVSxFQUFFO3FDQUd1QixzQ0FBa0I7UUFDbEIsOEJBQVU7R0FIakMsdUJBQXVCLENBOFZuQztBQTlWWSwwREFBdUIiLCJmaWxlIjoic2VydmljZXMvYWN0aXZpdGktdGFza2xpc3Quc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE2IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzL1J4JztcbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSwgTG9nU2VydmljZSB9IGZyb20gJ25nMi1hbGZyZXNjby1jb3JlJztcbmltcG9ydCB7IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwsIFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2ZpbHRlci5tb2RlbCc7XG5pbXBvcnQgeyBDb21tZW50IH0gZnJvbSAnLi4vbW9kZWxzL2NvbW1lbnQubW9kZWwnO1xuaW1wb3J0IHsgVXNlciB9IGZyb20gJy4uL21vZGVscy91c2VyLm1vZGVsJztcbmltcG9ydCB7IFRhc2tEZXRhaWxzTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvdGFzay1kZXRhaWxzLm1vZGVsJztcbmltcG9ydCB7IEZvcm0gfSBmcm9tICcuLi9tb2RlbHMvZm9ybS5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBY3Rpdml0aVRhc2tMaXN0U2VydmljZSB7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXRyaXZlIGFsbCB0aGUgRGVwbG95ZWQgYXBwXG4gICAgICogQHJldHVybnMge09ic2VydmFibGU8YW55Pn1cbiAgICAgKi9cbiAgICBnZXREZXBsb3llZEFwcGxpY2F0aW9ucyhuYW1lPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkuYXBwc0FwaS5nZXRBcHBEZWZpbml0aW9ucygpKVxuICAgICAgICAgICAgLm1hcCgocmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChuYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhLmZpbmQocCA9PiBwLm5hbWUgPT09IG5hbWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0cml2ZSBhbGwgdGhlIFRhc2tzIGZpbHRlcnNcbiAgICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxhbnk+fVxuICAgICAqL1xuICAgIGdldFRhc2tMaXN0RmlsdGVycyhhcHBJZD86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuY2FsbEFwaVRhc2tGaWx0ZXJzKGFwcElkKSlcbiAgICAgICAgICAgIC5tYXAoKHJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgZmlsdGVyczogRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbFtdID0gW107XG4gICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5mb3JFYWNoKChmaWx0ZXI6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbHRlck1vZGVsID0gbmV3IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwoZmlsdGVyKTtcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVycy5wdXNoKGZpbHRlck1vZGVsKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UgJiYgcmVzcG9uc2UuZGF0YSAmJiByZXNwb25zZS5kYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVEZWZhdWx0RmlsdGVyKGFwcElkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlcnM7XG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXRyaXZlIGFsbCB0aGUgdGFza3MgZmlsdGVyZWQgYnkgZmlsdGVyTW9kZWxcbiAgICAgKiBAcGFyYW0gZmlsdGVyIC0gVGFza0ZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWxcbiAgICAgKiBAcmV0dXJucyB7YW55fVxuICAgICAqL1xuICAgIGdldFRhc2tzKHJlcXVlc3ROb2RlOiBUYXNrUXVlcnlSZXF1ZXN0UmVwcmVzZW50YXRpb25Nb2RlbCk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbFtdPiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuY2FsbEFwaVRhc2tzRmlsdGVyZWQocmVxdWVzdE5vZGUpKVxuICAgICAgICAgICAgLm1hcCgocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVxdWVzdE5vZGUucHJvY2Vzc0RlZmluaXRpb25LZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5kYXRhLmZpbHRlcihwID0+IHAucHJvY2Vzc0RlZmluaXRpb25LZXkgPT09IHJlcXVlc3ROb2RlLnByb2Nlc3NEZWZpbml0aW9uS2V5KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLmRhdGE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0cml2ZSBhbGwgdGhlIHRhc2sgZGV0YWlsc1xuICAgICAqIEBwYXJhbSBpZCAtIHRhc2tJZFxuICAgICAqIEByZXR1cm5zIHs8VGFza0RldGFpbHNNb2RlbD59XG4gICAgICovXG4gICAgZ2V0VGFza0RldGFpbHMoaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZSh0aGlzLmNhbGxBcGlUYXNrRGV0YWlscyhpZCkpXG4gICAgICAgICAgICAubWFwKHJlcyA9PiByZXMpXG4gICAgICAgICAgICAubWFwKChkZXRhaWxzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRhc2tEZXRhaWxzTW9kZWwoZGV0YWlscyk7XG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXRyaXZlIGFsbCB0aGUgdGFzaydzIGNvbW1lbnRzXG4gICAgICogQHBhcmFtIGlkIC0gdGFza0lkXG4gICAgICogQHJldHVybnMgezxDb21tZW50W10+fVxuICAgICAqL1xuICAgIGdldFRhc2tDb21tZW50cyhpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxDb21tZW50W10+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UodGhpcy5jYWxsQXBpVGFza0NvbW1lbnRzKGlkKSlcbiAgICAgICAgICAgIC5tYXAocmVzID0+IHJlcylcbiAgICAgICAgICAgIC5tYXAoKHJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgY29tbWVudHM6IENvbW1lbnRbXSA9IFtdO1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZm9yRWFjaCgoY29tbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgdXNlciA9IG5ldyBVc2VyKGNvbW1lbnQuY3JlYXRlZEJ5KTtcbiAgICAgICAgICAgICAgICAgICAgY29tbWVudHMucHVzaChuZXcgQ29tbWVudChjb21tZW50LmlkLCBjb21tZW50Lm1lc3NhZ2UsIGNvbW1lbnQuY3JlYXRlZCwgdXNlcikpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHJldHVybiBjb21tZW50cztcbiAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHJpdmUgYWxsIHRoZSB0YXNrJ3MgY2hlY2tsaXN0XG4gICAgICogQHBhcmFtIGlkIC0gdGFza0lkXG4gICAgICogQHJldHVybnMge1Rhc2tEZXRhaWxzTW9kZWx9XG4gICAgICovXG4gICAgZ2V0VGFza0NoZWNrbGlzdChpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc01vZGVsW10+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UodGhpcy5jYWxsQXBpVGFza0NoZWNrbGlzdChpZCkpXG4gICAgICAgICAgICAubWFwKHJlcyA9PiByZXMpXG4gICAgICAgICAgICAubWFwKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGNoZWNrbGlzdHM6IFRhc2tEZXRhaWxzTW9kZWxbXSA9IFtdO1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZm9yRWFjaCgoY2hlY2tsaXN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNoZWNrbGlzdHMucHVzaChuZXcgVGFza0RldGFpbHNNb2RlbChjaGVja2xpc3QpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gY2hlY2tsaXN0cztcbiAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHJpdmUgYWxsIHRoZSBmb3JtIHNoYXJlZCB3aXRoIHRoaXMgdXNlclxuICAgICAqIEByZXR1cm5zIHtUYXNrRGV0YWlsc01vZGVsfVxuICAgICAqL1xuICAgIGdldEZvcm1MaXN0KCk6IE9ic2VydmFibGU8Rm9ybSBbXT4ge1xuICAgICAgICBsZXQgb3B0cyA9IHtcbiAgICAgICAgICAgICdmaWx0ZXInOiAnbXlSZXVzYWJsZUZvcm1zJywgLy8gU3RyaW5nIHwgZmlsdGVyXG4gICAgICAgICAgICAnc29ydCc6ICdtb2RpZmllZERlc2MnLCAvLyBTdHJpbmcgfCBzb3J0XG4gICAgICAgICAgICAnbW9kZWxUeXBlJzogMiAvLyBJbnRlZ2VyIHwgbW9kZWxUeXBlXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkubW9kZWxzQXBpLmdldE1vZGVscyhvcHRzKSkubWFwKHJlcyA9PiByZXMpXG4gICAgICAgICAgICAubWFwKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGZvcm1zOiBGb3JtW10gPSBbXTtcbiAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZvckVhY2goKGZvcm0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZm9ybXMucHVzaChuZXcgRm9ybShmb3JtLmlkLCBmb3JtLm5hbWUpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZm9ybXM7XG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICB9XG5cbiAgICBhdHRhY2hGb3JtVG9BVGFzayh0YXNrSWQ6IHN0cmluZywgZm9ybUlkOiBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS50YXNrQXBpLmF0dGFjaEZvcm0odGFza0lkLCB7J2Zvcm1JZCc6IGZvcm1JZH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYW5kIHJldHVybiB0aGUgZGVmYXVsdCBmaWx0ZXJzXG4gICAgICogQHBhcmFtIGFwcElkXG4gICAgICogQHJldHVybnMge0ZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWxbXX1cbiAgICAgKi9cbiAgICBjcmVhdGVEZWZhdWx0RmlsdGVyKGFwcElkOiBzdHJpbmcpOiBGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsW10ge1xuICAgICAgICBsZXQgZmlsdGVyczogRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbFtdID0gW107XG5cbiAgICAgICAgbGV0IGludm9sdmVkVGFza3NGaWx0ZXIgPSB0aGlzLmdldEludm9sdmVkVGFza3NGaWx0ZXJJbnN0YW5jZShhcHBJZCk7XG4gICAgICAgIHRoaXMuYWRkRmlsdGVyKGludm9sdmVkVGFza3NGaWx0ZXIpO1xuICAgICAgICBmaWx0ZXJzLnB1c2goaW52b2x2ZWRUYXNrc0ZpbHRlcik7XG5cbiAgICAgICAgbGV0IG15VGFza3NGaWx0ZXIgPSB0aGlzLmdldE15VGFza3NGaWx0ZXJJbnN0YW5jZShhcHBJZCk7XG4gICAgICAgIHRoaXMuYWRkRmlsdGVyKG15VGFza3NGaWx0ZXIpO1xuICAgICAgICBmaWx0ZXJzLnB1c2gobXlUYXNrc0ZpbHRlcik7XG5cbiAgICAgICAgbGV0IHF1ZXVlZFRhc2tzRmlsdGVyID0gdGhpcy5nZXRRdWV1ZWRUYXNrc0ZpbHRlckluc3RhbmNlKGFwcElkKTtcbiAgICAgICAgdGhpcy5hZGRGaWx0ZXIocXVldWVkVGFza3NGaWx0ZXIpO1xuICAgICAgICBmaWx0ZXJzLnB1c2gocXVldWVkVGFza3NGaWx0ZXIpO1xuXG4gICAgICAgIGxldCBjb21wbGV0ZWRUYXNrc0ZpbHRlciA9IHRoaXMuZ2V0Q29tcGxldGVkVGFza3NGaWx0ZXJJbnN0YW5jZShhcHBJZCk7XG4gICAgICAgIHRoaXMuYWRkRmlsdGVyKGNvbXBsZXRlZFRhc2tzRmlsdGVyKTtcbiAgICAgICAgZmlsdGVycy5wdXNoKGNvbXBsZXRlZFRhc2tzRmlsdGVyKTtcblxuICAgICAgICByZXR1cm4gZmlsdGVycztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSB0YXNrXG4gICAgICogQHBhcmFtIHRhc2sgLSBUYXNrRGV0YWlsc01vZGVsXG4gICAgICogQHJldHVybnMge1Rhc2tEZXRhaWxzTW9kZWx9XG4gICAgICovXG4gICAgYWRkVGFzayh0YXNrOiBUYXNrRGV0YWlsc01vZGVsKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuY2FsbEFwaUFkZFRhc2sodGFzaykpXG4gICAgICAgICAgICAubWFwKHJlcyA9PiByZXMpXG4gICAgICAgICAgICAubWFwKChyZXNwb25zZTogVGFza0RldGFpbHNNb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGFza0RldGFpbHNNb2RlbChyZXNwb25zZSk7XG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBmaWx0ZXJcbiAgICAgKiBAcGFyYW0gZmlsdGVyIC0gRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbFxuICAgICAqIEByZXR1cm5zIHtGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsfVxuICAgICAqL1xuICAgIGFkZEZpbHRlcihmaWx0ZXI6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwpOiBPYnNlcnZhYmxlPEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UodGhpcy5jYWxsQXBpQWRkRmlsdGVyKGZpbHRlcikpXG4gICAgICAgICAgICAubWFwKHJlcyA9PiByZXMpXG4gICAgICAgICAgICAubWFwKChyZXNwb25zZTogRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGNvbW1lbnQgdG8gYSB0YXNrXG4gICAgICogQHBhcmFtIGlkIC0gdGFza0lkXG4gICAgICogQHBhcmFtIG1lc3NhZ2UgLSBjb250ZW50IG9mIHRoZSBjb21tZW50XG4gICAgICogQHJldHVybnMge0NvbW1lbnR9XG4gICAgICovXG4gICAgYWRkVGFza0NvbW1lbnQoaWQ6IHN0cmluZywgbWVzc2FnZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxDb21tZW50PiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuY2FsbEFwaUFkZFRhc2tDb21tZW50KGlkLCBtZXNzYWdlKSlcbiAgICAgICAgICAgIC5tYXAocmVzID0+IHJlcylcbiAgICAgICAgICAgIC5tYXAoKHJlc3BvbnNlOiBDb21tZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBDb21tZW50KHJlc3BvbnNlLmlkLCByZXNwb25zZS5tZXNzYWdlLCByZXNwb25zZS5jcmVhdGVkLCByZXNwb25zZS5jcmVhdGVkQnkpO1xuICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYWtlIHRoZSB0YXNrIGNvbXBsZXRlZFxuICAgICAqIEBwYXJhbSBpZCAtIHRhc2tJZFxuICAgICAqIEByZXR1cm5zIHtUYXNrRGV0YWlsc01vZGVsfVxuICAgICAqL1xuICAgIGNvbXBsZXRlVGFzayhpZDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuY2FsbEFwaUNvbXBsZXRlVGFzayhpZCkpXG4gICAgICAgICAgICAubWFwKHJlcyA9PiByZXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiB0aGUgdG90YWwgbnVtYmVyIG9mIHRoZSB0YXNrcyBieSBmaWx0ZXJcbiAgICAgKiBAcGFyYW0gcmVxdWVzdE5vZGUgLSBUYXNrRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbFxuICAgICAqIEByZXR1cm5zIHthbnl9XG4gICAgICovXG4gICAgcHVibGljIGdldFRvdGFsVGFza3MocmVxdWVzdE5vZGU6IFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmVxdWVzdE5vZGUuc2l6ZSA9IDA7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuY2FsbEFwaVRhc2tzRmlsdGVyZWQocmVxdWVzdE5vZGUpKVxuICAgICAgICAgICAgLm1hcCgocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IHN0YW5kYWxvbmUgdGFza1xuICAgICAqIEBwYXJhbSB0YXNrIC0gVGFza0RldGFpbHNNb2RlbFxuICAgICAqIEByZXR1cm5zIHtUYXNrRGV0YWlsc01vZGVsfVxuICAgICAqL1xuICAgIGNyZWF0ZU5ld1Rhc2sodGFzazogVGFza0RldGFpbHNNb2RlbCk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZSh0aGlzLmNhbGxBcGlDcmVhdGVUYXNrKHRhc2spKVxuICAgICAgICAgICAgLm1hcChyZXMgPT4gcmVzKVxuICAgICAgICAgICAgLm1hcCgocmVzcG9uc2U6IFRhc2tEZXRhaWxzTW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRhc2tEZXRhaWxzTW9kZWwocmVzcG9uc2UpO1xuICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xhaW0gYSB0YXNrXG4gICAgICogQHBhcmFtIGlkIC0gdGFza0lkXG4gICAgICovXG4gICAgY2xhaW1UYXNrKHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tBcGkuY2xhaW1UYXNrKHRhc2tJZCkpXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpVGFza3NGaWx0ZXJlZChyZXF1ZXN0Tm9kZTogVGFza1F1ZXJ5UmVxdWVzdFJlcHJlc2VudGF0aW9uTW9kZWwpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tBcGkubGlzdFRhc2tzKHJlcXVlc3ROb2RlKTtcbiAgICB9XG5cbiAgICBjYWxsQXBpVGFza0ZpbHRlcnMoYXBwSWQ/OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGFwcElkKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkudXNlckZpbHRlcnNBcGkuZ2V0VXNlclRhc2tGaWx0ZXJzKHthcHBJZDogYXBwSWR9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS51c2VyRmlsdGVyc0FwaS5nZXRVc2VyVGFza0ZpbHRlcnMoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaVRhc2tEZXRhaWxzKGlkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tBcGkuZ2V0VGFzayhpZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpVGFza0NvbW1lbnRzKGlkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tBcGkuZ2V0VGFza0NvbW1lbnRzKGlkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGxBcGlBZGRUYXNrQ29tbWVudChpZDogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tBcGkuYWRkVGFza0NvbW1lbnQoe21lc3NhZ2U6IG1lc3NhZ2V9LCBpZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpQWRkVGFzayh0YXNrOiBUYXNrRGV0YWlsc01vZGVsKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS50YXNrQXBpLmFkZFN1YnRhc2sodGFzay5wYXJlbnRUYXNrSWQsIHRhc2spO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaUFkZEZpbHRlcihmaWx0ZXI6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnVzZXJGaWx0ZXJzQXBpLmNyZWF0ZVVzZXJUYXNrRmlsdGVyKGZpbHRlcik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpVGFza0NoZWNrbGlzdChpZDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS50YXNrQXBpLmdldENoZWNrbGlzdChpZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpQ29tcGxldGVUYXNrKGlkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tBcGkuY29tcGxldGVUYXNrKGlkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGxBcGlDcmVhdGVUYXNrKHRhc2s6IFRhc2tEZXRhaWxzTW9kZWwpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tBcGkuY3JlYXRlTmV3VGFzayh0YXNrKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZUVycm9yKGVycm9yOiBhbnkpIHtcbiAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVycm9yKTtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUudGhyb3coZXJyb3IgfHwgJ1NlcnZlciBlcnJvcicpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBhIHN0YXRpYyBJbnZvbHZlZCBmaWx0ZXIgaW5zdGFuY2VcbiAgICAgKiBAcGFyYW0gYXBwSWRcbiAgICAgKiBAcmV0dXJucyB7RmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbH1cbiAgICAgKi9cbiAgICBnZXRJbnZvbHZlZFRhc2tzRmlsdGVySW5zdGFuY2UoYXBwSWQ6IHN0cmluZyk6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwge1xuICAgICAgICByZXR1cm4gbmV3IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwoe1xuICAgICAgICAgICAgJ25hbWUnOiAnSW52b2x2ZWQgVGFza3MnLFxuICAgICAgICAgICAgJ2FwcElkJzogYXBwSWQsXG4gICAgICAgICAgICAncmVjZW50JzogZmFsc2UsXG4gICAgICAgICAgICAnaWNvbic6ICdnbHlwaGljb24tYWxpZ24tbGVmdCcsXG4gICAgICAgICAgICAnZmlsdGVyJzogeydzb3J0JzogJ2NyZWF0ZWQtZGVzYycsICduYW1lJzogJycsICdzdGF0ZSc6ICdvcGVuJywgJ2Fzc2lnbm1lbnQnOiAnaW52b2x2ZWQnfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gYSBzdGF0aWMgTXkgdGFzayBmaWx0ZXIgaW5zdGFuY2VcbiAgICAgKiBAcGFyYW0gYXBwSWRcbiAgICAgKiBAcmV0dXJucyB7RmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbH1cbiAgICAgKi9cbiAgICBnZXRNeVRhc2tzRmlsdGVySW5zdGFuY2UoYXBwSWQ6IHN0cmluZyk6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwge1xuICAgICAgICByZXR1cm4gbmV3IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwoe1xuICAgICAgICAgICAgJ25hbWUnOiAnTXkgVGFza3MnLFxuICAgICAgICAgICAgJ2FwcElkJzogYXBwSWQsXG4gICAgICAgICAgICAncmVjZW50JzogZmFsc2UsXG4gICAgICAgICAgICAnaWNvbic6ICdnbHlwaGljb24taW5ib3gnLFxuICAgICAgICAgICAgJ2ZpbHRlcic6IHsnc29ydCc6ICdjcmVhdGVkLWRlc2MnLCAnbmFtZSc6ICcnLCAnc3RhdGUnOiAnb3BlbicsICdhc3NpZ25tZW50JzogJ2Fzc2lnbmVlJ31cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIGEgc3RhdGljIFF1ZXVlZCBmaWx0ZXIgaW5zdGFuY2VcbiAgICAgKiBAcGFyYW0gYXBwSWRcbiAgICAgKiBAcmV0dXJucyB7RmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbH1cbiAgICAgKi9cbiAgICBnZXRRdWV1ZWRUYXNrc0ZpbHRlckluc3RhbmNlKGFwcElkOiBzdHJpbmcpOiBGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsIHtcbiAgICAgICAgcmV0dXJuIG5ldyBGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsKHtcbiAgICAgICAgICAgICduYW1lJzogJ1F1ZXVlZCBUYXNrcycsXG4gICAgICAgICAgICAnYXBwSWQnOiBhcHBJZCxcbiAgICAgICAgICAgICdyZWNlbnQnOiBmYWxzZSxcbiAgICAgICAgICAgICdpY29uJzogJ2dseXBoaWNvbi1yZWNvcmQnLFxuICAgICAgICAgICAgJ2ZpbHRlcic6IHsnc29ydCc6ICdjcmVhdGVkLWRlc2MnLCAnbmFtZSc6ICcnLCAnc3RhdGUnOiAnb3BlbicsICdhc3NpZ25tZW50JzogJ2NhbmRpZGF0ZSd9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBhIHN0YXRpYyBDb21wbGV0ZWQgZmlsdGVyIGluc3RhbmNlXG4gICAgICogQHBhcmFtIGFwcElkXG4gICAgICogQHJldHVybnMge0ZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWx9XG4gICAgICovXG4gICAgZ2V0Q29tcGxldGVkVGFza3NGaWx0ZXJJbnN0YW5jZShhcHBJZDogc3RyaW5nKTogRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbCB7XG4gICAgICAgIHJldHVybiBuZXcgRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbCh7XG4gICAgICAgICAgICAnbmFtZSc6ICdDb21wbGV0ZWQgVGFza3MnLFxuICAgICAgICAgICAgJ2FwcElkJzogYXBwSWQsXG4gICAgICAgICAgICAncmVjZW50JzogdHJ1ZSxcbiAgICAgICAgICAgICdpY29uJzogJ2dseXBoaWNvbi1vay1zaWduJyxcbiAgICAgICAgICAgICdmaWx0ZXInOiB7J3NvcnQnOiAnY3JlYXRlZC1kZXNjJywgJ25hbWUnOiAnJywgJ3N0YXRlJzogJ2NvbXBsZXRlZCcsICdhc3NpZ25tZW50JzogJ2ludm9sdmVkJ31cbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19
