/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var ng2_alfresco_datatable_1 = require("ng2-alfresco-datatable");
var activiti_tasklist_service_1 = require("./../services/activiti-tasklist.service");
var filter_model_1 = require("../models/filter.model");
var ActivitiTaskList = (function () {
    function ActivitiTaskList(translateService, taskListService, logService) {
        this.translateService = translateService;
        this.taskListService = taskListService;
        this.logService = logService;
        this.rowClick = new core_1.EventEmitter();
        this.onSuccess = new core_1.EventEmitter();
        this.onError = new core_1.EventEmitter();
        this.defaultSchemaColumn = [
            { type: 'text', key: 'id', title: 'Id' },
            { type: 'text', key: 'name', title: 'Name', cssClass: 'full-width name-column', sortable: true },
            { type: 'text', key: 'formKey', title: 'Form Key', sortable: true },
            { type: 'text', key: 'created', title: 'Created', sortable: true }
        ];
        if (translateService) {
            translateService.addTranslationFolder('ng2-activiti-tasklist', 'node_modules/ng2-activiti-tasklist/src');
        }
    }
    ActivitiTaskList.prototype.ngOnInit = function () {
        if (!this.data) {
            this.data = this.initDefaultSchemaColumns();
        }
    };
    ActivitiTaskList.prototype.ngOnChanges = function (changes) {
        if (this.isPropertyChanged(changes)) {
            this.reload();
        }
    };
    ActivitiTaskList.prototype.isPropertyChanged = function (changes) {
        var changed = false;
        var appId = changes['appId'];
        var processDefinitionKey = changes['processDefinitionKey'];
        var state = changes['state'];
        var sort = changes['sort'];
        var name = changes['name'];
        var assignment = changes['assignment'];
        if (appId && appId.currentValue) {
            changed = true;
        }
        else if (processDefinitionKey && processDefinitionKey.currentValue) {
            changed = true;
        }
        else if (state && state.currentValue) {
            changed = true;
        }
        else if (sort && sort.currentValue) {
            changed = true;
        }
        else if (name && name.currentValue) {
            changed = true;
        }
        else if (assignment && assignment.currentValue) {
            changed = true;
        }
        return changed;
    };
    ActivitiTaskList.prototype.reload = function () {
        this.requestNode = this.createRequestNode();
        this.load(this.requestNode);
    };
    ActivitiTaskList.prototype.initDefaultSchemaColumns = function () {
        return new ng2_alfresco_datatable_1.ObjectDataTableAdapter([], this.defaultSchemaColumn);
    };
    ActivitiTaskList.prototype.load = function (requestNode) {
        var _this = this;
        this.taskListService.getTotalTasks(requestNode).subscribe(function (res) {
            requestNode.size = res.total;
            _this.taskListService.getTasks(requestNode).subscribe(function (response) {
                var instancesRow = _this.createDataRow(response);
                _this.renderInstances(instancesRow);
                _this.selectTask(requestNode.landingTaskId);
                _this.onSuccess.emit(response);
            }, function (error) {
                _this.logService.error(error);
                _this.onError.emit(error);
            });
        }, function (err) {
            _this.logService.error(err);
            _this.onError.emit(err);
        });
    };
    ActivitiTaskList.prototype.createDataRow = function (instances) {
        var instancesRows = [];
        instances.forEach(function (row) {
            instancesRows.push(new ng2_alfresco_datatable_1.ObjectDataRow({
                id: row.id,
                name: row.name,
                created: row.created
            }));
        });
        return instancesRows;
    };
    ActivitiTaskList.prototype.renderInstances = function (instances) {
        instances = this.optimizeNames(instances);
        this.data.setRows(instances);
    };
    ActivitiTaskList.prototype.selectTask = function (taskIdToSelect) {
        if (!this.isListEmpty()) {
            var rows = this.data.getRows();
            if (rows.length > 0) {
                var dataRow = rows.find(function (row) { return row.getValue('id') === taskIdToSelect; }) || rows[0];
                this.data.selectedRow = dataRow;
                this.currentInstanceId = dataRow.getValue('id');
            }
        }
        else {
            if (this.data) {
                this.data.selectedRow = null;
            }
            this.currentInstanceId = null;
        }
    };
    ActivitiTaskList.prototype.getCurrentId = function () {
        return this.currentInstanceId;
    };
    ActivitiTaskList.prototype.isListEmpty = function () {
        return this.data === undefined ||
            (this.data && this.data.getRows() && this.data.getRows().length === 0);
    };
    ActivitiTaskList.prototype.onRowClick = function (event) {
        var item = event;
        this.currentInstanceId = item.value.getValue('id');
        this.rowClick.emit(this.currentInstanceId);
    };
    ActivitiTaskList.prototype.optimizeNames = function (istances) {
        istances = istances.map(function (t) {
            t.obj.name = t.obj.name || 'No name';
            return t;
        });
        return istances;
    };
    ActivitiTaskList.prototype.createRequestNode = function () {
        var requestNode = {
            appDefinitionId: this.appId,
            processDefinitionKey: this.processDefinitionKey,
            text: this.name,
            assignment: this.assignment,
            state: this.state,
            sort: this.sort,
            landingTaskId: this.landingTaskId
        };
        return new filter_model_1.TaskQueryRequestRepresentationModel(requestNode);
    };
    return ActivitiTaskList;
}());
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiTaskList.prototype, "appId", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiTaskList.prototype, "processDefinitionKey", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiTaskList.prototype, "state", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiTaskList.prototype, "assignment", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiTaskList.prototype, "sort", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiTaskList.prototype, "name", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiTaskList.prototype, "landingTaskId", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", Object)
], ActivitiTaskList.prototype, "data", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], ActivitiTaskList.prototype, "rowClick", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], ActivitiTaskList.prototype, "onSuccess", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], ActivitiTaskList.prototype, "onError", void 0);
ActivitiTaskList = __decorate([
    core_1.Component({
        selector: 'activiti-tasklist',
        moduleId: module.id,
        template: "<div *ngIf=\"!requestNode\">{{ 'TASK_FILTERS.MESSAGES.NONE' | translate }}</div> <div *ngIf=\"requestNode\">     <div *ngIf=\"!isListEmpty()\">         <alfresco-datatable             [data]=\"data\"             (rowClick)=\"onRowClick($event)\">         </alfresco-datatable>     </div>     <div *ngIf=\"isListEmpty()\">         {{ 'TASK_LIST.MESSAGES.NONE' | translate }}     </div> </div>",
        styles: ["alfresco-datatable >>> .column-header {     color: #232323;     font-size: 15px; }  alfresco-datatable >>> .data-cell {     cursor: pointer !important; }  alfresco-datatable >>> .cell-value{     width: 250px;     white-space: nowrap;     overflow: hidden;     text-overflow: ellipsis }"]
    }),
    __metadata("design:paramtypes", [ng2_alfresco_core_1.AlfrescoTranslationService,
        activiti_tasklist_service_1.ActivitiTaskListService,
        ng2_alfresco_core_1.LogService])
], ActivitiTaskList);
exports.ActivitiTaskList = ActivitiTaskList;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYWN0aXZpdGktdGFza2xpc3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRzs7Ozs7Ozs7Ozs7QUFFSCxzQ0FBeUc7QUFDekcsdURBQTJFO0FBQzNFLGlFQUErRztBQUMvRyxxRkFBa0Y7QUFDbEYsdURBQTZFO0FBVTdFLElBQWEsZ0JBQWdCO0lBOEN6QiwwQkFBb0IsZ0JBQTRDLEVBQzVDLGVBQXdDLEVBQ3hDLFVBQXNCO1FBRnRCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBNEI7UUFDNUMsb0JBQWUsR0FBZixlQUFlLENBQXlCO1FBQ3hDLGVBQVUsR0FBVixVQUFVLENBQVk7UUFuQjFDLGFBQVEsR0FBeUIsSUFBSSxtQkFBWSxFQUFVLENBQUM7UUFHNUQsY0FBUyxHQUFzQixJQUFJLG1CQUFZLEVBQU8sQ0FBQztRQUd2RCxZQUFPLEdBQXNCLElBQUksbUJBQVksRUFBTyxDQUFDO1FBSTdDLHdCQUFtQixHQUFVO1lBQ2pDLEVBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUM7WUFDdEMsRUFBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsd0JBQXdCLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBQztZQUM5RixFQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUM7WUFDakUsRUFBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFDO1NBQ25FLENBQUM7UUFLRSxFQUFFLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7WUFDbkIsZ0JB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LENBbE9BLEFBa09DLElBQUE7QUEvTkc7SUFEQyxZQUFLLEVBQUU7OytDQUNNO0FBR2Q7SUFEQyxZQUFLLEVBQUU7OzhEQUNxQjtBQUc3QjtJQURDLFlBQUssRUFBRTs7K0NBQ007QUFHZDtJQURDLFlBQUssRUFBRTs7b0RBQ1c7QUFHbkI7SUFEQyxZQUFLLEVBQUU7OzhDQUNLO0FBR2I7SUFEQyxZQUFLLEVBQUU7OzhDQUNLO0FBR2I7SUFEQyxZQUFLLEVBQUU7O3VEQUNjO0FBS3RCO0lBREMsWUFBSyxFQUFFOzs4Q0FDZTtBQUd2QjtJQURDLGFBQU0sRUFBRTs4QkFDQyxtQkFBWTtrREFBc0M7QUFHNUQ7SUFEQyxhQUFNLEVBQUU7OEJBQ0UsbUJBQVk7bURBQWdDO0FBR3ZEO0lBREMsYUFBTSxFQUFFOzhCQUNBLG1CQUFZO2lEQUFnQztBQW5DNUMsZ0JBQWdCO0lBTjVCLGdCQUFTLENBQUM7UUFDUCxRQUFRLEVBQUUsbUJBQW1CO1FBQzdCLFFBQVEsRUFBRSxNQUFNLENBQUMsRUFBRTtRQUNuQixRQUFRLEVBQUUseVlBQXlZO1FBQ25aLE1BQU0sRUFBRSxDQUFDLCtSQUErUixDQUFDO0tBQzVTLENBQUM7cUNBK0N3Qyw4Q0FBMEI7UUFDM0IsbURBQXVCO1FBQzVCLDhCQUFVO0dBaERqQyxnQkFBZ0IsQ0FrTzVCO0FBbE9ZLDRDQUFnQiIsImZpbGUiOiJjb21wb25lbnRzL2FjdGl2aXRpLXRhc2tsaXN0LmNvbXBvbmVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE2IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBPbkluaXQsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWxmcmVzY29UcmFuc2xhdGlvblNlcnZpY2UsIExvZ1NlcnZpY2UgfSBmcm9tICduZzItYWxmcmVzY28tY29yZSc7XG5pbXBvcnQgeyBPYmplY3REYXRhVGFibGVBZGFwdGVyLCBEYXRhVGFibGVBZGFwdGVyLCBEYXRhUm93RXZlbnQsIE9iamVjdERhdGFSb3cgfSBmcm9tICduZzItYWxmcmVzY28tZGF0YXRhYmxlJztcbmltcG9ydCB7IEFjdGl2aXRpVGFza0xpc3RTZXJ2aWNlIH0gZnJvbSAnLi8uLi9zZXJ2aWNlcy9hY3Rpdml0aS10YXNrbGlzdC5zZXJ2aWNlJztcbmltcG9ydCB7IFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2ZpbHRlci5tb2RlbCc7XG5cbmRlY2xhcmUgbGV0IGNvbXBvbmVudEhhbmRsZXI6IGFueTtcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhY3Rpdml0aS10YXNrbGlzdCcsXG4gICAgbW9kdWxlSWQ6IG1vZHVsZS5pZCxcbiAgICB0ZW1wbGF0ZTogXCI8ZGl2ICpuZ0lmPVxcXCIhcmVxdWVzdE5vZGVcXFwiPnt7ICdUQVNLX0ZJTFRFUlMuTUVTU0FHRVMuTk9ORScgfCB0cmFuc2xhdGUgfX08L2Rpdj4gPGRpdiAqbmdJZj1cXFwicmVxdWVzdE5vZGVcXFwiPiAgICAgPGRpdiAqbmdJZj1cXFwiIWlzTGlzdEVtcHR5KClcXFwiPiAgICAgICAgIDxhbGZyZXNjby1kYXRhdGFibGUgICAgICAgICAgICAgW2RhdGFdPVxcXCJkYXRhXFxcIiAgICAgICAgICAgICAocm93Q2xpY2spPVxcXCJvblJvd0NsaWNrKCRldmVudClcXFwiPiAgICAgICAgIDwvYWxmcmVzY28tZGF0YXRhYmxlPiAgICAgPC9kaXY+ICAgICA8ZGl2ICpuZ0lmPVxcXCJpc0xpc3RFbXB0eSgpXFxcIj4gICAgICAgICB7eyAnVEFTS19MSVNULk1FU1NBR0VTLk5PTkUnIHwgdHJhbnNsYXRlIH19ICAgICA8L2Rpdj4gPC9kaXY+XCIsXG4gICAgc3R5bGVzOiBbXCJhbGZyZXNjby1kYXRhdGFibGUgPj4+IC5jb2x1bW4taGVhZGVyIHsgICAgIGNvbG9yOiAjMjMyMzIzOyAgICAgZm9udC1zaXplOiAxNXB4OyB9ICBhbGZyZXNjby1kYXRhdGFibGUgPj4+IC5kYXRhLWNlbGwgeyAgICAgY3Vyc29yOiBwb2ludGVyICFpbXBvcnRhbnQ7IH0gIGFsZnJlc2NvLWRhdGF0YWJsZSA+Pj4gLmNlbGwtdmFsdWV7ICAgICB3aWR0aDogMjUwcHg7ICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOyAgICAgb3ZlcmZsb3c6IGhpZGRlbjsgICAgIHRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzIH1cIl1cbn0pXG5leHBvcnQgY2xhc3MgQWN0aXZpdGlUYXNrTGlzdCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcblxuICAgIEBJbnB1dCgpXG4gICAgYXBwSWQ6IHN0cmluZztcblxuICAgIEBJbnB1dCgpXG4gICAgcHJvY2Vzc0RlZmluaXRpb25LZXk6IHN0cmluZztcblxuICAgIEBJbnB1dCgpXG4gICAgc3RhdGU6IHN0cmluZztcblxuICAgIEBJbnB1dCgpXG4gICAgYXNzaWdubWVudDogc3RyaW5nO1xuXG4gICAgQElucHV0KClcbiAgICBzb3J0OiBzdHJpbmc7XG5cbiAgICBASW5wdXQoKVxuICAgIG5hbWU6IHN0cmluZztcblxuICAgIEBJbnB1dCgpXG4gICAgbGFuZGluZ1Rhc2tJZDogc3RyaW5nO1xuXG4gICAgcmVxdWVzdE5vZGU6IFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsO1xuXG4gICAgQElucHV0KClcbiAgICBkYXRhOiBEYXRhVGFibGVBZGFwdGVyO1xuXG4gICAgQE91dHB1dCgpXG4gICAgcm93Q2xpY2s6IEV2ZW50RW1pdHRlcjxzdHJpbmc+ID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG5cbiAgICBAT3V0cHV0KClcbiAgICBvblN1Y2Nlc3M6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgICBAT3V0cHV0KClcbiAgICBvbkVycm9yOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gICAgY3VycmVudEluc3RhbmNlSWQ6IHN0cmluZztcblxuICAgIHByaXZhdGUgZGVmYXVsdFNjaGVtYUNvbHVtbjogYW55W10gPSBbXG4gICAgICAgIHt0eXBlOiAndGV4dCcsIGtleTogJ2lkJywgdGl0bGU6ICdJZCd9LFxuICAgICAgICB7dHlwZTogJ3RleHQnLCBrZXk6ICduYW1lJywgdGl0bGU6ICdOYW1lJywgY3NzQ2xhc3M6ICdmdWxsLXdpZHRoIG5hbWUtY29sdW1uJywgc29ydGFibGU6IHRydWV9LFxuICAgICAgICB7dHlwZTogJ3RleHQnLCBrZXk6ICdmb3JtS2V5JywgdGl0bGU6ICdGb3JtIEtleScsIHNvcnRhYmxlOiB0cnVlfSxcbiAgICAgICAge3R5cGU6ICd0ZXh0Jywga2V5OiAnY3JlYXRlZCcsIHRpdGxlOiAnQ3JlYXRlZCcsIHNvcnRhYmxlOiB0cnVlfVxuICAgIF07XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IEFsZnJlc2NvVHJhbnNsYXRpb25TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdGFza0xpc3RTZXJ2aWNlOiBBY3Rpdml0aVRhc2tMaXN0U2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UpIHtcbiAgICAgICAgaWYgKHRyYW5zbGF0ZVNlcnZpY2UpIHtcbiAgICAgICAgICAgIHRyYW5zbGF0ZVNlcnZpY2UuYWRkVHJhbnNsYXRpb25Gb2xkZXIoJ25nMi1hY3Rpdml0aS10YXNrbGlzdCcsICdub2RlX21vZHVsZXMvbmcyLWFjdGl2aXRpLXRhc2tsaXN0L3NyYycpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIGlmICghdGhpcy5kYXRhKSB7XG4gICAgICAgICAgICB0aGlzLmRhdGEgPSB0aGlzLmluaXREZWZhdWx0U2NoZW1hQ29sdW1ucygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgICAgICBpZiAodGhpcy5pc1Byb3BlcnR5Q2hhbmdlZChjaGFuZ2VzKSkge1xuICAgICAgICAgICAgdGhpcy5yZWxvYWQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaXNQcm9wZXJ0eUNoYW5nZWQoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IGJvb2xlYW4ge1xuICAgICAgICBsZXQgY2hhbmdlZDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgICAgIGxldCBhcHBJZCA9IGNoYW5nZXNbJ2FwcElkJ107XG4gICAgICAgIGxldCBwcm9jZXNzRGVmaW5pdGlvbktleSA9IGNoYW5nZXNbJ3Byb2Nlc3NEZWZpbml0aW9uS2V5J107XG4gICAgICAgIGxldCBzdGF0ZSA9IGNoYW5nZXNbJ3N0YXRlJ107XG4gICAgICAgIGxldCBzb3J0ID0gY2hhbmdlc1snc29ydCddO1xuICAgICAgICBsZXQgbmFtZSA9IGNoYW5nZXNbJ25hbWUnXTtcbiAgICAgICAgbGV0IGFzc2lnbm1lbnQgPSBjaGFuZ2VzWydhc3NpZ25tZW50J107XG5cbiAgICAgICAgaWYgKGFwcElkICYmIGFwcElkLmN1cnJlbnRWYWx1ZSkge1xuICAgICAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAocHJvY2Vzc0RlZmluaXRpb25LZXkgJiYgcHJvY2Vzc0RlZmluaXRpb25LZXkuY3VycmVudFZhbHVlKSB7XG4gICAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSAmJiBzdGF0ZS5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKHNvcnQgJiYgc29ydC5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKG5hbWUgJiYgbmFtZS5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKGFzc2lnbm1lbnQgJiYgYXNzaWdubWVudC5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjaGFuZ2VkO1xuICAgIH1cblxuICAgIHB1YmxpYyByZWxvYWQoKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdE5vZGUgPSB0aGlzLmNyZWF0ZVJlcXVlc3ROb2RlKCk7XG4gICAgICAgIHRoaXMubG9hZCh0aGlzLnJlcXVlc3ROb2RlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gYW4gaW5pdERlZmF1bHRTY2hlbWFDb2x1bW5zIGluc3RhbmNlIHdpdGggdGhlIGRlZmF1bHQgU2NoZW1hIENvbHVtblxuICAgICAqIEByZXR1cm5zIHtPYmplY3REYXRhVGFibGVBZGFwdGVyfVxuICAgICAqL1xuICAgIGluaXREZWZhdWx0U2NoZW1hQ29sdW1ucygpOiBPYmplY3REYXRhVGFibGVBZGFwdGVyIHtcbiAgICAgICAgcmV0dXJuIG5ldyBPYmplY3REYXRhVGFibGVBZGFwdGVyKFxuICAgICAgICAgICAgW10sXG4gICAgICAgICAgICB0aGlzLmRlZmF1bHRTY2hlbWFDb2x1bW5cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGxvYWQocmVxdWVzdE5vZGU6IFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsKSB7XG4gICAgICAgIHRoaXMudGFza0xpc3RTZXJ2aWNlLmdldFRvdGFsVGFza3MocmVxdWVzdE5vZGUpLnN1YnNjcmliZShcbiAgICAgICAgICAgIChyZXMpID0+IHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0Tm9kZS5zaXplID0gcmVzLnRvdGFsO1xuICAgICAgICAgICAgICAgIHRoaXMudGFza0xpc3RTZXJ2aWNlLmdldFRhc2tzKHJlcXVlc3ROb2RlKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgICAgIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGluc3RhbmNlc1JvdyA9IHRoaXMuY3JlYXRlRGF0YVJvdyhyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckluc3RhbmNlcyhpbnN0YW5jZXNSb3cpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RUYXNrKHJlcXVlc3ROb2RlLmxhbmRpbmdUYXNrSWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vblN1Y2Nlc3MuZW1pdChyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25FcnJvci5lbWl0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkVycm9yLmVtaXQoZXJyKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhbiBhcnJheSBvZiBPYmplY3REYXRhUm93XG4gICAgICogQHBhcmFtIGluc3RhbmNlc1xuICAgICAqIEByZXR1cm5zIHtPYmplY3REYXRhUm93W119XG4gICAgICovXG4gICAgcHJpdmF0ZSBjcmVhdGVEYXRhUm93KGluc3RhbmNlczogYW55W10pOiBPYmplY3REYXRhUm93W10ge1xuICAgICAgICBsZXQgaW5zdGFuY2VzUm93czogT2JqZWN0RGF0YVJvd1tdID0gW107XG4gICAgICAgIGluc3RhbmNlcy5mb3JFYWNoKChyb3cpID0+IHtcbiAgICAgICAgICAgIGluc3RhbmNlc1Jvd3MucHVzaChuZXcgT2JqZWN0RGF0YVJvdyh7XG4gICAgICAgICAgICAgICAgaWQ6IHJvdy5pZCxcbiAgICAgICAgICAgICAgICBuYW1lOiByb3cubmFtZSxcbiAgICAgICAgICAgICAgICBjcmVhdGVkOiByb3cuY3JlYXRlZFxuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGluc3RhbmNlc1Jvd3M7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVuZGVyIHRoZSBpbnN0YW5jZXMgbGlzdFxuICAgICAqXG4gICAgICogQHBhcmFtIGluc3RhbmNlc1xuICAgICAqL1xuICAgIHByaXZhdGUgcmVuZGVySW5zdGFuY2VzKGluc3RhbmNlczogYW55W10pIHtcbiAgICAgICAgaW5zdGFuY2VzID0gdGhpcy5vcHRpbWl6ZU5hbWVzKGluc3RhbmNlcyk7XG4gICAgICAgIHRoaXMuZGF0YS5zZXRSb3dzKGluc3RhbmNlcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2VsZWN0IHRoZSB0YXNrIGdpdmVuIGluIGlucHV0IGlmIHByZXNlbnRcbiAgICAgKi9cbiAgICBzZWxlY3RUYXNrKHRhc2tJZFRvU2VsZWN0OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzTGlzdEVtcHR5KCkpIHtcbiAgICAgICAgICAgIGxldCByb3dzID0gdGhpcy5kYXRhLmdldFJvd3MoKTtcbiAgICAgICAgICAgIGlmIChyb3dzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBsZXQgZGF0YVJvdyA9IHJvd3MuZmluZChyb3cgPT4gcm93LmdldFZhbHVlKCdpZCcpID09PSAgdGFza0lkVG9TZWxlY3QpIHx8IHJvd3NbMF07XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhLnNlbGVjdGVkUm93ID0gZGF0YVJvdztcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRJbnN0YW5jZUlkID0gZGF0YVJvdy5nZXRWYWx1ZSgnaWQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmRhdGEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRhdGEuc2VsZWN0ZWRSb3cgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5jdXJyZW50SW5zdGFuY2VJZCA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gdGhlIGN1cnJlbnQgaWRcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgICAqL1xuICAgIGdldEN1cnJlbnRJZCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50SW5zdGFuY2VJZDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiB0aGUgbGlzdCBpcyBlbXB0eVxuICAgICAqIEByZXR1cm5zIHtPYmplY3REYXRhVGFibGVBZGFwdGVyfGJvb2xlYW59XG4gICAgICovXG4gICAgaXNMaXN0RW1wdHkoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRhdGEgPT09IHVuZGVmaW5lZCB8fFxuICAgICAgICAgICAgKHRoaXMuZGF0YSAmJiB0aGlzLmRhdGEuZ2V0Um93cygpICYmIHRoaXMuZGF0YS5nZXRSb3dzKCkubGVuZ3RoID09PSAwKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBFbWl0IHRoZSBldmVudCByb3dDbGljayBwYXNzaW5nIHRoZSBjdXJyZW50IHRhc2sgaWQgd2hlbiB0aGUgcm93IGlzIGNsaWNrZWRcbiAgICAgKiBAcGFyYW0gZXZlbnRcbiAgICAgKi9cbiAgICBvblJvd0NsaWNrKGV2ZW50OiBEYXRhUm93RXZlbnQpIHtcbiAgICAgICAgbGV0IGl0ZW0gPSBldmVudDtcbiAgICAgICAgdGhpcy5jdXJyZW50SW5zdGFuY2VJZCA9IGl0ZW0udmFsdWUuZ2V0VmFsdWUoJ2lkJyk7XG4gICAgICAgIHRoaXMucm93Q2xpY2suZW1pdCh0aGlzLmN1cnJlbnRJbnN0YW5jZUlkKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPcHRpbWl6ZSBuYW1lIGZpZWxkXG4gICAgICogQHBhcmFtIGlzdGFuY2VzXG4gICAgICogQHJldHVybnMge2FueVtdfVxuICAgICAqL1xuICAgIHByaXZhdGUgb3B0aW1pemVOYW1lcyhpc3RhbmNlczogYW55W10pIHtcbiAgICAgICAgaXN0YW5jZXMgPSBpc3RhbmNlcy5tYXAodCA9PiB7XG4gICAgICAgICAgICB0Lm9iai5uYW1lID0gdC5vYmoubmFtZSB8fCAnTm8gbmFtZSc7XG4gICAgICAgICAgICByZXR1cm4gdDtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBpc3RhbmNlcztcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZVJlcXVlc3ROb2RlKCkge1xuICAgICAgICBsZXQgcmVxdWVzdE5vZGUgPSB7XG4gICAgICAgICAgICBhcHBEZWZpbml0aW9uSWQ6IHRoaXMuYXBwSWQsXG4gICAgICAgICAgICBwcm9jZXNzRGVmaW5pdGlvbktleTogdGhpcy5wcm9jZXNzRGVmaW5pdGlvbktleSxcbiAgICAgICAgICAgIHRleHQ6IHRoaXMubmFtZSxcbiAgICAgICAgICAgIGFzc2lnbm1lbnQ6IHRoaXMuYXNzaWdubWVudCxcbiAgICAgICAgICAgIHN0YXRlOiB0aGlzLnN0YXRlLFxuICAgICAgICAgICAgc29ydDogdGhpcy5zb3J0LFxuICAgICAgICAgICAgbGFuZGluZ1Rhc2tJZDogdGhpcy5sYW5kaW5nVGFza0lkXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBuZXcgVGFza1F1ZXJ5UmVxdWVzdFJlcHJlc2VudGF0aW9uTW9kZWwocmVxdWVzdE5vZGUpO1xuICAgIH1cbn1cbiJdfQ==
