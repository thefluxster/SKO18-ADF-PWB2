/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var alfresco_search_service_1 = require("./../services/alfresco-search.service");
var alfresco_thumbnail_service_1 = require("./../services/alfresco-thumbnail.service");
var AlfrescoSearchAutocompleteComponent = (function () {
    function AlfrescoSearchAutocompleteComponent(searchService, translateService, thumbnailService) {
        this.searchService = searchService;
        this.translateService = translateService;
        this.thumbnailService = thumbnailService;
        this.searchTerm = '';
        this.results = null;
        this.maxResults = 5;
        this.resultSort = null;
        this.rootNodeId = '-root';
        this.resultType = null;
        this.fileSelect = new core_1.EventEmitter();
        this.searchFocus = new core_1.EventEmitter();
        this.cancel = new core_1.EventEmitter();
        this.resultsLoad = new core_1.EventEmitter();
        this.scrollBack = new core_1.EventEmitter();
        this.baseComponentPath = module.id.replace('/components/alfresco-search-autocomplete.component.js', '');
    }
    AlfrescoSearchAutocompleteComponent.prototype.ngOnInit = function () {
        if (this.translateService) {
            this.translateService.addTranslationFolder('ng2-alfresco-search', 'node_modules/ng2-alfresco-search/src');
        }
    };
    AlfrescoSearchAutocompleteComponent.prototype.ngOnChanges = function (changes) {
        if (changes.searchTerm) {
            this.results = null;
            this.errorMessage = null;
            this.displaySearchResults(changes.searchTerm.currentValue);
        }
    };
    AlfrescoSearchAutocompleteComponent.prototype.displaySearchResults = function (searchTerm) {
        var _this = this;
        var searchOpts = {
            include: ['path'],
            rootNodeId: this.rootNodeId,
            nodeType: this.resultType,
            maxItems: this.maxResults,
            orderBy: this.resultSort
        };
        if (searchTerm !== null && searchTerm !== '') {
            this.searchService
                .getNodeQueryResults(searchTerm, searchOpts)
                .subscribe(function (results) {
                _this.results = results.list.entries.slice(0, _this.maxResults);
                _this.errorMessage = null;
                _this.resultsLoad.emit(_this.results);
            }, function (error) {
                _this.results = null;
                _this.errorMessage = error;
                _this.resultsLoad.error(error);
            });
        }
    };
    AlfrescoSearchAutocompleteComponent.prototype.getMimeTypeIcon = function (node) {
        if (node.entry.content && node.entry.content.mimeType) {
            var icon = this.thumbnailService.getMimeTypeIcon(node.entry.content.mimeType);
            return this.resolveIconPath(icon);
        }
        if (node.entry.isFolder) {
            return this.baseComponentPath + "/assets/images/ft_ic_folder.svg";
        }
    };
    AlfrescoSearchAutocompleteComponent.prototype.resolveIconPath = function (icon) {
        return this.baseComponentPath + "/assets/images/" + icon;
    };
    AlfrescoSearchAutocompleteComponent.prototype.getMimeTypeKey = function (node) {
        if (node.entry.content && node.entry.content.mimeType) {
            return 'SEARCH.ICONS.' + this.thumbnailService.getMimeTypeKey(node.entry.content.mimeType);
        }
        else {
            return '';
        }
    };
    AlfrescoSearchAutocompleteComponent.prototype.focusResult = function () {
        var firstResult = this.resultsTableBody.nativeElement.querySelector('tr');
        firstResult.focus();
    };
    AlfrescoSearchAutocompleteComponent.prototype.onItemClick = function (node) {
        if (node && node.entry) {
            this.fileSelect.emit(node);
        }
    };
    AlfrescoSearchAutocompleteComponent.prototype.onRowFocus = function ($event) {
        this.searchFocus.emit($event);
    };
    AlfrescoSearchAutocompleteComponent.prototype.onRowBlur = function ($event) {
        this.searchFocus.emit($event);
    };
    AlfrescoSearchAutocompleteComponent.prototype.onRowEnter = function (node) {
        if (node && node.entry) {
            if (node.entry.isFile) {
                this.fileSelect.emit(node);
            }
        }
    };
    AlfrescoSearchAutocompleteComponent.prototype.getNextElementSibling = function (node) {
        return node.nextElementSibling;
    };
    AlfrescoSearchAutocompleteComponent.prototype.getPreviousElementSibling = function (node) {
        return node.previousElementSibling;
    };
    AlfrescoSearchAutocompleteComponent.prototype.onRowArrowDown = function ($event) {
        var nextElement = this.getNextElementSibling($event.target);
        if (nextElement) {
            nextElement.focus();
        }
    };
    AlfrescoSearchAutocompleteComponent.prototype.onRowArrowUp = function ($event) {
        var previousElement = this.getPreviousElementSibling($event.target);
        if (previousElement) {
            previousElement.focus();
        }
        else {
            this.scrollBack.emit($event);
        }
    };
    AlfrescoSearchAutocompleteComponent.prototype.onRowEscape = function ($event) {
        this.cancel.emit($event);
    };
    return AlfrescoSearchAutocompleteComponent;
}());
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], AlfrescoSearchAutocompleteComponent.prototype, "searchTerm", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", Object)
], AlfrescoSearchAutocompleteComponent.prototype, "ngClass", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", Number)
], AlfrescoSearchAutocompleteComponent.prototype, "maxResults", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], AlfrescoSearchAutocompleteComponent.prototype, "resultSort", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], AlfrescoSearchAutocompleteComponent.prototype, "rootNodeId", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], AlfrescoSearchAutocompleteComponent.prototype, "resultType", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], AlfrescoSearchAutocompleteComponent.prototype, "fileSelect", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], AlfrescoSearchAutocompleteComponent.prototype, "searchFocus", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", Object)
], AlfrescoSearchAutocompleteComponent.prototype, "cancel", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", Object)
], AlfrescoSearchAutocompleteComponent.prototype, "resultsLoad", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", Object)
], AlfrescoSearchAutocompleteComponent.prototype, "scrollBack", void 0);
__decorate([
    core_1.ViewChild('resultsTableBody', {}),
    __metadata("design:type", core_1.ElementRef)
], AlfrescoSearchAutocompleteComponent.prototype, "resultsTableBody", void 0);
AlfrescoSearchAutocompleteComponent = __decorate([
    core_1.Component({
        moduleId: module.id,
        selector: 'alfresco-search-autocomplete',
        template: "<table data-automation-id=\"autocomplete_results\" *ngIf=\"results && results.length && searchTerm\"        class=\"mdl-data-table mdl-js-data-table mdl-shadow--2dp full-width\">     <tbody #resultsTableBody>     <tr id=\"result_row_{{idx}}\" *ngFor=\"let result of results; let idx = index\" tabindex=\"0\"             (blur)=\"onRowBlur($event)\" (focus)=\"onRowFocus($event)\"             (click)=\"onItemClick(result)\"             (keyup.enter)=\"onRowEnter(result)\"             (keyup.arrowdown)=\"onRowArrowDown($event)\"             (keyup.arrowup)=\"onRowArrowUp($event)\"             (keyup.escape)=\"onRowEscape($event)\"             attr.data-automation-id=\"autocomplete_result_for_{{result.entry.name}}\">         <td class=\"img-td\"><img src=\"{{getMimeTypeIcon(result)}}\" alt=\"{{getMimeTypeKey(result)|translate}}\"/></td>         <td>             <div id=\"result_name_{{idx}}\"  class=\"truncate\"><b>{{result.entry.name}}</b></div>             <div id=\"result_user_{{idx}}\"  class=\"truncate\">{{result.entry.createdByUser.displayName}}</div>         </td>     </tr>     </tbody> </table> <table id=\"search_no_result\" data-automation-id=\"search_no_result_found\" *ngIf=\"results && results.length === 0\"        class=\"mdl-data-table mdl-js-data-table mdl-shadow--2dp full-width\">     <tbody>     <tr>         <td>             <div class=\"truncate\"><b> {{ 'SEARCH.RESULTS.NONE' | translate:{searchTerm: searchTerm} }}</b></div>         </td>     </tr>     </tbody> </table> <table data-automation-id=\"autocomplete_error_message\" *ngIf=\"errorMessage\"        class=\"mdl-data-table mdl-js-data-table mdl-shadow--2dp full-width\">     <tbody>     <tr>         <td>{{ 'SEARCH.RESULTS.ERROR' | translate:{errorMessage: errorMessage} }}</td>     </tr>     </tbody> </table>",
        styles: [":host {     position: absolute;     z-index: 5;     display: none;     color: #555;     margin: -21px 0px 0px 0px; } :host a {     color: #555;     text-decoration: none; } :host table {     width: 300px; } :host .mdl-data-table tbody tr {     height: 32px; } :host .mdl-data-table td {     height: 32px;     padding: 8px;     text-align: left;     border-top: none;     border-bottom: none; } :host.active.valid {     display: block; }  .img-td{     width: 30px; }  .truncate{     width: 240px;     white-space: nowrap;     overflow: hidden;     text-overflow: ellipsis; }  @media screen and (max-width: 400px) {     :host {         right: 0;     }     .truncate{         width: 200px;     } }"]
    }),
    __metadata("design:paramtypes", [alfresco_search_service_1.AlfrescoSearchService,
        ng2_alfresco_core_1.AlfrescoTranslationService,
        alfresco_thumbnail_service_1.AlfrescoThumbnailService])
], AlfrescoSearchAutocompleteComponent);
exports.AlfrescoSearchAutocompleteComponent = AlfrescoSearchAutocompleteComponent;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYWxmcmVzY28tc2VhcmNoLWF1dG9jb21wbGV0ZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7OztHQWVHOzs7Ozs7Ozs7OztBQUVILHNDQUFpSDtBQUNqSCx1REFBK0Q7QUFFL0QsaUZBQTZGO0FBQzdGLHVGQUFvRjtBQVFwRixJQUFhLG1DQUFtQztJQTJDNUMsNkNBQW9CLGFBQW9DLEVBQ3BDLGdCQUE0QyxFQUM1QyxnQkFBMEM7UUFGMUMsa0JBQWEsR0FBYixhQUFhLENBQXVCO1FBQ3BDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBNEI7UUFDNUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUEwQjtRQTFDOUQsZUFBVSxHQUFXLEVBQUUsQ0FBQztRQUV4QixZQUFPLEdBQVEsSUFBSSxDQUFDO1FBUXBCLGVBQVUsR0FBVyxDQUFDLENBQUM7UUFHdkIsZUFBVSxHQUFXLElBQUksQ0FBQztRQUcxQixlQUFVLEdBQVcsT0FBTyxDQUFDO1FBRzdCLGVBQVUsR0FBVyxJQUFJLENBQUM7UUFHMUIsZUFBVSxHQUFzQixJQUFJLG1CQUFZLEVBQUUsQ0FBQztRQUduRCxnQkFBVyxHQUE2QixJQUFJLG1CQUFZLEVBQWMsQ0FBQztRQUd2RSxXQUFNLEdBQUcsSUFBSSxtQkFBWSxFQUFFLENBQUM7UUFHNUIsZ0JBQVcsR0FBRyxJQUFJLG1CQUFZLEVBQUUsQ0FBQztRQUdqQyxlQUFVLEdBQUcsSUFBSSxtQkFBWSxFQUFFLENBQUM7UUFJaEMsc0JBQWlCLEdBQVcsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsdURBQXVELEVBQUUsRUFBRSxDQUFDLENBQUM7SUFLM0csQ0FBQztJQUVELHNEQUFRLEdBQVI7UUFDSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxvQkFBb0IsQ0FBQyxxQkFBcUIsRUFBRSxzQ0FB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QjtBQUdqQztJQURDLGFBQU0sRUFBRTs7dUVBQ3VCO0FBRUc7SUFBbEMsZ0JBQVMsQ0FBQyxrQkFBa0IsRUFBRSxFQUFFLENBQUM7OEJBQW1CLGlCQUFVOzZFQUFDO0FBdkN2RCxtQ0FBbUM7SUFOL0MsZ0JBQVMsQ0FBQztRQUNQLFFBQVEsRUFBRSxNQUFNLENBQUMsRUFBRTtRQUNuQixRQUFRLEVBQUUsOEJBQThCO1FBQ3hDLFFBQVEsRUFBRSw2d0RBQTZ3RDtRQUN2eEQsTUFBTSxFQUFFLENBQUMsd3JCQUF3ckIsQ0FBQztLQUNyc0IsQ0FBQztxQ0E0Q3FDLCtDQUFxQjtRQUNsQiw4Q0FBMEI7UUFDMUIscURBQXdCO0dBN0NyRCxtQ0FBbUMsQ0FtTC9DO0FBbkxZLGtGQUFtQyIsImZpbGUiOiJjb21wb25lbnRzL2FsZnJlc2NvLXNlYXJjaC1hdXRvY29tcGxldGUuY29tcG9uZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTYgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkluaXQsIE9uQ2hhbmdlcywgT3V0cHV0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFsZnJlc2NvVHJhbnNsYXRpb25TZXJ2aWNlIH0gZnJvbSAnbmcyLWFsZnJlc2NvLWNvcmUnO1xuaW1wb3J0IHsgTWluaW1hbE5vZGVFbnRpdHkgfSBmcm9tICdhbGZyZXNjby1qcy1hcGknO1xuaW1wb3J0IHsgQWxmcmVzY29TZWFyY2hTZXJ2aWNlLCBTZWFyY2hPcHRpb25zIH0gZnJvbSAnLi8uLi9zZXJ2aWNlcy9hbGZyZXNjby1zZWFyY2guc2VydmljZSc7XG5pbXBvcnQgeyBBbGZyZXNjb1RodW1ibmFpbFNlcnZpY2UgfSBmcm9tICcuLy4uL3NlcnZpY2VzL2FsZnJlc2NvLXRodW1ibmFpbC5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gICAgbW9kdWxlSWQ6IG1vZHVsZS5pZCxcbiAgICBzZWxlY3RvcjogJ2FsZnJlc2NvLXNlYXJjaC1hdXRvY29tcGxldGUnLFxuICAgIHRlbXBsYXRlOiBcIjx0YWJsZSBkYXRhLWF1dG9tYXRpb24taWQ9XFxcImF1dG9jb21wbGV0ZV9yZXN1bHRzXFxcIiAqbmdJZj1cXFwicmVzdWx0cyAmJiByZXN1bHRzLmxlbmd0aCAmJiBzZWFyY2hUZXJtXFxcIiAgICAgICAgY2xhc3M9XFxcIm1kbC1kYXRhLXRhYmxlIG1kbC1qcy1kYXRhLXRhYmxlIG1kbC1zaGFkb3ctLTJkcCBmdWxsLXdpZHRoXFxcIj4gICAgIDx0Ym9keSAjcmVzdWx0c1RhYmxlQm9keT4gICAgIDx0ciBpZD1cXFwicmVzdWx0X3Jvd197e2lkeH19XFxcIiAqbmdGb3I9XFxcImxldCByZXN1bHQgb2YgcmVzdWx0czsgbGV0IGlkeCA9IGluZGV4XFxcIiB0YWJpbmRleD1cXFwiMFxcXCIgICAgICAgICAgICAgKGJsdXIpPVxcXCJvblJvd0JsdXIoJGV2ZW50KVxcXCIgKGZvY3VzKT1cXFwib25Sb3dGb2N1cygkZXZlbnQpXFxcIiAgICAgICAgICAgICAoY2xpY2spPVxcXCJvbkl0ZW1DbGljayhyZXN1bHQpXFxcIiAgICAgICAgICAgICAoa2V5dXAuZW50ZXIpPVxcXCJvblJvd0VudGVyKHJlc3VsdClcXFwiICAgICAgICAgICAgIChrZXl1cC5hcnJvd2Rvd24pPVxcXCJvblJvd0Fycm93RG93bigkZXZlbnQpXFxcIiAgICAgICAgICAgICAoa2V5dXAuYXJyb3d1cCk9XFxcIm9uUm93QXJyb3dVcCgkZXZlbnQpXFxcIiAgICAgICAgICAgICAoa2V5dXAuZXNjYXBlKT1cXFwib25Sb3dFc2NhcGUoJGV2ZW50KVxcXCIgICAgICAgICAgICAgYXR0ci5kYXRhLWF1dG9tYXRpb24taWQ9XFxcImF1dG9jb21wbGV0ZV9yZXN1bHRfZm9yX3t7cmVzdWx0LmVudHJ5Lm5hbWV9fVxcXCI+ICAgICAgICAgPHRkIGNsYXNzPVxcXCJpbWctdGRcXFwiPjxpbWcgc3JjPVxcXCJ7e2dldE1pbWVUeXBlSWNvbihyZXN1bHQpfX1cXFwiIGFsdD1cXFwie3tnZXRNaW1lVHlwZUtleShyZXN1bHQpfHRyYW5zbGF0ZX19XFxcIi8+PC90ZD4gICAgICAgICA8dGQ+ICAgICAgICAgICAgIDxkaXYgaWQ9XFxcInJlc3VsdF9uYW1lX3t7aWR4fX1cXFwiICBjbGFzcz1cXFwidHJ1bmNhdGVcXFwiPjxiPnt7cmVzdWx0LmVudHJ5Lm5hbWV9fTwvYj48L2Rpdj4gICAgICAgICAgICAgPGRpdiBpZD1cXFwicmVzdWx0X3VzZXJfe3tpZHh9fVxcXCIgIGNsYXNzPVxcXCJ0cnVuY2F0ZVxcXCI+e3tyZXN1bHQuZW50cnkuY3JlYXRlZEJ5VXNlci5kaXNwbGF5TmFtZX19PC9kaXY+ICAgICAgICAgPC90ZD4gICAgIDwvdHI+ICAgICA8L3Rib2R5PiA8L3RhYmxlPiA8dGFibGUgaWQ9XFxcInNlYXJjaF9ub19yZXN1bHRcXFwiIGRhdGEtYXV0b21hdGlvbi1pZD1cXFwic2VhcmNoX25vX3Jlc3VsdF9mb3VuZFxcXCIgKm5nSWY9XFxcInJlc3VsdHMgJiYgcmVzdWx0cy5sZW5ndGggPT09IDBcXFwiICAgICAgICBjbGFzcz1cXFwibWRsLWRhdGEtdGFibGUgbWRsLWpzLWRhdGEtdGFibGUgbWRsLXNoYWRvdy0tMmRwIGZ1bGwtd2lkdGhcXFwiPiAgICAgPHRib2R5PiAgICAgPHRyPiAgICAgICAgIDx0ZD4gICAgICAgICAgICAgPGRpdiBjbGFzcz1cXFwidHJ1bmNhdGVcXFwiPjxiPiB7eyAnU0VBUkNILlJFU1VMVFMuTk9ORScgfCB0cmFuc2xhdGU6e3NlYXJjaFRlcm06IHNlYXJjaFRlcm19IH19PC9iPjwvZGl2PiAgICAgICAgIDwvdGQ+ICAgICA8L3RyPiAgICAgPC90Ym9keT4gPC90YWJsZT4gPHRhYmxlIGRhdGEtYXV0b21hdGlvbi1pZD1cXFwiYXV0b2NvbXBsZXRlX2Vycm9yX21lc3NhZ2VcXFwiICpuZ0lmPVxcXCJlcnJvck1lc3NhZ2VcXFwiICAgICAgICBjbGFzcz1cXFwibWRsLWRhdGEtdGFibGUgbWRsLWpzLWRhdGEtdGFibGUgbWRsLXNoYWRvdy0tMmRwIGZ1bGwtd2lkdGhcXFwiPiAgICAgPHRib2R5PiAgICAgPHRyPiAgICAgICAgIDx0ZD57eyAnU0VBUkNILlJFU1VMVFMuRVJST1InIHwgdHJhbnNsYXRlOntlcnJvck1lc3NhZ2U6IGVycm9yTWVzc2FnZX0gfX08L3RkPiAgICAgPC90cj4gICAgIDwvdGJvZHk+IDwvdGFibGU+XCIsXG4gICAgc3R5bGVzOiBbXCI6aG9zdCB7ICAgICBwb3NpdGlvbjogYWJzb2x1dGU7ICAgICB6LWluZGV4OiA1OyAgICAgZGlzcGxheTogbm9uZTsgICAgIGNvbG9yOiAjNTU1OyAgICAgbWFyZ2luOiAtMjFweCAwcHggMHB4IDBweDsgfSA6aG9zdCBhIHsgICAgIGNvbG9yOiAjNTU1OyAgICAgdGV4dC1kZWNvcmF0aW9uOiBub25lOyB9IDpob3N0IHRhYmxlIHsgICAgIHdpZHRoOiAzMDBweDsgfSA6aG9zdCAubWRsLWRhdGEtdGFibGUgdGJvZHkgdHIgeyAgICAgaGVpZ2h0OiAzMnB4OyB9IDpob3N0IC5tZGwtZGF0YS10YWJsZSB0ZCB7ICAgICBoZWlnaHQ6IDMycHg7ICAgICBwYWRkaW5nOiA4cHg7ICAgICB0ZXh0LWFsaWduOiBsZWZ0OyAgICAgYm9yZGVyLXRvcDogbm9uZTsgICAgIGJvcmRlci1ib3R0b206IG5vbmU7IH0gOmhvc3QuYWN0aXZlLnZhbGlkIHsgICAgIGRpc3BsYXk6IGJsb2NrOyB9ICAuaW1nLXRkeyAgICAgd2lkdGg6IDMwcHg7IH0gIC50cnVuY2F0ZXsgICAgIHdpZHRoOiAyNDBweDsgICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7ICAgICBvdmVyZmxvdzogaGlkZGVuOyAgICAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7IH0gIEBtZWRpYSBzY3JlZW4gYW5kIChtYXgtd2lkdGg6IDQwMHB4KSB7ICAgICA6aG9zdCB7ICAgICAgICAgcmlnaHQ6IDA7ICAgICB9ICAgICAudHJ1bmNhdGV7ICAgICAgICAgd2lkdGg6IDIwMHB4OyAgICAgfSB9XCJdXG59KVxuZXhwb3J0IGNsYXNzIEFsZnJlc2NvU2VhcmNoQXV0b2NvbXBsZXRlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMge1xuXG4gICAgQElucHV0KClcbiAgICBzZWFyY2hUZXJtOiBzdHJpbmcgPSAnJztcblxuICAgIHJlc3VsdHM6IGFueSA9IG51bGw7XG5cbiAgICBlcnJvck1lc3NhZ2U7XG5cbiAgICBASW5wdXQoKVxuICAgIG5nQ2xhc3M6IGFueTtcblxuICAgIEBJbnB1dCgpXG4gICAgbWF4UmVzdWx0czogbnVtYmVyID0gNTtcblxuICAgIEBJbnB1dCgpXG4gICAgcmVzdWx0U29ydDogc3RyaW5nID0gbnVsbDtcblxuICAgIEBJbnB1dCgpXG4gICAgcm9vdE5vZGVJZDogc3RyaW5nID0gJy1yb290JztcblxuICAgIEBJbnB1dCgpXG4gICAgcmVzdWx0VHlwZTogc3RyaW5nID0gbnVsbDtcblxuICAgIEBPdXRwdXQoKVxuICAgIGZpbGVTZWxlY3Q6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgQE91dHB1dCgpXG4gICAgc2VhcmNoRm9jdXM6IEV2ZW50RW1pdHRlcjxGb2N1c0V2ZW50PiA9IG5ldyBFdmVudEVtaXR0ZXI8Rm9jdXNFdmVudD4oKTtcblxuICAgIEBPdXRwdXQoKVxuICAgIGNhbmNlbCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIEBPdXRwdXQoKVxuICAgIHJlc3VsdHNMb2FkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgQE91dHB1dCgpXG4gICAgc2Nyb2xsQmFjayA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIEBWaWV3Q2hpbGQoJ3Jlc3VsdHNUYWJsZUJvZHknLCB7fSkgcmVzdWx0c1RhYmxlQm9keTogRWxlbWVudFJlZjtcblxuICAgIGJhc2VDb21wb25lbnRQYXRoOiBzdHJpbmcgPSBtb2R1bGUuaWQucmVwbGFjZSgnL2NvbXBvbmVudHMvYWxmcmVzY28tc2VhcmNoLWF1dG9jb21wbGV0ZS5jb21wb25lbnQuanMnLCAnJyk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHNlYXJjaFNlcnZpY2U6IEFsZnJlc2NvU2VhcmNoU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IEFsZnJlc2NvVHJhbnNsYXRpb25TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdGh1bWJuYWlsU2VydmljZTogQWxmcmVzY29UaHVtYm5haWxTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLnRyYW5zbGF0ZVNlcnZpY2UpIHtcbiAgICAgICAgICAgIHRoaXMudHJhbnNsYXRlU2VydmljZS5hZGRUcmFuc2xhdGlvbkZvbGRlcignbmcyLWFsZnJlc2NvLXNlYXJjaCcsICdub2RlX21vZHVsZXMvbmcyLWFsZnJlc2NvLXNlYXJjaC9zcmMnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXMpIHtcbiAgICAgICAgaWYgKGNoYW5nZXMuc2VhcmNoVGVybSkge1xuICAgICAgICAgICAgdGhpcy5yZXN1bHRzID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMuZXJyb3JNZXNzYWdlID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMuZGlzcGxheVNlYXJjaFJlc3VsdHMoY2hhbmdlcy5zZWFyY2hUZXJtLmN1cnJlbnRWYWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMb2FkcyBhbmQgZGlzcGxheXMgc2VhcmNoIHJlc3VsdHNcbiAgICAgKiBAcGFyYW0gc2VhcmNoVGVybSBTZWFyY2ggcXVlcnkgZW50ZXJlZCBieSB1c2VyXG4gICAgICovXG4gICAgcHJpdmF0ZSBkaXNwbGF5U2VhcmNoUmVzdWx0cyhzZWFyY2hUZXJtKSB7XG4gICAgICAgIGxldCBzZWFyY2hPcHRzOiBTZWFyY2hPcHRpb25zID0ge1xuICAgICAgICAgICAgaW5jbHVkZTogWydwYXRoJ10sXG4gICAgICAgICAgICByb290Tm9kZUlkOiB0aGlzLnJvb3ROb2RlSWQsXG4gICAgICAgICAgICBub2RlVHlwZTogdGhpcy5yZXN1bHRUeXBlLFxuICAgICAgICAgICAgbWF4SXRlbXM6IHRoaXMubWF4UmVzdWx0cyxcbiAgICAgICAgICAgIG9yZGVyQnk6IHRoaXMucmVzdWx0U29ydFxuICAgICAgICB9O1xuICAgICAgICBpZiAoc2VhcmNoVGVybSAhPT0gbnVsbCAmJiBzZWFyY2hUZXJtICE9PSAnJykge1xuICAgICAgICAgICAgdGhpcy5zZWFyY2hTZXJ2aWNlXG4gICAgICAgICAgICAgICAgLmdldE5vZGVRdWVyeVJlc3VsdHMoc2VhcmNoVGVybSwgc2VhcmNoT3B0cylcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgICAgICByZXN1bHRzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzdWx0cyA9IHJlc3VsdHMubGlzdC5lbnRyaWVzLnNsaWNlKDAsIHRoaXMubWF4UmVzdWx0cyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVycm9yTWVzc2FnZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc3VsdHNMb2FkLmVtaXQodGhpcy5yZXN1bHRzKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXN1bHRzID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXJyb3JNZXNzYWdlID0gPGFueT5lcnJvcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzdWx0c0xvYWQuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGh1bWJuYWlsIFVSTCBmb3IgdGhlIGdpdmVuIGRvY3VtZW50IG5vZGUuXG4gICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBnZXQgVVJMIGZvci5cbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBVUkwgYWRkcmVzcy5cbiAgICAgKi9cbiAgICBnZXRNaW1lVHlwZUljb24obm9kZTogTWluaW1hbE5vZGVFbnRpdHkpOiBzdHJpbmcge1xuICAgICAgICBpZiAobm9kZS5lbnRyeS5jb250ZW50ICYmIG5vZGUuZW50cnkuY29udGVudC5taW1lVHlwZSkge1xuICAgICAgICAgICAgbGV0IGljb24gPSB0aGlzLnRodW1ibmFpbFNlcnZpY2UuZ2V0TWltZVR5cGVJY29uKG5vZGUuZW50cnkuY29udGVudC5taW1lVHlwZSk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXNvbHZlSWNvblBhdGgoaWNvbik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5vZGUuZW50cnkuaXNGb2xkZXIpIHtcbiAgICAgICAgICAgIHJldHVybiBgJHt0aGlzLmJhc2VDb21wb25lbnRQYXRofS9hc3NldHMvaW1hZ2VzL2Z0X2ljX2ZvbGRlci5zdmdgO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVzb2x2ZUljb25QYXRoKGljb246IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBgJHt0aGlzLmJhc2VDb21wb25lbnRQYXRofS9hc3NldHMvaW1hZ2VzLyR7aWNvbn1gO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGh1bWJuYWlsIG1lc3NhZ2Uga2V5IGZvciB0aGUgZ2l2ZW4gZG9jdW1lbnQgbm9kZSwgd2hpY2ggY2FuIGJlIHVzZWQgdG8gbG9vayB1cCBhbHQgdGV4dFxuICAgICAqIEBwYXJhbSBub2RlIE5vZGUgdG8gZ2V0IFVSTCBmb3IuXG4gICAgICogQHJldHVybnMge3N0cmluZ30gVVJMIGFkZHJlc3MuXG4gICAgICovXG4gICAgZ2V0TWltZVR5cGVLZXkobm9kZTogTWluaW1hbE5vZGVFbnRpdHkpOiBzdHJpbmcge1xuICAgICAgICBpZiAobm9kZS5lbnRyeS5jb250ZW50ICYmIG5vZGUuZW50cnkuY29udGVudC5taW1lVHlwZSkge1xuICAgICAgICAgICAgcmV0dXJuICdTRUFSQ0guSUNPTlMuJyArIHRoaXMudGh1bWJuYWlsU2VydmljZS5nZXRNaW1lVHlwZUtleShub2RlLmVudHJ5LmNvbnRlbnQubWltZVR5cGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZm9jdXNSZXN1bHQoKTogdm9pZCB7XG4gICAgICAgIGxldCBmaXJzdFJlc3VsdDogYW55ID0gdGhpcy5yZXN1bHRzVGFibGVCb2R5Lm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcigndHInKTtcbiAgICAgICAgZmlyc3RSZXN1bHQuZm9jdXMoKTtcbiAgICB9XG5cbiAgICBvbkl0ZW1DbGljayhub2RlOiBNaW5pbWFsTm9kZUVudGl0eSk6IHZvaWQge1xuICAgICAgICBpZiAobm9kZSAmJiBub2RlLmVudHJ5KSB7XG4gICAgICAgICAgICB0aGlzLmZpbGVTZWxlY3QuZW1pdChub2RlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uUm93Rm9jdXMoJGV2ZW50OiBGb2N1c0V2ZW50KTogdm9pZCB7XG4gICAgICAgIHRoaXMuc2VhcmNoRm9jdXMuZW1pdCgkZXZlbnQpO1xuICAgIH1cblxuICAgIG9uUm93Qmx1cigkZXZlbnQ6IEZvY3VzRXZlbnQpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zZWFyY2hGb2N1cy5lbWl0KCRldmVudCk7XG4gICAgfVxuXG4gICAgb25Sb3dFbnRlcihub2RlOiBNaW5pbWFsTm9kZUVudGl0eSk6IHZvaWQge1xuICAgICAgICBpZiAobm9kZSAmJiBub2RlLmVudHJ5KSB7XG4gICAgICAgICAgICBpZiAobm9kZS5lbnRyeS5pc0ZpbGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZpbGVTZWxlY3QuZW1pdChub2RlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TmV4dEVsZW1lbnRTaWJsaW5nKG5vZGU6IEVsZW1lbnQpOiBFbGVtZW50IHtcbiAgICAgICAgcmV0dXJuIG5vZGUubmV4dEVsZW1lbnRTaWJsaW5nO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UHJldmlvdXNFbGVtZW50U2libGluZyhub2RlOiBFbGVtZW50KTogRWxlbWVudCB7XG4gICAgICAgIHJldHVybiBub2RlLnByZXZpb3VzRWxlbWVudFNpYmxpbmc7XG4gICAgfVxuXG4gICAgb25Sb3dBcnJvd0Rvd24oJGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgICAgIGxldCBuZXh0RWxlbWVudDogYW55ID0gdGhpcy5nZXROZXh0RWxlbWVudFNpYmxpbmcoPEVsZW1lbnQ+ICRldmVudC50YXJnZXQpO1xuICAgICAgICBpZiAobmV4dEVsZW1lbnQpIHtcbiAgICAgICAgICAgIG5leHRFbGVtZW50LmZvY3VzKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvblJvd0Fycm93VXAoJGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgICAgIGxldCBwcmV2aW91c0VsZW1lbnQ6IGFueSA9IHRoaXMuZ2V0UHJldmlvdXNFbGVtZW50U2libGluZyg8RWxlbWVudD4gJGV2ZW50LnRhcmdldCk7XG4gICAgICAgIGlmIChwcmV2aW91c0VsZW1lbnQpIHtcbiAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudC5mb2N1cygpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zY3JvbGxCYWNrLmVtaXQoJGV2ZW50KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uUm93RXNjYXBlKCRldmVudDogS2V5Ym9hcmRFdmVudCk6IHZvaWQge1xuICAgICAgICB0aGlzLmNhbmNlbC5lbWl0KCRldmVudCk7XG4gICAgfVxuXG59XG4iXX0=
