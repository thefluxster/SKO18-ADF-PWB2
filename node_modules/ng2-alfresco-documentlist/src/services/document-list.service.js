/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var Rx_1 = require("rxjs/Rx");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var DocumentListService = DocumentListService_1 = (function () {
    function DocumentListService(authService, contentService, apiService, logService) {
        this.authService = authService;
        this.contentService = contentService;
        this.apiService = apiService;
        this.logService = logService;
        this.mimeTypeIcons = {
            'image/png': 'ft_ic_raster_image.svg',
            'image/jpeg': 'ft_ic_raster_image.svg',
            'image/gif': 'ft_ic_raster_image.svg',
            'application/pdf': 'ft_ic_pdf.svg',
            'application/vnd.ms-excel': 'ft_ic_ms_excel.svg',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'ft_ic_ms_excel.svg',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.template': 'ft_ic_ms_excel.svg',
            'application/msword': 'ft_ic_ms_word.svg',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'ft_ic_ms_word.svg',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.template': 'ft_ic_ms_word.svg',
            'application/vnd.ms-powerpoint': 'ft_ic_ms_powerpoint.svg',
            'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'ft_ic_ms_powerpoint.svg',
            'application/vnd.openxmlformats-officedocument.presentationml.template': 'ft_ic_ms_powerpoint.svg',
            'application/vnd.openxmlformats-officedocument.presentationml.slideshow': 'ft_ic_ms_powerpoint.svg',
            'video/mp4': 'ft_ic_video.svg',
            'text/plain': 'ft_ic_document.svg',
            'application/x-javascript': 'ft_ic_document.svg',
            'application/json': 'ft_ic_document.svg',
            'image/svg+xml': 'ft_ic_vector_image.svg',
            'text/html': 'ft_ic_website.svg',
            'application/x-compressed': 'ft_ic_archive.svg',
            'application/x-zip-compressed': 'ft_ic_archive.svg',
            'application/zip': 'ft_ic_archive.svg',
            'application/vnd.apple.keynote': 'ft_ic_presentation.svg',
            'application/vnd.apple.pages': 'ft_ic_document.svg',
            'application/vnd.apple.numbers': 'ft_ic_spreadsheet.svg'
        };
    }
    DocumentListService.prototype.getNodesPromise = function (folder, opts) {
        var rootNodeId = DocumentListService_1.ROOT_ID;
        if (opts && opts.rootFolderId) {
            rootNodeId = opts.rootFolderId;
        }
        var params = {
            includeSource: true,
            include: ['path', 'properties']
        };
        if (folder) {
            params.relativePath = folder;
        }
        if (opts) {
            if (opts.maxItems) {
                params.maxItems = opts.maxItems;
            }
            if (opts.skipCount) {
                params.skipCount = opts.skipCount;
            }
        }
        return this.apiService.getInstance().nodes.getNodeChildren(rootNodeId, params);
    };
    DocumentListService.prototype.deleteNode = function (nodeId) {
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().nodes.deleteNode(nodeId));
    };
    DocumentListService.prototype.createFolder = function (name, parentId) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().nodes.createFolder(name, '/', parentId))
            .catch(function (err) { return _this.handleError(err); });
    };
    DocumentListService.prototype.getFolder = function (folder, opts) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.getNodesPromise(folder, opts))
            .map(function (res) { return res; })
            .catch(function (err) { return _this.handleError(err); });
    };
    DocumentListService.prototype.getFolderNode = function (nodeId) {
        var opts = {
            includeSource: true,
            include: ['path', 'properties']
        };
        var nodes = this.apiService.getInstance().nodes;
        return nodes.getNodeInfo(nodeId, opts);
    };
    DocumentListService.prototype.getDocumentThumbnailUrl = function (node) {
        if (node && this.contentService) {
            return this.contentService.getDocumentThumbnailUrl(node);
        }
        return null;
    };
    DocumentListService.prototype.getMimeTypeIcon = function (mimeType) {
        var icon = this.mimeTypeIcons[mimeType];
        return icon || DocumentListService_1.DEFAULT_MIME_TYPE_ICON;
    };
    DocumentListService.prototype.handleError = function (error) {
        this.logService.error(error);
        return Rx_1.Observable.throw(error || 'Server error');
    };
    return DocumentListService;
}());
DocumentListService.DEFAULT_MIME_TYPE_ICON = 'ft_ic_miscellaneous.svg';
DocumentListService.ROOT_ID = '-root-';
DocumentListService = DocumentListService_1 = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [ng2_alfresco_core_1.AlfrescoAuthenticationService,
        ng2_alfresco_core_1.AlfrescoContentService,
        ng2_alfresco_core_1.AlfrescoApiService,
        ng2_alfresco_core_1.LogService])
], DocumentListService);
exports.DocumentListService = DocumentListService;
var DocumentListService_1;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL2RvY3VtZW50LWxpc3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7Ozs7Ozs7Ozs7O0FBRUgsc0NBQTJDO0FBRTNDLDhCQUFxQztBQUVyQyx1REFBMEg7QUFHMUgsSUFBYSxtQkFBbUI7SUFtQzVCLDZCQUFvQixXQUEwQyxFQUMxQyxjQUFzQyxFQUN0QyxVQUE4QixFQUM5QixVQUFzQjtRQUh0QixnQkFBVyxHQUFYLFdBQVcsQ0FBK0I7UUFDMUMsbUJBQWMsR0FBZCxjQUFjLENBQXdCO1FBQ3RDLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQzlCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFoQzFDLGtCQUFhLEdBQVE7WUFDakIsV0FBVyxFQUFFLHdCQUF3QjtZQUNyQyxZQUFZLEVBQUUsd0JBQXdCO1lBQ3RDLFdBQVcsRUFBRSx3QkFBd0I7WUFDckMsaUJBQWlCLEVBQUUsZUFBZTtZQUNsQywwQkFBMEIsRUFBRSxvQkFBb0I7WUFDaEQsbUVBQW1FLEVBQUUsb0JBQW9CO1lBQ3pGLHNFQUFzRSxFQUFFLG9CQUFvQjtZQUM1RixvQkFBb0IsRUFBRSxtQkFBbUI7WUFDekMseUVBQXlFLEVBQUUsbUJBQW1CO1lBQzlGLHlFQUF5RSxFQUFFLG1CQUFtQjtZQUM5RiwrQkFBK0IsRUFBRSx5QkFBeUI7WUFDMUQsMkVBQTJFLEVBQUUseUJBQXlCO1lBQ3RHLHVFQUF1RSxFQUFFLHlCQUF5QjtZQUNsRyx3RUFBd0UsRUFBRSx5QkFBeUI7WUFDbkcsV0FBVyxFQUFFLGlCQUFpQjtZQUM5QixZQUFZLEVBQUUsb0JBQW9CO1lBQ2xDLDBCQUEwQixFQUFFLG9CQUFvQjtZQUNoRCxrQkFBa0IsRUFBRSxvQkFBb0I7WUFDeEMsZUFBZSxFQUFFLHdCQUF3QjtZQUN6QyxXQUFXLEVBQUUsbUJBQW1CO1lBQ2hDLDBCQUEwQixFQUFFLG1CQUFtQjtZQUMvQyw4QkFBOEIsRUFBRSxtQkFBbUI7WUFDbkQsaUJB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QztJQUMzQyxDQUFDO0lBT0QscURBQXVCLEdBQXZCLFVBQXdCLElBQXVCO1FBQzNDLEVBQUUsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztZQUM5QixNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3RCxDQUFDO1FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsNkNBQWUsR0FBZixVQUFnQixRQUFnQjtRQUM1QixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3hDLE1BQU0sQ0FBQyxJQUFJLElBQUkscUJBQW1CLENBQUMsc0JBQXNCLENBQUM7SUFDOUQsQ0FBQztJQUVPLHlDQUFXLEdBQW5CLFVBQW9CLEtBQWU7UUFHL0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0IsTUFBTSxDQUFDLGVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxJQUFJLGNBQWMsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFDTCwwQkFBQztBQUFELENBaklBLEFBaUlDLElBQUE7QUEvSFUsMENBQXNCLEdBQVcseUJBQXlCLENBQUM7QUFFM0QsMkJBQU8sR0FBRyxRQUFRLENBQUM7QUFKakIsbUJBQW1CO0lBRC9CLGlCQUFVLEVBQUU7cUNBb0N3QixpREFBNkI7UUFDMUIsMENBQXNCO1FBQzFCLHNDQUFrQjtRQUNsQiw4QkFBVTtHQXRDakMsbUJBQW1CLENBaUkvQjtBQWpJWSxrREFBbUIiLCJmaWxlIjoic2VydmljZXMvZG9jdW1lbnQtbGlzdC5zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTYgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9odHRwJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzL1J4JztcbmltcG9ydCB7IE5vZGVQYWdpbmcsIE1pbmltYWxOb2RlRW50aXR5LCBNaW5pbWFsTm9kZUVudHJ5RW50aXR5IH0gZnJvbSAnYWxmcmVzY28tanMtYXBpJztcbmltcG9ydCB7IEFsZnJlc2NvQXV0aGVudGljYXRpb25TZXJ2aWNlLCBBbGZyZXNjb0NvbnRlbnRTZXJ2aWNlLCBBbGZyZXNjb0FwaVNlcnZpY2UsIExvZ1NlcnZpY2UgfSBmcm9tICduZzItYWxmcmVzY28tY29yZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEb2N1bWVudExpc3RTZXJ2aWNlIHtcblxuICAgIHN0YXRpYyBERUZBVUxUX01JTUVfVFlQRV9JQ09OOiBzdHJpbmcgPSAnZnRfaWNfbWlzY2VsbGFuZW91cy5zdmcnO1xuXG4gICAgc3RhdGljIFJPT1RfSUQgPSAnLXJvb3QtJztcblxuICAgIG1pbWVUeXBlSWNvbnM6IGFueSA9IHtcbiAgICAgICAgJ2ltYWdlL3BuZyc6ICdmdF9pY19yYXN0ZXJfaW1hZ2Uuc3ZnJyxcbiAgICAgICAgJ2ltYWdlL2pwZWcnOiAnZnRfaWNfcmFzdGVyX2ltYWdlLnN2ZycsXG4gICAgICAgICdpbWFnZS9naWYnOiAnZnRfaWNfcmFzdGVyX2ltYWdlLnN2ZycsXG4gICAgICAgICdhcHBsaWNhdGlvbi9wZGYnOiAnZnRfaWNfcGRmLnN2ZycsXG4gICAgICAgICdhcHBsaWNhdGlvbi92bmQubXMtZXhjZWwnOiAnZnRfaWNfbXNfZXhjZWwuc3ZnJyxcbiAgICAgICAgJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLnNoZWV0JzogJ2Z0X2ljX21zX2V4Y2VsLnN2ZycsXG4gICAgICAgICdhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuc3ByZWFkc2hlZXRtbC50ZW1wbGF0ZSc6ICdmdF9pY19tc19leGNlbC5zdmcnLFxuICAgICAgICAnYXBwbGljYXRpb24vbXN3b3JkJzogJ2Z0X2ljX21zX3dvcmQuc3ZnJyxcbiAgICAgICAgJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC53b3JkcHJvY2Vzc2luZ21sLmRvY3VtZW50JzogJ2Z0X2ljX21zX3dvcmQuc3ZnJyxcbiAgICAgICAgJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC53b3JkcHJvY2Vzc2luZ21sLnRlbXBsYXRlJzogJ2Z0X2ljX21zX3dvcmQuc3ZnJyxcbiAgICAgICAgJ2FwcGxpY2F0aW9uL3ZuZC5tcy1wb3dlcnBvaW50JzogJ2Z0X2ljX21zX3Bvd2VycG9pbnQuc3ZnJyxcbiAgICAgICAgJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5wcmVzZW50YXRpb25tbC5wcmVzZW50YXRpb24nOiAnZnRfaWNfbXNfcG93ZXJwb2ludC5zdmcnLFxuICAgICAgICAnYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnByZXNlbnRhdGlvbm1sLnRlbXBsYXRlJzogJ2Z0X2ljX21zX3Bvd2VycG9pbnQuc3ZnJyxcbiAgICAgICAgJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5wcmVzZW50YXRpb25tbC5zbGlkZXNob3cnOiAnZnRfaWNfbXNfcG93ZXJwb2ludC5zdmcnLFxuICAgICAgICAndmlkZW8vbXA0JzogJ2Z0X2ljX3ZpZGVvLnN2ZycsXG4gICAgICAgICd0ZXh0L3BsYWluJzogJ2Z0X2ljX2RvY3VtZW50LnN2ZycsXG4gICAgICAgICdhcHBsaWNhdGlvbi94LWphdmFzY3JpcHQnOiAnZnRfaWNfZG9jdW1lbnQuc3ZnJyxcbiAgICAgICAgJ2FwcGxpY2F0aW9uL2pzb24nOiAnZnRfaWNfZG9jdW1lbnQuc3ZnJyxcbiAgICAgICAgJ2ltYWdlL3N2Zyt4bWwnOiAnZnRfaWNfdmVjdG9yX2ltYWdlLnN2ZycsXG4gICAgICAgICd0ZXh0L2h0bWwnOiAnZnRfaWNfd2Vic2l0ZS5zdmcnLFxuICAgICAgICAnYXBwbGljYXRpb24veC1jb21wcmVzc2VkJzogJ2Z0X2ljX2FyY2hpdmUuc3ZnJyxcbiAgICAgICAgJ2FwcGxpY2F0aW9uL3gtemlwLWNvbXByZXNzZWQnOiAnZnRfaWNfYXJjaGl2ZS5zdmcnLFxuICAgICAgICAnYXBwbGljYXRpb24vemlwJzogJ2Z0X2ljX2FyY2hpdmUuc3ZnJyxcbiAgICAgICAgJ2FwcGxpY2F0aW9uL3ZuZC5hcHBsZS5rZXlub3RlJzogJ2Z0X2ljX3ByZXNlbnRhdGlvbi5zdmcnLFxuICAgICAgICAnYXBwbGljYXRpb24vdm5kLmFwcGxlLnBhZ2VzJzogJ2Z0X2ljX2RvY3VtZW50LnN2ZycsXG4gICAgICAgICdhcHBsaWNhdGlvbi92bmQuYXBwbGUubnVtYmVycyc6ICdmdF9pY19zcHJlYWRzaGVldC5zdmcnXG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXV0aFNlcnZpY2U6IEFsZnJlc2NvQXV0aGVudGljYXRpb25TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgY29udGVudFNlcnZpY2U6IEFsZnJlc2NvQ29udGVudFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXROb2Rlc1Byb21pc2UoZm9sZGVyOiBzdHJpbmcsIG9wdHM/OiBhbnkpOiBQcm9taXNlPE5vZGVQYWdpbmc+IHtcblxuICAgICAgICBsZXQgcm9vdE5vZGVJZCA9IERvY3VtZW50TGlzdFNlcnZpY2UuUk9PVF9JRDtcbiAgICAgICAgaWYgKG9wdHMgJiYgb3B0cy5yb290Rm9sZGVySWQpIHtcbiAgICAgICAgICAgIHJvb3ROb2RlSWQgPSBvcHRzLnJvb3RGb2xkZXJJZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBwYXJhbXM6IGFueSA9IHtcbiAgICAgICAgICAgIGluY2x1ZGVTb3VyY2U6IHRydWUsXG4gICAgICAgICAgICBpbmNsdWRlOiBbJ3BhdGgnLCAncHJvcGVydGllcyddXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGZvbGRlcikge1xuICAgICAgICAgICAgcGFyYW1zLnJlbGF0aXZlUGF0aCA9IGZvbGRlcjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRzKSB7XG4gICAgICAgICAgICBpZiAob3B0cy5tYXhJdGVtcykge1xuICAgICAgICAgICAgICAgIHBhcmFtcy5tYXhJdGVtcyA9IG9wdHMubWF4SXRlbXM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob3B0cy5za2lwQ291bnQpIHtcbiAgICAgICAgICAgICAgICBwYXJhbXMuc2tpcENvdW50ID0gb3B0cy5za2lwQ291bnQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkubm9kZXMuZ2V0Tm9kZUNoaWxkcmVuKHJvb3ROb2RlSWQsIHBhcmFtcyk7XG4gICAgfVxuXG4gICAgZGVsZXRlTm9kZShub2RlSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLm5vZGVzLmRlbGV0ZU5vZGUobm9kZUlkKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IGZvbGRlciBpbiB0aGUgcGF0aC5cbiAgICAgKiBAcGFyYW0gbmFtZSBGb2xkZXIgbmFtZVxuICAgICAqIEBwYXJhbSBwYXJlbnRJZCBQYXJlbnQgZm9sZGVyIElEXG4gICAgICogQHJldHVybnMge2FueX1cbiAgICAgKi9cbiAgICBjcmVhdGVGb2xkZXIobmFtZTogc3RyaW5nLCBwYXJlbnRJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxNaW5pbWFsTm9kZUVudGl0eT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5ub2Rlcy5jcmVhdGVGb2xkZXIobmFtZSwgJy8nLCBwYXJlbnRJZCkpXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgZm9sZGVyIG5vZGUgd2l0aCB0aGUgc3BlY2lmaWVkIHJlbGF0aXZlIG5hbWUgcGF0aCBiZWxvdyB0aGUgcm9vdCBub2RlLlxuICAgICAqIEBwYXJhbSBmb2xkZXIgUGF0aCB0byBmb2xkZXIuXG4gICAgICogQHBhcmFtIG9wdHMgT3B0aW9ucy5cbiAgICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxOb2RlUGFnaW5nPn0gRm9sZGVyIGVudGl0eS5cbiAgICAgKi9cbiAgICBnZXRGb2xkZXIoZm9sZGVyOiBzdHJpbmcsIG9wdHM/OiBhbnkpIHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UodGhpcy5nZXROb2Rlc1Byb21pc2UoZm9sZGVyLCBvcHRzKSlcbiAgICAgICAgICAgIC5tYXAocmVzID0+IDxOb2RlUGFnaW5nPiByZXMpXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgZ2V0Rm9sZGVyTm9kZShub2RlSWQ6IHN0cmluZyk6IFByb21pc2U8TWluaW1hbE5vZGVFbnRyeUVudGl0eT4ge1xuICAgICAgICBsZXQgb3B0czogYW55ID0ge1xuICAgICAgICAgICAgaW5jbHVkZVNvdXJjZTogdHJ1ZSxcbiAgICAgICAgICAgIGluY2x1ZGU6IFsncGF0aCcsICdwcm9wZXJ0aWVzJ11cbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgbm9kZXM6IGFueSA9IHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLm5vZGVzO1xuICAgICAgICByZXR1cm4gbm9kZXMuZ2V0Tm9kZUluZm8obm9kZUlkLCBvcHRzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGh1bWJuYWlsIFVSTCBmb3IgdGhlIGdpdmVuIGRvY3VtZW50IG5vZGUuXG4gICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBnZXQgVVJMIGZvci5cbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBVUkwgYWRkcmVzcy5cbiAgICAgKi9cbiAgICBnZXREb2N1bWVudFRodW1ibmFpbFVybChub2RlOiBNaW5pbWFsTm9kZUVudGl0eSkge1xuICAgICAgICBpZiAobm9kZSAmJiB0aGlzLmNvbnRlbnRTZXJ2aWNlKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb250ZW50U2VydmljZS5nZXREb2N1bWVudFRodW1ibmFpbFVybChub2RlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBnZXRNaW1lVHlwZUljb24obWltZVR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGxldCBpY29uID0gdGhpcy5taW1lVHlwZUljb25zW21pbWVUeXBlXTtcbiAgICAgICAgcmV0dXJuIGljb24gfHwgRG9jdW1lbnRMaXN0U2VydmljZS5ERUZBVUxUX01JTUVfVFlQRV9JQ09OO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlRXJyb3IoZXJyb3I6IFJlc3BvbnNlKSB7XG4gICAgICAgIC8vIGluIGEgcmVhbCB3b3JsZCBhcHAsIHdlIG1heSBzZW5kIHRoZSBlcnJvciB0byBzb21lIHJlbW90ZSBsb2dnaW5nIGluZnJhc3RydWN0dXJlXG4gICAgICAgIC8vIGluc3RlYWQgb2YganVzdCBsb2dnaW5nIGl0IHRvIHRoZSBjb25zb2xlXG4gICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcihlcnJvcik7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLnRocm93KGVycm9yIHx8ICdTZXJ2ZXIgZXJyb3InKTtcbiAgICB9XG59XG4iXX0=
