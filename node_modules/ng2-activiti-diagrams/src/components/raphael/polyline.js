/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var anchor_1 = require("./anchor");
var Polyline = (function () {
    function Polyline(uuid, points, strokeWidth, paper) {
        this.id = null;
        this.points = [];
        this.path = [];
        this.anchors = [];
        this.strokeWidth = 1;
        this.radius = 1;
        this.showDetails = false;
        this.paper = null;
        this.element = null;
        this.isDefaultConditionAvailable = false;
        this.closePath = false;
        this.points = points;
        this.path = [];
        this.anchors = [];
        if (strokeWidth) {
            this.strokeWidth = strokeWidth;
        }
        this.paper = paper;
        this.closePath = false;
        this.init();
    }
    Polyline.prototype.init = function () {
        var linesCount = this.getLinesCount();
        if (linesCount < 1) {
            return;
        }
        this.normalizeCoordinates();
        this.pushAnchor(anchor_1.Anchor.ANCHOR_TYPE.first, this.getLine(0).x1, this.getLine(0).y1);
        for (var i = 1; i < linesCount; i++) {
            var line1 = this.getLine(i - 1);
            this.pushAnchor(anchor_1.Anchor.ANCHOR_TYPE.main, line1.x2, line1.y2);
        }
        this.pushAnchor(anchor_1.Anchor.ANCHOR_TYPE.last, this.getLine(linesCount - 1).x2, this.getLine(linesCount - 1).y2);
        this.rebuildPath();
    };
    Polyline.prototype.normalizeCoordinates = function () {
        for (var i = 0; i < this.points.length; i++) {
            this.points[i].x = parseFloat(this.points[i].x);
            this.points[i].y = parseFloat(this.points[i].y);
        }
    };
    Polyline.prototype.getLinesCount = function () {
        return this.points.length - 1;
    };
    Polyline.prototype._getLine = function (i) {
        if (this.points.length > i && this.points[i]) {
            return { x1: this.points[i].x, y1: this.points[i].y, x2: this.points[i + 1].x, y2: this.points[i + 1].y };
        }
        else {
            return undefined;
        }
    };
    Polyline.prototype.getLine = function (i) {
        var line = this._getLine(i);
        if (line !== undefined) {
            line.angle = this.getLineAngle(i);
        }
        return line;
    };
    Polyline.prototype.getLineAngle = function (i) {
        var line = this._getLine(i);
        return Math.atan2(line.y2 - line.y1, line.x2 - line.x1);
    };
    Polyline.prototype.getLineLengthX = function (i) {
        var line = this.getLine(i);
        return (line.x2 - line.x1);
    };
    Polyline.prototype.getLineLengthY = function (i) {
        var line = this.getLine(i);
        return (line.y2 - line.y1);
    };
    Polyline.prototype.getLineLength = function (i) {
        return Math.sqrt(Math.pow(this.getLineLengthX(i), 2) + Math.pow(this.getLineLengthY(i), 2));
    };
    Polyline.prototype.getAnchors = function () {
        return this.anchors;
    };
    Polyline.prototype.getAnchorsCount = function (type) {
        if (type === void 0) { type = null; }
        if (!type) {
            return this.anchors.length;
        }
        else {
            var count = 0;
            for (var i = 0; i < this.getAnchorsCount(null); i++) {
                var anchor = this.anchors[i];
                if (anchor.getType() === type) {
                    count++;
                }
            }
            return count;
        }
    };
    Polyline.prototype.pushAnchor = function (type, x, y) {
        var index, typeIndex;
        if (type === anchor_1.Anchor.ANCHOR_TYPE.first) {
            index = 0;
            typeIndex = 0;
        }
        else if (type === anchor_1.Anchor.ANCHOR_TYPE.last) {
            index = this.getAnchorsCount();
            typeIndex = 0;
        }
        else if (!index) {
            index = this.anchors.length;
        }
        else {
            for (var i = 0; i < this.getAnchorsCount(); i++) {
                var anchor = this.anchors[i];
                if (anchor.index > index) {
                    anchor.index++;
                    anchor.typeIndex++;
                }
            }
        }
        var anchor = new anchor_1.Anchor(this.id, anchor_1.Anchor.ANCHOR_TYPE.main, x, y);
        this.anchors.push(anchor);
    };
    Polyline.prototype.getAnchor = function (position) {
        return this.anchors[position];
    };
    Polyline.prototype.getAnchorByType = function (type, position) {
        if (type === anchor_1.Anchor.ANCHOR_TYPE.first) {
            return this.anchors[0];
        }
        if (type === anchor_1.Anchor.ANCHOR_TYPE.last) {
            return this.anchors[this.getAnchorsCount() - 1];
        }
        for (var i = 0; i < this.getAnchorsCount(); i++) {
            var anchor = this.anchors[i];
            if (anchor.type === type) {
                if (position === anchor.position) {
                    return anchor;
                }
            }
        }
        return null;
    };
    Polyline.prototype.addNewPoint = function (position, x, y) {
        for (var i = 0; i < this.getLinesCount(); i++) {
            var line = this.getLine(i);
            if (x > line.x1 && x < line.x2 && y > line.y1 && y < line.y2) {
                this.points.splice(i + 1, 0, { x: x, y: y });
                break;
            }
        }
        this.rebuildPath();
    };
    Polyline.prototype.rebuildPath = function () {
        var path = [];
        for (var i = 0; i < this.getAnchorsCount(); i++) {
            var anchor = this.getAnchor(i);
            var pathType = '';
            if (i === 0) {
                pathType = 'M';
            }
            else {
                pathType = 'L';
            }
            var targetX = anchor.x, targetY = anchor.y;
            if (i > 0 && i < this.getAnchorsCount() - 1) {
                var cx = anchor.x, cy = anchor.y;
                var AO = this.getLineLength(i - 1);
                if (AO < this.radius) {
                    AO = this.radius;
                }
                this.isDefaultConditionAvailable = (this.isDefaultConditionAvailable || (i === 1 && AO > 10));
                var ED = this.getLineLengthY(i - 1) * this.radius / AO;
                var OD = this.getLineLengthX(i - 1) * this.radius / AO;
                targetX = anchor.x - OD;
                targetY = anchor.y - ED;
                if (AO < 2 * this.radius && i > 1) {
                    targetX = anchor.x - this.getLineLengthX(i - 1) / 2;
                    targetY = anchor.y - this.getLineLengthY(i - 1) / 2;
                }
                var AO = this.getLineLength(i);
                if (AO < this.radius) {
                    AO = this.radius;
                }
                var ED = this.getLineLengthY(i) * this.radius / AO;
                var OD = this.getLineLengthX(i) * this.radius / AO;
                var nextSrcX = anchor.x + OD;
                var nextSrcY = anchor.y + ED;
                if (AO < 2 * this.radius && i < this.getAnchorsCount() - 2) {
                    nextSrcX = anchor.x + this.getLineLengthX(i) / 2;
                    nextSrcY = anchor.y + this.getLineLengthY(i) / 2;
                    ;
                }
                var dx0 = (cx - targetX) / 3, dy0 = (cy - targetY) / 3, ax = cx - dx0, ay = cy - dy0, dx1 = (cx - nextSrcX) / 3, dy1 = (cy - nextSrcY) / 3, bx = cx - dx1, by = cy - dy1, zx = nextSrcX, zy = nextSrcY;
            }
            else if (i === 1 && this.getAnchorsCount() === 2) {
                var AO = this.getLineLength(i - 1);
                if (AO < this.radius) {
                    AO = this.radius;
                }
                this.isDefaultConditionAvailable = (this.isDefaultConditionAvailable || (i === 1 && AO > 10));
            }
            if (this.strokeWidth % 2 === 1) {
                targetX += 0.5;
                targetY += 0.5;
            }
            path.push([pathType, targetX, targetY]);
            if (i > 0 && i < this.getAnchorsCount() - 1) {
                path.push(['C', ax, ay, bx, by, zx, zy]);
            }
        }
        if (this.closePath) {
            path.push(['Z']);
        }
        this.path = path;
    };
    Polyline.prototype.transform = function (transformation) {
        this.element.transform(transformation);
    };
    Polyline.prototype.function = function (attrs) {
        this.element.attr(attrs);
    };
    return Polyline;
}());
exports.Polyline = Polyline;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvcmFwaGFlbC9wb2x5bGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7O0FBRUgsbUNBQWtDO0FBR2xDO0lBY0ksa0JBQVksSUFBSSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsS0FBSztRQVo1QyxPQUFFLEdBQVEsSUFBSSxDQUFDO1FBQ2YsV0FBTSxHQUFRLEVBQUUsQ0FBQztRQUNqQixTQUFJLEdBQVEsRUFBRSxDQUFDO1FBQ2YsWUFBTyxHQUFRLEVBQUUsQ0FBQztRQUNsQixnQkFBVyxHQUFRLENBQUMsQ0FBQztRQUNyQixXQUFNLEdBQVEsQ0FBQyxDQUFDO1FBQ2hCLGdCQUFXLEdBQVEsS0FBSyxDQUFDO1FBQ3pCLFVBQUssR0FBUSxJQUFJLENBQUM7UUFDbEIsWUFBTyxHQUFRLElBQUksQ0FBQztRQUNwQixnQ0FBMkIsR0FBUSxLQUFLLENBQUM7UUFDekMsY0FBUyxHQUFRLEtBQUssQ0FBQztRQVVuQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUtyQixJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUVmLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBRWxCLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDZCxJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztRQUNuQyxDQUFDO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFFbkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7UUFFdkIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2hCLENBQUM7SUFFRCx1QkFBSSxHQUFKO1FBQ0ksSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3RDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLE1BQU0sQ0FBQztRQUNYLENBQUM7UUFFRCxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUk1QixJQUFJLENBQUMsVUFBVSxDQUFDLGVBQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFbEYsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxVQUFVLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUNsQyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNoQyxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2pFLENBQUM7UUFFRCxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUUzRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVELHVDQUFvQixHQUFwQjtRQUNJLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUMxQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoRCxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwRCxDQUFDO0lBQ0wsQ0FBQztJQUVELGdDQUFhLEdBQWI7UUFDSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFRCwyQkFBUSxHQUFSLFVBQVMsQ0FBQztRQUNOLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzQyxNQUFNLENBQUMsRUFBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBQyxDQUFDO1FBQzVHLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLE1BQU0sQ0FBQyxTQUFTLENBQUM7UUFDckIsQ0FBQztJQUNMLENBQUM7SUFFRCwwQkFBTyxHQUFQLFVBQVEsQ0FBQztRQUNMLElBQUksSUFBSSxHQUFRLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakMsRUFBRSxDQUFDLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDckIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLENBQUM7UUFDRCxNQUFNLENB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QUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3JCLENBQUM7UUFFRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNyQixDQUFDO0lBRUQsNEJBQVMsR0FBVCxVQUFVLGNBQWM7UUFDcEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVELDJCQUFRLEdBQVIsVUFBUyxLQUFLO1FBQ1YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVMLGVBQUM7QUFBRCxDQW5TQSxBQW1TQyxJQUFBO0FBblNZLDRCQUFRIiwiZmlsZSI6ImNvbXBvbmVudHMvcmFwaGFlbC9wb2x5bGluZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE2IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEFuY2hvciB9IGZyb20gJy4vYW5jaG9yJztcblxuLyogdHNsaW50OmRpc2FibGUgKi9cbmV4cG9ydCBjbGFzcyBQb2x5bGluZSB7XG5cbiAgICBpZDogYW55ID0gbnVsbDtcbiAgICBwb2ludHM6IGFueSA9IFtdO1xuICAgIHBhdGg6IGFueSA9IFtdO1xuICAgIGFuY2hvcnM6IGFueSA9IFtdO1xuICAgIHN0cm9rZVdpZHRoOiBhbnkgPSAxO1xuICAgIHJhZGl1czogYW55ID0gMTtcbiAgICBzaG93RGV0YWlsczogYW55ID0gZmFsc2U7XG4gICAgcGFwZXI6IGFueSA9IG51bGw7XG4gICAgZWxlbWVudDogYW55ID0gbnVsbDtcbiAgICBpc0RlZmF1bHRDb25kaXRpb25BdmFpbGFibGU6IGFueSA9IGZhbHNlO1xuICAgIGNsb3NlUGF0aDogYW55ID0gZmFsc2U7XG5cbiAgICBjb25zdHJ1Y3Rvcih1dWlkLCBwb2ludHMsIHN0cm9rZVdpZHRoLCBwYXBlcikge1xuICAgICAgICAvKiBBcnJheSBvbiBjb29yZGluYXRlczpcbiAgICAgICAgICogcG9pbnRzOiBbe3g6IDQxMCwgeTogMTEwfSwgMVxuICAgICAgICAgKlx0XHRcdHt4OiA1NzAsIHk6IDExMH0sIDEgMlxuICAgICAgICAgKlx0XHRcdHt4OiA2MjAsIHk6IDI0MH0sICAgMiAzXG4gICAgICAgICAqXHRcdFx0e3g6IDc1MCwgeTogMjcwfSwgICAgIDMgNFxuICAgICAgICAgKlx0XHRcdHt4OiA2NTAsIHk6IDM3MH1dOyAgICAgIDRcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMucG9pbnRzID0gcG9pbnRzO1xuICAgICAgICAvKlxuICAgICAgICAgKiBwYXRoIGZvciBncmFwaFxuICAgICAgICAgKiBbWydNJywgeDEsIHkxXSwgWydMJywgeDIsIHkyXSwgWydDJywgYXgsIGF5LCBieCwgYnksIHgzLCB5M10sIFsnTCcsIHgzLCB5M11dXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnBhdGggPSBbXTtcblxuICAgICAgICB0aGlzLmFuY2hvcnMgPSBbXTtcblxuICAgICAgICBpZiAoc3Ryb2tlV2lkdGgpIHtcbiAgICAgICAgICAgIHRoaXMuc3Ryb2tlV2lkdGggPSBzdHJva2VXaWR0aDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucGFwZXIgPSBwYXBlcjtcblxuICAgICAgICB0aGlzLmNsb3NlUGF0aCA9IGZhbHNlO1xuXG4gICAgICAgIHRoaXMuaW5pdCgpO1xuICAgIH1cblxuICAgIGluaXQoKSB7XG4gICAgICAgIHZhciBsaW5lc0NvdW50ID0gdGhpcy5nZXRMaW5lc0NvdW50KCk7XG4gICAgICAgIGlmIChsaW5lc0NvdW50IDwgMSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5ub3JtYWxpemVDb29yZGluYXRlcygpO1xuXG4gICAgICAgIC8vIGNyZWF0ZSBhbmNob3JzXG5cbiAgICAgICAgdGhpcy5wdXNoQW5jaG9yKEFuY2hvci5BTkNIT1JfVFlQRS5maXJzdCwgdGhpcy5nZXRMaW5lKDApLngxLCB0aGlzLmdldExpbmUoMCkueTEpO1xuXG4gICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgbGluZXNDb3VudDsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgbGluZTEgPSB0aGlzLmdldExpbmUoaSAtIDEpO1xuICAgICAgICAgICAgdGhpcy5wdXNoQW5jaG9yKEFuY2hvci5BTkNIT1JfVFlQRS5tYWluLCBsaW5lMS54MiwgbGluZTEueTIpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wdXNoQW5jaG9yKEFuY2hvci5BTkNIT1JfVFlQRS5sYXN0LCB0aGlzLmdldExpbmUobGluZXNDb3VudCAtIDEpLngyLCB0aGlzLmdldExpbmUobGluZXNDb3VudCAtIDEpLnkyKTtcblxuICAgICAgICB0aGlzLnJlYnVpbGRQYXRoKCk7XG4gICAgfVxuXG4gICAgbm9ybWFsaXplQ29vcmRpbmF0ZXMoKSB7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wb2ludHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMucG9pbnRzW2ldLnggPSBwYXJzZUZsb2F0KHRoaXMucG9pbnRzW2ldLngpO1xuICAgICAgICAgICAgdGhpcy5wb2ludHNbaV0ueSA9IHBhcnNlRmxvYXQodGhpcy5wb2ludHNbaV0ueSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRMaW5lc0NvdW50KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5wb2ludHMubGVuZ3RoIC0gMTtcbiAgICB9XG5cbiAgICBfZ2V0TGluZShpKSB7XG4gICAgICAgIGlmICh0aGlzLnBvaW50cy5sZW5ndGggPiBpICYmIHRoaXMucG9pbnRzW2ldKSB7XG4gICAgICAgICAgICByZXR1cm4ge3gxOiB0aGlzLnBvaW50c1tpXS54LCB5MTogdGhpcy5wb2ludHNbaV0ueSwgeDI6IHRoaXMucG9pbnRzW2kgKyAxXS54LCB5MjogdGhpcy5wb2ludHNbaSArIDFdLnl9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldExpbmUoaSkge1xuICAgICAgICB2YXIgbGluZTogYW55ID0gdGhpcy5fZ2V0TGluZShpKTtcbiAgICAgICAgaWYgKGxpbmUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgbGluZS5hbmdsZSA9IHRoaXMuZ2V0TGluZUFuZ2xlKGkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsaW5lO1xuICAgIH1cblxuICAgIGdldExpbmVBbmdsZShpKSB7XG4gICAgICAgIHZhciBsaW5lID0gdGhpcy5fZ2V0TGluZShpKTtcbiAgICAgICAgcmV0dXJuIE1hdGguYXRhbjIobGluZS55MiAtIGxpbmUueTEsIGxpbmUueDIgLSBsaW5lLngxKTtcbiAgICB9XG5cbiAgICBnZXRMaW5lTGVuZ3RoWChpKSB7XG4gICAgICAgIHZhciBsaW5lID0gdGhpcy5nZXRMaW5lKGkpO1xuICAgICAgICByZXR1cm4gKGxpbmUueDIgLSBsaW5lLngxKTtcbiAgICB9XG5cbiAgICBnZXRMaW5lTGVuZ3RoWShpKSB7XG4gICAgICAgIHZhciBsaW5lID0gdGhpcy5nZXRMaW5lKGkpO1xuICAgICAgICByZXR1cm4gKGxpbmUueTIgLSBsaW5lLnkxKTtcbiAgICB9XG5cbiAgICBnZXRMaW5lTGVuZ3RoKGkpIHtcbiAgICAgICAgcmV0dXJuIE1hdGguc3FydChNYXRoLnBvdyh0aGlzLmdldExpbmVMZW5ndGhYKGkpLCAyKSArIE1hdGgucG93KHRoaXMuZ2V0TGluZUxlbmd0aFkoaSksIDIpKTtcbiAgICB9XG5cbiAgICBnZXRBbmNob3JzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5hbmNob3JzO1xuICAgIH1cblxuICAgIGdldEFuY2hvcnNDb3VudCh0eXBlOiBhbnkgPSBudWxsKSB7XG4gICAgICAgIGlmICghdHlwZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYW5jaG9ycy5sZW5ndGg7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YXIgY291bnQgPSAwO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmdldEFuY2hvcnNDb3VudChudWxsKTsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFuY2hvciA9IHRoaXMuYW5jaG9yc1tpXTtcbiAgICAgICAgICAgICAgICBpZiAoYW5jaG9yLmdldFR5cGUoKSA9PT0gdHlwZSkge1xuICAgICAgICAgICAgICAgICAgICBjb3VudCsrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBjb3VudDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1c2hBbmNob3IodHlwZSwgeCwgeSkge1xuICAgICAgICB2YXIgaW5kZXgsIHR5cGVJbmRleDtcbiAgICAgICAgaWYgKHR5cGUgPT09IEFuY2hvci5BTkNIT1JfVFlQRS5maXJzdCkge1xuICAgICAgICAgICAgaW5kZXggPSAwO1xuICAgICAgICAgICAgdHlwZUluZGV4ID0gMDtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSBBbmNob3IuQU5DSE9SX1RZUEUubGFzdCkge1xuICAgICAgICAgICAgaW5kZXggPSB0aGlzLmdldEFuY2hvcnNDb3VudCgpO1xuICAgICAgICAgICAgdHlwZUluZGV4ID0gMDtcbiAgICAgICAgfSBlbHNlIGlmICghaW5kZXgpIHtcbiAgICAgICAgICAgIGluZGV4ID0gdGhpcy5hbmNob3JzLmxlbmd0aDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5nZXRBbmNob3JzQ291bnQoKTsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFuY2hvciA9IHRoaXMuYW5jaG9yc1tpXTtcbiAgICAgICAgICAgICAgICBpZiAoYW5jaG9yLmluZGV4ID4gaW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgYW5jaG9yLmluZGV4Kys7XG4gICAgICAgICAgICAgICAgICAgIGFuY2hvci50eXBlSW5kZXgrKztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgYW5jaG9yOiBhbnkgPSBuZXcgQW5jaG9yKHRoaXMuaWQsIEFuY2hvci5BTkNIT1JfVFlQRS5tYWluLCB4LCB5KTtcblxuICAgICAgICB0aGlzLmFuY2hvcnMucHVzaChhbmNob3IpO1xuICAgIH1cblxuICAgIGdldEFuY2hvcihwb3NpdGlvbikge1xuICAgICAgICByZXR1cm4gdGhpcy5hbmNob3JzW3Bvc2l0aW9uXTtcbiAgICB9XG5cbiAgICBnZXRBbmNob3JCeVR5cGUodHlwZSwgcG9zaXRpb24pIHtcbiAgICAgICAgaWYgKHR5cGUgPT09IEFuY2hvci5BTkNIT1JfVFlQRS5maXJzdCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYW5jaG9yc1swXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZSA9PT0gQW5jaG9yLkFOQ0hPUl9UWVBFLmxhc3QpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFuY2hvcnNbdGhpcy5nZXRBbmNob3JzQ291bnQoKSAtIDFdO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5nZXRBbmNob3JzQ291bnQoKTsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgYW5jaG9yID0gdGhpcy5hbmNob3JzW2ldO1xuICAgICAgICAgICAgaWYgKGFuY2hvci50eXBlID09PSB0eXBlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBvc2l0aW9uID09PSBhbmNob3IucG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuY2hvcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgYWRkTmV3UG9pbnQocG9zaXRpb24sIHgsIHkpIHtcbiAgICAgICAgLy9cbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmdldExpbmVzQ291bnQoKTsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgbGluZSA9IHRoaXMuZ2V0TGluZShpKTtcbiAgICAgICAgICAgIGlmICh4ID4gbGluZS54MSAmJiB4IDwgbGluZS54MiAmJiB5ID4gbGluZS55MSAmJiB5IDwgbGluZS55Mikge1xuICAgICAgICAgICAgICAgIHRoaXMucG9pbnRzLnNwbGljZShpICsgMSwgMCwge3g6IHgsIHk6IHl9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucmVidWlsZFBhdGgoKTtcbiAgICB9XG5cbiAgICByZWJ1aWxkUGF0aCgpIHtcbiAgICAgICAgdmFyIHBhdGggPSBbXTtcblxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZ2V0QW5jaG9yc0NvdW50KCk7IGkrKykge1xuICAgICAgICAgICAgdmFyIGFuY2hvciA9IHRoaXMuZ2V0QW5jaG9yKGkpO1xuXG4gICAgICAgICAgICB2YXIgcGF0aFR5cGUgPSAnJztcblxuICAgICAgICAgICAgaWYgKGkgPT09IDApIHtcbiAgICAgICAgICAgICAgICBwYXRoVHlwZSA9ICdNJztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGF0aFR5cGUgPSAnTCc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBUT0RPOiBzYXZlIHByZXZpb3VzIHBvaW50cyBhbmQgY2FsY3VsYXRlIG5ldyBwYXRoIGp1c3QgaWYgcG9pbnRzIGFyZSB1cGRhdGVkLCBhbmQgdGhlbiBzYXZlIGN1cnJlbnRzIHZhbHVlcyBhcyBwcmV2aW91c1xuXG4gICAgICAgICAgICB2YXIgdGFyZ2V0WCA9IGFuY2hvci54LCB0YXJnZXRZID0gYW5jaG9yLnk7XG4gICAgICAgICAgICBpZiAoaSA+IDAgJiYgaSA8IHRoaXMuZ2V0QW5jaG9yc0NvdW50KCkgLSAxKSB7XG4gICAgICAgICAgICAgICAgLy8gZ2V0IG5ldyB4LHlcbiAgICAgICAgICAgICAgICB2YXIgY3ggPSBhbmNob3IueCwgY3kgPSBhbmNob3IueTtcblxuICAgICAgICAgICAgICAgIC8vIHBpdm90IHBvaW50IG9mIHByZXYgbGluZVxuICAgICAgICAgICAgICAgIHZhciBBTyA9IHRoaXMuZ2V0TGluZUxlbmd0aChpIC0gMSk7XG4gICAgICAgICAgICAgICAgaWYgKEFPIDwgdGhpcy5yYWRpdXMpIHtcbiAgICAgICAgICAgICAgICAgICAgQU8gPSB0aGlzLnJhZGl1cztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdENvbmRpdGlvbkF2YWlsYWJsZSA9ICh0aGlzLmlzRGVmYXVsdENvbmRpdGlvbkF2YWlsYWJsZSB8fCAoaSA9PT0gMSAmJiBBTyA+IDEwKSk7XG5cbiAgICAgICAgICAgICAgICB2YXIgRUQgPSB0aGlzLmdldExpbmVMZW5ndGhZKGkgLSAxKSAqIHRoaXMucmFkaXVzIC8gQU87XG4gICAgICAgICAgICAgICAgdmFyIE9EID0gdGhpcy5nZXRMaW5lTGVuZ3RoWChpIC0gMSkgKiB0aGlzLnJhZGl1cyAvIEFPO1xuICAgICAgICAgICAgICAgIHRhcmdldFggPSBhbmNob3IueCAtIE9EO1xuICAgICAgICAgICAgICAgIHRhcmdldFkgPSBhbmNob3IueSAtIEVEO1xuXG4gICAgICAgICAgICAgICAgaWYgKEFPIDwgMiAqIHRoaXMucmFkaXVzICYmIGkgPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFggPSBhbmNob3IueCAtIHRoaXMuZ2V0TGluZUxlbmd0aFgoaSAtIDEpIC8gMjtcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WSA9IGFuY2hvci55IC0gdGhpcy5nZXRMaW5lTGVuZ3RoWShpIC0gMSkgLyAyO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIHBpdm90IHBvaW50IG9mIG5leHQgbGluZVxuICAgICAgICAgICAgICAgIHZhciBBTyA9IHRoaXMuZ2V0TGluZUxlbmd0aChpKTtcbiAgICAgICAgICAgICAgICBpZiAoQU8gPCB0aGlzLnJhZGl1cykge1xuICAgICAgICAgICAgICAgICAgICBBTyA9IHRoaXMucmFkaXVzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgRUQgPSB0aGlzLmdldExpbmVMZW5ndGhZKGkpICogdGhpcy5yYWRpdXMgLyBBTztcbiAgICAgICAgICAgICAgICB2YXIgT0QgPSB0aGlzLmdldExpbmVMZW5ndGhYKGkpICogdGhpcy5yYWRpdXMgLyBBTztcbiAgICAgICAgICAgICAgICB2YXIgbmV4dFNyY1ggPSBhbmNob3IueCArIE9EO1xuICAgICAgICAgICAgICAgIHZhciBuZXh0U3JjWSA9IGFuY2hvci55ICsgRUQ7XG5cbiAgICAgICAgICAgICAgICBpZiAoQU8gPCAyICogdGhpcy5yYWRpdXMgJiYgaSA8IHRoaXMuZ2V0QW5jaG9yc0NvdW50KCkgLSAyKSB7XG4gICAgICAgICAgICAgICAgICAgIG5leHRTcmNYID0gYW5jaG9yLnggKyB0aGlzLmdldExpbmVMZW5ndGhYKGkpIC8gMjtcbiAgICAgICAgICAgICAgICAgICAgbmV4dFNyY1kgPSBhbmNob3IueSArIHRoaXMuZ2V0TGluZUxlbmd0aFkoaSkgLyAyO1xuICAgICAgICAgICAgICAgICAgICA7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdmFyIGR4MCA9IChjeCAtIHRhcmdldFgpIC8gMyxcbiAgICAgICAgICAgICAgICAgICAgZHkwID0gKGN5IC0gdGFyZ2V0WSkgLyAzLFxuICAgICAgICAgICAgICAgICAgICBheCA9IGN4IC0gZHgwLFxuICAgICAgICAgICAgICAgICAgICBheSA9IGN5IC0gZHkwLFxuXG4gICAgICAgICAgICAgICAgICAgIGR4MSA9IChjeCAtIG5leHRTcmNYKSAvIDMsXG4gICAgICAgICAgICAgICAgICAgIGR5MSA9IChjeSAtIG5leHRTcmNZKSAvIDMsXG4gICAgICAgICAgICAgICAgICAgIGJ4ID0gY3ggLSBkeDEsXG4gICAgICAgICAgICAgICAgICAgIGJ5ID0gY3kgLSBkeTEsXG5cbiAgICAgICAgICAgICAgICAgICAgenggPSBuZXh0U3JjWCwgenkgPSBuZXh0U3JjWTtcblxuICAgICAgICAgICAgfSBlbHNlIGlmIChpID09PSAxICYmIHRoaXMuZ2V0QW5jaG9yc0NvdW50KCkgPT09IDIpIHtcbiAgICAgICAgICAgICAgICB2YXIgQU8gPSB0aGlzLmdldExpbmVMZW5ndGgoaSAtIDEpO1xuICAgICAgICAgICAgICAgIGlmIChBTyA8IHRoaXMucmFkaXVzKSB7XG4gICAgICAgICAgICAgICAgICAgIEFPID0gdGhpcy5yYWRpdXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0Q29uZGl0aW9uQXZhaWxhYmxlID0gKHRoaXMuaXNEZWZhdWx0Q29uZGl0aW9uQXZhaWxhYmxlIHx8IChpID09PSAxICYmIEFPID4gMTApKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gYW50aSBzbW9vdGhpbmdcbiAgICAgICAgICAgIGlmICh0aGlzLnN0cm9rZVdpZHRoICUgMiA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHRhcmdldFggKz0gMC41O1xuICAgICAgICAgICAgICAgIHRhcmdldFkgKz0gMC41O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBwYXRoLnB1c2goW3BhdGhUeXBlLCB0YXJnZXRYLCB0YXJnZXRZXSk7XG5cbiAgICAgICAgICAgIGlmIChpID4gMCAmJiBpIDwgdGhpcy5nZXRBbmNob3JzQ291bnQoKSAtIDEpIHtcbiAgICAgICAgICAgICAgICBwYXRoLnB1c2goWydDJywgYXgsIGF5LCBieCwgYnksIHp4LCB6eV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuY2xvc2VQYXRoKSB7XG4gICAgICAgICAgICBwYXRoLnB1c2goWydaJ10pO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wYXRoID0gcGF0aDtcbiAgICB9XG5cbiAgICB0cmFuc2Zvcm0odHJhbnNmb3JtYXRpb24pIHtcbiAgICAgICAgdGhpcy5lbGVtZW50LnRyYW5zZm9ybSh0cmFuc2Zvcm1hdGlvbik7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24oYXR0cnMpIHtcbiAgICAgICAgdGhpcy5lbGVtZW50LmF0dHIoYXR0cnMpO1xuICAgIH1cblxufVxuIl19
