/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var Observable_1 = require("rxjs/Observable");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var index_1 = require("../models/index");
var process_instance_variable_model_1 = require("./../models/process-instance-variable.model");
var ng2_activiti_tasklist_1 = require("ng2-activiti-tasklist");
var filter_process_model_1 = require("../models/filter-process.model");
var ActivitiProcessService = (function () {
    function ActivitiProcessService(apiService) {
        this.apiService = apiService;
    }
    ActivitiProcessService.prototype.getDeployedApplications = function (name) {
        var _this = this;
        return Observable_1.Observable.fromPromise(this.apiService.getInstance().activiti.appsApi.getAppDefinitions())
            .map(function (response) { return response.data.find(function (p) { return p.name === name; }); })
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.getProcessInstances = function (requestNode) {
        var _this = this;
        return Observable_1.Observable.fromPromise(this.apiService.getInstance().activiti.processApi.getProcessInstances(requestNode))
            .map(function (res) {
            if (requestNode.processDefinitionKey) {
                return res.data.filter(function (p) { return p.processDefinitionKey === requestNode.processDefinitionKey; });
            }
            else {
                return res.data;
            }
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.getProcessFilters = function (appId) {
        var _this = this;
        var filterOpts = appId ? {
            appId: appId
        } : {};
        return Observable_1.Observable.fromPromise(this.callApiGetUserProcessInstanceFilters(filterOpts))
            .map(function (response) {
            var filters = [];
            response.data.forEach(function (filter) {
                var filterModel = new filter_process_model_1.FilterProcessRepresentationModel(filter);
                filters.push(filterModel);
            });
            if (response && response.data && response.data.length === 0) {
                return _this.createDefaultFilters(appId);
            }
            return filters;
        })
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.createDefaultFilters = function (appId) {
        var filters = [];
        var involvedTasksFilter = this.getRunningFilterInstance(appId);
        this.addFilter(involvedTasksFilter);
        filters.push(involvedTasksFilter);
        var myTasksFilter = this.getCompletedFilterInstance(appId);
        this.addFilter(myTasksFilter);
        filters.push(myTasksFilter);
        var queuedTasksFilter = this.getAllFilterInstance(appId);
        this.addFilter(queuedTasksFilter);
        filters.push(queuedTasksFilter);
        return filters;
    };
    ActivitiProcessService.prototype.getRunningFilterInstance = function (appId) {
        return new filter_process_model_1.FilterProcessRepresentationModel({
            'name': 'Running',
            'appId': appId,
            'recent': true,
            'icon': 'glyphicon-random',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'running' }
        });
    };
    ActivitiProcessService.prototype.getCompletedFilterInstance = function (appId) {
        return new filter_process_model_1.FilterProcessRepresentationModel({
            'name': 'Completed',
            'appId': appId,
            'recent': false,
            'icon': 'glyphicon-ok-sign',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'completed' }
        });
    };
    ActivitiProcessService.prototype.getAllFilterInstance = function (appId) {
        return new filter_process_model_1.FilterProcessRepresentationModel({
            'name': 'All',
            'appId': appId,
            'recent': true,
            'icon': 'glyphicon-th',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'all' }
        });
    };
    ActivitiProcessService.prototype.addFilter = function (filter) {
        var _this = this;
        return Observable_1.Observable.fromPromise(this.callApiAddFilter(filter))
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.getProcess = function (id) {
        var _this = this;
        return Observable_1.Observable.fromPromise(this.apiService.getInstance().activiti.processApi.getProcessInstance(id))
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.getProcessTasks = function (id, state) {
        var _this = this;
        var taskOpts = state ? {
            processInstanceId: id,
            state: state
        } : {
            processInstanceId: id
        };
        return Observable_1.Observable.fromPromise(this.apiService.getInstance().activiti.taskApi.listTasks(taskOpts))
            .map(this.extractData)
            .map(function (tasks) { return tasks.map(function (task) {
            task.created = moment(task.created, 'YYYY-MM-DD').format();
            return task;
        }); })
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.getProcessInstanceComments = function (id) {
        var _this = this;
        return Observable_1.Observable.fromPromise(this.apiService.getInstance().activiti.commentsApi.getProcessInstanceComments(id))
            .map(function (res) { return res; })
            .map(function (response) {
            var comments = [];
            response.data.forEach(function (comment) {
                var user = new ng2_activiti_tasklist_1.User({
                    id: comment.createdBy.id,
                    email: comment.createdBy.email,
                    firstName: comment.createdBy.firstName,
                    lastName: comment.createdBy.lastName
                });
                comments.push(new ng2_activiti_tasklist_1.Comment(comment.id, comment.message, comment.created, user));
            });
            return comments;
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.addProcessInstanceComment = function (id, message) {
        var _this = this;
        return Observable_1.Observable.fromPromise(this.apiService.getInstance().activiti.commentsApi.addProcessInstanceComment({ message: message }, id))
            .map(function (response) {
            return new ng2_activiti_tasklist_1.Comment(response.id, response.message, response.created, response.createdBy);
        }).catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.getProcessDefinitions = function (appId) {
        var _this = this;
        var opts = appId ? {
            latest: true,
            appDefinitionId: appId
        } : {
            latest: true
        };
        return Observable_1.Observable.fromPromise(this.apiService.getInstance().activiti.processApi.getProcessDefinitions(opts))
            .map(this.extractData)
            .map(function (processDefs) { return processDefs.map(function (pd) { return new index_1.ProcessDefinitionRepresentation(pd); }); })
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.startProcess = function (processDefinitionId, name, outcome, startFormValues) {
        var _this = this;
        var startRequest = {
            name: name,
            processDefinitionId: processDefinitionId
        };
        if (outcome) {
            startRequest.outcome = outcome;
        }
        if (startFormValues) {
            startRequest.values = startFormValues;
        }
        return Observable_1.Observable.fromPromise(this.apiService.getInstance().activiti.processApi.startNewProcessInstance(startRequest))
            .map(function (pd) { return new index_1.ProcessInstance(pd); })
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.cancelProcess = function (processInstanceId) {
        var _this = this;
        return Observable_1.Observable.fromPromise(this.apiService.getInstance().activiti.processApi.deleteProcessInstance(processInstanceId))
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.getProcessInstanceVariables = function (processDefinitionId) {
        var _this = this;
        return Observable_1.Observable.fromPromise(this.apiService.getInstance().activiti.processInstanceVariablesApi.getProcessInstanceVariables(processDefinitionId))
            .map(function (processVars) { return processVars.map(function (pd) { return new process_instance_variable_model_1.ProcessInstanceVariable(pd); }); })
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.createOrUpdateProcessInstanceVariables = function (processDefinitionId, variables) {
        var _this = this;
        return Observable_1.Observable.fromPromise(this.apiService.getInstance().activiti.processInstanceVariablesApi.createOrUpdateProcessInstanceVariables(processDefinitionId, variables))
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.deleteProcessInstanceVariable = function (processDefinitionId, variableName) {
        var _this = this;
        return Observable_1.Observable.fromPromise(this.apiService.getInstance().activiti.processInstanceVariablesApi.deleteProcessInstanceVariable(processDefinitionId, variableName))
            .catch(function (err) { return _this.handleError(err); });
    };
    ActivitiProcessService.prototype.callApiGetUserProcessInstanceFilters = function (filterOpts) {
        return this.apiService.getInstance().activiti.userFiltersApi.getUserProcessInstanceFilters(filterOpts);
    };
    ActivitiProcessService.prototype.callApiAddFilter = function (filter) {
        return this.apiService.getInstance().activiti.userFiltersApi.createUserProcessInstanceFilter(filter);
    };
    ActivitiProcessService.prototype.extractData = function (res) {
        return res.data || {};
    };
    ActivitiProcessService.prototype.handleError = function (error) {
        return Observable_1.Observable.throw(error || 'Server error');
    };
    return ActivitiProcessService;
}());
ActivitiProcessService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [ng2_alfresco_core_1.AlfrescoApiService])
], ActivitiProcessService);
exports.ActivitiProcessService = ActivitiProcessService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL2FjdGl2aXRpLXByb2Nlc3Muc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7Ozs7Ozs7Ozs7O0FBRUgsc0NBQTJDO0FBQzNDLDhDQUE2QztBQUM3Qyx1REFBdUQ7QUFDdkQseUNBQW1GO0FBRW5GLCtGQUFzRjtBQUN0RiwrREFBMEc7QUFDMUcsdUVBQWtGO0FBS2xGLElBQWEsc0JBQXNCO0lBRS9CLGdDQUFvQixVQUE4QjtRQUE5QixlQUFVLEdBQVYsVUFBVSxDQUFvQjtJQUNsRCxDQUFDO0lBTUQsd0RBQXVCLEdBQXZCLFVBQXdCLElBQVk7UUFBcEMsaUJBSUM7UUFIRyxNQUFNLENBQUMsdUJBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUM7YUFDNUYsR0FBRyxDQUFDLFVBQUMsUUFBYSxJQUFLLE9BQUEsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFtQyxJQUFLLE9BQUEsQ0FBQyxDQUFDLElBQUksS0FBSyxJQUFJLEVBQWYsQ0FBZSxDQUFDLEVBQTVFLENBQTRFLENBQUM7YUFDcEcsS0FBSyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsS0FBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsRUFBckIsQ0FBcUIsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxvREFBbUIsR0FBbkIsVUFBb0IsV0FBK0M7UUFBbkUsaUJBU0M7UUFSRyxNQUFNLENBQUMsdUJBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQzVHLEdBQUcsQ0FBQyxVQUFDLEdBQVE7WUFDVixFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsb0JBQW9C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LDZCQUE2QixDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzNHLENBQUM7SUFFTyxpREFBZ0IsR0FBeEIsVUFBeUIsTUFBd0M7UUFDN0QsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQywrQkFBK0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN6RyxDQUFDO0lBRU8sNENBQVcsR0FBbkIsVUFBb0IsR0FBUTtRQUN4QixNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVPLDRDQUFXLEdBQW5CLFVBQW9CLEtBQVU7UUFDMUIsTUFBTSxDQUFDLHVCQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxjQUFjLENBQUMsQ0FBQztJQUNyRCxDQUFDO0lBQ0wsNkJBQUM7QUFBRCxDQXBRQSxBQW9RQyxJQUFBO0FBcFFZLHNCQUFzQjtJQURsQyxpQkFBVSxFQUFFO3FDQUd1QixzQ0FBa0I7R0FGekMsc0JBQXNCLENBb1FsQztBQXBRWSx3REFBc0IiLCJmaWxlIjoic2VydmljZXMvYWN0aXZpdGktcHJvY2Vzcy5zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTYgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMvT2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UgfSBmcm9tICduZzItYWxmcmVzY28tY29yZSc7XG5pbXBvcnQgeyBQcm9jZXNzSW5zdGFuY2UsIFByb2Nlc3NEZWZpbml0aW9uUmVwcmVzZW50YXRpb24gfSBmcm9tICcuLi9tb2RlbHMvaW5kZXgnO1xuaW1wb3J0IHsgUHJvY2Vzc0ZpbHRlclJlcXVlc3RSZXByZXNlbnRhdGlvbiB9IGZyb20gJy4uL21vZGVscy9wcm9jZXNzLWluc3RhbmNlLWZpbHRlci5tb2RlbCc7XG5pbXBvcnQgeyBQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZSB9IGZyb20gJy4vLi4vbW9kZWxzL3Byb2Nlc3MtaW5zdGFuY2UtdmFyaWFibGUubW9kZWwnO1xuaW1wb3J0IHsgQXBwRGVmaW5pdGlvblJlcHJlc2VudGF0aW9uTW9kZWwsIENvbW1lbnQsIFRhc2tEZXRhaWxzTW9kZWwsIFVzZXIgfSBmcm9tICduZzItYWN0aXZpdGktdGFza2xpc3QnO1xuaW1wb3J0IHsgRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvZmlsdGVyLXByb2Nlc3MubW9kZWwnO1xuXG5kZWNsYXJlIHZhciBtb21lbnQ6IGFueTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEFjdGl2aXRpUHJvY2Vzc1NlcnZpY2Uge1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXRyaWV2ZSBhbGwgZGVwbG95ZWQgYXBwc1xuICAgICAqIEByZXR1cm5zIHtPYnNlcnZhYmxlPGFueT59XG4gICAgICovXG4gICAgZ2V0RGVwbG95ZWRBcHBsaWNhdGlvbnMobmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxBcHBEZWZpbml0aW9uUmVwcmVzZW50YXRpb25Nb2RlbD4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5hcHBzQXBpLmdldEFwcERlZmluaXRpb25zKCkpXG4gICAgICAgICAgICAubWFwKChyZXNwb25zZTogYW55KSA9PiByZXNwb25zZS5kYXRhLmZpbmQoKHA6IEFwcERlZmluaXRpb25SZXByZXNlbnRhdGlvbk1vZGVsKSA9PiBwLm5hbWUgPT09IG5hbWUpKVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIGdldFByb2Nlc3NJbnN0YW5jZXMocmVxdWVzdE5vZGU6IFByb2Nlc3NGaWx0ZXJSZXF1ZXN0UmVwcmVzZW50YXRpb24pOiBPYnNlcnZhYmxlPFByb2Nlc3NJbnN0YW5jZVtdPiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnByb2Nlc3NBcGkuZ2V0UHJvY2Vzc0luc3RhbmNlcyhyZXF1ZXN0Tm9kZSkpXG4gICAgICAgICAgICAubWFwKChyZXM6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXF1ZXN0Tm9kZS5wcm9jZXNzRGVmaW5pdGlvbktleSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLmRhdGEuZmlsdGVyKHAgPT4gcC5wcm9jZXNzRGVmaW5pdGlvbktleSA9PT0gcmVxdWVzdE5vZGUucHJvY2Vzc0RlZmluaXRpb25LZXkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXMuZGF0YTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICB9XG5cbiAgICBnZXRQcm9jZXNzRmlsdGVycyhhcHBJZDogbnVtYmVyKTogT2JzZXJ2YWJsZTxGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbFtdPiB7XG4gICAgICAgIGxldCBmaWx0ZXJPcHRzID0gYXBwSWQgPyB7XG4gICAgICAgICAgICBhcHBJZDogYXBwSWRcbiAgICAgICAgfSA6IHt9O1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZSh0aGlzLmNhbGxBcGlHZXRVc2VyUHJvY2Vzc0luc3RhbmNlRmlsdGVycyhmaWx0ZXJPcHRzKSlcbiAgICAgICAgICAgIC5tYXAoKHJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgZmlsdGVyczogRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWxbXSA9IFtdO1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZm9yRWFjaCgoZmlsdGVyOiBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgZmlsdGVyTW9kZWwgPSBuZXcgRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWwoZmlsdGVyKTtcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVycy5wdXNoKGZpbHRlck1vZGVsKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UgJiYgcmVzcG9uc2UuZGF0YSAmJiByZXNwb25zZS5kYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVEZWZhdWx0RmlsdGVycyhhcHBJZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXJzO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYW5kIHJldHVybiB0aGUgZGVmYXVsdCBmaWx0ZXJzXG4gICAgICogQHBhcmFtIGFwcElkXG4gICAgICogQHJldHVybnMge0ZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWxbXX1cbiAgICAgKi9cbiAgICBwcml2YXRlIGNyZWF0ZURlZmF1bHRGaWx0ZXJzKGFwcElkOiBudW1iZXIpOiBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbFtdIHtcbiAgICAgICAgbGV0IGZpbHRlcnM6IEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsW10gPSBbXTtcblxuICAgICAgICBsZXQgaW52b2x2ZWRUYXNrc0ZpbHRlciA9IHRoaXMuZ2V0UnVubmluZ0ZpbHRlckluc3RhbmNlKGFwcElkKTtcbiAgICAgICAgdGhpcy5hZGRGaWx0ZXIoaW52b2x2ZWRUYXNrc0ZpbHRlcik7XG4gICAgICAgIGZpbHRlcnMucHVzaChpbnZvbHZlZFRhc2tzRmlsdGVyKTtcblxuICAgICAgICBsZXQgbXlUYXNrc0ZpbHRlciA9IHRoaXMuZ2V0Q29tcGxldGVkRmlsdGVySW5zdGFuY2UoYXBwSWQpO1xuICAgICAgICB0aGlzLmFkZEZpbHRlcihteVRhc2tzRmlsdGVyKTtcbiAgICAgICAgZmlsdGVycy5wdXNoKG15VGFza3NGaWx0ZXIpO1xuXG4gICAgICAgIGxldCBxdWV1ZWRUYXNrc0ZpbHRlciA9IHRoaXMuZ2V0QWxsRmlsdGVySW5zdGFuY2UoYXBwSWQpO1xuICAgICAgICB0aGlzLmFkZEZpbHRlcihxdWV1ZWRUYXNrc0ZpbHRlcik7XG4gICAgICAgIGZpbHRlcnMucHVzaChxdWV1ZWRUYXNrc0ZpbHRlcik7XG5cbiAgICAgICAgcmV0dXJuIGZpbHRlcnM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIGEgc3RhdGljIFJ1bm5pbmcgZmlsdGVyIGluc3RhbmNlXG4gICAgICogQHBhcmFtIGFwcElkXG4gICAgICogQHJldHVybnMge0ZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsfVxuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0UnVubmluZ0ZpbHRlckluc3RhbmNlKGFwcElkOiBudW1iZXIpOiBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCB7XG4gICAgICAgIHJldHVybiBuZXcgRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWwoe1xuICAgICAgICAgICAgJ25hbWUnOiAnUnVubmluZycsXG4gICAgICAgICAgICAnYXBwSWQnOiBhcHBJZCxcbiAgICAgICAgICAgICdyZWNlbnQnOiB0cnVlLFxuICAgICAgICAgICAgJ2ljb24nOiAnZ2x5cGhpY29uLXJhbmRvbScsXG4gICAgICAgICAgICAnZmlsdGVyJzogeydzb3J0JzogJ2NyZWF0ZWQtZGVzYycsICduYW1lJzogJycsICdzdGF0ZSc6ICdydW5uaW5nJ31cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIGEgc3RhdGljIENvbXBsZXRlZCBmaWx0ZXIgaW5zdGFuY2VcbiAgICAgKiBAcGFyYW0gYXBwSWRcbiAgICAgKiBAcmV0dXJucyB7RmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWx9XG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXRDb21wbGV0ZWRGaWx0ZXJJbnN0YW5jZShhcHBJZDogbnVtYmVyKTogRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWwge1xuICAgICAgICByZXR1cm4gbmV3IEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsKHtcbiAgICAgICAgICAgICduYW1lJzogJ0NvbXBsZXRlZCcsXG4gICAgICAgICAgICAnYXBwSWQnOiBhcHBJZCxcbiAgICAgICAgICAgICdyZWNlbnQnOiBmYWxzZSxcbiAgICAgICAgICAgICdpY29uJzogJ2dseXBoaWNvbi1vay1zaWduJyxcbiAgICAgICAgICAgICdmaWx0ZXInOiB7J3NvcnQnOiAnY3JlYXRlZC1kZXNjJywgJ25hbWUnOiAnJywgJ3N0YXRlJzogJ2NvbXBsZXRlZCd9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBhIHN0YXRpYyBBbGwgZmlsdGVyIGluc3RhbmNlXG4gICAgICogQHBhcmFtIGFwcElkXG4gICAgICogQHJldHVybnMge0ZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsfVxuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0QWxsRmlsdGVySW5zdGFuY2UoYXBwSWQ6IG51bWJlcik6IEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsIHtcbiAgICAgICAgcmV0dXJuIG5ldyBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCh7XG4gICAgICAgICAgICAnbmFtZSc6ICdBbGwnLFxuICAgICAgICAgICAgJ2FwcElkJzogYXBwSWQsXG4gICAgICAgICAgICAncmVjZW50JzogdHJ1ZSxcbiAgICAgICAgICAgICdpY29uJzogJ2dseXBoaWNvbi10aCcsXG4gICAgICAgICAgICAnZmlsdGVyJzogeydzb3J0JzogJ2NyZWF0ZWQtZGVzYycsICduYW1lJzogJycsICdzdGF0ZSc6ICdhbGwnfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBmaWx0ZXJcbiAgICAgKiBAcGFyYW0gZmlsdGVyIC0gRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWxcbiAgICAgKiBAcmV0dXJucyB7RmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWx9XG4gICAgICovXG4gICAgYWRkRmlsdGVyKGZpbHRlcjogRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWwpOiBPYnNlcnZhYmxlPEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsPiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuY2FsbEFwaUFkZEZpbHRlcihmaWx0ZXIpKVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIGdldFByb2Nlc3MoaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8UHJvY2Vzc0luc3RhbmNlPiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnByb2Nlc3NBcGkuZ2V0UHJvY2Vzc0luc3RhbmNlKGlkKSlcbiAgICAgICAgICAgIC5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICB9XG5cbiAgICBnZXRQcm9jZXNzVGFza3MoaWQ6IHN0cmluZywgc3RhdGU/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWxbXT4ge1xuICAgICAgICBsZXQgdGFza09wdHMgPSBzdGF0ZSA/IHtcbiAgICAgICAgICAgIHByb2Nlc3NJbnN0YW5jZUlkOiBpZCxcbiAgICAgICAgICAgIHN0YXRlOiBzdGF0ZVxuICAgICAgICB9IDoge1xuICAgICAgICAgICAgcHJvY2Vzc0luc3RhbmNlSWQ6IGlkXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tBcGkubGlzdFRhc2tzKHRhc2tPcHRzKSlcbiAgICAgICAgICAgIC5tYXAodGhpcy5leHRyYWN0RGF0YSlcbiAgICAgICAgICAgIC5tYXAodGFza3MgPT4gdGFza3MubWFwKCh0YXNrOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICB0YXNrLmNyZWF0ZWQgPSAgbW9tZW50KHRhc2suY3JlYXRlZCwgJ1lZWVktTU0tREQnKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGFzaztcbiAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHJpdmUgYWxsIHRoZSBwcm9jZXNzIGluc3RhbmNlJ3MgY29tbWVudHNcbiAgICAgKiBAcGFyYW0gaWQgLSBwcm9jZXNzIGluc3RhbmNlIElEXG4gICAgICogQHJldHVybnMgezxDb21tZW50W10+fVxuICAgICAqL1xuICAgIGdldFByb2Nlc3NJbnN0YW5jZUNvbW1lbnRzKGlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPENvbW1lbnRbXT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5jb21tZW50c0FwaS5nZXRQcm9jZXNzSW5zdGFuY2VDb21tZW50cyhpZCkpXG4gICAgICAgICAgICAubWFwKHJlcyA9PiByZXMpXG4gICAgICAgICAgICAubWFwKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGNvbW1lbnRzOiBDb21tZW50W10gPSBbXTtcbiAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZvckVhY2goKGNvbW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHVzZXIgPSBuZXcgVXNlcih7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogY29tbWVudC5jcmVhdGVkQnkuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbWFpbDogY29tbWVudC5jcmVhdGVkQnkuZW1haWwsXG4gICAgICAgICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IGNvbW1lbnQuY3JlYXRlZEJ5LmZpcnN0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiBjb21tZW50LmNyZWF0ZWRCeS5sYXN0TmFtZVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgY29tbWVudHMucHVzaChuZXcgQ29tbWVudChjb21tZW50LmlkLCBjb21tZW50Lm1lc3NhZ2UsIGNvbW1lbnQuY3JlYXRlZCwgdXNlcikpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHJldHVybiBjb21tZW50cztcbiAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGNvbW1lbnQgdG8gYSBwcm9jZXNzIGluc3RhbmNlXG4gICAgICogQHBhcmFtIGlkIC0gcHJvY2VzcyBpbnN0YW5jZSBJZFxuICAgICAqIEBwYXJhbSBtZXNzYWdlIC0gY29udGVudCBvZiB0aGUgY29tbWVudFxuICAgICAqIEByZXR1cm5zIHtDb21tZW50fVxuICAgICAqL1xuICAgIGFkZFByb2Nlc3NJbnN0YW5jZUNvbW1lbnQoaWQ6IHN0cmluZywgbWVzc2FnZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxDb21tZW50PiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKFxuICAgICAgICAgICAgdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkuY29tbWVudHNBcGkuYWRkUHJvY2Vzc0luc3RhbmNlQ29tbWVudCh7bWVzc2FnZTogbWVzc2FnZX0sIGlkKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLm1hcCgocmVzcG9uc2U6IENvbW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IENvbW1lbnQocmVzcG9uc2UuaWQsIHJlc3BvbnNlLm1lc3NhZ2UsIHJlc3BvbnNlLmNyZWF0ZWQsIHJlc3BvbnNlLmNyZWF0ZWRCeSk7XG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcblxuICAgIH1cblxuICAgIGdldFByb2Nlc3NEZWZpbml0aW9ucyhhcHBJZD86IHN0cmluZyk6IE9ic2VydmFibGU8UHJvY2Vzc0RlZmluaXRpb25SZXByZXNlbnRhdGlvbltdPiB7XG4gICAgICAgIGxldCBvcHRzID0gYXBwSWQgPyB7XG4gICAgICAgICAgICBsYXRlc3Q6IHRydWUsXG4gICAgICAgICAgICBhcHBEZWZpbml0aW9uSWQ6IGFwcElkXG4gICAgICAgIH0gOiB7XG4gICAgICAgICAgICBsYXRlc3Q6IHRydWVcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UoXG4gICAgICAgICAgICB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5wcm9jZXNzQXBpLmdldFByb2Nlc3NEZWZpbml0aW9ucyhvcHRzKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLm1hcCh0aGlzLmV4dHJhY3REYXRhKVxuICAgICAgICAgICAgLm1hcChwcm9jZXNzRGVmcyA9PiBwcm9jZXNzRGVmcy5tYXAoKHBkKSA9PiBuZXcgUHJvY2Vzc0RlZmluaXRpb25SZXByZXNlbnRhdGlvbihwZCkpKVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIHN0YXJ0UHJvY2Vzcyhwcm9jZXNzRGVmaW5pdGlvbklkOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgb3V0Y29tZT86IHN0cmluZywgc3RhcnRGb3JtVmFsdWVzPzogYW55KTogT2JzZXJ2YWJsZTxQcm9jZXNzSW5zdGFuY2U+IHtcbiAgICAgICAgbGV0IHN0YXJ0UmVxdWVzdDogYW55ID0ge1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIHByb2Nlc3NEZWZpbml0aW9uSWQ6IHByb2Nlc3NEZWZpbml0aW9uSWRcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKG91dGNvbWUpIHtcbiAgICAgICAgICAgIHN0YXJ0UmVxdWVzdC5vdXRjb21lID0gb3V0Y29tZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc3RhcnRGb3JtVmFsdWVzKSB7XG4gICAgICAgICAgICBzdGFydFJlcXVlc3QudmFsdWVzID0gc3RhcnRGb3JtVmFsdWVzO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKFxuICAgICAgICAgICAgdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkucHJvY2Vzc0FwaS5zdGFydE5ld1Byb2Nlc3NJbnN0YW5jZShzdGFydFJlcXVlc3QpXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAubWFwKChwZCkgPT4gbmV3IFByb2Nlc3NJbnN0YW5jZShwZCkpXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgY2FuY2VsUHJvY2Vzcyhwcm9jZXNzSW5zdGFuY2VJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKFxuICAgICAgICAgICAgdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkucHJvY2Vzc0FwaS5kZWxldGVQcm9jZXNzSW5zdGFuY2UocHJvY2Vzc0luc3RhbmNlSWQpXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgZ2V0UHJvY2Vzc0luc3RhbmNlVmFyaWFibGVzKHByb2Nlc3NEZWZpbml0aW9uSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8UHJvY2Vzc0luc3RhbmNlVmFyaWFibGVbXT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZShcbiAgICAgICAgICAgIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaS5nZXRQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXMocHJvY2Vzc0RlZmluaXRpb25JZClcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5tYXAoKHByb2Nlc3NWYXJzOiBhbnlbXSkgPT4gcHJvY2Vzc1ZhcnMubWFwKChwZCkgPT4gbmV3IFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlKHBkKSkpXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgY3JlYXRlT3JVcGRhdGVQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXMocHJvY2Vzc0RlZmluaXRpb25JZDogc3RyaW5nLCB2YXJpYWJsZXM6IFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlW10pOiBPYnNlcnZhYmxlPFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlW10+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UoXG4gICAgICAgICAgICB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5wcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXNBcGkuY3JlYXRlT3JVcGRhdGVQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXMocHJvY2Vzc0RlZmluaXRpb25JZCwgdmFyaWFibGVzKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIGRlbGV0ZVByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlKHByb2Nlc3NEZWZpbml0aW9uSWQ6IHN0cmluZywgdmFyaWFibGVOYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UoXG4gICAgICAgICAgICB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5wcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXNBcGkuZGVsZXRlUHJvY2Vzc0luc3RhbmNlVmFyaWFibGUocHJvY2Vzc0RlZmluaXRpb25JZCwgdmFyaWFibGVOYW1lKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaUdldFVzZXJQcm9jZXNzSW5zdGFuY2VGaWx0ZXJzKGZpbHRlck9wdHMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnVzZXJGaWx0ZXJzQXBpLmdldFVzZXJQcm9jZXNzSW5zdGFuY2VGaWx0ZXJzKGZpbHRlck9wdHMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaUFkZEZpbHRlcihmaWx0ZXI6IEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS51c2VyRmlsdGVyc0FwaS5jcmVhdGVVc2VyUHJvY2Vzc0luc3RhbmNlRmlsdGVyKGZpbHRlcik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBleHRyYWN0RGF0YShyZXM6IGFueSkge1xuICAgICAgICByZXR1cm4gcmVzLmRhdGEgfHwge307XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVFcnJvcihlcnJvcjogYW55KSB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLnRocm93KGVycm9yIHx8ICdTZXJ2ZXIgZXJyb3InKTtcbiAgICB9XG59XG4iXX0=
