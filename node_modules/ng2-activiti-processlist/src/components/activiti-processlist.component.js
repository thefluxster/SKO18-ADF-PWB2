/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var common_1 = require("@angular/common");
var core_1 = require("@angular/core");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var ng2_alfresco_datatable_1 = require("ng2-alfresco-datatable");
var process_instance_filter_model_1 = require("../models/process-instance-filter.model");
var activiti_process_service_1 = require("../services/activiti-process.service");
var ActivitiProcessInstanceListComponent = (function () {
    function ActivitiProcessInstanceListComponent(processService, translate) {
        this.processService = processService;
        this.translate = translate;
        this.rowClick = new core_1.EventEmitter();
        this.onSuccess = new core_1.EventEmitter();
        this.onError = new core_1.EventEmitter();
        this.defaultSchemaColumn = [
            { type: 'text', key: 'id', title: 'Id' },
            { type: 'text', key: 'name', title: 'Name', cssClass: 'full-width name-column', sortable: true },
            { type: 'text', key: 'started', title: 'Started', sortable: true },
            { type: 'text', key: 'startedBy.email', title: 'Started By', sortable: true }
        ];
        if (translate !== null) {
            translate.addTranslationFolder('ng2-activiti-processlist', 'node_modules/ng2-activiti-processlist/src');
        }
    }
    ActivitiProcessInstanceListComponent.prototype.ngOnInit = function () {
        if (!this.data) {
            this.data = this.initDefaultSchemaColumns();
        }
        if (this.appId) {
            this.reload();
        }
    };
    ActivitiProcessInstanceListComponent.prototype.ngOnChanges = function (changes) {
        if (this.isPropertyChanged(changes)) {
            this.reload();
        }
    };
    ActivitiProcessInstanceListComponent.prototype.isPropertyChanged = function (changes) {
        var changed = false;
        var appId = changes['appId'];
        var processDefinitionKey = changes['processDefinitionKey'];
        var state = changes['state'];
        var sort = changes['sort'];
        var name = changes['name'];
        if (appId && appId.currentValue) {
            changed = true;
        }
        else if (processDefinitionKey && processDefinitionKey.currentValue) {
            changed = true;
        }
        else if (state && state.currentValue) {
            changed = true;
        }
        else if (sort && sort.currentValue) {
            changed = true;
        }
        else if (name && name.currentValue) {
            changed = true;
        }
        return changed;
    };
    ActivitiProcessInstanceListComponent.prototype.reload = function () {
        this.requestNode = this.createRequestNode();
        this.load(this.requestNode);
    };
    ActivitiProcessInstanceListComponent.prototype.initDefaultSchemaColumns = function () {
        return new ng2_alfresco_datatable_1.ObjectDataTableAdapter([], this.defaultSchemaColumn);
    };
    ActivitiProcessInstanceListComponent.prototype.load = function (requestNode) {
        var _this = this;
        this.processService.getProcessInstances(requestNode)
            .subscribe(function (response) {
            var instancesRow = _this.createDataRow(response);
            _this.renderInstances(instancesRow);
            _this.selectFirst();
            _this.onSuccess.emit(response);
        }, function (error) {
            _this.onError.emit(error);
        });
    };
    ActivitiProcessInstanceListComponent.prototype.createDataRow = function (instances) {
        var instancesRows = [];
        instances.forEach(function (row) {
            instancesRows.push(new ng2_alfresco_datatable_1.ObjectDataRow({
                id: row.id,
                name: row.name,
                started: row.started,
                processDefinitionName: row.processDefinitionName
            }));
        });
        return instancesRows;
    };
    ActivitiProcessInstanceListComponent.prototype.renderInstances = function (instances) {
        instances = this.optimizeNames(instances);
        this.setDatatableSorting();
        this.data.setRows(instances);
    };
    ActivitiProcessInstanceListComponent.prototype.setDatatableSorting = function () {
        if (!this.sort) {
            return;
        }
        var sortingParams = this.sort.split('-');
        if (sortingParams.length === 2) {
            var sortColumn = sortingParams[0] === 'created' ? 'started' : sortingParams[0];
            var sortOrder = sortingParams[1];
            this.data.setSorting(new ng2_alfresco_datatable_1.DataSorting(sortColumn, sortOrder));
        }
    };
    ActivitiProcessInstanceListComponent.prototype.selectFirst = function () {
        if (!this.isListEmpty()) {
            var row = this.data.getRows()[0];
            this.data.selectedRow = row;
            this.currentInstanceId = row.getValue('id');
        }
        else {
            if (this.data) {
                this.data.selectedRow = null;
            }
            this.currentInstanceId = null;
        }
    };
    ActivitiProcessInstanceListComponent.prototype.getCurrentId = function () {
        return this.currentInstanceId;
    };
    ActivitiProcessInstanceListComponent.prototype.isListEmpty = function () {
        return this.data === undefined ||
            (this.data && this.data.getRows() && this.data.getRows().length === 0);
    };
    ActivitiProcessInstanceListComponent.prototype.onRowClick = function (event) {
        var item = event;
        this.currentInstanceId = item.value.getValue('id');
        this.rowClick.emit(this.currentInstanceId);
    };
    ActivitiProcessInstanceListComponent.prototype.optimizeNames = function (instances) {
        var _this = this;
        instances = instances.map(function (t) {
            t.obj.name = _this.getProcessNameOrDescription(t.obj, 'medium');
            return t;
        });
        return instances;
    };
    ActivitiProcessInstanceListComponent.prototype.getProcessNameOrDescription = function (processInstance, dateFormat) {
        var name = '';
        if (processInstance) {
            name = processInstance.name ||
                processInstance.processDefinitionName + ' - ' + this.getFormatDate(processInstance.started, dateFormat);
        }
        return name;
    };
    ActivitiProcessInstanceListComponent.prototype.getFormatDate = function (value, format) {
        var datePipe = new common_1.DatePipe('en-US');
        try {
            return datePipe.transform(value, format);
        }
        catch (err) {
            return '';
        }
    };
    ActivitiProcessInstanceListComponent.prototype.createRequestNode = function () {
        var requestNode = {
            appDefinitionId: this.appId,
            processDefinitionKey: this.processDefinitionKey,
            state: this.state,
            sort: this.sort
        };
        return new process_instance_filter_model_1.ProcessFilterRequestRepresentation(requestNode);
    };
    return ActivitiProcessInstanceListComponent;
}());
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiProcessInstanceListComponent.prototype, "appId", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiProcessInstanceListComponent.prototype, "processDefinitionKey", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiProcessInstanceListComponent.prototype, "state", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiProcessInstanceListComponent.prototype, "sort", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiProcessInstanceListComponent.prototype, "name", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", Object)
], ActivitiProcessInstanceListComponent.prototype, "data", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], ActivitiProcessInstanceListComponent.prototype, "rowClick", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], ActivitiProcessInstanceListComponent.prototype, "onSuccess", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], ActivitiProcessInstanceListComponent.prototype, "onError", void 0);
ActivitiProcessInstanceListComponent = __decorate([
    core_1.Component({
        selector: 'activiti-process-instance-list',
        moduleId: module.id,
        styles: ["alfresco-datatable >>> .column-header {     color: #232323;     font-size: 15px; }  alfresco-datatable >>> .data-cell {     cursor: pointer !important; }  alfresco-datatable >>> .cell-value{     width: 250px;     white-space: nowrap;     overflow: hidden;     text-overflow: ellipsis }"],
        template: "<div *ngIf=\"!requestNode\">{{ 'FILTERS.MESSAGES.NONE' | translate }}</div> <div *ngIf=\"requestNode\">     <div *ngIf=\"!isListEmpty()\">         <alfresco-datatable             [data]=\"data\"             (rowClick)=\"onRowClick($event)\">         </alfresco-datatable>     </div>     <div *ngIf=\"isListEmpty()\">         {{ 'PROCESSLIST.NONE' | translate }}     </div> </div>"
    }),
    __metadata("design:paramtypes", [activiti_process_service_1.ActivitiProcessService,
        ng2_alfresco_core_1.AlfrescoTranslationService])
], ActivitiProcessInstanceListComponent);
exports.ActivitiProcessInstanceListComponent = ActivitiProcessInstanceListComponent;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYWN0aXZpdGktcHJvY2Vzc2xpc3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRzs7Ozs7Ozs7Ozs7QUFFSCwwQ0FBMkM7QUFDM0Msc0NBQXlHO0FBQ3pHLHVEQUErRDtBQUMvRCxpRUFBNEg7QUFDNUgseUZBQTZGO0FBRTdGLGlGQUE4RTtBQVE5RSxJQUFhLG9DQUFvQztJQXdDN0MsOENBQW9CLGNBQXNDLEVBQ3RDLFNBQXFDO1FBRHJDLG1CQUFjLEdBQWQsY0FBYyxDQUF3QjtRQUN0QyxjQUFTLEdBQVQsU0FBUyxDQUE0QjtRQWxCekQsYUFBUSxHQUF5QixJQUFJLG1CQUFZLEVBQVUsQ0FBQztRQUc1RCxjQUFTLEdBQW9DLElBQUksbUJBQVksRUFBcUIsQ0FBQztRQUduRixZQUFPLEdBQXNCLElBQUksbUJBQVksRUFBTyxDQUFDO1FBSTdDLHdCQUFtQixHQUFVO1lBQ2pDLEVBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUM7WUFDdEMsRUFBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsd0JBQXdCLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBQztZQUM5RixFQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUM7WUFDaEUsRUFBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxpQkFBaUIsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUM7U0FDOUUsQ0FBQztRQUlFLEVBQUUsQ0FBQyxDQUFDLFNBQVMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLFNBQVMsQ0FBQyxvQkFBb0IsQ0FB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cG9uZW50cy9hY3Rpdml0aS1wcm9jZXNzbGlzdC5jb21wb25lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxNiBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBEYXRlUGlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgT25Jbml0LCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFsZnJlc2NvVHJhbnNsYXRpb25TZXJ2aWNlIH0gZnJvbSAnbmcyLWFsZnJlc2NvLWNvcmUnO1xuaW1wb3J0IHsgT2JqZWN0RGF0YVRhYmxlQWRhcHRlciwgRGF0YVRhYmxlQWRhcHRlciwgRGF0YVJvd0V2ZW50LCBPYmplY3REYXRhUm93LCBEYXRhU29ydGluZyB9IGZyb20gJ25nMi1hbGZyZXNjby1kYXRhdGFibGUnO1xuaW1wb3J0IHsgUHJvY2Vzc0ZpbHRlclJlcXVlc3RSZXByZXNlbnRhdGlvbiB9IGZyb20gJy4uL21vZGVscy9wcm9jZXNzLWluc3RhbmNlLWZpbHRlci5tb2RlbCc7XG5pbXBvcnQgeyBQcm9jZXNzSW5zdGFuY2UgfSBmcm9tICcuLi9tb2RlbHMvcHJvY2Vzcy1pbnN0YW5jZS5tb2RlbCc7XG5pbXBvcnQgeyBBY3Rpdml0aVByb2Nlc3NTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYWN0aXZpdGktcHJvY2Vzcy5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhY3Rpdml0aS1wcm9jZXNzLWluc3RhbmNlLWxpc3QnLFxuICAgIG1vZHVsZUlkOiBtb2R1bGUuaWQsXG4gICAgc3R5bGVzOiBbXCJhbGZyZXNjby1kYXRhdGFibGUgPj4+IC5jb2x1bW4taGVhZGVyIHsgICAgIGNvbG9yOiAjMjMyMzIzOyAgICAgZm9udC1zaXplOiAxNXB4OyB9ICBhbGZyZXNjby1kYXRhdGFibGUgPj4+IC5kYXRhLWNlbGwgeyAgICAgY3Vyc29yOiBwb2ludGVyICFpbXBvcnRhbnQ7IH0gIGFsZnJlc2NvLWRhdGF0YWJsZSA+Pj4gLmNlbGwtdmFsdWV7ICAgICB3aWR0aDogMjUwcHg7ICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOyAgICAgb3ZlcmZsb3c6IGhpZGRlbjsgICAgIHRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzIH1cIl0sXG4gICAgdGVtcGxhdGU6IFwiPGRpdiAqbmdJZj1cXFwiIXJlcXVlc3ROb2RlXFxcIj57eyAnRklMVEVSUy5NRVNTQUdFUy5OT05FJyB8IHRyYW5zbGF0ZSB9fTwvZGl2PiA8ZGl2ICpuZ0lmPVxcXCJyZXF1ZXN0Tm9kZVxcXCI+ICAgICA8ZGl2ICpuZ0lmPVxcXCIhaXNMaXN0RW1wdHkoKVxcXCI+ICAgICAgICAgPGFsZnJlc2NvLWRhdGF0YWJsZSAgICAgICAgICAgICBbZGF0YV09XFxcImRhdGFcXFwiICAgICAgICAgICAgIChyb3dDbGljayk9XFxcIm9uUm93Q2xpY2soJGV2ZW50KVxcXCI+ICAgICAgICAgPC9hbGZyZXNjby1kYXRhdGFibGU+ICAgICA8L2Rpdj4gICAgIDxkaXYgKm5nSWY9XFxcImlzTGlzdEVtcHR5KClcXFwiPiAgICAgICAgIHt7ICdQUk9DRVNTTElTVC5OT05FJyB8IHRyYW5zbGF0ZSB9fSAgICAgPC9kaXY+IDwvZGl2PlwiXG59KVxuZXhwb3J0IGNsYXNzIEFjdGl2aXRpUHJvY2Vzc0luc3RhbmNlTGlzdENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcblxuICAgIEBJbnB1dCgpXG4gICAgYXBwSWQ6IHN0cmluZztcblxuICAgIEBJbnB1dCgpXG4gICAgcHJvY2Vzc0RlZmluaXRpb25LZXk6IHN0cmluZztcblxuICAgIEBJbnB1dCgpXG4gICAgc3RhdGU6IHN0cmluZztcblxuICAgIEBJbnB1dCgpXG4gICAgc29ydDogc3RyaW5nO1xuXG4gICAgQElucHV0KClcbiAgICBuYW1lOiBzdHJpbmc7XG5cbiAgICByZXF1ZXN0Tm9kZTogUHJvY2Vzc0ZpbHRlclJlcXVlc3RSZXByZXNlbnRhdGlvbjtcblxuICAgIEBJbnB1dCgpXG4gICAgZGF0YTogRGF0YVRhYmxlQWRhcHRlcjtcblxuICAgIEBPdXRwdXQoKVxuICAgIHJvd0NsaWNrOiBFdmVudEVtaXR0ZXI8c3RyaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuXG4gICAgQE91dHB1dCgpXG4gICAgb25TdWNjZXNzOiBFdmVudEVtaXR0ZXI8UHJvY2Vzc0luc3RhbmNlW10+ID0gbmV3IEV2ZW50RW1pdHRlcjxQcm9jZXNzSW5zdGFuY2VbXT4oKTtcblxuICAgIEBPdXRwdXQoKVxuICAgIG9uRXJyb3I6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgICBjdXJyZW50SW5zdGFuY2VJZDogc3RyaW5nO1xuXG4gICAgcHJpdmF0ZSBkZWZhdWx0U2NoZW1hQ29sdW1uOiBhbnlbXSA9IFtcbiAgICAgICAge3R5cGU6ICd0ZXh0Jywga2V5OiAnaWQnLCB0aXRsZTogJ0lkJ30sXG4gICAgICAgIHt0eXBlOiAndGV4dCcsIGtleTogJ25hbWUnLCB0aXRsZTogJ05hbWUnLCBjc3NDbGFzczogJ2Z1bGwtd2lkdGggbmFtZS1jb2x1bW4nLCBzb3J0YWJsZTogdHJ1ZX0sXG4gICAgICAgIHt0eXBlOiAndGV4dCcsIGtleTogJ3N0YXJ0ZWQnLCB0aXRsZTogJ1N0YXJ0ZWQnLCBzb3J0YWJsZTogdHJ1ZX0sXG4gICAgICAgIHt0eXBlOiAndGV4dCcsIGtleTogJ3N0YXJ0ZWRCeS5lbWFpbCcsIHRpdGxlOiAnU3RhcnRlZCBCeScsIHNvcnRhYmxlOiB0cnVlfVxuICAgIF07XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHByb2Nlc3NTZXJ2aWNlOiBBY3Rpdml0aVByb2Nlc3NTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdHJhbnNsYXRlOiBBbGZyZXNjb1RyYW5zbGF0aW9uU2VydmljZSkge1xuICAgICAgICBpZiAodHJhbnNsYXRlICE9PSBudWxsKSB7XG4gICAgICAgICAgICB0cmFuc2xhdGUuYWRkVHJhbnNsYXRpb25Gb2xkZXIoJ25nMi1hY3Rpdml0aS1wcm9jZXNzbGlzdCcsICdub2RlX21vZHVsZXMvbmcyLWFjdGl2aXRpLXByb2Nlc3NsaXN0L3NyYycpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIGlmICghdGhpcy5kYXRhKSB7XG4gICAgICAgICAgICB0aGlzLmRhdGEgPSB0aGlzLmluaXREZWZhdWx0U2NoZW1hQ29sdW1ucygpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmFwcElkKSB7XG4gICAgICAgICAgICB0aGlzLnJlbG9hZCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgICAgICBpZiAodGhpcy5pc1Byb3BlcnR5Q2hhbmdlZChjaGFuZ2VzKSkge1xuICAgICAgICAgICAgdGhpcy5yZWxvYWQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaXNQcm9wZXJ0eUNoYW5nZWQoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IGJvb2xlYW4ge1xuICAgICAgICBsZXQgY2hhbmdlZDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgICAgIGxldCBhcHBJZCA9IGNoYW5nZXNbJ2FwcElkJ107XG4gICAgICAgIGxldCBwcm9jZXNzRGVmaW5pdGlvbktleSA9IGNoYW5nZXNbJ3Byb2Nlc3NEZWZpbml0aW9uS2V5J107XG4gICAgICAgIGxldCBzdGF0ZSA9IGNoYW5nZXNbJ3N0YXRlJ107XG4gICAgICAgIGxldCBzb3J0ID0gY2hhbmdlc1snc29ydCddO1xuICAgICAgICBsZXQgbmFtZSA9IGNoYW5nZXNbJ25hbWUnXTtcblxuICAgICAgICBpZiAoYXBwSWQgJiYgYXBwSWQuY3VycmVudFZhbHVlKSB7XG4gICAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmIChwcm9jZXNzRGVmaW5pdGlvbktleSAmJiBwcm9jZXNzRGVmaW5pdGlvbktleS5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YXRlICYmIHN0YXRlLmN1cnJlbnRWYWx1ZSkge1xuICAgICAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAoc29ydCAmJiBzb3J0LmN1cnJlbnRWYWx1ZSkge1xuICAgICAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAobmFtZSAmJiBuYW1lLmN1cnJlbnRWYWx1ZSkge1xuICAgICAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNoYW5nZWQ7XG4gICAgfVxuXG4gICAgcHVibGljIHJlbG9hZCgpIHtcbiAgICAgICAgdGhpcy5yZXF1ZXN0Tm9kZSA9IHRoaXMuY3JlYXRlUmVxdWVzdE5vZGUoKTtcbiAgICAgICAgdGhpcy5sb2FkKHRoaXMucmVxdWVzdE5vZGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBhbiBpbml0RGVmYXVsdFNjaGVtYUNvbHVtbnMgaW5zdGFuY2Ugd2l0aCB0aGUgZGVmYXVsdCBTY2hlbWEgQ29sdW1uXG4gICAgICogQHJldHVybnMge09iamVjdERhdGFUYWJsZUFkYXB0ZXJ9XG4gICAgICovXG4gICAgaW5pdERlZmF1bHRTY2hlbWFDb2x1bW5zKCk6IE9iamVjdERhdGFUYWJsZUFkYXB0ZXIge1xuICAgICAgICByZXR1cm4gbmV3IE9iamVjdERhdGFUYWJsZUFkYXB0ZXIoXG4gICAgICAgICAgICBbXSxcbiAgICAgICAgICAgIHRoaXMuZGVmYXVsdFNjaGVtYUNvbHVtblxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgbG9hZChyZXF1ZXN0Tm9kZTogUHJvY2Vzc0ZpbHRlclJlcXVlc3RSZXByZXNlbnRhdGlvbikge1xuICAgICAgICB0aGlzLnByb2Nlc3NTZXJ2aWNlLmdldFByb2Nlc3NJbnN0YW5jZXMocmVxdWVzdE5vZGUpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgaW5zdGFuY2VzUm93ID0gdGhpcy5jcmVhdGVEYXRhUm93KHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJJbnN0YW5jZXMoaW5zdGFuY2VzUm93KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RGaXJzdCgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uU3VjY2Vzcy5lbWl0KHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkVycm9yLmVtaXQoZXJyb3IpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhbiBhcnJheSBvZiBPYmplY3REYXRhUm93XG4gICAgICogQHBhcmFtIGluc3RhbmNlc1xuICAgICAqIEByZXR1cm5zIHtPYmplY3REYXRhUm93W119XG4gICAgICovXG4gICAgcHJpdmF0ZSBjcmVhdGVEYXRhUm93KGluc3RhbmNlczogYW55W10pOiBPYmplY3REYXRhUm93W10ge1xuICAgICAgICBsZXQgaW5zdGFuY2VzUm93czogT2JqZWN0RGF0YVJvd1tdID0gW107XG4gICAgICAgIGluc3RhbmNlcy5mb3JFYWNoKChyb3cpID0+IHtcbiAgICAgICAgICAgIGluc3RhbmNlc1Jvd3MucHVzaChuZXcgT2JqZWN0RGF0YVJvdyh7XG4gICAgICAgICAgICAgICAgaWQ6IHJvdy5pZCxcbiAgICAgICAgICAgICAgICBuYW1lOiByb3cubmFtZSxcbiAgICAgICAgICAgICAgICBzdGFydGVkOiByb3cuc3RhcnRlZCxcbiAgICAgICAgICAgICAgICBwcm9jZXNzRGVmaW5pdGlvbk5hbWU6IHJvdy5wcm9jZXNzRGVmaW5pdGlvbk5hbWVcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBpbnN0YW5jZXNSb3dzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbmRlciB0aGUgaW5zdGFuY2VzIGxpc3RcbiAgICAgKlxuICAgICAqIEBwYXJhbSBpbnN0YW5jZXNcbiAgICAgKi9cbiAgICBwcml2YXRlIHJlbmRlckluc3RhbmNlcyhpbnN0YW5jZXM6IGFueVtdKSB7XG4gICAgICAgIGluc3RhbmNlcyA9IHRoaXMub3B0aW1pemVOYW1lcyhpbnN0YW5jZXMpO1xuICAgICAgICB0aGlzLnNldERhdGF0YWJsZVNvcnRpbmcoKTtcbiAgICAgICAgdGhpcy5kYXRhLnNldFJvd3MoaW5zdGFuY2VzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTb3J0IHRoZSBkYXRhdGFibGUgcm93cyBiYXNlZCBvbiBjdXJyZW50IHZhbHVlIG9mICdzb3J0JyBwcm9wZXJ0eVxuICAgICAqL1xuICAgIHByaXZhdGUgc2V0RGF0YXRhYmxlU29ydGluZygpIHtcbiAgICAgICAgaWYgKCF0aGlzLnNvcnQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBsZXQgc29ydGluZ1BhcmFtczogc3RyaW5nW10gPSB0aGlzLnNvcnQuc3BsaXQoJy0nKTtcbiAgICAgICAgaWYgKHNvcnRpbmdQYXJhbXMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICBsZXQgc29ydENvbHVtbiA9IHNvcnRpbmdQYXJhbXNbMF0gPT09ICdjcmVhdGVkJyA/ICdzdGFydGVkJyA6IHNvcnRpbmdQYXJhbXNbMF07XG4gICAgICAgICAgICBsZXQgc29ydE9yZGVyID0gc29ydGluZ1BhcmFtc1sxXTtcbiAgICAgICAgICAgIHRoaXMuZGF0YS5zZXRTb3J0aW5nKG5ldyBEYXRhU29ydGluZyhzb3J0Q29sdW1uLCBzb3J0T3JkZXIpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNlbGVjdCB0aGUgZmlyc3QgaW5zdGFuY2Ugb2YgYSBsaXN0IGlmIHByZXNlbnRcbiAgICAgKi9cbiAgICBzZWxlY3RGaXJzdCgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzTGlzdEVtcHR5KCkpIHtcbiAgICAgICAgICAgIGxldCByb3cgPSB0aGlzLmRhdGEuZ2V0Um93cygpWzBdO1xuICAgICAgICAgICAgdGhpcy5kYXRhLnNlbGVjdGVkUm93ID0gcm93O1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50SW5zdGFuY2VJZCA9IHJvdy5nZXRWYWx1ZSgnaWQnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmRhdGEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRhdGEuc2VsZWN0ZWRSb3cgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5jdXJyZW50SW5zdGFuY2VJZCA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gdGhlIGN1cnJlbnQgaWRcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgICAqL1xuICAgIGdldEN1cnJlbnRJZCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50SW5zdGFuY2VJZDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiB0aGUgbGlzdCBpcyBlbXB0eVxuICAgICAqIEByZXR1cm5zIHtPYmplY3REYXRhVGFibGVBZGFwdGVyfGJvb2xlYW59XG4gICAgICovXG4gICAgaXNMaXN0RW1wdHkoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRhdGEgPT09IHVuZGVmaW5lZCB8fFxuICAgICAgICAgICAgKHRoaXMuZGF0YSAmJiB0aGlzLmRhdGEuZ2V0Um93cygpICYmIHRoaXMuZGF0YS5nZXRSb3dzKCkubGVuZ3RoID09PSAwKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBFbWl0IHRoZSBldmVudCByb3dDbGljayBwYXNzaW5nIHRoZSBjdXJyZW50IHRhc2sgaWQgd2hlbiB0aGUgcm93IGlzIGNsaWNrZWRcbiAgICAgKiBAcGFyYW0gZXZlbnRcbiAgICAgKi9cbiAgICBvblJvd0NsaWNrKGV2ZW50OiBEYXRhUm93RXZlbnQpIHtcbiAgICAgICAgbGV0IGl0ZW0gPSBldmVudDtcbiAgICAgICAgdGhpcy5jdXJyZW50SW5zdGFuY2VJZCA9IGl0ZW0udmFsdWUuZ2V0VmFsdWUoJ2lkJyk7XG4gICAgICAgIHRoaXMucm93Q2xpY2suZW1pdCh0aGlzLmN1cnJlbnRJbnN0YW5jZUlkKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPcHRpbWl6ZSBuYW1lIGZpZWxkXG4gICAgICogQHBhcmFtIGluc3RhbmNlc1xuICAgICAqIEByZXR1cm5zIHthbnlbXX1cbiAgICAgKi9cbiAgICBwcml2YXRlIG9wdGltaXplTmFtZXMoaW5zdGFuY2VzOiBhbnlbXSkge1xuICAgICAgICBpbnN0YW5jZXMgPSBpbnN0YW5jZXMubWFwKHQgPT4ge1xuICAgICAgICAgICAgdC5vYmoubmFtZSA9IHRoaXMuZ2V0UHJvY2Vzc05hbWVPckRlc2NyaXB0aW9uKHQub2JqLCAnbWVkaXVtJyk7XG4gICAgICAgICAgICByZXR1cm4gdDtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBpbnN0YW5jZXM7XG4gICAgfVxuXG4gICAgZ2V0UHJvY2Vzc05hbWVPckRlc2NyaXB0aW9uKHByb2Nlc3NJbnN0YW5jZSwgZGF0ZUZvcm1hdCk6IHN0cmluZyB7XG4gICAgICAgIGxldCBuYW1lID0gJyc7XG4gICAgICAgIGlmIChwcm9jZXNzSW5zdGFuY2UpIHtcbiAgICAgICAgICAgIG5hbWUgPSBwcm9jZXNzSW5zdGFuY2UubmFtZSB8fFxuICAgICAgICAgICAgICAgIHByb2Nlc3NJbnN0YW5jZS5wcm9jZXNzRGVmaW5pdGlvbk5hbWUgKyAnIC0gJyArIHRoaXMuZ2V0Rm9ybWF0RGF0ZShwcm9jZXNzSW5zdGFuY2Uuc3RhcnRlZCwgZGF0ZUZvcm1hdCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5hbWU7XG4gICAgfVxuXG4gICAgZ2V0Rm9ybWF0RGF0ZSh2YWx1ZSwgZm9ybWF0OiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IGRhdGVQaXBlID0gbmV3IERhdGVQaXBlKCdlbi1VUycpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0dXJuIGRhdGVQaXBlLnRyYW5zZm9ybSh2YWx1ZSwgZm9ybWF0KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZVJlcXVlc3ROb2RlKCkge1xuICAgICAgICBsZXQgcmVxdWVzdE5vZGUgPSB7XG4gICAgICAgICAgICBhcHBEZWZpbml0aW9uSWQ6IHRoaXMuYXBwSWQsXG4gICAgICAgICAgICBwcm9jZXNzRGVmaW5pdGlvbktleTogdGhpcy5wcm9jZXNzRGVmaW5pdGlvbktleSxcbiAgICAgICAgICAgIHN0YXRlOiB0aGlzLnN0YXRlLFxuICAgICAgICAgICAgc29ydDogdGhpcy5zb3J0XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBuZXcgUHJvY2Vzc0ZpbHRlclJlcXVlc3RSZXByZXNlbnRhdGlvbihyZXF1ZXN0Tm9kZSk7XG4gICAgfVxufVxuIl19
