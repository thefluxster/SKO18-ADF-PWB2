/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var forms_1 = require("@angular/forms");
var widget_component_1 = require("./../widget.component");
var moment = require("moment");
function dateCheck(c) {
    var startDate = moment(c.get('startDate').value);
    var endDate = moment(c.get('endDate').value);
    var result = startDate.isAfter(endDate);
    return result ? { 'greaterThan': true } : null;
}
var DateRangeWidget = DateRangeWidget_1 = (function (_super) {
    __extends(DateRangeWidget, _super);
    function DateRangeWidget(elementRef, formBuilder) {
        var _this = _super.call(this) || this;
        _this.elementRef = elementRef;
        _this.formBuilder = formBuilder;
        _this.dateRangeChanged = new core_1.EventEmitter();
        _this.debug = false;
        return _this;
    }
    DateRangeWidget.prototype.ngOnInit = function () {
        this.initForm();
        this.addAccessibilityLabelToDatePicker();
    };
    DateRangeWidget.prototype.initForm = function () {
        var _this = this;
        var startDateForm = this.field.value ? this.field.value.startDate : '';
        var startDate = this.convertToMomentDate(startDateForm);
        var endDateForm = this.field.value ? this.field.value.endDate : '';
        var endDate = this.convertToMomentDate(endDateForm);
        var startDateControl = new forms_1.FormControl(startDate);
        startDateControl.setValidators(forms_1.Validators.required);
        this.dateRange.addControl('startDate', startDateControl);
        var endDateControl = new forms_1.FormControl(endDate);
        endDateControl.setValidators(forms_1.Validators.required);
        this.dateRange.addControl('endDate', endDateControl);
        this.dateRange.setValidators(dateCheck);
        this.dateRange.valueChanges.subscribe(function (data) { return _this.onGroupValueChanged(data); });
        this.initSartDateDialog(startDate);
        this.initEndDateDialog(endDate);
    };
    DateRangeWidget.prototype.initSartDateDialog = function (date) {
        var _this = this;
        var settings = {
            type: 'date',
            past: moment().subtract(100, 'years'),
            future: moment().add(100, 'years')
        };
        settings.init = moment(date, DateRangeWidget_1.FORMAT_DATE_ACTIVITI);
        this.dialogStart = new mdDateTimePicker.default(settings);
        this.dialogStart.trigger = this.startElement.nativeElement;
        var startDateButton = document.getElementById('startDateButton');
        startDateButton.addEventListener('click', function () {
            _this.dialogStart.toggle();
        });
    };
    DateRangeWidget.prototype.addAccessibilityLabelToDatePicker = function () {
        var left = document.querySelector('#mddtp-date__left');
        if (left) {
            left.appendChild(this.createCustomElement('date left'));
        }
        var right = document.querySelector('#mddtp-date__right');
        if (right) {
            right.appendChild(this.createCustomElement('date right'));
        }
        var cancel = document.querySelector('#mddtp-date__cancel');
        if (cancel) {
            cancel.appendChild(this.createCustomElement('date cancel'));
        }
        var ok = document.querySelector('#mddtp-date__ok');
        if (ok) {
            ok.appendChild(this.createCustomElement('date ok'));
        }
    };
    DateRangeWidget.prototype.createCustomElement = function (text) {
        var span = document.createElement('span');
        span.style.visibility = 'hidden';
        var rightSpanText = document.createTextNode(text);
        span.appendChild(rightSpanText);
        return span;
    };
    DateRangeWidget.prototype.initEndDateDialog = function (date) {
        var _this = this;
        var settings = {
            type: 'date',
            past: moment().subtract(100, 'years'),
            future: moment().add(100, 'years')
        };
        settings.init = moment(date, DateRangeWidget_1.FORMAT_DATE_ACTIVITI);
        this.dialogEnd = new mdDateTimePicker.default(settings);
        this.dialogEnd.trigger = this.endElement.nativeElement;
        var endDateButton = document.getElementById('endDateButton');
        endDateButton.addEventListener('click', function () {
            _this.dialogEnd.toggle();
        });
    };
    DateRangeWidget.prototype.onOkStart = function (inputEl) {
        var date = this.dialogStart.time.format(DateRangeWidget_1.FORMAT_DATE_ACTIVITI);
        this.dateRange.patchValue({
            startDate: date
        });
        var materialElemen = inputEl.parentElement;
        if (materialElemen) {
            materialElemen.MaterialTextfield.change(date);
        }
    };
    DateRangeWidget.prototype.onOkEnd = function (inputEl) {
        var date = this.dialogEnd.time.format(DateRangeWidget_1.FORMAT_DATE_ACTIVITI);
        this.dateRange.patchValue({
            endDate: date
        });
        var materialElemen = inputEl.parentElement;
        if (materialElemen) {
            materialElemen.MaterialTextfield.change(date);
        }
    };
    DateRangeWidget.prototype.onGroupValueChanged = function (data) {
        if (this.dateRange.valid) {
            var dateStart = this.convertToMomentDateWithTime(this.dateRange.controls['startDate'].value);
            var endStart = this.convertToMomentDateWithTime(this.dateRange.controls['endDate'].value);
            this.dateRangeChanged.emit({ startDate: dateStart, endDate: endStart });
        }
    };
    DateRangeWidget.prototype.convertToMomentDateWithTime = function (date) {
        return moment(date, DateRangeWidget_1.FORMAT_DATE_ACTIVITI, true).format(DateRangeWidget_1.FORMAT_DATE_ACTIVITI) + 'T00:00:00.000Z';
    };
    DateRangeWidget.prototype.convertToMomentDate = function (date) {
        if (date) {
            return moment(date).format(DateRangeWidget_1.FORMAT_DATE_ACTIVITI);
        }
        else {
            return moment().format(DateRangeWidget_1.FORMAT_DATE_ACTIVITI);
        }
    };
    DateRangeWidget.prototype.ngOnDestroy = function () {
    };
    return DateRangeWidget;
}(widget_component_1.WidgetComponent));
DateRangeWidget.FORMAT_DATE_ACTIVITI = 'YYYY-MM-DD';
__decorate([
    core_1.ViewChild('startElement'),
    __metadata("design:type", Object)
], DateRangeWidget.prototype, "startElement", void 0);
__decorate([
    core_1.ViewChild('endElement'),
    __metadata("design:type", Object)
], DateRangeWidget.prototype, "endElement", void 0);
__decorate([
    core_1.Input('group'),
    __metadata("design:type", forms_1.FormGroup)
], DateRangeWidget.prototype, "dateRange", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", Object)
], DateRangeWidget.prototype, "field", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], DateRangeWidget.prototype, "dateRangeChanged", void 0);
DateRangeWidget = DateRangeWidget_1 = __decorate([
    core_1.Component({
        moduleId: module.id,
        selector: 'date-range-widget',
        template: "<label>{{field.nameKey | translate}}</label><br> <div [formGroup]=\"dateRange\">     <small *ngIf=\"dateRange && dateRange.errors && dateRange.errors.greaterThan\" [hidden]=\"!dateRange.errors\" class=\"text-danger\">         Start date must be less than End date     </small>     <div class=\"mdl-grid\">         <div class=\"mdl-cell mdl-cell--4-col\">             <div class=\"mdl-textfield mdl-js-textfield mdl-textfield--floating-label\">                 <input class=\"mdl-textfield__input\"                        formControlName=\"startDate\"                        type=\"text\"                        (onOk)=\"onOkStart(startElement)\"                        id=\"startDateInput\" #startElement>                 <label class=\"mdl-textfield__label\" for=\"startDateInput\">Start Date</label>                 <small [hidden]=\"dateRange && dateRange.controls.startDate && dateRange.controls.startDate.valid\" class=\"text-danger\">                     Start is required                 </small>             </div>         </div>         <div class=\"mdl-cell mdl-cell--2-col\">             <button id=\"startDateButton\" class=\"mdl-button mdl-js-button mdl-button--fab date-picker-mdl\">                 <i class=\"material-icons\">date_range</i>             </button>         </div>         <div class=\"mdl-cell mdl-cell--4-col\">             <div class=\"mdl-textfield mdl-js-textfield mdl-textfield--floating-label\">                 <input class=\"mdl-textfield__input\"                        formControlName=\"endDate\"                        type=\"text\"                        (onOk)=\"onOkEnd(endElement)\"                        id=\"endDateInput\" #endElement>                 <label class=\"mdl-textfield__label\" for=\"endDateInput\">End Date</label>             </div>         </div>         <div class=\"mdl-cell mdl-cell--2-col\">             <button id=\"endDateButton\" class=\"mdl-button mdl-js-button mdl-button--fab date-picker-mdl\">                 <i class=\"material-icons\">date_range</i>             </button>         </div>     </div> </div> <div *ngIf=\"debug\">     <p>FormGroup : {{dateRange && dateRange.value | json }}</p>     <p>FormGroup valid : {{dateRange && dateRange.valid }}</p>     <p>FormGroup status : {{dateRange && dateRange.errors | json }}</p>     <p>FormGroup start status : {{dateRange && dateRange.controls.startDate && dateRange.controls.startDate.errors | json }}</p>     <p>FormGroup end status: {{dateRange && dateRange.controls.endDate.errors | json }}</p> </div>",
        styles: [".date-picker-mdl {     margin-left: 20px; }"]
    }),
    __metadata("design:paramtypes", [core_1.ElementRef,
        forms_1.FormBuilder])
], DateRangeWidget);
exports.DateRangeWidget = DateRangeWidget;
var DateRangeWidget_1;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvd2lkZ2V0cy9kYXRlLXJhbmdlL2RhdGUtcmFuZ2Uud2lkZ2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRzs7Ozs7Ozs7Ozs7Ozs7OztBQUVILHNDQUE4RjtBQUM5Rix3Q0FBa0c7QUFDbEcsMERBQXdEO0FBQ3hELCtCQUFpQztBQUVqQyxtQkFBbUIsQ0FBa0I7SUFDakMsSUFBSSxTQUFTLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDakQsSUFBSSxPQUFPLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0MsSUFBSSxNQUFNLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN4QyxNQUFNLENBQUMsTUFBTSxHQUFHLEVBQUMsYUFBYSxFQUFFLElBQUksRUFBQyxHQUFHLElBQUksQ0FBQztBQUNqRCxDQUFDO0FBVUQsSUFBYSxlQUFlO0lBQVMsbUNBQWU7SUF5QmhELHlCQUFtQixVQUFzQixFQUNyQixXQUF3QjtRQUQ1QyxZQUVJLGlCQUFPLFNBQ1Y7UUFIa0IsZ0JBQVUsR0FBVixVQUFVLENBQVk7UUFDckIsaUJBQVcsR0FBWCxXQUFXLENBQWE7UUFUNUMsc0JBQWdCLEdBQXNCLElBQUksbUJBQVksRUFBTyxDQUFDO1FBRTlELFdBQUssR0FBWSxLQUFLLENBQUM7O0lBU3ZCLENBQUM7SUFFRCxrQ0FBUSxHQUFSO1FBQ0ksSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxpQ0FBaUMsRUFBRSxDQUFDO0lBQzdDLENBQUM7SUFFRCxrQ0FBUSxHQUFSO1FBQUEsaUJBbUJDO1FBbEJHLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFL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QUMsTUFBTSxDQUFDLGlCQUFlLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUNqRSxDQUFDO0lBQ0wsQ0FBQztJQUVELHFDQUFXLEdBQVg7SUFFQSxDQUFDO0lBQ0wsc0JBQUM7QUFBRCxDQXhLQSxBQXdLQyxDQXhLb0Msa0NBQWUsR0F3S25EO0FBdEtpQixvQ0FBb0IsR0FBWSxZQUFZLENBQUM7QUFHM0Q7SUFEQyxnQkFBUyxDQUFDLGNBQWMsQ0FBQzs7cURBQ1I7QUFHbEI7SUFEQyxnQkFBUyxDQUFDLFlBQVksQ0FBQzs7bURBQ1I7QUFHaEI7SUFEQyxZQUFLLENBQUMsT0FBTyxDQUFDOzhCQUNHLGlCQUFTO2tEQUFDO0FBRzVCO0lBREMsWUFBSyxFQUFFOzs4Q0FDRztBQUdYO0lBREMsYUFBTSxFQUFFOzhCQUNTLG1CQUFZO3lEQUFnQztBQWpCckQsZUFBZTtJQU4zQixnQkFBUyxDQUFDO1FBQ1AsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1FBQ25CLFFBQVEsRUFBRSxtQkFBbUI7UUFDN0IsUUFBUSxFQUFFLG8rRUFBbytFO1FBQzkrRSxNQUFNLEVBQUUsQ0FBQyw2Q0FBNkMsQ0FBQztLQUMxRCxDQUFDO3FDQTBCaUMsaUJBQVU7UUFDUixtQkFBVztHQTFCbkMsZUFBZSxDQXdLM0I7QUF4S1ksMENBQWUiLCJmaWxlIjoiY29tcG9uZW50cy93aWRnZXRzL2RhdGUtcmFuZ2UvZGF0ZS1yYW5nZS53aWRnZXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxNiBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgVmlld0NoaWxkLCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wsIEZvcm1Hcm91cCwgRm9ybUJ1aWxkZXIsIEZvcm1Db250cm9sLCBWYWxpZGF0b3JzIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgV2lkZ2V0Q29tcG9uZW50IH0gZnJvbSAnLi8uLi93aWRnZXQuY29tcG9uZW50JztcbmltcG9ydCAqIGFzIG1vbWVudCBmcm9tICdtb21lbnQnO1xuXG5mdW5jdGlvbiBkYXRlQ2hlY2soYzogQWJzdHJhY3RDb250cm9sKSB7XG4gICAgbGV0IHN0YXJ0RGF0ZSA9IG1vbWVudChjLmdldCgnc3RhcnREYXRlJykudmFsdWUpO1xuICAgIGxldCBlbmREYXRlID0gbW9tZW50KGMuZ2V0KCdlbmREYXRlJykudmFsdWUpO1xuICAgIGxldCByZXN1bHQgPSBzdGFydERhdGUuaXNBZnRlcihlbmREYXRlKTtcbiAgICByZXR1cm4gcmVzdWx0ID8geydncmVhdGVyVGhhbic6IHRydWV9IDogbnVsbDtcbn1cblxuZGVjbGFyZSBsZXQgbWREYXRlVGltZVBpY2tlcjogYW55O1xuXG5AQ29tcG9uZW50KHtcbiAgICBtb2R1bGVJZDogbW9kdWxlLmlkLFxuICAgIHNlbGVjdG9yOiAnZGF0ZS1yYW5nZS13aWRnZXQnLFxuICAgIHRlbXBsYXRlOiBcIjxsYWJlbD57e2ZpZWxkLm5hbWVLZXkgfCB0cmFuc2xhdGV9fTwvbGFiZWw+PGJyPiA8ZGl2IFtmb3JtR3JvdXBdPVxcXCJkYXRlUmFuZ2VcXFwiPiAgICAgPHNtYWxsICpuZ0lmPVxcXCJkYXRlUmFuZ2UgJiYgZGF0ZVJhbmdlLmVycm9ycyAmJiBkYXRlUmFuZ2UuZXJyb3JzLmdyZWF0ZXJUaGFuXFxcIiBbaGlkZGVuXT1cXFwiIWRhdGVSYW5nZS5lcnJvcnNcXFwiIGNsYXNzPVxcXCJ0ZXh0LWRhbmdlclxcXCI+ICAgICAgICAgU3RhcnQgZGF0ZSBtdXN0IGJlIGxlc3MgdGhhbiBFbmQgZGF0ZSAgICAgPC9zbWFsbD4gICAgIDxkaXYgY2xhc3M9XFxcIm1kbC1ncmlkXFxcIj4gICAgICAgICA8ZGl2IGNsYXNzPVxcXCJtZGwtY2VsbCBtZGwtY2VsbC0tNC1jb2xcXFwiPiAgICAgICAgICAgICA8ZGl2IGNsYXNzPVxcXCJtZGwtdGV4dGZpZWxkIG1kbC1qcy10ZXh0ZmllbGQgbWRsLXRleHRmaWVsZC0tZmxvYXRpbmctbGFiZWxcXFwiPiAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPVxcXCJtZGwtdGV4dGZpZWxkX19pbnB1dFxcXCIgICAgICAgICAgICAgICAgICAgICAgICBmb3JtQ29udHJvbE5hbWU9XFxcInN0YXJ0RGF0ZVxcXCIgICAgICAgICAgICAgICAgICAgICAgICB0eXBlPVxcXCJ0ZXh0XFxcIiAgICAgICAgICAgICAgICAgICAgICAgIChvbk9rKT1cXFwib25Pa1N0YXJ0KHN0YXJ0RWxlbWVudClcXFwiICAgICAgICAgICAgICAgICAgICAgICAgaWQ9XFxcInN0YXJ0RGF0ZUlucHV0XFxcIiAjc3RhcnRFbGVtZW50PiAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPVxcXCJtZGwtdGV4dGZpZWxkX19sYWJlbFxcXCIgZm9yPVxcXCJzdGFydERhdGVJbnB1dFxcXCI+U3RhcnQgRGF0ZTwvbGFiZWw+ICAgICAgICAgICAgICAgICA8c21hbGwgW2hpZGRlbl09XFxcImRhdGVSYW5nZSAmJiBkYXRlUmFuZ2UuY29udHJvbHMuc3RhcnREYXRlICYmIGRhdGVSYW5nZS5jb250cm9scy5zdGFydERhdGUudmFsaWRcXFwiIGNsYXNzPVxcXCJ0ZXh0LWRhbmdlclxcXCI+ICAgICAgICAgICAgICAgICAgICAgU3RhcnQgaXMgcmVxdWlyZWQgICAgICAgICAgICAgICAgIDwvc21hbGw+ICAgICAgICAgICAgIDwvZGl2PiAgICAgICAgIDwvZGl2PiAgICAgICAgIDxkaXYgY2xhc3M9XFxcIm1kbC1jZWxsIG1kbC1jZWxsLS0yLWNvbFxcXCI+ICAgICAgICAgICAgIDxidXR0b24gaWQ9XFxcInN0YXJ0RGF0ZUJ1dHRvblxcXCIgY2xhc3M9XFxcIm1kbC1idXR0b24gbWRsLWpzLWJ1dHRvbiBtZGwtYnV0dG9uLS1mYWIgZGF0ZS1waWNrZXItbWRsXFxcIj4gICAgICAgICAgICAgICAgIDxpIGNsYXNzPVxcXCJtYXRlcmlhbC1pY29uc1xcXCI+ZGF0ZV9yYW5nZTwvaT4gICAgICAgICAgICAgPC9idXR0b24+ICAgICAgICAgPC9kaXY+ICAgICAgICAgPGRpdiBjbGFzcz1cXFwibWRsLWNlbGwgbWRsLWNlbGwtLTQtY29sXFxcIj4gICAgICAgICAgICAgPGRpdiBjbGFzcz1cXFwibWRsLXRleHRmaWVsZCBtZGwtanMtdGV4dGZpZWxkIG1kbC10ZXh0ZmllbGQtLWZsb2F0aW5nLWxhYmVsXFxcIj4gICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz1cXFwibWRsLXRleHRmaWVsZF9faW5wdXRcXFwiICAgICAgICAgICAgICAgICAgICAgICAgZm9ybUNvbnRyb2xOYW1lPVxcXCJlbmREYXRlXFxcIiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU9XFxcInRleHRcXFwiICAgICAgICAgICAgICAgICAgICAgICAgKG9uT2spPVxcXCJvbk9rRW5kKGVuZEVsZW1lbnQpXFxcIiAgICAgICAgICAgICAgICAgICAgICAgIGlkPVxcXCJlbmREYXRlSW5wdXRcXFwiICNlbmRFbGVtZW50PiAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPVxcXCJtZGwtdGV4dGZpZWxkX19sYWJlbFxcXCIgZm9yPVxcXCJlbmREYXRlSW5wdXRcXFwiPkVuZCBEYXRlPC9sYWJlbD4gICAgICAgICAgICAgPC9kaXY+ICAgICAgICAgPC9kaXY+ICAgICAgICAgPGRpdiBjbGFzcz1cXFwibWRsLWNlbGwgbWRsLWNlbGwtLTItY29sXFxcIj4gICAgICAgICAgICAgPGJ1dHRvbiBpZD1cXFwiZW5kRGF0ZUJ1dHRvblxcXCIgY2xhc3M9XFxcIm1kbC1idXR0b24gbWRsLWpzLWJ1dHRvbiBtZGwtYnV0dG9uLS1mYWIgZGF0ZS1waWNrZXItbWRsXFxcIj4gICAgICAgICAgICAgICAgIDxpIGNsYXNzPVxcXCJtYXRlcmlhbC1pY29uc1xcXCI+ZGF0ZV9yYW5nZTwvaT4gICAgICAgICAgICAgPC9idXR0b24+ICAgICAgICAgPC9kaXY+ICAgICA8L2Rpdj4gPC9kaXY+IDxkaXYgKm5nSWY9XFxcImRlYnVnXFxcIj4gICAgIDxwPkZvcm1Hcm91cCA6IHt7ZGF0ZVJhbmdlICYmIGRhdGVSYW5nZS52YWx1ZSB8IGpzb24gfX08L3A+ICAgICA8cD5Gb3JtR3JvdXAgdmFsaWQgOiB7e2RhdGVSYW5nZSAmJiBkYXRlUmFuZ2UudmFsaWQgfX08L3A+ICAgICA8cD5Gb3JtR3JvdXAgc3RhdHVzIDoge3tkYXRlUmFuZ2UgJiYgZGF0ZVJhbmdlLmVycm9ycyB8IGpzb24gfX08L3A+ICAgICA8cD5Gb3JtR3JvdXAgc3RhcnQgc3RhdHVzIDoge3tkYXRlUmFuZ2UgJiYgZGF0ZVJhbmdlLmNvbnRyb2xzLnN0YXJ0RGF0ZSAmJiBkYXRlUmFuZ2UuY29udHJvbHMuc3RhcnREYXRlLmVycm9ycyB8IGpzb24gfX08L3A+ICAgICA8cD5Gb3JtR3JvdXAgZW5kIHN0YXR1czoge3tkYXRlUmFuZ2UgJiYgZGF0ZVJhbmdlLmNvbnRyb2xzLmVuZERhdGUuZXJyb3JzIHwganNvbiB9fTwvcD4gPC9kaXY+XCIsXG4gICAgc3R5bGVzOiBbXCIuZGF0ZS1waWNrZXItbWRsIHsgICAgIG1hcmdpbi1sZWZ0OiAyMHB4OyB9XCJdXG59KVxuZXhwb3J0IGNsYXNzIERhdGVSYW5nZVdpZGdldCBleHRlbmRzIFdpZGdldENvbXBvbmVudCB7XG5cbiAgICBwdWJsaWMgc3RhdGljIEZPUk1BVF9EQVRFX0FDVElWSVRJOiBzdHJpbmcgPSAgJ1lZWVktTU0tREQnO1xuXG4gICAgQFZpZXdDaGlsZCgnc3RhcnRFbGVtZW50JylcbiAgICBzdGFydEVsZW1lbnQ6IGFueTtcblxuICAgIEBWaWV3Q2hpbGQoJ2VuZEVsZW1lbnQnKVxuICAgIGVuZEVsZW1lbnQ6IGFueTtcblxuICAgIEBJbnB1dCgnZ3JvdXAnKVxuICAgIHB1YmxpYyBkYXRlUmFuZ2U6IEZvcm1Hcm91cDtcblxuICAgIEBJbnB1dCgpXG4gICAgZmllbGQ6IGFueTtcblxuICAgIEBPdXRwdXQoKVxuICAgIGRhdGVSYW5nZUNoYW5nZWQ6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgICBkZWJ1ZzogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgZGlhbG9nU3RhcnQ6IGFueTtcblxuICAgIGRpYWxvZ0VuZDogYW55O1xuXG4gICAgY29uc3RydWN0b3IocHVibGljIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBmb3JtQnVpbGRlcjogRm9ybUJ1aWxkZXIpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy5pbml0Rm9ybSgpO1xuICAgICAgICB0aGlzLmFkZEFjY2Vzc2liaWxpdHlMYWJlbFRvRGF0ZVBpY2tlcigpO1xuICAgIH1cblxuICAgIGluaXRGb3JtKCkge1xuICAgICAgICBsZXQgc3RhcnREYXRlRm9ybSA9IHRoaXMuZmllbGQudmFsdWUgPyB0aGlzLmZpZWxkLnZhbHVlLnN0YXJ0RGF0ZSA6ICcnIDtcbiAgICAgICAgbGV0IHN0YXJ0RGF0ZSA9IHRoaXMuY29udmVydFRvTW9tZW50RGF0ZShzdGFydERhdGVGb3JtKTtcbiAgICAgICAgbGV0IGVuZERhdGVGb3JtID0gdGhpcy5maWVsZC52YWx1ZSA/IHRoaXMuZmllbGQudmFsdWUuZW5kRGF0ZSA6ICcnIDtcbiAgICAgICAgbGV0IGVuZERhdGUgPSB0aGlzLmNvbnZlcnRUb01vbWVudERhdGUoZW5kRGF0ZUZvcm0pO1xuXG4gICAgICAgIGxldCBzdGFydERhdGVDb250cm9sID0gbmV3IEZvcm1Db250cm9sKHN0YXJ0RGF0ZSk7XG4gICAgICAgIHN0YXJ0RGF0ZUNvbnRyb2wuc2V0VmFsaWRhdG9ycyhWYWxpZGF0b3JzLnJlcXVpcmVkKTtcbiAgICAgICAgdGhpcy5kYXRlUmFuZ2UuYWRkQ29udHJvbCgnc3RhcnREYXRlJywgc3RhcnREYXRlQ29udHJvbCk7XG5cbiAgICAgICAgbGV0IGVuZERhdGVDb250cm9sID0gbmV3IEZvcm1Db250cm9sKGVuZERhdGUpO1xuICAgICAgICBlbmREYXRlQ29udHJvbC5zZXRWYWxpZGF0b3JzKFZhbGlkYXRvcnMucmVxdWlyZWQpO1xuICAgICAgICB0aGlzLmRhdGVSYW5nZS5hZGRDb250cm9sKCdlbmREYXRlJywgZW5kRGF0ZUNvbnRyb2wpO1xuXG4gICAgICAgIHRoaXMuZGF0ZVJhbmdlLnNldFZhbGlkYXRvcnMoZGF0ZUNoZWNrKTtcbiAgICAgICAgdGhpcy5kYXRlUmFuZ2UudmFsdWVDaGFuZ2VzLnN1YnNjcmliZShkYXRhID0+IHRoaXMub25Hcm91cFZhbHVlQ2hhbmdlZChkYXRhKSk7XG5cbiAgICAgICAgdGhpcy5pbml0U2FydERhdGVEaWFsb2coc3RhcnREYXRlKTtcbiAgICAgICAgdGhpcy5pbml0RW5kRGF0ZURpYWxvZyhlbmREYXRlKTtcbiAgICB9XG5cbiAgICBpbml0U2FydERhdGVEaWFsb2coZGF0ZTogc3RyaW5nKSB7XG4gICAgICAgIGxldCBzZXR0aW5nczogYW55ID0ge1xuICAgICAgICAgICAgdHlwZTogJ2RhdGUnLFxuICAgICAgICAgICAgcGFzdDogbW9tZW50KCkuc3VidHJhY3QoMTAwLCAneWVhcnMnKSxcbiAgICAgICAgICAgIGZ1dHVyZTogbW9tZW50KCkuYWRkKDEwMCwgJ3llYXJzJylcbiAgICAgICAgfTtcblxuICAgICAgICBzZXR0aW5ncy5pbml0ID0gbW9tZW50KGRhdGUsIERhdGVSYW5nZVdpZGdldC5GT1JNQVRfREFURV9BQ1RJVklUSSk7XG5cbiAgICAgICAgdGhpcy5kaWFsb2dTdGFydCA9IG5ldyBtZERhdGVUaW1lUGlja2VyLmRlZmF1bHQoc2V0dGluZ3MpO1xuICAgICAgICB0aGlzLmRpYWxvZ1N0YXJ0LnRyaWdnZXIgPSB0aGlzLnN0YXJ0RWxlbWVudC5uYXRpdmVFbGVtZW50O1xuXG4gICAgICAgIGxldCBzdGFydERhdGVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhcnREYXRlQnV0dG9uJyk7XG4gICAgICAgIHN0YXJ0RGF0ZUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGlhbG9nU3RhcnQudG9nZ2xlKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgYWRkQWNjZXNzaWJpbGl0eUxhYmVsVG9EYXRlUGlja2VyKCkge1xuICAgICAgICBsZXQgbGVmdDogYW55ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI21kZHRwLWRhdGVfX2xlZnQnKTtcbiAgICAgICAgaWYgKGxlZnQpIHtcbiAgICAgICAgICAgIGxlZnQuYXBwZW5kQ2hpbGQodGhpcy5jcmVhdGVDdXN0b21FbGVtZW50KCdkYXRlIGxlZnQnKSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcmlnaHQ6IGFueSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNtZGR0cC1kYXRlX19yaWdodCcpO1xuICAgICAgICBpZiAocmlnaHQpIHtcbiAgICAgICAgICAgIHJpZ2h0LmFwcGVuZENoaWxkKHRoaXMuY3JlYXRlQ3VzdG9tRWxlbWVudCgnZGF0ZSByaWdodCcpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjYW5jZWw6IGFueSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNtZGR0cC1kYXRlX19jYW5jZWwnKTtcbiAgICAgICAgaWYgKGNhbmNlbCkge1xuICAgICAgICAgICAgY2FuY2VsLmFwcGVuZENoaWxkKHRoaXMuY3JlYXRlQ3VzdG9tRWxlbWVudCgnZGF0ZSBjYW5jZWwnKSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgb2s6IGFueSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNtZGR0cC1kYXRlX19vaycpO1xuICAgICAgICBpZiAob2spIHtcbiAgICAgICAgICAgIG9rLmFwcGVuZENoaWxkKHRoaXMuY3JlYXRlQ3VzdG9tRWxlbWVudCgnZGF0ZSBvaycpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlQ3VzdG9tRWxlbWVudCh0ZXh0OiBzdHJpbmcpOiBIVE1MRWxlbWVudCB7XG4gICAgICAgIGxldCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgICAgICBzcGFuLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJztcbiAgICAgICAgbGV0IHJpZ2h0U3BhblRleHQgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTtcbiAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZChyaWdodFNwYW5UZXh0KTtcbiAgICAgICAgcmV0dXJuIHNwYW47XG4gICAgfVxuXG4gICAgaW5pdEVuZERhdGVEaWFsb2coZGF0ZTogc3RyaW5nKSB7XG4gICAgICAgIGxldCBzZXR0aW5nczogYW55ID0ge1xuICAgICAgICAgICAgdHlwZTogJ2RhdGUnLFxuICAgICAgICAgICAgcGFzdDogbW9tZW50KCkuc3VidHJhY3QoMTAwLCAneWVhcnMnKSxcbiAgICAgICAgICAgIGZ1dHVyZTogbW9tZW50KCkuYWRkKDEwMCwgJ3llYXJzJylcbiAgICAgICAgfTtcblxuICAgICAgICBzZXR0aW5ncy5pbml0ID0gbW9tZW50KGRhdGUsIERhdGVSYW5nZVdpZGdldC5GT1JNQVRfREFURV9BQ1RJVklUSSk7XG5cbiAgICAgICAgdGhpcy5kaWFsb2dFbmQgPSBuZXcgbWREYXRlVGltZVBpY2tlci5kZWZhdWx0KHNldHRpbmdzKTtcbiAgICAgICAgdGhpcy5kaWFsb2dFbmQudHJpZ2dlciA9IHRoaXMuZW5kRWxlbWVudC5uYXRpdmVFbGVtZW50O1xuXG4gICAgICAgIGxldCBlbmREYXRlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZERhdGVCdXR0b24nKTtcbiAgICAgICAgZW5kRGF0ZUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGlhbG9nRW5kLnRvZ2dsZSgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBvbk9rU3RhcnQoaW5wdXRFbDogSFRNTElucHV0RWxlbWVudCkge1xuICAgICAgICBsZXQgZGF0ZSA9IHRoaXMuZGlhbG9nU3RhcnQudGltZS5mb3JtYXQoRGF0ZVJhbmdlV2lkZ2V0LkZPUk1BVF9EQVRFX0FDVElWSVRJKTtcbiAgICAgICAgdGhpcy5kYXRlUmFuZ2UucGF0Y2hWYWx1ZSh7XG4gICAgICAgICAgICBzdGFydERhdGU6IGRhdGVcbiAgICAgICAgfSk7XG4gICAgICAgIGxldCBtYXRlcmlhbEVsZW1lbjogYW55ID0gaW5wdXRFbC5wYXJlbnRFbGVtZW50O1xuICAgICAgICBpZiAobWF0ZXJpYWxFbGVtZW4pIHtcbiAgICAgICAgICAgIG1hdGVyaWFsRWxlbWVuLk1hdGVyaWFsVGV4dGZpZWxkLmNoYW5nZShkYXRlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uT2tFbmQoaW5wdXRFbDogSFRNTElucHV0RWxlbWVudCkge1xuICAgICAgICBsZXQgZGF0ZSA9IHRoaXMuZGlhbG9nRW5kLnRpbWUuZm9ybWF0KERhdGVSYW5nZVdpZGdldC5GT1JNQVRfREFURV9BQ1RJVklUSSk7XG4gICAgICAgIHRoaXMuZGF0ZVJhbmdlLnBhdGNoVmFsdWUoe1xuICAgICAgICAgICAgZW5kRGF0ZTogZGF0ZVxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgbWF0ZXJpYWxFbGVtZW46IGFueSA9IGlucHV0RWwucGFyZW50RWxlbWVudDtcbiAgICAgICAgaWYgKG1hdGVyaWFsRWxlbWVuKSB7XG4gICAgICAgICAgICBtYXRlcmlhbEVsZW1lbi5NYXRlcmlhbFRleHRmaWVsZC5jaGFuZ2UoZGF0ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvbkdyb3VwVmFsdWVDaGFuZ2VkKGRhdGE6IGFueSkge1xuICAgICAgICBpZiAodGhpcy5kYXRlUmFuZ2UudmFsaWQpIHtcbiAgICAgICAgICAgIGxldCBkYXRlU3RhcnQgPSB0aGlzLmNvbnZlcnRUb01vbWVudERhdGVXaXRoVGltZSh0aGlzLmRhdGVSYW5nZS5jb250cm9sc1snc3RhcnREYXRlJ10udmFsdWUpO1xuICAgICAgICAgICAgbGV0IGVuZFN0YXJ0ID0gdGhpcy5jb252ZXJ0VG9Nb21lbnREYXRlV2l0aFRpbWUodGhpcy5kYXRlUmFuZ2UuY29udHJvbHNbJ2VuZERhdGUnXS52YWx1ZSk7XG4gICAgICAgICAgICB0aGlzLmRhdGVSYW5nZUNoYW5nZWQuZW1pdCh7c3RhcnREYXRlOiBkYXRlU3RhcnQsIGVuZERhdGU6IGVuZFN0YXJ0fSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgY29udmVydFRvTW9tZW50RGF0ZVdpdGhUaW1lKGRhdGU6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gbW9tZW50KGRhdGUsIERhdGVSYW5nZVdpZGdldC5GT1JNQVRfREFURV9BQ1RJVklUSSwgdHJ1ZSkuZm9ybWF0KERhdGVSYW5nZVdpZGdldC5GT1JNQVRfREFURV9BQ1RJVklUSSkgKyAnVDAwOjAwOjAwLjAwMFonO1xuICAgIH1cblxuICAgIHByaXZhdGUgY29udmVydFRvTW9tZW50RGF0ZShkYXRlOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGRhdGUpIHtcbiAgICAgICAgICAgIHJldHVybiBtb21lbnQoZGF0ZSkuZm9ybWF0KERhdGVSYW5nZVdpZGdldC5GT1JNQVRfREFURV9BQ1RJVklUSSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gbW9tZW50KCkuZm9ybWF0KERhdGVSYW5nZVdpZGdldC5GT1JNQVRfREFURV9BQ1RJVklUSSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcblxuICAgIH1cbn1cbiJdfQ==
