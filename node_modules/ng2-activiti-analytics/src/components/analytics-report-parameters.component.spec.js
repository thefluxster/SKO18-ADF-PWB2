/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var testing_1 = require("@angular/core/testing");
var core_1 = require("@angular/core");
var Rx_1 = require("rxjs/Rx");
var moment = require("moment");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var analytics_report_parameters_component_1 = require("../components/analytics-report-parameters.component");
var index_1 = require("../components/widgets/index");
var analytics_service_1 = require("../services/analytics.service");
var report_model_1 = require("../models/report.model");
var analyticParamsMock = require("../assets/analyticsParamsReportComponent.mock");
describe('AnalyticsReportParametersComponent', function () {
    var component;
    var fixture;
    var debug;
    var element;
    var componentHandler;
    beforeEach(testing_1.async(function () {
        testing_1.TestBed.configureTestingModule({
            imports: [
                ng2_alfresco_core_1.CoreModule.forRoot()
            ],
            declarations: [
                analytics_report_parameters_component_1.AnalyticsReportParametersComponent
            ].concat(index_1.WIDGET_DIRECTIVES),
            providers: [
                analytics_service_1.AnalyticsService
            ]
        }).compileComponents();
        var translateService = testing_1.TestBed.get(ng2_alfresco_core_1.AlfrescoTranslationService);
        spyOn(translateService, 'addTranslationFolder').and.stub();
        spyOn(translateService, 'get').and.callFake(function (key) { return Rx_1.Observable.of(key); });
        componentHandler = jasmine.createSpyObj('componentHandler', [
            'upgradeAllRegistered'
        ]);
        window['componentHandler'] = componentHandler;
    }));
    beforeEach(function () {
        fixture = testing_1.TestBed.createComponent(analytics_report_parameters_component_1.AnalyticsReportParametersComponent);
        component = fixture.componentInstance;
        debug = fixture.debugElement;
        element = fixture.nativeElement;
        fixture.detectChanges();
    });
    describe('Rendering tests', function () {
        beforeEach(function () {
            jasmine.Ajax.install();
        });
        afterEach(function () {
            jasmine.Ajax.uninstall();
        });
        it('Should initialize the Report form with a Form Group ', function () {
            expect(component.reportForm.get('dateRange')).toBeDefined();
            expect(component.reportForm.get('dateRange').get('startDate')).toBeDefined();
            expect(component.reportForm.get('dateRange').get('endDate')).toBeDefined();
        });
        it('Should render a dropdown with all the status when the definition parameter type is \'status\' ', function (done) {
            component.onSuccessReportParams.subscribe(function () {
                fixture.detectChanges();
                var dropDown = element.querySelector('#select-status');
                expect(element.querySelector('h4').innerHTML).toEqual('Fake Task overview status');
                expect(dropDown).toBeDefined();
                expect(dropDown.length).toEqual(4);
                expect(dropDown[0].innerHTML).toEqual('Choose One');
                expect(dropDown[1].innerHTML).toEqual('All');
                expect(dropDown[2].innerHTML).toEqual('Active');
                expect(dropDown[3].innerHTML).toEqual('Complete');
                done();
            });
            var reportId = 1;
            var change = new core_1.SimpleChange(null, reportId);
            component.ngOnChanges({ 'reportId': change });
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'json',
                responseText: analyticParamsMock.reportDefParamStatus
            });
        });
        it('Should render a number with the default value when the definition parameter type is \'integer\' ', function (done) {
            component.onSuccessReportParams.subscribe(function () {
                fixture.detectChanges();
                var numberElement = element.querySelector('#slowProcessInstanceInteger');
                expect(numberElement.value).toEqual('10');
                done();
            });
            var reportId = 1;
            var change = new core_1.SimpleChange(null, reportId);
            component.ngOnChanges({ 'reportId': change });
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'json',
                responseText: analyticParamsMock.reportDefParamNumber
            });
        });
        it('Should render a duration component when the definition parameter type is \'duration\' ', function (done) {
            component.onSuccessReportParams.subscribe(function () {
                fixture.detectChanges();
                var numberElement = element.querySelector('#duration');
                expect(numberElement.value).toEqual('0');
                var dropDown = element.querySelector('#select-duration');
                expect(dropDown).toBeDefined();
                expect(dropDown.length).toEqual(4);
                expect(dropDown[0].innerHTML).toEqual('Seconds');
                expect(dropDown[1].innerHTML).toEqual('Minutes');
                expect(dropDown[2].innerHTML).toEqual('Hours');
                expect(dropDown[3].innerHTML).toEqual('Days');
                done();
            });
            var reportId = 1;
            var change = new core_1.SimpleChange(null, reportId);
            component.ngOnChanges({ 'reportId': change });
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'json',
                responseText: analyticParamsMock.reportDefParamDuration
            });
        });
        it('Should save an Params object when the submit is performed', function () {
            component.onSuccess.subscribe(function (res) {
                expect(res.dateRange.startDate).toEqual('2016-09-01T00:00:00.000Z');
                expect(res.dateRange.endDate).toEqual('2016-10-05T00:00:00.000Z');
                expect(res.status).toEqual('All');
                expect(res.processDefinitionId).toEqual('FakeProcess:1:22');
                expect(res.taskName).toEqual('FakeTaskName');
                expect(res.duration).toEqual(22);
                expect(res.dateRangeInterval).toEqual(120);
                expect(res.slowProcessInstanceInteger).toEqual(2);
                expect(res.typeFiltering).toEqual(true);
            });
            var values = {
                dateRange: {
                    startDate: '2016-09-01', endDate: '2016-10-05'
                },
                statusGroup: {
                    status: 'All'
                },
                processDefGroup: {
                    processDefinitionId: 'FakeProcess:1:22'
                },
                taskGroup: {
                    taskName: 'FakeTaskName'
                },
                durationGroup: {
                    duration: 22
                },
                dateIntervalGroup: {
                    dateRangeInterval: 120
                },
                processInstanceGroup: {
                    slowProcessInstanceInteger: 2
                },
                typeFilteringGroup: {
                    typeFiltering: true
                }
            };
            component.submit(values);
        });
        it('Should render a checkbox with the value true when the definition parameter type is \'boolean\' ', function (done) {
            component.onSuccessReportParams.subscribe(function () {
                fixture.detectChanges();
                var checkElement = element.querySelector('#typeFiltering');
                expect(checkElement.checked).toBeTruthy();
                done();
            });
            var reportId = 1;
            var change = new core_1.SimpleChange(null, reportId);
            component.ngOnChanges({ 'reportId': change });
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'json',
                responseText: analyticParamsMock.reportDefParamCheck
            });
        });
        it('Should render a date range components when the definition parameter type is \'dateRange\' ', function (done) {
            component.onSuccessReportParams.subscribe(function () {
                fixture.detectChanges();
                var today = moment().format('YYYY-MM-DD');
                var startDate = element.querySelector('#startDateInput');
                var endDate = element.querySelector('#endDateInput');
                expect(startDate.value).toEqual(today);
                expect(endDate.value).toEqual(today);
                done();
            });
            var reportId = 1;
            var change = new core_1.SimpleChange(null, reportId);
            component.ngOnChanges({ 'reportId': change });
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'json',
                responseText: analyticParamsMock.reportDefParamDateRange
            });
        });
        it('Should render a dropdown with all the RangeInterval when the definition parameter type is \'dateRangeInterval\' ', function (done) {
            component.onSuccessReportParams.subscribe(function () {
                fixture.detectChanges();
                var dropDown = element.querySelector('#select-dateRangeInterval');
                expect(dropDown).toBeDefined();
                expect(dropDown.length).toEqual(5);
                expect(dropDown[0].innerHTML).toEqual('By hour');
                expect(dropDown[1].innerHTML).toEqual('By day');
                expect(dropDown[2].innerHTML).toEqual('By week');
                expect(dropDown[3].innerHTML).toEqual('By month');
                expect(dropDown[4].innerHTML).toEqual('By year');
                done();
            });
            var reportId = 1;
            var change = new core_1.SimpleChange(null, reportId);
            component.ngOnChanges({ 'reportId': change });
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'json',
                responseText: analyticParamsMock.reportDefParamRangeInterval
            });
        });
        it('Should render a dropdown with all the process definition when the definition parameter type is \'processDefinition\' and the' +
            ' reportId change', function (done) {
            component.onSuccessParamOpt.subscribe(function () {
                fixture.detectChanges();
                var dropDown = element.querySelector('#select-processDefinitionId');
                expect(dropDown).toBeDefined();
                expect(dropDown.length).toEqual(5);
                expect(dropDown[0].innerHTML).toEqual('Choose One');
                expect(dropDown[1].innerHTML).toEqual('Fake Process Test 1 Name  (v 1) ');
                expect(dropDown[2].innerHTML).toEqual('Fake Process Test 1 Name  (v 2) ');
                expect(dropDown[3].innerHTML).toEqual('Fake Process Test 2 Name  (v 1) ');
                expect(dropDown[4].innerHTML).toEqual('Fake Process Test 3 Name  (v 1) ');
                done();
            });
            jasmine.Ajax.stubRequest('http://localhost:9999/activiti-app/app/rest/reporting/report-params/1').andReturn({
                status: 200,
                contentType: 'json',
                responseText: analyticParamsMock.reportDefParamProcessDef
            });
            jasmine.Ajax.stubRequest('http://localhost:9999/activiti-app/app/rest/reporting/process-definitions').andReturn({
                status: 200,
                contentType: 'json',
                responseText: analyticParamsMock.reportDefParamProcessDefOptionsNoApp
            });
            var reportId = 1;
            var change = new core_1.SimpleChange(null, reportId);
            component.ngOnChanges({ 'reportId': change });
        });
        it('Should render a dropdown with all the process definition when the definition parameter type is \'processDefinition\' and the' +
            ' appId change', function (done) {
            component.onSuccessParamOpt.subscribe(function () {
                fixture.detectChanges();
                var dropDown = element.querySelector('#select-processDefinitionId');
                expect(dropDown).toBeDefined();
                expect(dropDown.length).toEqual(3);
                expect(dropDown[0].innerHTML).toEqual('Choose One');
                expect(dropDown[1].innerHTML).toEqual('Fake Process Test 1 Name  (v 1) ');
                expect(dropDown[2].innerHTML).toEqual('Fake Process Test 1 Name  (v 2) ');
                done();
            });
            jasmine.Ajax.stubRequest('http://localhost:9999/activiti-app/app/rest/reporting/report-params/1').andReturn({
                status: 200,
                contentType: 'json',
                responseText: analyticParamsMock.reportDefParamProcessDef
            });
            jasmine.Ajax.stubRequest('http://localhost:9999/activiti-app/api/enterprise/process-definitions').andReturn({
                status: 200,
                contentType: 'json',
                responseText: analyticParamsMock.reportDefParamProcessDefOptionsApp
            });
            var appId = '1';
            component.appId = appId;
            component.reportId = '1';
            var change = new core_1.SimpleChange(null, appId);
            component.ngOnChanges({ 'appId': change });
        });
        it('Should load the task list when a process definition is selected', function () {
            component.onSuccessReportParams.subscribe(function (res) {
                expect(res).toBeDefined();
                expect(res.length).toEqual(2);
                expect(res[0].id).toEqual('Fake task name 1');
                expect(res[0].name).toEqual('Fake task name 1');
                expect(res[1].id).toEqual('Fake task name 2');
                expect(res[1].name).toEqual('Fake task name 2');
            });
            component.reportId = '100';
            component.reportParameters = new report_model_1.ReportParametersModel(analyticParamsMock.reportDefParamTask);
            component.onProcessDefinitionChanges(analyticParamsMock.fieldProcessDef);
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 200,
                contentType: 'json',
                responseText: analyticParamsMock.reportDefParamTaskOptions
            });
        });
        it('Should emit an error with a 404 response when the options response is not found', function (done) {
            component.onError.subscribe(function (err) {
                expect(err).toBeDefined();
                done();
            });
            jasmine.Ajax.stubRequest('http://localhost:9999/activiti-app/app/rest/reporting/report-params/1').andReturn({
                status: 200,
                contentType: 'json',
                responseText: analyticParamsMock.reportDefParamProcessDef
            });
            jasmine.Ajax.stubRequest('http://localhost:9999/activiti-app/app/rest/reporting/process-definitions').andReturn({
                status: 404,
                contentType: 'json',
                responseText: []
            });
            var reportId = 1;
            var change = new core_1.SimpleChange(null, reportId);
            component.ngOnChanges({ 'reportId': change });
        });
        it('Should emit an error with a 404 response when the report parameters response is not found', function (done) {
            component.onError.subscribe(function (err) {
                expect(err).toBeDefined();
                done();
            });
            var reportId = 1;
            var change = new core_1.SimpleChange(null, reportId);
            component.ngOnChanges({ 'reportId': change });
            jasmine.Ajax.requests.mostRecent().respondWith({
                status: 404,
                contentType: 'json',
                responseText: []
            });
        });
        it('Should convert a string in number', function () {
            var numberConvert = component.convertNumber('2');
            expect(numberConvert).toEqual(2);
        });
    });
});
//# sourceMappingURL=analytics-report-parameters.component.spec.js.map