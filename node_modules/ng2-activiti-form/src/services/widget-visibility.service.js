/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var Rx_1 = require("rxjs/Rx");
var moment = require("moment");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var WidgetVisibilityService = (function () {
    function WidgetVisibilityService(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
    }
    WidgetVisibilityService.prototype.refreshVisibility = function (form) {
        var _this = this;
        if (form && form.tabs && form.tabs.length > 0) {
            form.tabs.map(function (tabModel) { return _this.refreshEntityVisibility(tabModel); });
        }
        if (form) {
            form.getFormFields().map(function (field) { return _this.refreshEntityVisibility(field); });
        }
    };
    WidgetVisibilityService.prototype.refreshEntityVisibility = function (element) {
        var visible = this.evaluateVisibility(element.form, element.visibilityCondition);
        element.isVisible = visible;
    };
    WidgetVisibilityService.prototype.evaluateVisibility = function (form, visibilityObj) {
        var isLeftFieldPresent = visibilityObj && (visibilityObj.leftFormFieldId || visibilityObj.leftRestResponseId);
        if (!isLeftFieldPresent || isLeftFieldPresent === 'null') {
            return true;
        }
        else {
            return this.isFieldVisible(form, visibilityObj);
        }
    };
    WidgetVisibilityService.prototype.isFieldVisible = function (form, visibilityObj) {
        var leftValue = this.getLeftValue(form, visibilityObj);
        var rightValue = this.getRightValue(form, visibilityObj);
        var actualResult = this.evaluateCondition(leftValue, rightValue, visibilityObj.operator);
        if (visibilityObj.nextCondition) {
            return this.evaluateLogicalOperation(visibilityObj.nextConditionOperator, actualResult, this.isFieldVisible(form, visibilityObj.nextCondition));
        }
        else {
            return actualResult;
        }
    };
    WidgetVisibilityService.prototype.getLeftValue = function (form, visibilityObj) {
        var leftValue = '';
        if (visibilityObj.leftRestResponseId && visibilityObj.leftRestResponseId !== 'null') {
            leftValue = this.getVariableValue(form, visibilityObj.leftRestResponseId, this.processVarList);
        }
        else {
            leftValue = this.getFormValue(form, visibilityObj.leftFormFieldId);
            leftValue = leftValue ? leftValue : this.getVariableValue(form, visibilityObj.leftFormFieldId, this.processVarList);
        }
        return leftValue;
    };
    WidgetVisibilityService.prototype.getRightValue = function (form, visibilityObj) {
        var valueFound = '';
        if (visibilityObj.rightRestResponseId) {
            valueFound = this.getVariableValue(form, visibilityObj.rightRestResponseId, this.processVarList);
        }
        else if (visibilityObj.rightFormFieldId) {
            valueFound = this.getFormValue(form, visibilityObj.rightFormFieldId);
        }
        else {
            if (moment(visibilityObj.rightValue, 'YYYY-MM-DD', true).isValid()) {
                valueFound = visibilityObj.rightValue + 'T00:00:00.000Z';
            }
            else {
                valueFound = visibilityObj.rightValue;
            }
        }
        return valueFound;
    };
    WidgetVisibilityService.prototype.getFormValue = function (form, field) {
        var value = this.getFieldValue(form.values, field);
        return value ? value : this.searchForm(form, field);
    };
    WidgetVisibilityService.prototype.getFieldValue = function (valueList, fieldName) {
        var dropDownFilterByName, valueFound = '';
        if (fieldName && fieldName.indexOf('_LABEL') > 0) {
            dropDownFilterByName = fieldName.substring(0, fieldName.length - 6);
            if (valueList[dropDownFilterByName]) {
                valueFound = valueList[dropDownFilterByName].name;
            }
        }
        else if (valueList[fieldName] && valueList[fieldName].id) {
            valueFound = valueList[fieldName].id;
        }
        else {
            valueFound = valueList[fieldName];
        }
        return valueFound;
    };
    WidgetVisibilityService.prototype.searchForm = function (form, name) {
        var _this = this;
        var fieldValue = '';
        form.fields.forEach(function (containerModel) {
            containerModel.field.columns.forEach(function (containerColumnModel) {
                var fieldFound = containerColumnModel.fields.find(function (field) { return _this.isSearchedField(field, name); });
                if (fieldFound) {
                    fieldValue = _this.getObjectValue(fieldFound);
                    if (!fieldValue) {
                        if (fieldFound.value && fieldFound.value.id) {
                            fieldValue = fieldFound.value.id;
                        }
                        else {
                            fieldValue = fieldFound.value;
                        }
                    }
                }
            });
        });
        return fieldValue;
    };
    WidgetVisibilityService.prototype.getObjectValue = function (field) {
        var value = '';
        if (field.value && field.value.name) {
            value = field.value.name;
        }
        else if (field.options) {
            var option = field.options.find(function (option) { return option.id === field.value; });
            if (option) {
                value = option.name;
            }
            else {
                value = field.value;
            }
        }
        return value;
    };
    WidgetVisibilityService.prototype.isSearchedField = function (field, fieldToFind) {
        var forrmattedFieldName = this.removeLabel(field, fieldToFind);
        return field.name ? field.name.toUpperCase() === forrmattedFieldName.toUpperCase() : false;
    };
    WidgetVisibilityService.prototype.removeLabel = function (field, fieldToFind) {
        var formattedFieldName = fieldToFind || '';
        if (field.fieldType === 'RestFieldRepresentation' && fieldToFind.indexOf('_LABEL') > 0) {
            formattedFieldName = fieldToFind.substring(0, fieldToFind.length - 6);
        }
        return formattedFieldName;
    };
    WidgetVisibilityService.prototype.getVariableValue = function (form, name, processVarList) {
        return this.getFormVariableValue(form, name) ||
            this.getProcessVariableValue(name, processVarList);
    };
    WidgetVisibilityService.prototype.getFormVariableValue = function (form, name) {
        if (form.json.variables) {
            var formVariable = form.json.variables.find(function (formVar) { return formVar.name === name; });
            return formVariable ? formVariable.value : formVariable;
        }
    };
    WidgetVisibilityService.prototype.getProcessVariableValue = function (name, processVarList) {
        if (this.processVarList) {
            var processVariable = this.processVarList.find(function (variable) { return variable.id === name; });
            return processVariable ? processVariable.value : processVariable;
        }
    };
    WidgetVisibilityService.prototype.evaluateLogicalOperation = function (logicOp, previousValue, newValue) {
        switch (logicOp) {
            case 'and':
                return previousValue && newValue;
            case 'or':
                return previousValue || newValue;
            case 'and-not':
                return previousValue && !newValue;
            case 'or-not':
                return previousValue || !newValue;
            default:
                this.logService.error('NO valid operation! wrong op request : ' + logicOp);
                break;
        }
    };
    WidgetVisibilityService.prototype.evaluateCondition = function (leftValue, rightValue, operator) {
        switch (operator) {
            case '==':
                return leftValue + '' === rightValue + '';
            case '<':
                return leftValue < rightValue;
            case '!=':
                return leftValue + '' !== rightValue + '';
            case '>':
                return leftValue > rightValue;
            case '>=':
                return leftValue >= rightValue;
            case '<=':
                return leftValue <= rightValue;
            case 'empty':
                return leftValue ? leftValue === '' : true;
            case '!empty':
                return leftValue ? leftValue !== '' : false;
            default:
                this.logService.error('NO valid operation!');
                break;
        }
        return;
    };
    WidgetVisibilityService.prototype.cleanProcessVariable = function () {
        this.processVarList = [];
    };
    WidgetVisibilityService.prototype.getTaskProcessVariable = function (taskId) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.taskFormsApi.getTaskFormVariables(taskId))
            .map(function (res) {
            var jsonRes = _this.toJson(res);
            _this.processVarList = jsonRes;
            return jsonRes;
        })
            .catch(function (err) { return _this.handleError(err); });
    };
    WidgetVisibilityService.prototype.toJson = function (res) {
        return res || {};
    };
    WidgetVisibilityService.prototype.handleError = function (err) {
        this.logService.error('Error while performing a call');
        return Rx_1.Observable.throw('Error while performing a call - Server error');
    };
    return WidgetVisibilityService;
}());
WidgetVisibilityService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [ng2_alfresco_core_1.AlfrescoApiService,
        ng2_alfresco_core_1.LogService])
], WidgetVisibilityService);
exports.WidgetVisibilityService = WidgetVisibilityService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL3dpZGdldC12aXNpYmlsaXR5LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7OztHQWVHOzs7Ozs7Ozs7OztBQUVILHNDQUEyQztBQUMzQyw4QkFBcUM7QUFDckMsK0JBQWlDO0FBQ2pDLHVEQUFtRTtBQU1uRSxJQUFhLHVCQUF1QjtJQUloQyxpQ0FBb0IsVUFBOEIsRUFDOUIsVUFBc0I7UUFEdEIsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7UUFDOUIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtJQUMxQyxDQUFDO0lBRU0sbURBQWlCLEdBQXhCLFVBQXlCLElBQWU7UUFBeEMsaUJBUUM7UUFQRyxFQUFFLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzVDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQUEsUUFBUSxJQUFJLE9BQUEsS0FBSSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsQ0FBQyxFQUF0QyxDQUFzQyxDQUFDLENBQUM7UUFDdEUsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDUCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsR0FBRyxDQUFDLFVBQUEsS0FBSyxJQUFJLE9BQUEsS0FBSSxDQUFDLHVCQUF1QixDQUFDLEtBQUssQ0FBQyxFQUFuQyxDQUFtQyxDQUFDLENBQUM7UUFDM0UsQ0FBQztJQUNMLENBQUM7SUFFRCx5REFBdUIsR0FBdkIsVUFBd0IsT0FBa0M7UUFDdEQsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDakYsT0FBTyxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUM7SUFDaEMsQ0FBQztJQUVELG9EQUFr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Tyw2Q0FBVyxHQUFuQixVQUFvQixHQUFHO1FBQ25CLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLCtCQUErQixDQUFDLENBQUM7UUFDdkQsTUFBTSxDQUFDLGVBQVUsQ0FBQyxLQUFLLENBQUMsOENBQThDLENBQUMsQ0FBQztJQUM1RSxDQUFDO0lBQ0wsOEJBQUM7QUFBRCxDQWhPQSxBQWdPQyxJQUFBO0FBaE9ZLHVCQUF1QjtJQURuQyxpQkFBVSxFQUFFO3FDQUt1QixzQ0FBa0I7UUFDbEIsOEJBQVU7R0FMakMsdUJBQXVCLENBZ09uQztBQWhPWSwwREFBdUIiLCJmaWxlIjoic2VydmljZXMvd2lkZ2V0LXZpc2liaWxpdHkuc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE2IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzL1J4JztcbmltcG9ydCAqIGFzIG1vbWVudCBmcm9tICdtb21lbnQnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlLCBMb2dTZXJ2aWNlIH0gZnJvbSAnbmcyLWFsZnJlc2NvLWNvcmUnO1xuaW1wb3J0IHsgRm9ybU1vZGVsLCBGb3JtRmllbGRNb2RlbCwgVGFiTW9kZWwsIENvbnRhaW5lck1vZGVsLCBDb250YWluZXJDb2x1bW5Nb2RlbCB9IGZyb20gJy4uL2NvbXBvbmVudHMvd2lkZ2V0cy9jb3JlL2luZGV4JztcbmltcG9ydCB7IFdpZGdldFZpc2liaWxpdHlNb2RlbCB9IGZyb20gJy4uL21vZGVscy93aWRnZXQtdmlzaWJpbGl0eS5tb2RlbCc7XG5pbXBvcnQgeyBUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvdGFzay1wcm9jZXNzLXZhcmlhYmxlLm1vZGVsJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFdpZGdldFZpc2liaWxpdHlTZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgcHJvY2Vzc1Zhckxpc3Q6IFRhc2tQcm9jZXNzVmFyaWFibGVNb2RlbFtdO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgcHVibGljIHJlZnJlc2hWaXNpYmlsaXR5KGZvcm06IEZvcm1Nb2RlbCkge1xuICAgICAgICBpZiAoZm9ybSAmJiBmb3JtLnRhYnMgJiYgZm9ybS50YWJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGZvcm0udGFicy5tYXAodGFiTW9kZWwgPT4gdGhpcy5yZWZyZXNoRW50aXR5VmlzaWJpbGl0eSh0YWJNb2RlbCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZvcm0pIHtcbiAgICAgICAgICAgIGZvcm0uZ2V0Rm9ybUZpZWxkcygpLm1hcChmaWVsZCA9PiB0aGlzLnJlZnJlc2hFbnRpdHlWaXNpYmlsaXR5KGZpZWxkKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZWZyZXNoRW50aXR5VmlzaWJpbGl0eShlbGVtZW50OiBGb3JtRmllbGRNb2RlbCB8IFRhYk1vZGVsKSB7XG4gICAgICAgIGxldCB2aXNpYmxlID0gdGhpcy5ldmFsdWF0ZVZpc2liaWxpdHkoZWxlbWVudC5mb3JtLCBlbGVtZW50LnZpc2liaWxpdHlDb25kaXRpb24pO1xuICAgICAgICBlbGVtZW50LmlzVmlzaWJsZSA9IHZpc2libGU7XG4gICAgfVxuXG4gICAgZXZhbHVhdGVWaXNpYmlsaXR5KGZvcm06IEZvcm1Nb2RlbCwgdmlzaWJpbGl0eU9iajogV2lkZ2V0VmlzaWJpbGl0eU1vZGVsKTogYm9vbGVhbiB7XG4gICAgICAgIGxldCBpc0xlZnRGaWVsZFByZXNlbnQgPSB2aXNpYmlsaXR5T2JqICYmICggdmlzaWJpbGl0eU9iai5sZWZ0Rm9ybUZpZWxkSWQgfHwgdmlzaWJpbGl0eU9iai5sZWZ0UmVzdFJlc3BvbnNlSWQgKTtcbiAgICAgICAgaWYgKCFpc0xlZnRGaWVsZFByZXNlbnQgfHwgaXNMZWZ0RmllbGRQcmVzZW50ID09PSAnbnVsbCcpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNGaWVsZFZpc2libGUoZm9ybSwgdmlzaWJpbGl0eU9iaik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpc0ZpZWxkVmlzaWJsZShmb3JtOiBGb3JtTW9kZWwsIHZpc2liaWxpdHlPYmo6IFdpZGdldFZpc2liaWxpdHlNb2RlbCk6IGJvb2xlYW4ge1xuICAgICAgICBsZXQgbGVmdFZhbHVlID0gdGhpcy5nZXRMZWZ0VmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iaik7XG4gICAgICAgIGxldCByaWdodFZhbHVlID0gdGhpcy5nZXRSaWdodFZhbHVlKGZvcm0sIHZpc2liaWxpdHlPYmopO1xuICAgICAgICBsZXQgYWN0dWFsUmVzdWx0ID0gdGhpcy5ldmFsdWF0ZUNvbmRpdGlvbihsZWZ0VmFsdWUsIHJpZ2h0VmFsdWUsIHZpc2liaWxpdHlPYmoub3BlcmF0b3IpO1xuICAgICAgICBpZiAodmlzaWJpbGl0eU9iai5uZXh0Q29uZGl0aW9uKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ldmFsdWF0ZUxvZ2ljYWxPcGVyYXRpb24oXG4gICAgICAgICAgICAgICAgdmlzaWJpbGl0eU9iai5uZXh0Q29uZGl0aW9uT3BlcmF0b3IsXG4gICAgICAgICAgICAgICAgYWN0dWFsUmVzdWx0LFxuICAgICAgICAgICAgICAgIHRoaXMuaXNGaWVsZFZpc2libGUoZm9ybSwgdmlzaWJpbGl0eU9iai5uZXh0Q29uZGl0aW9uKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBhY3R1YWxSZXN1bHQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRMZWZ0VmFsdWUoZm9ybTogRm9ybU1vZGVsLCB2aXNpYmlsaXR5T2JqOiBXaWRnZXRWaXNpYmlsaXR5TW9kZWwpIHtcbiAgICAgICAgbGV0IGxlZnRWYWx1ZSA9ICcnO1xuICAgICAgICBpZiAodmlzaWJpbGl0eU9iai5sZWZ0UmVzdFJlc3BvbnNlSWQgJiYgdmlzaWJpbGl0eU9iai5sZWZ0UmVzdFJlc3BvbnNlSWQgIT09ICdudWxsJykge1xuICAgICAgICAgICAgbGVmdFZhbHVlID0gdGhpcy5nZXRWYXJpYWJsZVZhbHVlKGZvcm0sIHZpc2liaWxpdHlPYmoubGVmdFJlc3RSZXNwb25zZUlkLCB0aGlzLnByb2Nlc3NWYXJMaXN0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxlZnRWYWx1ZSA9IHRoaXMuZ2V0Rm9ybVZhbHVlKGZvcm0sIHZpc2liaWxpdHlPYmoubGVmdEZvcm1GaWVsZElkKTtcbiAgICAgICAgICAgIGxlZnRWYWx1ZSA9IGxlZnRWYWx1ZSA/IGxlZnRWYWx1ZSA6IHRoaXMuZ2V0VmFyaWFibGVWYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqLmxlZnRGb3JtRmllbGRJZCwgdGhpcy5wcm9jZXNzVmFyTGlzdCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZTtcbiAgICB9XG5cbiAgICBnZXRSaWdodFZhbHVlKGZvcm06IEZvcm1Nb2RlbCwgdmlzaWJpbGl0eU9iajogV2lkZ2V0VmlzaWJpbGl0eU1vZGVsKSB7XG4gICAgICAgIGxldCB2YWx1ZUZvdW5kID0gJyc7XG4gICAgICAgIGlmICh2aXNpYmlsaXR5T2JqLnJpZ2h0UmVzdFJlc3BvbnNlSWQpIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB0aGlzLmdldFZhcmlhYmxlVmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iai5yaWdodFJlc3RSZXNwb25zZUlkLCB0aGlzLnByb2Nlc3NWYXJMaXN0KTtcbiAgICAgICAgfSBlbHNlIGlmICh2aXNpYmlsaXR5T2JqLnJpZ2h0Rm9ybUZpZWxkSWQpIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB0aGlzLmdldEZvcm1WYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqLnJpZ2h0Rm9ybUZpZWxkSWQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKG1vbWVudCh2aXNpYmlsaXR5T2JqLnJpZ2h0VmFsdWUsICdZWVlZLU1NLUREJywgdHJ1ZSkuaXNWYWxpZCgpKSB7XG4gICAgICAgICAgICAgICAgdmFsdWVGb3VuZCA9IHZpc2liaWxpdHlPYmoucmlnaHRWYWx1ZSArICdUMDA6MDA6MDAuMDAwWic7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2aXNpYmlsaXR5T2JqLnJpZ2h0VmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlRm91bmQ7XG4gICAgfVxuXG4gICAgZ2V0Rm9ybVZhbHVlKGZvcm06IEZvcm1Nb2RlbCwgZmllbGQ6IHN0cmluZykge1xuICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmdldEZpZWxkVmFsdWUoZm9ybS52YWx1ZXMsIGZpZWxkKTtcbiAgICAgICAgcmV0dXJuIHZhbHVlID8gdmFsdWUgOiB0aGlzLnNlYXJjaEZvcm0oZm9ybSwgZmllbGQpO1xuICAgIH1cblxuICAgIGdldEZpZWxkVmFsdWUodmFsdWVMaXN0OiBhbnksIGZpZWxkTmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGxldCBkcm9wRG93bkZpbHRlckJ5TmFtZSwgdmFsdWVGb3VuZCA9ICcnO1xuICAgICAgICBpZiAoZmllbGROYW1lICYmIGZpZWxkTmFtZS5pbmRleE9mKCdfTEFCRUwnKSA+IDApIHtcbiAgICAgICAgICAgIGRyb3BEb3duRmlsdGVyQnlOYW1lID0gZmllbGROYW1lLnN1YnN0cmluZygwLCBmaWVsZE5hbWUubGVuZ3RoIC0gNik7XG4gICAgICAgICAgICBpZiAodmFsdWVMaXN0W2Ryb3BEb3duRmlsdGVyQnlOYW1lXSkge1xuICAgICAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2YWx1ZUxpc3RbZHJvcERvd25GaWx0ZXJCeU5hbWVdLm5hbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAodmFsdWVMaXN0W2ZpZWxkTmFtZV0gJiYgdmFsdWVMaXN0W2ZpZWxkTmFtZV0uaWQpIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2YWx1ZUxpc3RbZmllbGROYW1lXS5pZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2YWx1ZUxpc3RbZmllbGROYW1lXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdmFsdWVGb3VuZDtcbiAgICB9XG5cbiAgICBzZWFyY2hGb3JtKGZvcm06IEZvcm1Nb2RlbCwgbmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGxldCBmaWVsZFZhbHVlID0gJyc7XG4gICAgICAgIGZvcm0uZmllbGRzLmZvckVhY2goKGNvbnRhaW5lck1vZGVsOiBDb250YWluZXJNb2RlbCkgPT4ge1xuICAgICAgICAgICAgY29udGFpbmVyTW9kZWwuZmllbGQuY29sdW1ucy5mb3JFYWNoKChjb250YWluZXJDb2x1bW5Nb2RlbDogQ29udGFpbmVyQ29sdW1uTW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgZmllbGRGb3VuZCA9IGNvbnRhaW5lckNvbHVtbk1vZGVsLmZpZWxkcy5maW5kKGZpZWxkID0+IHRoaXMuaXNTZWFyY2hlZEZpZWxkKGZpZWxkLCBuYW1lKSk7XG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkRm91bmQpIHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGRWYWx1ZSA9IHRoaXMuZ2V0T2JqZWN0VmFsdWUoZmllbGRGb3VuZCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkRm91bmQudmFsdWUgJiYgZmllbGRGb3VuZC52YWx1ZS5pZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkVmFsdWUgPSBmaWVsZEZvdW5kLnZhbHVlLmlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZFZhbHVlID0gZmllbGRGb3VuZC52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGZpZWxkVmFsdWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRPYmplY3RWYWx1ZShmaWVsZDogRm9ybUZpZWxkTW9kZWwpIHtcbiAgICAgICAgbGV0IHZhbHVlID0gJyc7XG4gICAgICAgIGlmIChmaWVsZC52YWx1ZSAmJiBmaWVsZC52YWx1ZS5uYW1lKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IGZpZWxkLnZhbHVlLm5hbWU7XG4gICAgICAgIH0gZWxzZSBpZiAoZmllbGQub3B0aW9ucykge1xuICAgICAgICAgICAgbGV0IG9wdGlvbiA9IGZpZWxkLm9wdGlvbnMuZmluZChvcHRpb24gPT4gb3B0aW9uLmlkID09PSBmaWVsZC52YWx1ZSk7XG4gICAgICAgICAgICBpZiAob3B0aW9uKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBvcHRpb24ubmFtZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBmaWVsZC52YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc1NlYXJjaGVkRmllbGQoZmllbGQ6IEZvcm1GaWVsZE1vZGVsLCBmaWVsZFRvRmluZDogc3RyaW5nKSB7XG4gICAgICAgIGxldCBmb3JybWF0dGVkRmllbGROYW1lID0gdGhpcy5yZW1vdmVMYWJlbChmaWVsZCwgZmllbGRUb0ZpbmQpO1xuICAgICAgICByZXR1cm4gZmllbGQubmFtZSA/IGZpZWxkLm5hbWUudG9VcHBlckNhc2UoKSA9PT0gZm9ycm1hdHRlZEZpZWxkTmFtZS50b1VwcGVyQ2FzZSgpIDogZmFsc2U7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZW1vdmVMYWJlbChmaWVsZDogRm9ybUZpZWxkTW9kZWwsIGZpZWxkVG9GaW5kKSB7XG4gICAgICAgIGxldCBmb3JtYXR0ZWRGaWVsZE5hbWUgPSBmaWVsZFRvRmluZCB8fCAnJztcbiAgICAgICAgaWYgKGZpZWxkLmZpZWxkVHlwZSA9PT0gJ1Jlc3RGaWVsZFJlcHJlc2VudGF0aW9uJyAmJiBmaWVsZFRvRmluZC5pbmRleE9mKCdfTEFCRUwnKSA+IDApIHtcbiAgICAgICAgICAgIGZvcm1hdHRlZEZpZWxkTmFtZSA9IGZpZWxkVG9GaW5kLnN1YnN0cmluZygwLCBmaWVsZFRvRmluZC5sZW5ndGggLSA2KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZm9ybWF0dGVkRmllbGROYW1lO1xuICAgIH1cblxuICAgIGdldFZhcmlhYmxlVmFsdWUoZm9ybTogRm9ybU1vZGVsLCBuYW1lOiBzdHJpbmcsIHByb2Nlc3NWYXJMaXN0OiBUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWxbXSkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRGb3JtVmFyaWFibGVWYWx1ZShmb3JtLCBuYW1lKSB8fFxuICAgICAgICAgICAgdGhpcy5nZXRQcm9jZXNzVmFyaWFibGVWYWx1ZShuYW1lLCBwcm9jZXNzVmFyTGlzdCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRGb3JtVmFyaWFibGVWYWx1ZShmb3JtOiBGb3JtTW9kZWwsIG5hbWU6IHN0cmluZykge1xuICAgICAgICBpZiAoZm9ybS5qc29uLnZhcmlhYmxlcykge1xuICAgICAgICAgICAgbGV0IGZvcm1WYXJpYWJsZSA9IGZvcm0uanNvbi52YXJpYWJsZXMuZmluZChmb3JtVmFyID0+IGZvcm1WYXIubmFtZSA9PT0gbmFtZSk7XG4gICAgICAgICAgICByZXR1cm4gZm9ybVZhcmlhYmxlID8gZm9ybVZhcmlhYmxlLnZhbHVlIDogZm9ybVZhcmlhYmxlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRQcm9jZXNzVmFyaWFibGVWYWx1ZShuYW1lOiBzdHJpbmcsIHByb2Nlc3NWYXJMaXN0OiBUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWxbXSkge1xuICAgICAgICBpZiAodGhpcy5wcm9jZXNzVmFyTGlzdCkge1xuICAgICAgICAgICAgbGV0IHByb2Nlc3NWYXJpYWJsZSA9IHRoaXMucHJvY2Vzc1Zhckxpc3QuZmluZCh2YXJpYWJsZSA9PiB2YXJpYWJsZS5pZCA9PT0gbmFtZSk7XG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzc1ZhcmlhYmxlID8gcHJvY2Vzc1ZhcmlhYmxlLnZhbHVlIDogcHJvY2Vzc1ZhcmlhYmxlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZXZhbHVhdGVMb2dpY2FsT3BlcmF0aW9uKGxvZ2ljT3AsIHByZXZpb3VzVmFsdWUsIG5ld1ZhbHVlKTogYm9vbGVhbiB7XG4gICAgICAgIHN3aXRjaCAobG9naWNPcCkge1xuICAgICAgICAgICAgY2FzZSAnYW5kJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZSAmJiBuZXdWYWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJ29yJyA6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHByZXZpb3VzVmFsdWUgfHwgbmV3VmFsdWU7XG4gICAgICAgICAgICBjYXNlICdhbmQtbm90JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZSAmJiAhbmV3VmFsdWU7XG4gICAgICAgICAgICBjYXNlICdvci1ub3QnOlxuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2aW91c1ZhbHVlIHx8ICFuZXdWYWx1ZTtcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKCdOTyB2YWxpZCBvcGVyYXRpb24hIHdyb25nIG9wIHJlcXVlc3QgOiAnICsgbG9naWNPcCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBldmFsdWF0ZUNvbmRpdGlvbihsZWZ0VmFsdWUsIHJpZ2h0VmFsdWUsIG9wZXJhdG9yKTogYm9vbGVhbiB7XG4gICAgICAgIHN3aXRjaCAob3BlcmF0b3IpIHtcbiAgICAgICAgICAgIGNhc2UgJz09JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlICsgJycgPT09IHJpZ2h0VmFsdWUgKyAnJztcbiAgICAgICAgICAgIGNhc2UgJzwnOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgPCByaWdodFZhbHVlO1xuICAgICAgICAgICAgY2FzZSAnIT0nOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgKyAnJyAhPT0gcmlnaHRWYWx1ZSArICcnO1xuICAgICAgICAgICAgY2FzZSAnPic6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZSA+IHJpZ2h0VmFsdWU7XG4gICAgICAgICAgICBjYXNlICc+PSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZSA+PSByaWdodFZhbHVlO1xuICAgICAgICAgICAgY2FzZSAnPD0nOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgPD0gcmlnaHRWYWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJ2VtcHR5JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlID8gbGVmdFZhbHVlID09PSAnJyA6IHRydWU7XG4gICAgICAgICAgICBjYXNlICchZW1wdHknOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgPyBsZWZ0VmFsdWUgIT09ICcnIDogZmFsc2U7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcignTk8gdmFsaWQgb3BlcmF0aW9uIScpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjbGVhblByb2Nlc3NWYXJpYWJsZSgpIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzVmFyTGlzdCA9IFtdO1xuICAgIH1cblxuICAgIGdldFRhc2tQcm9jZXNzVmFyaWFibGUodGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tQcm9jZXNzVmFyaWFibGVNb2RlbFtdPiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tGb3Jtc0FwaS5nZXRUYXNrRm9ybVZhcmlhYmxlcyh0YXNrSWQpKVxuICAgICAgICAgICAgLm1hcChyZXMgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBqc29uUmVzID0gdGhpcy50b0pzb24ocmVzKTtcbiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NWYXJMaXN0ID0gPFRhc2tQcm9jZXNzVmFyaWFibGVNb2RlbFtdPmpzb25SZXM7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGpzb25SZXM7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIHRvSnNvbihyZXM6IGFueSkge1xuICAgICAgICByZXR1cm4gcmVzIHx8IHt9O1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlRXJyb3IoZXJyKSB7XG4gICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcignRXJyb3Igd2hpbGUgcGVyZm9ybWluZyBhIGNhbGwnKTtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUudGhyb3coJ0Vycm9yIHdoaWxlIHBlcmZvcm1pbmcgYSBjYWxsIC0gU2VydmVyIGVycm9yJyk7XG4gICAgfVxufVxuIl19
