/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var Rx_1 = require("rxjs/Rx");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var form_definition_model_1 = require("../models/form-definition.model");
var ecm_model_service_1 = require("./ecm-model.service");
var FormService = FormService_1 = (function () {
    function FormService(ecmModelService, apiService, logService) {
        this.ecmModelService = ecmModelService;
        this.apiService = apiService;
        this.logService = logService;
        this.formLoaded = new Rx_1.Subject();
        this.formFieldValueChanged = new Rx_1.Subject();
        this.taskCompleted = new Rx_1.Subject();
        this.taskCompletedError = new Rx_1.Subject();
        this.taskSaved = new Rx_1.Subject();
        this.taskSavedError = new Rx_1.Subject();
    }
    FormService.prototype.createFormFromANode = function (formName) {
        var _this = this;
        return Rx_1.Observable.create(function (observer) {
            _this.createForm(formName).subscribe(function (form) {
                _this.ecmModelService.searchEcmType(formName, ecm_model_service_1.EcmModelService.MODEL_NAME).subscribe(function (customType) {
                    var formDefinitionModel = new form_definition_model_1.FormDefinitionModel(form.id, form.name, form.lastUpdatedByFullName, form.lastUpdated, customType.entry.properties);
                    _this.addFieldsToAForm(form.id, formDefinitionModel).subscribe(function (formData) {
                        observer.next(formData);
                        observer.complete();
                    }, function (err) { return _this.handleError(err); });
                }, function (err) { return _this.handleError(err); });
            }, function (err) { return _this.handleError(err); });
        });
    };
    FormService.prototype.createForm = function (formName) {
        var dataModel = {
            name: formName,
            description: '',
            modelType: 2,
            stencilSet: 0
        };
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.modelsApi.createModel(dataModel));
    };
    FormService.prototype.addFieldsToAForm = function (formId, formModel) {
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.editorApi.saveForm(formId, formModel));
    };
    FormService.prototype.searchFrom = function (name) {
        var _this = this;
        var opts = {
            'modelType': 2
        };
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.modelsApi.getModels(opts))
            .map(function (forms) {
            return forms.data.find(function (formdata) { return formdata.name === name; });
        })
            .catch(function (err) { return _this.handleError(err); });
    };
    FormService.prototype.getForms = function () {
        var opts = {
            'modelType': 2
        };
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.modelsApi.getModels(opts));
    };
    FormService.prototype.getProcessDefinitions = function () {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.processApi.getProcessDefinitions({}))
            .map(this.toJsonArray)
            .catch(function (err) { return _this.handleError(err); });
    };
    FormService.prototype.getTasks = function () {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.taskApi.listTasks({}))
            .map(this.toJsonArray)
            .catch(function (err) { return _this.handleError(err); });
    };
    FormService.prototype.getTask = function (taskId) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.taskApi.getTask(taskId))
            .map(this.toJson)
            .catch(function (err) { return _this.handleError(err); });
    };
    FormService.prototype.saveTaskForm = function (taskId, formValues) {
        var _this = this;
        var body = JSON.stringify({ values: formValues });
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.taskApi.saveTaskForm(taskId, body))
            .catch(function (err) { return _this.handleError(err); });
    };
    FormService.prototype.completeTaskForm = function (taskId, formValues, outcome) {
        var _this = this;
        var data = { values: formValues };
        if (outcome) {
            data.outcome = outcome;
        }
        var body = JSON.stringify(data);
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.taskApi.completeTaskForm(taskId, body))
            .catch(function (err) { return _this.handleError(err); });
    };
    FormService.prototype.getTaskForm = function (taskId) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.taskApi.getTaskForm(taskId))
            .map(this.toJson)
            .catch(function (err) { return _this.handleError(err); });
    };
    FormService.prototype.getFormDefinitionById = function (formId) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.editorApi.getForm(formId))
            .map(this.toJson)
            .catch(function (err) { return _this.handleError(err); });
    };
    FormService.prototype.getFormDefinitionByName = function (name) {
        var _this = this;
        var opts = {
            'filter': 'myReusableForms',
            'filterText': name,
            'modelType': 2
        };
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.modelsApi.getModels(opts))
            .map(this.getFormId)
            .catch(function (err) { return _this.handleError(err); });
    };
    FormService.prototype.getStartFormInstance = function (processId) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.processApi.getProcessInstanceStartForm(processId))
            .map(this.toJson)
            .catch(function (err) { return _this.handleError(err); });
    };
    FormService.prototype.getStartFormDefinition = function (processId) {
        var _this = this;
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.processApi.getProcessDefinitionStartForm(processId))
            .map(this.toJson)
            .catch(function (err) { return _this.handleError(err); });
    };
    FormService.prototype.createTemporaryRawRelatedContent = function (file) {
        return Rx_1.Observable.fromPromise(this.apiService.getInstance().activiti.contentApi.createTemporaryRawRelatedContent(file));
    };
    FormService.prototype.getRestFieldValues = function (taskId, field) {
        var alfrescoApi = this.apiService.getInstance();
        return Rx_1.Observable.fromPromise(alfrescoApi.activiti.taskApi.getRestFieldValues(taskId, field));
    };
    FormService.prototype.getRestFieldValuesByProcessId = function (processDefinitionId, field) {
        var alfrescoApi = this.apiService.getInstance();
        return Rx_1.Observable.fromPromise(alfrescoApi.activiti.processApi.getRestFieldValues(processDefinitionId, field));
    };
    FormService.prototype.getRestFieldValuesColumnByProcessId = function (processDefinitionId, field, column) {
        var alfrescoApi = this.apiService.getInstance();
        return Rx_1.Observable.fromPromise(alfrescoApi.activiti.processApi.getRestTableFieldValues(processDefinitionId, field, column));
    };
    FormService.prototype.getRestFieldValuesColumn = function (taskId, field, column) {
        var alfrescoApi = this.apiService.getInstance();
        return Rx_1.Observable.fromPromise(alfrescoApi.activiti.taskApi.getRestFieldValuesColumn(taskId, field, column));
    };
    FormService.prototype.getWorkflowGroups = function (filter, groupId) {
        var _this = this;
        return Rx_1.Observable.create(function (observer) {
            var xhr = new XMLHttpRequest();
            xhr.withCredentials = true;
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var json = JSON.parse(xhr.response);
                        var data = (json.data || []).map(function (item) { return item; });
                        observer.next(data);
                        observer.complete();
                    }
                    else {
                        _this.logService.error(xhr.response);
                        Rx_1.Observable.throw(new Error(xhr.response));
                    }
                }
            };
            var host = _this.apiService.getInstance().config.hostBpm;
            var url = host + "/activiti-app/app/rest/workflow-groups?filter=" + filter;
            if (groupId) {
                url += "&groupId=" + groupId;
            }
            xhr.open('GET', url, true);
            xhr.setRequestHeader('Authorization', _this.apiService.getInstance().getTicketBpm());
            xhr.send();
        });
    };
    FormService.prototype.getWorkflowUsers = function (filter, groupId) {
        var _this = this;
        return Rx_1.Observable.create(function (observer) {
            var xhr = new XMLHttpRequest();
            xhr.withCredentials = true;
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var json = JSON.parse(xhr.response);
                        var data = (json.data || []).map(function (item) { return item; });
                        observer.next(data);
                        observer.complete();
                    }
                    else {
                        _this.logService.error(xhr.response);
                        Rx_1.Observable.throw(new Error(xhr.response));
                    }
                }
            };
            var host = _this.apiService.getInstance().config.hostBpm;
            var url = host + "/activiti-app/app/rest/workflow-users?filter=" + filter;
            if (groupId) {
                url += "&groupId=" + groupId;
            }
            xhr.open('GET', url, true);
            xhr.setRequestHeader('Authorization', _this.apiService.getInstance().getTicketBpm());
            xhr.send();
        });
    };
    FormService.prototype.getFormId = function (res) {
        var result = null;
        if (res && res.data && res.data.length > 0) {
            result = res.data[0].id;
        }
        return result;
    };
    FormService.prototype.toJson = function (res) {
        if (res) {
            return res || {};
        }
        return {};
    };
    FormService.prototype.toJsonArray = function (res) {
        if (res) {
            return res.data || [];
        }
        return [];
    };
    FormService.prototype.handleError = function (error) {
        var errMsg = FormService_1.UNKNOWN_ERROR_MESSAGE;
        if (error) {
            errMsg = (error.message) ? error.message :
                error.status ? error.status + " - " + error.statusText : FormService_1.GENERIC_ERROR_MESSAGE;
        }
        this.logService.error(errMsg);
        return Rx_1.Observable.throw(errMsg);
    };
    return FormService;
}());
FormService.UNKNOWN_ERROR_MESSAGE = 'Unknown error';
FormService.GENERIC_ERROR_MESSAGE = 'Server error';
FormService = FormService_1 = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [ecm_model_service_1.EcmModelService,
        ng2_alfresco_core_1.AlfrescoApiService,
        ng2_alfresco_core_1.LogService])
], FormService);
exports.FormService = FormService;
var FormService_1;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL2Zvcm0uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7Ozs7Ozs7Ozs7O0FBRUgsc0NBQTJDO0FBQzNDLDhCQUE4QztBQUM5Qyx1REFBbUU7QUFFbkUseUVBQXNFO0FBQ3RFLHlEQUFzRDtBQU10RCxJQUFhLFdBQVc7SUFZcEIscUJBQW9CLGVBQWdDLEVBQ2hDLFVBQThCLEVBQzlCLFVBQXNCO1FBRnRCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyxlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUM5QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBVDFDLGVBQVUsR0FBdUIsSUFBSSxZQUFPLEVBQWEsQ0FBQztRQUMxRCwwQkFBcUIsR0FBNEIsSUFBSSxZQUFPLEVBQWtCLENBQUM7UUFDL0Usa0JBQWEsR0FBdUIsSUFBSSxZQUFPLEVBQWEsQ0FBQztRQUM3RCx1QkFBa0IsR0FBNEIsSUFBSSxZQUFPLEVBQWtCLENBQUM7UUFDNUUsY0FBUyxHQUF1QixJQUFJLFlBQU8sRUFBYSxDQUFDO1FBQ3pELG1CQUFjLEdBQTRCLElBQUksWUFBTyxFQUFrQixDQUFDO0lBS3hFLENBQUM7SUFNRCx5Q0FBbUIsR0FBbkIsVUFBb0IsUUFBZ0I7UUFBcEMsaUJBZ0JDO1FBZkcsTUFBTSxDQUFDLGVBQVUsQ0FBQyxNQUFNLENBQUMsVUFBQSxRQUFRO1lBQzdCLEtBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsU0FBUyxDQUMvQixVQUFBLElBQUk7Z0JBQ0EsS0FBSSxDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLG1DQUFlLENBQUMsVUFBVSxDQUFDLENBQUMsU0FBUyxDQUM5RSxVQUFBLFVBQVU7b0JBQ04sSUFBSSxtQkFBbUIsR0FBRyxJQUFJLDJDQUFtQixDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMscUJBQXFCLEVBQUUs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QUssQ0FBQyxDQUFDLENBQUM7WUFDUixNQUFNLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsS0FBSyxDQUFDLE9BQU87Z0JBQ3BDLEtBQUssQ0FBQyxNQUFNLEdBQU0sS0FBSyxDQUFDLE1BQU0sV0FBTSxLQUFLLENBQUMsVUFBWSxHQUFHLGFBQVcsQ0FBQyxxQkFBcUIsQ0FBQztRQUNuRyxDQUFDO1FBQ0QsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDOUIsTUFBTSxDQUFDLGVBQVUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUNMLGtCQUFDO0FBQUQsQ0F0VkEsQUFzVkMsSUFBQTtBQXBWVSxpQ0FBcUIsR0FBVyxlQUFlLENBQUM7QUFDaEQsaUNBQXFCLEdBQVcsY0FBYyxDQUFDO0FBSDdDLFdBQVc7SUFEdkIsaUJBQVUsRUFBRTtxQ0FhNEIsbUNBQWU7UUFDcEIsc0NBQWtCO1FBQ2xCLDhCQUFVO0dBZGpDLFdBQVcsQ0FzVnZCO0FBdFZZLGtDQUFXIiwiZmlsZSI6InNlcnZpY2VzL2Zvcm0uc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE2IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzL1J4JztcbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSwgTG9nU2VydmljZSB9IGZyb20gJ25nMi1hbGZyZXNjby1jb3JlJztcbmltcG9ydCB7IEZvcm1WYWx1ZXMgfSBmcm9tICcuLy4uL2NvbXBvbmVudHMvd2lkZ2V0cy9jb3JlL2luZGV4JztcbmltcG9ydCB7IEZvcm1EZWZpbml0aW9uTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvZm9ybS1kZWZpbml0aW9uLm1vZGVsJztcbmltcG9ydCB7IEVjbU1vZGVsU2VydmljZSB9IGZyb20gJy4vZWNtLW1vZGVsLnNlcnZpY2UnO1xuaW1wb3J0IHsgR3JvdXBNb2RlbCB9IGZyb20gJy4vLi4vY29tcG9uZW50cy93aWRnZXRzL2NvcmUvZ3JvdXAubW9kZWwnO1xuaW1wb3J0IHsgR3JvdXBVc2VyTW9kZWwgfSBmcm9tICcuLy4uL2NvbXBvbmVudHMvd2lkZ2V0cy9jb3JlL2dyb3VwLXVzZXIubW9kZWwnO1xuaW1wb3J0IHsgRm9ybUV2ZW50LCBGb3JtRXJyb3JFdmVudCwgRm9ybUZpZWxkRXZlbnQgfSBmcm9tICcuLy4uL2V2ZW50cy9pbmRleCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBGb3JtU2VydmljZSB7XG5cbiAgICBzdGF0aWMgVU5LTk9XTl9FUlJPUl9NRVNTQUdFOiBzdHJpbmcgPSAnVW5rbm93biBlcnJvcic7XG4gICAgc3RhdGljIEdFTkVSSUNfRVJST1JfTUVTU0FHRTogc3RyaW5nID0gJ1NlcnZlciBlcnJvcic7XG5cbiAgICBmb3JtTG9hZGVkOiBTdWJqZWN0PEZvcm1FdmVudD4gPSBuZXcgU3ViamVjdDxGb3JtRXZlbnQ+KCk7XG4gICAgZm9ybUZpZWxkVmFsdWVDaGFuZ2VkOiBTdWJqZWN0PEZvcm1GaWVsZEV2ZW50PiA9IG5ldyBTdWJqZWN0PEZvcm1GaWVsZEV2ZW50PigpO1xuICAgIHRhc2tDb21wbGV0ZWQ6IFN1YmplY3Q8Rm9ybUV2ZW50PiA9IG5ldyBTdWJqZWN0PEZvcm1FdmVudD4oKTtcbiAgICB0YXNrQ29tcGxldGVkRXJyb3I6IFN1YmplY3Q8Rm9ybUVycm9yRXZlbnQ+ID0gbmV3IFN1YmplY3Q8Rm9ybUVycm9yRXZlbnQ+KCk7XG4gICAgdGFza1NhdmVkOiBTdWJqZWN0PEZvcm1FdmVudD4gPSBuZXcgU3ViamVjdDxGb3JtRXZlbnQ+KCk7XG4gICAgdGFza1NhdmVkRXJyb3I6IFN1YmplY3Q8Rm9ybUVycm9yRXZlbnQ+ID0gbmV3IFN1YmplY3Q8Rm9ybUVycm9yRXZlbnQ+KCk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVjbU1vZGVsU2VydmljZTogRWNtTW9kZWxTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgYXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbG9nU2VydmljZTogTG9nU2VydmljZSkge1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIEZvcm0gd2l0aCBhIGZpZWxkcyBmb3IgZWFjaCBtZXRhZGF0YSBwcm9wZXJ0aWVzXG4gICAgICogQHJldHVybnMge09ic2VydmFibGU8YW55Pn1cbiAgICAgKi9cbiAgICBjcmVhdGVGb3JtRnJvbUFOb2RlKGZvcm1OYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUob2JzZXJ2ZXIgPT4ge1xuICAgICAgICAgICAgdGhpcy5jcmVhdGVGb3JtKGZvcm1OYW1lKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgZm9ybSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWNtTW9kZWxTZXJ2aWNlLnNlYXJjaEVjbVR5cGUoZm9ybU5hbWUsIEVjbU1vZGVsU2VydmljZS5NT0RFTF9OQU1FKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21UeXBlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZm9ybURlZmluaXRpb25Nb2RlbCA9IG5ldyBGb3JtRGVmaW5pdGlvbk1vZGVsKGZvcm0uaWQsIGZvcm0ubmFtZSwgZm9ybS5sYXN0VXBkYXRlZEJ5RnVsbE5hbWUsIGZvcm0ubGFzdFVwZGF0ZWQsIGN1c3RvbVR5cGUuZW50cnkucHJvcGVydGllcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRGaWVsZHNUb0FGb3JtKGZvcm0uaWQsIGZvcm1EZWZpbml0aW9uTW9kZWwpLnN1YnNjcmliZShmb3JtRGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoZm9ybURhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIEZvcm1cbiAgICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxhbnk+fVxuICAgICAqL1xuICAgIGNyZWF0ZUZvcm0oZm9ybU5hbWU6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGxldCBkYXRhTW9kZWwgPSB7XG4gICAgICAgICAgICBuYW1lOiBmb3JtTmFtZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnJyxcbiAgICAgICAgICAgIG1vZGVsVHlwZTogMixcbiAgICAgICAgICAgIHN0ZW5jaWxTZXQ6IDBcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5tb2RlbHNBcGkuY3JlYXRlTW9kZWwoZGF0YU1vZGVsKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIEZpbGVkcyB0byBBIGZvcm1cbiAgICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxhbnk+fVxuICAgICAqL1xuICAgIGFkZEZpZWxkc1RvQUZvcm0oZm9ybUlkOiBzdHJpbmcsIGZvcm1Nb2RlbDogRm9ybURlZmluaXRpb25Nb2RlbCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLmVkaXRvckFwaS5zYXZlRm9ybShmb3JtSWQsIGZvcm1Nb2RlbCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNlYXJjaCBGb3IgQSBGb3JtIGJ5IG5hbWVcbiAgICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxhbnk+fVxuICAgICAqL1xuICAgIHNlYXJjaEZyb20obmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgbGV0IG9wdHMgPSB7XG4gICAgICAgICAgICAnbW9kZWxUeXBlJzogMlxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKFxuICAgICAgICAgICAgdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkubW9kZWxzQXBpLmdldE1vZGVscyhvcHRzKSlcbiAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24gKGZvcm1zOiBhbnkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZm9ybXMuZGF0YS5maW5kKGZvcm1kYXRhID0+IGZvcm1kYXRhLm5hbWUgPT09IG5hbWUpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IEFsbCB0aGUgZm9ybXNcbiAgICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxhbnk+fVxuICAgICAqL1xuICAgIGdldEZvcm1zKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGxldCBvcHRzID0ge1xuICAgICAgICAgICAgJ21vZGVsVHlwZSc6IDJcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5tb2RlbHNBcGkuZ2V0TW9kZWxzKG9wdHMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgUHJvY2VzcyBEZWZpbml0aW9uc1xuICAgICAqIEByZXR1cm5zIHtPYnNlcnZhYmxlPGFueT59XG4gICAgICovXG4gICAgZ2V0UHJvY2Vzc0RlZmluaXRpb25zKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnByb2Nlc3NBcGkuZ2V0UHJvY2Vzc0RlZmluaXRpb25zKHt9KSlcbiAgICAgICAgICAgIC5tYXAodGhpcy50b0pzb25BcnJheSlcbiAgICAgICAgICAgIC5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgQWxsIHRoZSBUYXNrc1xuICAgICAqIEByZXR1cm5zIHtPYnNlcnZhYmxlPGFueT59XG4gICAgICovXG4gICAgZ2V0VGFza3MoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkudGFza0FwaS5saXN0VGFza3Moe30pKVxuICAgICAgICAgICAgLm1hcCh0aGlzLnRvSnNvbkFycmF5KVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBUYXNrXG4gICAgICogQHBhcmFtIHRhc2tJZCBUYXNrIElkXG4gICAgICogQHJldHVybnMge09ic2VydmFibGU8YW55Pn1cbiAgICAgKi9cbiAgICBnZXRUYXNrKHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkudGFza0FwaS5nZXRUYXNrKHRhc2tJZCkpXG4gICAgICAgICAgICAubWFwKHRoaXMudG9Kc29uKVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNhdmUgVGFzayBGb3JtXG4gICAgICogQHBhcmFtIHRhc2tJZCBUYXNrIElkXG4gICAgICogQHBhcmFtIGZvcm1WYWx1ZXMgRm9ybSBWYWx1ZXNcbiAgICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxhbnk+fVxuICAgICAqL1xuICAgIHNhdmVUYXNrRm9ybSh0YXNrSWQ6IHN0cmluZywgZm9ybVZhbHVlczogRm9ybVZhbHVlcyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGxldCBib2R5ID0gSlNPTi5zdHJpbmdpZnkoe3ZhbHVlczogZm9ybVZhbHVlc30pO1xuXG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tBcGkuc2F2ZVRhc2tGb3JtKHRhc2tJZCwgYm9keSkpXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ29tcGxldGUgVGFzayBGb3JtXG4gICAgICogQHBhcmFtIHRhc2tJZCBUYXNrIElkXG4gICAgICogQHBhcmFtIGZvcm1WYWx1ZXMgRm9ybSBWYWx1ZXNcbiAgICAgKiBAcGFyYW0gb3V0Y29tZSBGb3JtIE91dGNvbWVcbiAgICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxhbnk+fVxuICAgICAqL1xuICAgIGNvbXBsZXRlVGFza0Zvcm0odGFza0lkOiBzdHJpbmcsIGZvcm1WYWx1ZXM6IEZvcm1WYWx1ZXMsIG91dGNvbWU/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBsZXQgZGF0YTogYW55ID0ge3ZhbHVlczogZm9ybVZhbHVlc307XG4gICAgICAgIGlmIChvdXRjb21lKSB7XG4gICAgICAgICAgICBkYXRhLm91dGNvbWUgPSBvdXRjb21lO1xuICAgICAgICB9XG4gICAgICAgIGxldCBib2R5ID0gSlNPTi5zdHJpbmdpZnkoZGF0YSk7XG5cbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkudGFza0FwaS5jb21wbGV0ZVRhc2tGb3JtKHRhc2tJZCwgYm9keSkpXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IEZvcm0gcmVsYXRlZCB0byBhIHRhc2tJZFxuICAgICAqIEBwYXJhbSB0YXNrSWQgVGFzayBJZFxuICAgICAqIEByZXR1cm5zIHtPYnNlcnZhYmxlPGFueT59XG4gICAgICovXG4gICAgZ2V0VGFza0Zvcm0odGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS50YXNrQXBpLmdldFRhc2tGb3JtKHRhc2tJZCkpXG4gICAgICAgICAgICAubWFwKHRoaXMudG9Kc29uKVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBGb3JtIERlZmluaXRpb25cbiAgICAgKiBAcGFyYW0gZm9ybUlkIEZvcm0gSWRcbiAgICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxhbnk+fVxuICAgICAqL1xuICAgIGdldEZvcm1EZWZpbml0aW9uQnlJZChmb3JtSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLmVkaXRvckFwaS5nZXRGb3JtKGZvcm1JZCkpXG4gICAgICAgICAgICAubWFwKHRoaXMudG9Kc29uKVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgZm9ybSBkZWZpbml0aW9uIGJ5IGEgZ2l2ZW4gbmFtZS5cbiAgICAgKiBAcGFyYW0gbmFtZVxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPFQ+fFByb21pc2U8RXJyb3JPYnNlcnZhYmxlPn1cbiAgICAgKi9cbiAgICBnZXRGb3JtRGVmaW5pdGlvbkJ5TmFtZShuYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBsZXQgb3B0cyA9IHtcbiAgICAgICAgICAgICdmaWx0ZXInOiAnbXlSZXVzYWJsZUZvcm1zJyxcbiAgICAgICAgICAgICdmaWx0ZXJUZXh0JzogbmFtZSxcbiAgICAgICAgICAgICdtb2RlbFR5cGUnOiAyXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkubW9kZWxzQXBpLmdldE1vZGVscyhvcHRzKSlcbiAgICAgICAgICAgIC5tYXAodGhpcy5nZXRGb3JtSWQpXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHN0YXJ0IGZvcm0gaW5zdGFuY2UgZm9yIGEgZ2l2ZW4gcHJvY2Vzc0lkXG4gICAgICogQHBhcmFtIHByb2Nlc3NJZCBQcm9jZXNzIGRlZmluaXRpb24gSURcbiAgICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxhbnk+fVxuICAgICAqL1xuICAgIGdldFN0YXJ0Rm9ybUluc3RhbmNlKHByb2Nlc3NJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UoXG4gICAgICAgICAgICB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5wcm9jZXNzQXBpLmdldFByb2Nlc3NJbnN0YW5jZVN0YXJ0Rm9ybShwcm9jZXNzSWQpKVxuICAgICAgICAgICAgLm1hcCh0aGlzLnRvSnNvbilcbiAgICAgICAgICAgIC5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgc3RhcnQgZm9ybSBkZWZpbml0aW9uIGZvciBhIGdpdmVuIHByb2Nlc3NcbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0lkIFByb2Nlc3MgZGVmaW5pdGlvbiBJRFxuICAgICAqIEByZXR1cm5zIHtPYnNlcnZhYmxlPGFueT59XG4gICAgICovXG4gICAgZ2V0U3RhcnRGb3JtRGVmaW5pdGlvbihwcm9jZXNzSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKFxuICAgICAgICAgICAgdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkucHJvY2Vzc0FwaS5nZXRQcm9jZXNzRGVmaW5pdGlvblN0YXJ0Rm9ybShwcm9jZXNzSWQpKVxuICAgICAgICAgICAgLm1hcCh0aGlzLnRvSnNvbilcbiAgICAgICAgICAgIC5jYXRjaChlcnIgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTYXZlIEZpbGVcbiAgICAgKiBAcGFyYW0gZmlsZSBmaWxlXG4gICAgICogQHJldHVybnMge09ic2VydmFibGU8YW55Pn1cbiAgICAgKi9cbiAgICBjcmVhdGVUZW1wb3JhcnlSYXdSZWxhdGVkQ29udGVudChmaWxlOiBhbnkpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5jb250ZW50QXBpLmNyZWF0ZVRlbXBvcmFyeVJhd1JlbGF0ZWRDb250ZW50KGZpbGUpKTtcbiAgICB9XG5cbiAgICBnZXRSZXN0RmllbGRWYWx1ZXModGFza0lkOiBzdHJpbmcsIGZpZWxkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBsZXQgYWxmcmVzY29BcGkgPSB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UoYWxmcmVzY29BcGkuYWN0aXZpdGkudGFza0FwaS5nZXRSZXN0RmllbGRWYWx1ZXModGFza0lkLCBmaWVsZCkpO1xuICAgIH1cblxuICAgIGdldFJlc3RGaWVsZFZhbHVlc0J5UHJvY2Vzc0lkKHByb2Nlc3NEZWZpbml0aW9uSWQ6IHN0cmluZywgZmllbGQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGxldCBhbGZyZXNjb0FwaSA9IHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpO1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZShhbGZyZXNjb0FwaS5hY3Rpdml0aS5wcm9jZXNzQXBpLmdldFJlc3RGaWVsZFZhbHVlcyhwcm9jZXNzRGVmaW5pdGlvbklkLCBmaWVsZCkpO1xuICAgIH1cblxuICAgIGdldFJlc3RGaWVsZFZhbHVlc0NvbHVtbkJ5UHJvY2Vzc0lkKHByb2Nlc3NEZWZpbml0aW9uSWQ6IHN0cmluZywgZmllbGQ6IHN0cmluZywgY29sdW1uPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgbGV0IGFsZnJlc2NvQXBpID0gdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKGFsZnJlc2NvQXBpLmFjdGl2aXRpLnByb2Nlc3NBcGkuZ2V0UmVzdFRhYmxlRmllbGRWYWx1ZXMocHJvY2Vzc0RlZmluaXRpb25JZCwgZmllbGQsIGNvbHVtbikpO1xuICAgIH1cblxuICAgIGdldFJlc3RGaWVsZFZhbHVlc0NvbHVtbih0YXNrSWQ6IHN0cmluZywgZmllbGQ6IHN0cmluZywgY29sdW1uPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgbGV0IGFsZnJlc2NvQXBpID0gdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKGFsZnJlc2NvQXBpLmFjdGl2aXRpLnRhc2tBcGkuZ2V0UmVzdEZpZWxkVmFsdWVzQ29sdW1uKHRhc2tJZCwgZmllbGQsIGNvbHVtbikpO1xuICAgIH1cblxuICAgIC8vIFRPRE86IHVzZXMgcHJpdmF0ZSB3ZWJBcHAgYXBpXG4gICAgZ2V0V29ya2Zsb3dHcm91cHMoZmlsdGVyOiBzdHJpbmcsIGdyb3VwSWQ/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPEdyb3VwTW9kZWxbXT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUob2JzZXJ2ZXIgPT4ge1xuXG4gICAgICAgICAgICBsZXQgeGhyOiBYTUxIdHRwUmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICAgICAgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7XG5cbiAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHhoci5yZWFkeVN0YXRlID09PSA0KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBqc29uID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGE6IEdyb3VwTW9kZWxbXSA9IChqc29uLmRhdGEgfHwgW10pLm1hcChpdGVtID0+IDxHcm91cE1vZGVsPiBpdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKHhoci5yZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBPYnNlcnZhYmxlLnRocm93KG5ldyBFcnJvcih4aHIucmVzcG9uc2UpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGxldCBob3N0ID0gdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuY29uZmlnLmhvc3RCcG07XG4gICAgICAgICAgICBsZXQgdXJsID0gYCR7aG9zdH0vYWN0aXZpdGktYXBwL2FwcC9yZXN0L3dvcmtmbG93LWdyb3Vwcz9maWx0ZXI9JHtmaWx0ZXJ9YDtcbiAgICAgICAgICAgIGlmIChncm91cElkKSB7XG4gICAgICAgICAgICAgICAgdXJsICs9IGAmZ3JvdXBJZD0ke2dyb3VwSWR9YDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHhoci5vcGVuKCdHRVQnLCB1cmwsIHRydWUpO1xuICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0F1dGhvcml6YXRpb24nLCB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5nZXRUaWNrZXRCcG0oKSk7XG4gICAgICAgICAgICB4aHIuc2VuZCgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBnZXRXb3JrZmxvd1VzZXJzKGZpbHRlcjogc3RyaW5nLCBncm91cElkPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxHcm91cFVzZXJNb2RlbFtdPiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZShvYnNlcnZlciA9PiB7XG5cbiAgICAgICAgICAgIGxldCB4aHI6IFhNTEh0dHBSZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICAgICAgICB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTtcblxuICAgICAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgPT09IDQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGpzb24gPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGF0YTogR3JvdXBVc2VyTW9kZWxbXSA9IChqc29uLmRhdGEgfHwgW10pLm1hcChpdGVtID0+IDxHcm91cFVzZXJNb2RlbD4gaXRlbSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcih4aHIucmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgT2JzZXJ2YWJsZS50aHJvdyhuZXcgRXJyb3IoeGhyLnJlc3BvbnNlKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgaG9zdCA9IHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmNvbmZpZy5ob3N0QnBtO1xuICAgICAgICAgICAgbGV0IHVybCA9IGAke2hvc3R9L2FjdGl2aXRpLWFwcC9hcHAvcmVzdC93b3JrZmxvdy11c2Vycz9maWx0ZXI9JHtmaWx0ZXJ9YDtcbiAgICAgICAgICAgIGlmIChncm91cElkKSB7XG4gICAgICAgICAgICAgICAgdXJsICs9IGAmZ3JvdXBJZD0ke2dyb3VwSWR9YDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHhoci5vcGVuKCdHRVQnLCB1cmwsIHRydWUpO1xuICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0F1dGhvcml6YXRpb24nLCB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5nZXRUaWNrZXRCcG0oKSk7XG4gICAgICAgICAgICB4aHIuc2VuZCgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBnZXRGb3JtSWQocmVzOiBhbnkpOiBzdHJpbmcge1xuICAgICAgICBsZXQgcmVzdWx0ID0gbnVsbDtcblxuICAgICAgICBpZiAocmVzICYmIHJlcy5kYXRhICYmIHJlcy5kYXRhLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IHJlcy5kYXRhWzBdLmlkO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICB0b0pzb24ocmVzOiBhbnkpIHtcbiAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgcmV0dXJuIHJlcyB8fCB7fTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge307XG4gICAgfVxuXG4gICAgdG9Kc29uQXJyYXkocmVzOiBhbnkpIHtcbiAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgcmV0dXJuIHJlcy5kYXRhIHx8IFtdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBoYW5kbGVFcnJvcihlcnJvcjogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgbGV0IGVyck1zZyA9IEZvcm1TZXJ2aWNlLlVOS05PV05fRVJST1JfTUVTU0FHRTtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICBlcnJNc2cgPSAoZXJyb3IubWVzc2FnZSkgPyBlcnJvci5tZXNzYWdlIDpcbiAgICAgICAgICAgICAgICBlcnJvci5zdGF0dXMgPyBgJHtlcnJvci5zdGF0dXN9IC0gJHtlcnJvci5zdGF0dXNUZXh0fWAgOiBGb3JtU2VydmljZS5HRU5FUklDX0VSUk9SX01FU1NBR0U7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVyck1zZyk7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLnRocm93KGVyck1zZyk7XG4gICAgfVxufVxuIl19
