/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var activiti_form_component_1 = require("./activiti-form.component");
var form_service_1 = require("./../services/form.service");
var widget_visibility_service_1 = require("./../services/widget-visibility.service");
var index_1 = require("./widgets/core/index");
var ActivitiStartForm = (function (_super) {
    __extends(ActivitiStartForm, _super);
    function ActivitiStartForm(translate, formService, visibilityService, logService) {
        var _this = _super.call(this, formService, visibilityService, null, null, logService) || this;
        _this.translate = translate;
        _this.showOutcomeButtons = true;
        _this.showRefreshButton = true;
        _this.readOnlyForm = false;
        _this.outcomeClick = new core_1.EventEmitter();
        _this.outcomesContainer = null;
        if (_this.translate) {
            _this.translate.addTranslationFolder('ng2-activiti-form', 'node_modules/ng2-activiti-form/src');
        }
        _this.showTitle = false;
        return _this;
    }
    ActivitiStartForm.prototype.ngOnChanges = function (changes) {
        var processDefinitionId = changes['processDefinitionId'];
        if (processDefinitionId && processDefinitionId.currentValue) {
            this.visibilityService.cleanProcessVariable();
            this.getStartFormDefinition(processDefinitionId.currentValue);
            return;
        }
        var processId = changes['processId'];
        if (processId && processId.currentValue) {
            this.visibilityService.cleanProcessVariable();
            this.loadStartForm(processId.currentValue);
            return;
        }
    };
    ActivitiStartForm.prototype.loadStartForm = function (processId) {
        var _this = this;
        this.formService
            .getStartFormInstance(processId)
            .subscribe(function (form) {
            _this.formName = form.name;
            form.processDefinitionId = _this.processDefinitionId;
            _this.form = _this.parseForm(form);
            _this.form.readOnly = _this.readOnlyForm;
            _this.formLoaded.emit(_this.form);
        }, function (error) { return _this.handleError(error); });
    };
    ActivitiStartForm.prototype.getStartFormDefinition = function (processId) {
        var _this = this;
        this.formService
            .getStartFormDefinition(processId)
            .subscribe(function (form) {
            _this.formName = form.processDefinitionName;
            _this.form = _this.parseForm(form);
            _this.form.readOnly = _this.readOnlyForm;
            _this.formLoaded.emit(_this.form);
        }, function (error) { return _this.handleError(error); });
    };
    ActivitiStartForm.prototype.isOutcomeButtonVisible = function (outcome, isFormReadOnly) {
        if (outcome && outcome.isSystem && (outcome.name === index_1.FormOutcomeModel.SAVE_ACTION ||
            outcome.name === index_1.FormOutcomeModel.COMPLETE_ACTION)) {
            return false;
        }
        else if (outcome && outcome.name === index_1.FormOutcomeModel.START_PROCESS_ACTION) {
            return true;
        }
        return _super.prototype.isOutcomeButtonVisible.call(this, outcome, isFormReadOnly);
    };
    ActivitiStartForm.prototype.saveTaskForm = function () {
    };
    ActivitiStartForm.prototype.onRefreshClicked = function () {
        if (this.processDefinitionId) {
            this.visibilityService.cleanProcessVariable();
            this.getStartFormDefinition(this.processDefinitionId);
        }
        else if (this.processId) {
            this.visibilityService.cleanProcessVariable();
            this.loadStartForm(this.processId);
        }
    };
    ActivitiStartForm.prototype.completeTaskForm = function (outcome) {
        this.outcomeClick.emit(outcome);
    };
    return ActivitiStartForm;
}(activiti_form_component_1.ActivitiForm));
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiStartForm.prototype, "processDefinitionId", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", String)
], ActivitiStartForm.prototype, "processId", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", Boolean)
], ActivitiStartForm.prototype, "showOutcomeButtons", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", Boolean)
], ActivitiStartForm.prototype, "showRefreshButton", void 0);
__decorate([
    core_1.Input(),
    __metadata("design:type", Boolean)
], ActivitiStartForm.prototype, "readOnlyForm", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], ActivitiStartForm.prototype, "outcomeClick", void 0);
__decorate([
    core_1.ViewChild('outcomesContainer', {}),
    __metadata("design:type", core_1.ElementRef)
], ActivitiStartForm.prototype, "outcomesContainer", void 0);
ActivitiStartForm = __decorate([
    core_1.Component({
        moduleId: module.id,
        selector: 'activiti-start-form',
        template: "<div>     <div *ngIf=\"hasForm()\">         <div class=\"mdl-card mdl-shadow--2dp activiti-form-container\">             <div class=\"mdl-card__title\">                 <i class=\"material-icons\">{{ form.isValid ? 'event_available' : 'event_busy' }}</i>                 <h2 *ngIf=\"isTitleEnabled()\" class=\"mdl-card__title-text\">{{form.taskName}}</h2>             </div>             <div class=\"mdl-card__media\">                 <div *ngIf=\"form.hasTabs()\">                     <tabs-widget [tabs]=\"form.tabs\" (formTabChanged)=\"checkVisibility($event);\"></tabs-widget>                 </div>                  <div *ngIf=\"!form.hasTabs() && form.hasFields()\">                     <div *ngFor=\"let field of form.fields\">                         <form-field [field]=\"field.field\"></form-field>                     </div>                 </div>             </div>             <div *ngIf=\"showOutcomeButtons && form.hasOutcomes()\" class=\"mdl-card__actions mdl-card--border\" #outcomesContainer>                 <button *ngFor=\"let outcome of form.outcomes\"                         alfresco-mdl-button                         [disabled]=\"!isOutcomeButtonEnabled(outcome)\"                         [class.mdl-button--colored]=\"!outcome.isSystem\"                         [class.activiti-form-hide-button]=\"!isOutcomeButtonVisible(outcome, form.readOnly)\"                         (click)=\"onOutcomeClicked(outcome, $event)\">                     {{outcome.name}}                 </button>             </div>             <div  *ngIf=\"showRefreshButton\" class=\"mdl-card__menu\" >                 <button (click)=\"onRefreshClicked()\"                         class=\"mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect\">                     <i class=\"material-icons\">refresh</i>                 </button>             </div>         </div>     </div> </div>",
        styles: [".activiti-form-container {     width: 100%;     min-height: 100px;     overflow: visible; }  .activiti-form-container > .mdl-card__media {     background-color: #fff; }  .activiti-form-debug-container {     padding: 10px; }  .activiti-form-debug-container .debug-toggle-text {     padding-left: 15px;     cursor: pointer; }  .activiti-form-debug-container .debug-toggle-text:hover {     font-weight: bold; }  .activiti-form-hide-button {     display: none; }"]
    }),
    __metadata("design:paramtypes", [ng2_alfresco_core_1.AlfrescoTranslationService,
        form_service_1.FormService,
        widget_visibility_service_1.WidgetVisibilityService,
        ng2_alfresco_core_1.LogService])
], ActivitiStartForm);
exports.ActivitiStartForm = ActivitiStartForm;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYWN0aXZpdGktc3RhcnQtZm9ybS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7OztHQWVHOzs7Ozs7Ozs7Ozs7Ozs7O0FBRUgsc0NBVXVCO0FBQ3ZCLHVEQUEyRTtBQUMzRSxxRUFBeUQ7QUFDekQsMkRBQXlEO0FBQ3pELHFGQUFtRjtBQUNuRiw4Q0FBd0Q7QUF5QnhELElBQWEsaUJBQWlCO0lBQVMscUNBQVk7SUF1Qi9DLDJCQUFvQixTQUFxQyxFQUM3QyxXQUF3QixFQUN4QixpQkFBMEMsRUFDMUMsVUFBc0I7UUFIbEMsWUFJSSxrQkFBTSxXQUFXLEVBQUUsaUJBQWlCLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxVQUFVLENBQUMsU0FPaEU7UUFYbUIsZUFBUyxHQUFULFNBQVMsQ0FBNEI7UUFkekQsd0JBQWtCLEdBQVksSUFBSSxDQUFDO1FBR25DLHVCQUFpQixHQUFZLElBQUksQ0FBQztRQUdsQyxrQkFBWSxHQUFZLEtBQUssQ0FBQztRQUc5QixrQkFBWSxHQUFzQixJQUFJLG1CQUFZLEVBQU8sQ0FBQztRQUcxRCx1QkFBaUIsR0FBZSxJQUFJLENBQUM7UUFRakMsRUFBRSxDQUFDLENBQUMsS0FBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDakIsS0FBSSxDQUFDLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxtQkFBbUIsRUFBRSxvQ0FBb0MsQ0FBQyxDQUFDO1FBQ25HLENBQUM7UUFFRCxLQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQzs7SUFDM0IsQ0FBQztJQUVELHVDQUFXLEdBQVgsVUFBWSxPQUFzQjtRQUM5QixJQUFJLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ3pELEVBQUUsQ0FBQyxDQUFDLG1CQUFtQixJQUFJLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7WUFDMUQsSUFBSSxDQUFDLGlCQUFpQixDQUFDLG9CQUFv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ZmlsZSI6ImNvbXBvbmVudHMvYWN0aXZpdGktc3RhcnQtZm9ybS5jb21wb25lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxNiBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICAgIENvbXBvbmVudCxcbiAgICBBZnRlclZpZXdDaGVja2VkLFxuICAgIE9uQ2hhbmdlcyxcbiAgICBTaW1wbGVDaGFuZ2VzLFxuICAgIElucHV0LFxuICAgIFZpZXdDaGlsZCxcbiAgICBFbGVtZW50UmVmLFxuICAgIE91dHB1dCxcbiAgICBFdmVudEVtaXR0ZXJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBbGZyZXNjb1RyYW5zbGF0aW9uU2VydmljZSwgTG9nU2VydmljZSB9IGZyb20gJ25nMi1hbGZyZXNjby1jb3JlJztcbmltcG9ydCB7IEFjdGl2aXRpRm9ybSB9IGZyb20gJy4vYWN0aXZpdGktZm9ybS5jb21wb25lbnQnO1xuaW1wb3J0IHsgRm9ybVNlcnZpY2UgfSBmcm9tICcuLy4uL3NlcnZpY2VzL2Zvcm0uc2VydmljZSc7XG5pbXBvcnQgeyBXaWRnZXRWaXNpYmlsaXR5U2VydmljZSB9ICBmcm9tICcuLy4uL3NlcnZpY2VzL3dpZGdldC12aXNpYmlsaXR5LnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybU91dGNvbWVNb2RlbCB9IGZyb20gJy4vd2lkZ2V0cy9jb3JlL2luZGV4JztcblxuLyoqXG4gKiBEaXNwbGF5cyB0aGUgc3RhcnQgZm9ybSBmb3IgYSBuYW1lZCBwcm9jZXNzIGRlZmluaXRpb24sIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHJldHJpZXZlIHZhbHVlcyB0byBzdGFydCBhIG5ldyBwcm9jZXNzLlxuICpcbiAqIEFmdGVyIHRoZSBmb3JtIGhhcyBiZWVuIGNvbXBsZXRlZCB0aGUgZm9ybSB2YWx1ZXMgYXJlIGF2YWlsYWJsZSBmcm9tIHRoZSBhdHRyaWJ1dGUgY29tcG9uZW50LmZvcm0udmFsdWVzIGFuZFxuICogY29tcG9uZW50LmZvcm0uaXNWYWxpZCAoYm9vbGVhbikgY2FuIGJlIHVzZWQgdG8gY2hlY2sgdGhlIGlmIHRoZSBmb3JtIGlzIHZhbGlkIG9yIG5vdC4gQm90aCBvZiB0aGVzZSBwcm9wZXJ0aWVzIGFyZVxuICogdXBkYXRlZCBhcyB0aGUgdXNlciB0eXBlcyBpbnRvIHRoZSBmb3JtLlxuICpcbiAqIEBJbnB1dFxuICoge3Byb2Nlc3NEZWZpbml0aW9uSWR9IHN0cmluZzogVGhlIHByb2Nlc3MgZGVmaW5pdGlvbiBJRFxuICoge3Nob3dPdXRjb21lQnV0dG9uc30gYm9vbGVhbjogV2hldGhlciBmb3JtIG91dGNvbWUgYnV0dG9ucyBzaG91bGQgYmUgc2hvd24sIHRoaXMgaXMgbm93IGFsd2F5cyBhY3RpdmUgdG8gc2hvdyBmb3JtIG91dGNvbWVzXG4gKiAgQE91dHB1dFxuICogIHtmb3JtTG9hZGVkfSBFdmVudEVtaXR0ZXIgLSBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gdGhlIGZvcm0gaXMgbG9hZGVkLCBpdCBwYXNzIGFsbCB0aGUgdmFsdWUgaW4gdGhlIGZvcm0uXG4gKiAge2Zvcm1TYXZlZH0gRXZlbnRFbWl0dGVyIC0gVGhpcyBldmVudCBpcyBmaXJlZCB3aGVuIHRoZSBmb3JtIGlzIHNhdmVkLCBpdCBwYXNzIGFsbCB0aGUgdmFsdWUgaW4gdGhlIGZvcm0uXG4gKiAge2Zvcm1Db21wbGV0ZWR9IEV2ZW50RW1pdHRlciAtIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiB0aGUgZm9ybSBpcyBjb21wbGV0ZWQsIGl0IHBhc3MgYWxsIHRoZSB2YWx1ZSBpbiB0aGUgZm9ybS5cbiAqXG4gKiBAcmV0dXJucyB7QWN0aXZpdGlGb3JtfSAuXG4gKi9cbkBDb21wb25lbnQoe1xuICAgIG1vZHVsZUlkOiBtb2R1bGUuaWQsXG4gICAgc2VsZWN0b3I6ICdhY3Rpdml0aS1zdGFydC1mb3JtJyxcbiAgICB0ZW1wbGF0ZTogXCI8ZGl2PiAgICAgPGRpdiAqbmdJZj1cXFwiaGFzRm9ybSgpXFxcIj4gICAgICAgICA8ZGl2IGNsYXNzPVxcXCJtZGwtY2FyZCBtZGwtc2hhZG93LS0yZHAgYWN0aXZpdGktZm9ybS1jb250YWluZXJcXFwiPiAgICAgICAgICAgICA8ZGl2IGNsYXNzPVxcXCJtZGwtY2FyZF9fdGl0bGVcXFwiPiAgICAgICAgICAgICAgICAgPGkgY2xhc3M9XFxcIm1hdGVyaWFsLWljb25zXFxcIj57eyBmb3JtLmlzVmFsaWQgPyAnZXZlbnRfYXZhaWxhYmxlJyA6ICdldmVudF9idXN5JyB9fTwvaT4gICAgICAgICAgICAgICAgIDxoMiAqbmdJZj1cXFwiaXNUaXRsZUVuYWJsZWQoKVxcXCIgY2xhc3M9XFxcIm1kbC1jYXJkX190aXRsZS10ZXh0XFxcIj57e2Zvcm0udGFza05hbWV9fTwvaDI+ICAgICAgICAgICAgIDwvZGl2PiAgICAgICAgICAgICA8ZGl2IGNsYXNzPVxcXCJtZGwtY2FyZF9fbWVkaWFcXFwiPiAgICAgICAgICAgICAgICAgPGRpdiAqbmdJZj1cXFwiZm9ybS5oYXNUYWJzKClcXFwiPiAgICAgICAgICAgICAgICAgICAgIDx0YWJzLXdpZGdldCBbdGFic109XFxcImZvcm0udGFic1xcXCIgKGZvcm1UYWJDaGFuZ2VkKT1cXFwiY2hlY2tWaXNpYmlsaXR5KCRldmVudCk7XFxcIj48L3RhYnMtd2lkZ2V0PiAgICAgICAgICAgICAgICAgPC9kaXY+ICAgICAgICAgICAgICAgICAgPGRpdiAqbmdJZj1cXFwiIWZvcm0uaGFzVGFicygpICYmIGZvcm0uaGFzRmllbGRzKClcXFwiPiAgICAgICAgICAgICAgICAgICAgIDxkaXYgKm5nRm9yPVxcXCJsZXQgZmllbGQgb2YgZm9ybS5maWVsZHNcXFwiPiAgICAgICAgICAgICAgICAgICAgICAgICA8Zm9ybS1maWVsZCBbZmllbGRdPVxcXCJmaWVsZC5maWVsZFxcXCI+PC9mb3JtLWZpZWxkPiAgICAgICAgICAgICAgICAgICAgIDwvZGl2PiAgICAgICAgICAgICAgICAgPC9kaXY+ICAgICAgICAgICAgIDwvZGl2PiAgICAgICAgICAgICA8ZGl2ICpuZ0lmPVxcXCJzaG93T3V0Y29tZUJ1dHRvbnMgJiYgZm9ybS5oYXNPdXRjb21lcygpXFxcIiBjbGFzcz1cXFwibWRsLWNhcmRfX2FjdGlvbnMgbWRsLWNhcmQtLWJvcmRlclxcXCIgI291dGNvbWVzQ29udGFpbmVyPiAgICAgICAgICAgICAgICAgPGJ1dHRvbiAqbmdGb3I9XFxcImxldCBvdXRjb21lIG9mIGZvcm0ub3V0Y29tZXNcXFwiICAgICAgICAgICAgICAgICAgICAgICAgIGFsZnJlc2NvLW1kbC1idXR0b24gICAgICAgICAgICAgICAgICAgICAgICAgW2Rpc2FibGVkXT1cXFwiIWlzT3V0Y29tZUJ1dHRvbkVuYWJsZWQob3V0Y29tZSlcXFwiICAgICAgICAgICAgICAgICAgICAgICAgIFtjbGFzcy5tZGwtYnV0dG9uLS1jb2xvcmVkXT1cXFwiIW91dGNvbWUuaXNTeXN0ZW1cXFwiICAgICAgICAgICAgICAgICAgICAgICAgIFtjbGFzcy5hY3Rpdml0aS1mb3JtLWhpZGUtYnV0dG9uXT1cXFwiIWlzT3V0Y29tZUJ1dHRvblZpc2libGUob3V0Y29tZSwgZm9ybS5yZWFkT25seSlcXFwiICAgICAgICAgICAgICAgICAgICAgICAgIChjbGljayk9XFxcIm9uT3V0Y29tZUNsaWNrZWQob3V0Y29tZSwgJGV2ZW50KVxcXCI+ICAgICAgICAgICAgICAgICAgICAge3tvdXRjb21lLm5hbWV9fSAgICAgICAgICAgICAgICAgPC9idXR0b24+ICAgICAgICAgICAgIDwvZGl2PiAgICAgICAgICAgICA8ZGl2ICAqbmdJZj1cXFwic2hvd1JlZnJlc2hCdXR0b25cXFwiIGNsYXNzPVxcXCJtZGwtY2FyZF9fbWVudVxcXCIgPiAgICAgICAgICAgICAgICAgPGJ1dHRvbiAoY2xpY2spPVxcXCJvblJlZnJlc2hDbGlja2VkKClcXFwiICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzPVxcXCJtZGwtYnV0dG9uIG1kbC1idXR0b24tLWljb24gbWRsLWpzLWJ1dHRvbiBtZGwtanMtcmlwcGxlLWVmZmVjdFxcXCI+ICAgICAgICAgICAgICAgICAgICAgPGkgY2xhc3M9XFxcIm1hdGVyaWFsLWljb25zXFxcIj5yZWZyZXNoPC9pPiAgICAgICAgICAgICAgICAgPC9idXR0b24+ICAgICAgICAgICAgIDwvZGl2PiAgICAgICAgIDwvZGl2PiAgICAgPC9kaXY+IDwvZGl2PlwiLFxuICAgIHN0eWxlczogW1wiLmFjdGl2aXRpLWZvcm0tY29udGFpbmVyIHsgICAgIHdpZHRoOiAxMDAlOyAgICAgbWluLWhlaWdodDogMTAwcHg7ICAgICBvdmVyZmxvdzogdmlzaWJsZTsgfSAgLmFjdGl2aXRpLWZvcm0tY29udGFpbmVyID4gLm1kbC1jYXJkX19tZWRpYSB7ICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmOyB9ICAuYWN0aXZpdGktZm9ybS1kZWJ1Zy1jb250YWluZXIgeyAgICAgcGFkZGluZzogMTBweDsgfSAgLmFjdGl2aXRpLWZvcm0tZGVidWctY29udGFpbmVyIC5kZWJ1Zy10b2dnbGUtdGV4dCB7ICAgICBwYWRkaW5nLWxlZnQ6IDE1cHg7ICAgICBjdXJzb3I6IHBvaW50ZXI7IH0gIC5hY3Rpdml0aS1mb3JtLWRlYnVnLWNvbnRhaW5lciAuZGVidWctdG9nZ2xlLXRleHQ6aG92ZXIgeyAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7IH0gIC5hY3Rpdml0aS1mb3JtLWhpZGUtYnV0dG9uIHsgICAgIGRpc3BsYXk6IG5vbmU7IH1cIl1cbn0pXG5leHBvcnQgY2xhc3MgQWN0aXZpdGlTdGFydEZvcm0gZXh0ZW5kcyBBY3Rpdml0aUZvcm0gaW1wbGVtZW50cyBBZnRlclZpZXdDaGVja2VkLCBPbkNoYW5nZXMge1xuXG4gICAgQElucHV0KClcbiAgICBwcm9jZXNzRGVmaW5pdGlvbklkOiBzdHJpbmc7XG5cbiAgICBASW5wdXQoKVxuICAgIHByb2Nlc3NJZDogc3RyaW5nO1xuXG4gICAgQElucHV0KClcbiAgICBzaG93T3V0Y29tZUJ1dHRvbnM6IGJvb2xlYW4gPSB0cnVlO1xuXG4gICAgQElucHV0KClcbiAgICBzaG93UmVmcmVzaEJ1dHRvbjogYm9vbGVhbiA9IHRydWU7XG5cbiAgICBASW5wdXQoKVxuICAgIHJlYWRPbmx5Rm9ybTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgQE91dHB1dCgpXG4gICAgb3V0Y29tZUNsaWNrOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gICAgQFZpZXdDaGlsZCgnb3V0Y29tZXNDb250YWluZXInLCB7fSlcbiAgICBvdXRjb21lc0NvbnRhaW5lcjogRWxlbWVudFJlZiA9IG51bGw7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRyYW5zbGF0ZTogQWxmcmVzY29UcmFuc2xhdGlvblNlcnZpY2UsXG4gICAgICAgICAgICAgICAgZm9ybVNlcnZpY2U6IEZvcm1TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHZpc2liaWxpdHlTZXJ2aWNlOiBXaWRnZXRWaXNpYmlsaXR5U2VydmljZSxcbiAgICAgICAgICAgICAgICBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlKSB7XG4gICAgICAgIHN1cGVyKGZvcm1TZXJ2aWNlLCB2aXNpYmlsaXR5U2VydmljZSwgbnVsbCwgbnVsbCwgbG9nU2VydmljZSk7XG5cbiAgICAgICAgaWYgKHRoaXMudHJhbnNsYXRlKSB7XG4gICAgICAgICAgICB0aGlzLnRyYW5zbGF0ZS5hZGRUcmFuc2xhdGlvbkZvbGRlcignbmcyLWFjdGl2aXRpLWZvcm0nLCAnbm9kZV9tb2R1bGVzL25nMi1hY3Rpdml0aS1mb3JtL3NyYycpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zaG93VGl0bGUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgICAgIGxldCBwcm9jZXNzRGVmaW5pdGlvbklkID0gY2hhbmdlc1sncHJvY2Vzc0RlZmluaXRpb25JZCddO1xuICAgICAgICBpZiAocHJvY2Vzc0RlZmluaXRpb25JZCAmJiBwcm9jZXNzRGVmaW5pdGlvbklkLmN1cnJlbnRWYWx1ZSkge1xuICAgICAgICAgICAgdGhpcy52aXNpYmlsaXR5U2VydmljZS5jbGVhblByb2Nlc3NWYXJpYWJsZSgpO1xuICAgICAgICAgICAgdGhpcy5nZXRTdGFydEZvcm1EZWZpbml0aW9uKHByb2Nlc3NEZWZpbml0aW9uSWQuY3VycmVudFZhbHVlKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBwcm9jZXNzSWQgPSBjaGFuZ2VzWydwcm9jZXNzSWQnXTtcbiAgICAgICAgaWYgKHByb2Nlc3NJZCAmJiBwcm9jZXNzSWQuY3VycmVudFZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnZpc2liaWxpdHlTZXJ2aWNlLmNsZWFuUHJvY2Vzc1ZhcmlhYmxlKCk7XG4gICAgICAgICAgICB0aGlzLmxvYWRTdGFydEZvcm0ocHJvY2Vzc0lkLmN1cnJlbnRWYWx1ZSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBsb2FkU3RhcnRGb3JtKHByb2Nlc3NJZDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuZm9ybVNlcnZpY2VcbiAgICAgICAgICAgIC5nZXRTdGFydEZvcm1JbnN0YW5jZShwcm9jZXNzSWQpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIGZvcm0gPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1OYW1lID0gZm9ybS5uYW1lO1xuICAgICAgICAgICAgICAgICAgICBmb3JtLnByb2Nlc3NEZWZpbml0aW9uSWQgPSB0aGlzLnByb2Nlc3NEZWZpbml0aW9uSWQ7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybSA9IHRoaXMucGFyc2VGb3JtKGZvcm0pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm0ucmVhZE9ubHkgPSB0aGlzLnJlYWRPbmx5Rm9ybTtcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5mb3JtLnByb2Nlc3NEZWZpbml0aW9uSWQgPSB0aGlzLnByb2Nlc3NEZWZpbml0aW9uSWQ7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybUxvYWRlZC5lbWl0KHRoaXMuZm9ybSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBlcnJvciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycm9yKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBnZXRTdGFydEZvcm1EZWZpbml0aW9uKHByb2Nlc3NJZDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuZm9ybVNlcnZpY2VcbiAgICAgICAgICAgIC5nZXRTdGFydEZvcm1EZWZpbml0aW9uKHByb2Nlc3NJZClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgZm9ybSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybU5hbWUgPSBmb3JtLnByb2Nlc3NEZWZpbml0aW9uTmFtZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtID0gdGhpcy5wYXJzZUZvcm0oZm9ybSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybS5yZWFkT25seSA9IHRoaXMucmVhZE9ubHlGb3JtO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1Mb2FkZWQuZW1pdCh0aGlzLmZvcm0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZXJyb3IgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnJvcilcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqIEBvdmVycmlkZSAqL1xuICAgIGlzT3V0Y29tZUJ1dHRvblZpc2libGUob3V0Y29tZTogRm9ybU91dGNvbWVNb2RlbCwgaXNGb3JtUmVhZE9ubHk6IGJvb2xlYW4pOiBib29sZWFuIHtcbiAgICAgICAgaWYgKG91dGNvbWUgJiYgb3V0Y29tZS5pc1N5c3RlbSAmJiAoIG91dGNvbWUubmFtZSA9PT0gRm9ybU91dGNvbWVNb2RlbC5TQVZFX0FDVElPTiB8fFxuICAgICAgICAgICAgb3V0Y29tZS5uYW1lID09PSBGb3JtT3V0Y29tZU1vZGVsLkNPTVBMRVRFX0FDVElPTiApKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZWxzZSBpZiAob3V0Y29tZSAmJiBvdXRjb21lLm5hbWUgPT09IEZvcm1PdXRjb21lTW9kZWwuU1RBUlRfUFJPQ0VTU19BQ1RJT04pIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdXBlci5pc091dGNvbWVCdXR0b25WaXNpYmxlKG91dGNvbWUsIGlzRm9ybVJlYWRPbmx5KTtcbiAgICB9XG5cbiAgICAvKiogQG92ZXJyaWRlICovXG4gICAgc2F2ZVRhc2tGb3JtKCkge1xuICAgICAgICAvLyBkbyBub3RoaW5nXG4gICAgfVxuXG4gICAgLyoqIEBvdmVycmlkZSAqL1xuICAgIG9uUmVmcmVzaENsaWNrZWQoKSB7XG4gICAgICAgIGlmICh0aGlzLnByb2Nlc3NEZWZpbml0aW9uSWQpIHtcbiAgICAgICAgICAgIHRoaXMudmlzaWJpbGl0eVNlcnZpY2UuY2xlYW5Qcm9jZXNzVmFyaWFibGUoKTtcbiAgICAgICAgICAgIHRoaXMuZ2V0U3RhcnRGb3JtRGVmaW5pdGlvbih0aGlzLnByb2Nlc3NEZWZpbml0aW9uSWQpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMucHJvY2Vzc0lkKSB7XG4gICAgICAgICAgICB0aGlzLnZpc2liaWxpdHlTZXJ2aWNlLmNsZWFuUHJvY2Vzc1ZhcmlhYmxlKCk7XG4gICAgICAgICAgICB0aGlzLmxvYWRTdGFydEZvcm0odGhpcy5wcm9jZXNzSWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29tcGxldGVUYXNrRm9ybShvdXRjb21lPzogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMub3V0Y29tZUNsaWNrLmVtaXQob3V0Y29tZSk7XG4gICAgfVxufVxuIl19
