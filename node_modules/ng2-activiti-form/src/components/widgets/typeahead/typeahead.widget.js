/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var form_service_1 = require("./../../../services/form.service");
var widget_component_1 = require("./../widget.component");
var widget_visibility_service_1 = require("../../../services/widget-visibility.service");
var TypeaheadWidget = (function (_super) {
    __extends(TypeaheadWidget, _super);
    function TypeaheadWidget(formService, visibilityService, logService) {
        var _this = _super.call(this) || this;
        _this.formService = formService;
        _this.visibilityService = visibilityService;
        _this.logService = logService;
        _this.popupVisible = false;
        _this.minTermLength = 1;
        _this.options = [];
        return _this;
    }
    TypeaheadWidget.prototype.ngOnInit = function () {
        if (this.field.form.taskId) {
            this.getValuesByTaskId();
        }
        else {
            this.getValuesByProcessDefinitionId();
        }
    };
    TypeaheadWidget.prototype.getValuesByTaskId = function () {
        var _this = this;
        this.formService
            .getRestFieldValues(this.field.form.taskId, this.field.id)
            .subscribe(function (result) {
            var options = result || [];
            _this.field.options = options;
            var fieldValue = _this.field.value;
            if (fieldValue) {
                var toSelect = options.find(function (item) { return item.id === fieldValue; });
                if (toSelect) {
                    _this.value = toSelect.name;
                }
            }
            _this.field.updateForm();
            _this.visibilityService.refreshEntityVisibility(_this.field);
        }, function (err) { return _this.handleError(err); });
    };
    TypeaheadWidget.prototype.getValuesByProcessDefinitionId = function () {
        var _this = this;
        this.formService
            .getRestFieldValuesByProcessId(this.field.form.processDefinitionId, this.field.id)
            .subscribe(function (result) {
            var options = result || [];
            _this.field.options = options;
            var fieldValue = _this.field.value;
            if (fieldValue) {
                var toSelect = options.find(function (item) { return item.id === fieldValue; });
                if (toSelect) {
                    _this.value = toSelect.name;
                }
            }
            _this.field.updateForm();
            _this.visibilityService.refreshEntityVisibility(_this.field);
        }, function (err) { return _this.handleError(err); });
    };
    TypeaheadWidget.prototype.getOptions = function () {
        var val = this.value.toLocaleLowerCase();
        return this.field.options.filter(function (item) {
            var name = item.name.toLocaleLowerCase();
            return name.indexOf(val) > -1;
        });
    };
    TypeaheadWidget.prototype.onKeyUp = function (event) {
        if (this.value && this.value.length >= this.minTermLength) {
            this.options = this.getOptions();
            this.popupVisible = this.options.length > 0;
        }
        else {
            this.popupVisible = false;
        }
    };
    TypeaheadWidget.prototype.onBlur = function () {
        var _this = this;
        setTimeout(function () {
            _this.flushValue();
            _this.checkVisibility();
        }, 200);
    };
    TypeaheadWidget.prototype.flushValue = function () {
        this.popupVisible = false;
        var options = this.field.options || [];
        var lValue = this.value ? this.value.toLocaleLowerCase() : null;
        var field = options.find(function (item) { return item.name && item.name.toLocaleLowerCase() === lValue; });
        if (field) {
            this.field.value = field.id;
            this.value = field.name;
        }
        else {
            this.field.value = null;
            this.value = null;
        }
        this.field.updateForm();
    };
    TypeaheadWidget.prototype.onItemClick = function (item, event) {
        if (item) {
            this.field.value = item.id;
            this.value = item.name;
            this.checkVisibility();
        }
        if (event) {
            event.preventDefault();
        }
    };
    TypeaheadWidget.prototype.handleError = function (error) {
        this.logService.error(error);
    };
    TypeaheadWidget.prototype.checkVisibility = function () {
        this.visibilityService.refreshVisibility(this.field.form);
    };
    return TypeaheadWidget;
}(widget_component_1.WidgetComponent));
TypeaheadWidget = __decorate([
    core_1.Component({
        moduleId: module.id,
        selector: 'typeahead-widget',
        template: "<div class=\"mdl-textfield mdl-js-textfield typeahead-widget\"      [class.is-dirty]=\"value\"      [class.typeahead-widget__invalid]=\"!field.isValid\" id=\"typehead-div\" *ngIf=\"field.isVisible\">     <label [attr.for]=\"field.id\">{{field.name}}</label>     <input class=\"mdl-textfield__input\"            type=\"text\"            [attr.id]=\"field.id\"            [(ngModel)]=\"value\"            (keyup)=\"onKeyUp($event)\"            (blur)=\"onBlur()\"            [disabled]=\"field.readOnly\"            placeholder=\"{{field.placeholder}}\">     <span *ngIf=\"field.validationSummary\" class=\"mdl-textfield__error\">{{field.validationSummary}}</span> </div> <div class=\"typeahead-autocomplete mdl-shadow--2dp\" *ngIf=\"options.length > 0 && popupVisible\">     <ul>         <li *ngFor=\"let item of options\"             [attr.id]=\"field.id +'-'+item.id\"             class=\"mdl-menu__item\"             (click)=\"onItemClick(item, $event)\">             {{item.name}}         </li>     </ul> </div>",
        styles: [".typeahead-widget {     width: 100%; }  .typeahead-autocomplete {     background-color: #fff;     position: relative;     max-height: 200px;     overflow-y: auto;     z-index: 5;     color: #555;     margin: -15px 0 0 0; }  .typeahead-autocomplete > ul {     list-style-type: none;     position: static;      height: auto;     width: auto;     min-width: 124px;     padding: 8px 0;     margin: 0;      box-shadow: 0 2px 2px 0 rgba(0,0,0,.14),0 3px 1px -2px rgba(0,0,0,.2),0 1px 5px 0 rgba(0,0,0,.12);     border-radius: 2px; }  .typeahead-autocomplete > ul > li {     opacity: 1; }    .typeahead-widget__invalid .mdl-textfield__input {     border-color: #d50000; }  .typeahead-widget__invalid .mdl-textfield__label {     color: #d50000; }  .typeahead-widget__invalid .mdl-textfield__label:after {     background-color: #d50000; }  .typeahead-widget__invalid .mdl-textfield__error {     visibility: visible !important; }"]
    }),
    __metadata("design:paramtypes", [form_service_1.FormService,
        widget_visibility_service_1.WidgetVisibilityService,
        ng2_alfresco_core_1.LogService])
], TypeaheadWidget);
exports.TypeaheadWidget = TypeaheadWidget;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvd2lkZ2V0cy90eXBlYWhlYWQvdHlwZWFoZWFkLndpZGdldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFSCxzQ0FBa0Q7QUFDbEQsdURBQStDO0FBQy9DLGlFQUErRDtBQUMvRCwwREFBd0Q7QUFFeEQseUZBQXNGO0FBUXRGLElBQWEsZUFBZTtJQUFTLG1DQUFlO0lBT2hELHlCQUFvQixXQUF3QixFQUN4QixpQkFBMEMsRUFDMUMsVUFBc0I7UUFGMUMsWUFHSSxpQkFBTyxTQUNWO1FBSm1CLGlCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLHVCQUFpQixHQUFqQixpQkFBaUIsQ0FBeUI7UUFDMUMsZ0JBQVUsR0FBVixVQUFVLENBQVk7UUFQMUMsa0JBQVksR0FBWSxLQUFLLENBQUM7UUFDOUIsbUJBQWEsR0FBVyxDQUFDLENBQUM7UUFFMUIsYUFBTyxHQUFzQixFQUFFLENBQUM7O0lBTWhDLENBQUM7SUFFRCxrQ0FBUSxHQUFSO1FBQ0ksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUN6QixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUM3QixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixJQUFJLENBQUMsOEJBQThCLEVBQUUsQ0FBQztRQUMxQyxDQUFDO0lBQ0wsQ0FBQztJQUVELDJDQUFpQixHQUFqQjtRQUFBLGlCQXVCQztRQXRCRyxJQUFJLENBQUMsV0FBVzthQUNYLGtCQUFrQixDQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFDdEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQ2hCO2FBQ0EsU0FBUyxDQUNOLFVBQUMsTUFBeUI7WUFDdEIsSUFBSSxPQUFPLEdBQUcsTUFBTSxJQUFJLEVBQUUsQ0FBQztZQUMzQixLQUFJLENBQUMs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QUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFHRCxxQ0FBVyxHQUFYLFVBQVksSUFBcUIsRUFBRSxLQUFZO1FBQzNDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDUCxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQzNCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztZQUN2QixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDM0IsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDUixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDM0IsQ0FBQztJQUNMLENBQUM7SUFFRCxxQ0FBVyxHQUFYLFVBQVksS0FBVTtRQUNsQixJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUQseUNBQWUsR0FBZjtRQUNJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFTCxzQkFBQztBQUFELENBdElBLEFBc0lDLENBdElvQyxrQ0FBZSxHQXNJbkQ7QUF0SVksZUFBZTtJQU4zQixnQkFBUyxDQUFDO1FBQ1AsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1FBQ25CLFFBQVEsRUFBRSxrQkFBa0I7UUFDNUIsUUFBUSxFQUFFLHcvQkFBdy9CO1FBQ2xnQyxNQUFNLEVBQUUsQ0FBQyx5NUJBQXk1QixDQUFDO0tBQ3Q2QixDQUFDO3FDQVFtQywwQkFBVztRQUNMLG1EQUF1QjtRQUM5Qiw4QkFBVTtHQVRqQyxlQUFlLENBc0kzQjtBQXRJWSwwQ0FBZSIsImZpbGUiOiJjb21wb25lbnRzL3dpZGdldHMvdHlwZWFoZWFkL3R5cGVhaGVhZC53aWRnZXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxNiBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTG9nU2VydmljZSB9IGZyb20gJ25nMi1hbGZyZXNjby1jb3JlJztcbmltcG9ydCB7IEZvcm1TZXJ2aWNlIH0gZnJvbSAnLi8uLi8uLi8uLi9zZXJ2aWNlcy9mb3JtLnNlcnZpY2UnO1xuaW1wb3J0IHsgV2lkZ2V0Q29tcG9uZW50IH0gZnJvbSAnLi8uLi93aWRnZXQuY29tcG9uZW50JztcbmltcG9ydCB7IEZvcm1GaWVsZE9wdGlvbiB9IGZyb20gJy4vLi4vY29yZS9mb3JtLWZpZWxkLW9wdGlvbic7XG5pbXBvcnQgeyBXaWRnZXRWaXNpYmlsaXR5U2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL3dpZGdldC12aXNpYmlsaXR5LnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgICBtb2R1bGVJZDogbW9kdWxlLmlkLFxuICAgIHNlbGVjdG9yOiAndHlwZWFoZWFkLXdpZGdldCcsXG4gICAgdGVtcGxhdGU6IFwiPGRpdiBjbGFzcz1cXFwibWRsLXRleHRmaWVsZCBtZGwtanMtdGV4dGZpZWxkIHR5cGVhaGVhZC13aWRnZXRcXFwiICAgICAgW2NsYXNzLmlzLWRpcnR5XT1cXFwidmFsdWVcXFwiICAgICAgW2NsYXNzLnR5cGVhaGVhZC13aWRnZXRfX2ludmFsaWRdPVxcXCIhZmllbGQuaXNWYWxpZFxcXCIgaWQ9XFxcInR5cGVoZWFkLWRpdlxcXCIgKm5nSWY9XFxcImZpZWxkLmlzVmlzaWJsZVxcXCI+ICAgICA8bGFiZWwgW2F0dHIuZm9yXT1cXFwiZmllbGQuaWRcXFwiPnt7ZmllbGQubmFtZX19PC9sYWJlbD4gICAgIDxpbnB1dCBjbGFzcz1cXFwibWRsLXRleHRmaWVsZF9faW5wdXRcXFwiICAgICAgICAgICAgdHlwZT1cXFwidGV4dFxcXCIgICAgICAgICAgICBbYXR0ci5pZF09XFxcImZpZWxkLmlkXFxcIiAgICAgICAgICAgIFsobmdNb2RlbCldPVxcXCJ2YWx1ZVxcXCIgICAgICAgICAgICAoa2V5dXApPVxcXCJvbktleVVwKCRldmVudClcXFwiICAgICAgICAgICAgKGJsdXIpPVxcXCJvbkJsdXIoKVxcXCIgICAgICAgICAgICBbZGlzYWJsZWRdPVxcXCJmaWVsZC5yZWFkT25seVxcXCIgICAgICAgICAgICBwbGFjZWhvbGRlcj1cXFwie3tmaWVsZC5wbGFjZWhvbGRlcn19XFxcIj4gICAgIDxzcGFuICpuZ0lmPVxcXCJmaWVsZC52YWxpZGF0aW9uU3VtbWFyeVxcXCIgY2xhc3M9XFxcIm1kbC10ZXh0ZmllbGRfX2Vycm9yXFxcIj57e2ZpZWxkLnZhbGlkYXRpb25TdW1tYXJ5fX08L3NwYW4+IDwvZGl2PiA8ZGl2IGNsYXNzPVxcXCJ0eXBlYWhlYWQtYXV0b2NvbXBsZXRlIG1kbC1zaGFkb3ctLTJkcFxcXCIgKm5nSWY9XFxcIm9wdGlvbnMubGVuZ3RoID4gMCAmJiBwb3B1cFZpc2libGVcXFwiPiAgICAgPHVsPiAgICAgICAgIDxsaSAqbmdGb3I9XFxcImxldCBpdGVtIG9mIG9wdGlvbnNcXFwiICAgICAgICAgICAgIFthdHRyLmlkXT1cXFwiZmllbGQuaWQgKyctJytpdGVtLmlkXFxcIiAgICAgICAgICAgICBjbGFzcz1cXFwibWRsLW1lbnVfX2l0ZW1cXFwiICAgICAgICAgICAgIChjbGljayk9XFxcIm9uSXRlbUNsaWNrKGl0ZW0sICRldmVudClcXFwiPiAgICAgICAgICAgICB7e2l0ZW0ubmFtZX19ICAgICAgICAgPC9saT4gICAgIDwvdWw+IDwvZGl2PlwiLFxuICAgIHN0eWxlczogW1wiLnR5cGVhaGVhZC13aWRnZXQgeyAgICAgd2lkdGg6IDEwMCU7IH0gIC50eXBlYWhlYWQtYXV0b2NvbXBsZXRlIHsgICAgIGJhY2tncm91bmQtY29sb3I6ICNmZmY7ICAgICBwb3NpdGlvbjogcmVsYXRpdmU7ICAgICBtYXgtaGVpZ2h0OiAyMDBweDsgICAgIG92ZXJmbG93LXk6IGF1dG87ICAgICB6LWluZGV4OiA1OyAgICAgY29sb3I6ICM1NTU7ICAgICBtYXJnaW46IC0xNXB4IDAgMCAwOyB9ICAudHlwZWFoZWFkLWF1dG9jb21wbGV0ZSA+IHVsIHsgICAgIGxpc3Qtc3R5bGUtdHlwZTogbm9uZTsgICAgIHBvc2l0aW9uOiBzdGF0aWM7ICAgICAgaGVpZ2h0OiBhdXRvOyAgICAgd2lkdGg6IGF1dG87ICAgICBtaW4td2lkdGg6IDEyNHB4OyAgICAgcGFkZGluZzogOHB4IDA7ICAgICBtYXJnaW46IDA7ICAgICAgYm94LXNoYWRvdzogMCAycHggMnB4IDAgcmdiYSgwLDAsMCwuMTQpLDAgM3B4IDFweCAtMnB4IHJnYmEoMCwwLDAsLjIpLDAgMXB4IDVweCAwIHJnYmEoMCwwLDAsLjEyKTsgICAgIGJvcmRlci1yYWRpdXM6IDJweDsgfSAgLnR5cGVhaGVhZC1hdXRvY29tcGxldGUgPiB1bCA+IGxpIHsgICAgIG9wYWNpdHk6IDE7IH0gICAgLnR5cGVhaGVhZC13aWRnZXRfX2ludmFsaWQgLm1kbC10ZXh0ZmllbGRfX2lucHV0IHsgICAgIGJvcmRlci1jb2xvcjogI2Q1MDAwMDsgfSAgLnR5cGVhaGVhZC13aWRnZXRfX2ludmFsaWQgLm1kbC10ZXh0ZmllbGRfX2xhYmVsIHsgICAgIGNvbG9yOiAjZDUwMDAwOyB9ICAudHlwZWFoZWFkLXdpZGdldF9faW52YWxpZCAubWRsLXRleHRmaWVsZF9fbGFiZWw6YWZ0ZXIgeyAgICAgYmFja2dyb3VuZC1jb2xvcjogI2Q1MDAwMDsgfSAgLnR5cGVhaGVhZC13aWRnZXRfX2ludmFsaWQgLm1kbC10ZXh0ZmllbGRfX2Vycm9yIHsgICAgIHZpc2liaWxpdHk6IHZpc2libGUgIWltcG9ydGFudDsgfVwiXVxufSlcbmV4cG9ydCBjbGFzcyBUeXBlYWhlYWRXaWRnZXQgZXh0ZW5kcyBXaWRnZXRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuXG4gICAgcG9wdXBWaXNpYmxlOiBib29sZWFuID0gZmFsc2U7XG4gICAgbWluVGVybUxlbmd0aDogbnVtYmVyID0gMTtcbiAgICB2YWx1ZTogc3RyaW5nO1xuICAgIG9wdGlvbnM6IEZvcm1GaWVsZE9wdGlvbltdID0gW107XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZvcm1TZXJ2aWNlOiBGb3JtU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHZpc2liaWxpdHlTZXJ2aWNlOiBXaWRnZXRWaXNpYmlsaXR5U2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuZmllbGQuZm9ybS50YXNrSWQpIHtcbiAgICAgICAgICAgIHRoaXMuZ2V0VmFsdWVzQnlUYXNrSWQoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZ2V0VmFsdWVzQnlQcm9jZXNzRGVmaW5pdGlvbklkKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRWYWx1ZXNCeVRhc2tJZCgpIHtcbiAgICAgICAgdGhpcy5mb3JtU2VydmljZVxuICAgICAgICAgICAgLmdldFJlc3RGaWVsZFZhbHVlcyhcbiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmZvcm0udGFza0lkLFxuICAgICAgICAgICAgICAgIHRoaXMuZmllbGQuaWRcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKHJlc3VsdDogRm9ybUZpZWxkT3B0aW9uW10pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSByZXN1bHQgfHwgW107XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQub3B0aW9ucyA9IG9wdGlvbnM7XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpZWxkVmFsdWUgPSB0aGlzLmZpZWxkLnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGRWYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRvU2VsZWN0ID0gb3B0aW9ucy5maW5kKGl0ZW0gPT4gaXRlbS5pZCA9PT0gZmllbGRWYWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9TZWxlY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbHVlID0gdG9TZWxlY3QubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLnVwZGF0ZUZvcm0oKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXNpYmlsaXR5U2VydmljZS5yZWZyZXNoRW50aXR5VmlzaWJpbGl0eSh0aGlzLmZpZWxkKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGVyciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycilcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgZ2V0VmFsdWVzQnlQcm9jZXNzRGVmaW5pdGlvbklkKCkge1xuICAgICAgICB0aGlzLmZvcm1TZXJ2aWNlXG4gICAgICAgICAgICAuZ2V0UmVzdEZpZWxkVmFsdWVzQnlQcm9jZXNzSWQoXG4gICAgICAgICAgICAgICAgdGhpcy5maWVsZC5mb3JtLnByb2Nlc3NEZWZpbml0aW9uSWQsXG4gICAgICAgICAgICAgICAgdGhpcy5maWVsZC5pZFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAocmVzdWx0OiBGb3JtRmllbGRPcHRpb25bXSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgb3B0aW9ucyA9IHJlc3VsdCB8fCBbXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWVsZC5vcHRpb25zID0gb3B0aW9ucztcblxuICAgICAgICAgICAgICAgICAgICBsZXQgZmllbGRWYWx1ZSA9IHRoaXMuZmllbGQudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZFZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgdG9TZWxlY3QgPSBvcHRpb25zLmZpbmQoaXRlbSA9PiBpdGVtLmlkID09PSBmaWVsZFZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b1NlbGVjdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmFsdWUgPSB0b1NlbGVjdC5uYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQudXBkYXRlRm9ybSgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnZpc2liaWxpdHlTZXJ2aWNlLnJlZnJlc2hFbnRpdHlWaXNpYmlsaXR5KHRoaXMuZmllbGQpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZXJyID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBnZXRPcHRpb25zKCk6IEZvcm1GaWVsZE9wdGlvbltdIHtcbiAgICAgICAgbGV0IHZhbCA9IHRoaXMudmFsdWUudG9Mb2NhbGVMb3dlckNhc2UoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmllbGQub3B0aW9ucy5maWx0ZXIoaXRlbSA9PiB7XG4gICAgICAgICAgICBsZXQgbmFtZSA9IGl0ZW0ubmFtZS50b0xvY2FsZUxvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgcmV0dXJuIG5hbWUuaW5kZXhPZih2YWwpID4gLTE7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIG9uS2V5VXAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgICAgaWYgKHRoaXMudmFsdWUgJiYgdGhpcy52YWx1ZS5sZW5ndGggPj0gdGhpcy5taW5UZXJtTGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLmdldE9wdGlvbnMoKTtcbiAgICAgICAgICAgIHRoaXMucG9wdXBWaXNpYmxlID0gdGhpcy5vcHRpb25zLmxlbmd0aCA+IDA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVwVmlzaWJsZSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25CbHVyKCkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZmx1c2hWYWx1ZSgpO1xuICAgICAgICAgICAgdGhpcy5jaGVja1Zpc2liaWxpdHkoKTtcbiAgICAgICAgfSwgMjAwKTtcbiAgICB9XG5cbiAgICBmbHVzaFZhbHVlKCkge1xuICAgICAgICB0aGlzLnBvcHVwVmlzaWJsZSA9IGZhbHNlO1xuXG4gICAgICAgIGxldCBvcHRpb25zID0gdGhpcy5maWVsZC5vcHRpb25zIHx8IFtdO1xuICAgICAgICBsZXQgbFZhbHVlID0gdGhpcy52YWx1ZSA/IHRoaXMudmFsdWUudG9Mb2NhbGVMb3dlckNhc2UoKSA6IG51bGw7XG5cbiAgICAgICAgbGV0IGZpZWxkID0gb3B0aW9ucy5maW5kKGl0ZW0gPT4gaXRlbS5uYW1lICYmIGl0ZW0ubmFtZS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSBsVmFsdWUpO1xuICAgICAgICBpZiAoZmllbGQpIHtcbiAgICAgICAgICAgIHRoaXMuZmllbGQudmFsdWUgPSBmaWVsZC5pZDtcbiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBmaWVsZC5uYW1lO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5maWVsZC52YWx1ZSA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLnZhbHVlID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRPRE86IHNlZW1zIHRvIGJlIG5vdCBuZWVkZWQgYXMgZmllbGQudmFsdWUgc2V0dGVyIGNhbGxzIGl0XG4gICAgICAgIHRoaXMuZmllbGQudXBkYXRlRm9ybSgpO1xuICAgIH1cblxuICAgIC8vIFRPRE86IHN0aWxsIGNhdXNlcyBvbkJsdXIgZXhlY3V0aW9uXG4gICAgb25JdGVtQ2xpY2soaXRlbTogRm9ybUZpZWxkT3B0aW9uLCBldmVudDogRXZlbnQpIHtcbiAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICAgIHRoaXMuZmllbGQudmFsdWUgPSBpdGVtLmlkO1xuICAgICAgICAgICAgdGhpcy52YWx1ZSA9IGl0ZW0ubmFtZTtcbiAgICAgICAgICAgIHRoaXMuY2hlY2tWaXNpYmlsaXR5KCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGV2ZW50KSB7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaGFuZGxlRXJyb3IoZXJyb3I6IGFueSkge1xuICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoZXJyb3IpO1xuICAgIH1cblxuICAgIGNoZWNrVmlzaWJpbGl0eSgpIHtcbiAgICAgICAgdGhpcy52aXNpYmlsaXR5U2VydmljZS5yZWZyZXNoVmlzaWJpbGl0eSh0aGlzLmZpZWxkLmZvcm0pO1xuICAgIH1cblxufVxuIl19
