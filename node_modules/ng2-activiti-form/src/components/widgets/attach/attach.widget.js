/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var ng2_alfresco_core_1 = require("ng2-alfresco-core");
var widget_component_1 = require("./../widget.component");
var activiti_alfresco_service_1 = require("../../../services/activiti-alfresco.service");
var form_field_model_1 = require("../core/form-field.model");
var AttachWidget = (function (_super) {
    __extends(AttachWidget, _super);
    function AttachWidget(contentService, logService) {
        var _this = _super.call(this) || this;
        _this.contentService = contentService;
        _this.logService = logService;
        _this.fieldChanged = new core_1.EventEmitter();
        return _this;
    }
    AttachWidget.prototype.ngOnInit = function () {
        if (this.field) {
            var params = this.field.params;
            if (params &&
                params.fileSource &&
                params.fileSource.selectedFolder) {
                this.selectedFolderSiteId = params.fileSource.selectedFolder.siteId;
                this.selectedFolderSiteName = params.fileSource.selectedFolder.site;
                this.setupFileBrowser();
                this.getExternalContentNodes();
            }
        }
    };
    AttachWidget.prototype.setupFileBrowser = function () {
        if (this.field) {
            var params = this.field.params;
            this.selectedFolderPathId = params.fileSource.selectedFolder.pathId;
            this.selectedFolderAccountId = params.fileSource.selectedFolder.accountId;
        }
    };
    AttachWidget.prototype.getLinkedFileName = function () {
        var result = this.fileName;
        if (this.selectedFile &&
            this.selectedFile.title) {
            result = this.selectedFile.title;
        }
        if (this.field &&
            this.field.value &&
            this.field.value.length > 0 &&
            this.field.value[0].name) {
            result = this.field.value[0].name;
        }
        return result;
    };
    AttachWidget.prototype.getExternalContentNodes = function () {
        var _this = this;
        this.contentService.getAlfrescoNodes(this.selectedFolderAccountId, this.selectedFolderPathId)
            .subscribe(function (nodes) { return _this.selectedFolderNodes = nodes; }, function (error) { return _this.logService.error(error); });
    };
    AttachWidget.prototype.selectFile = function (node, $event) {
        var _this = this;
        this.contentService.linkAlfrescoNode(this.selectedFolderAccountId, node, this.selectedFolderSiteId).subscribe(function (link) {
            _this.selectedFile = node;
            _this.field.value = [link];
            _this.field.json.value = [link];
            _this.closeDialog();
            _this.fieldChanged.emit(_this.field);
        });
    };
    AttachWidget.prototype.selectFolder = function (node, $event) {
        this.selectedFolderPathId = node.id;
        this.getExternalContentNodes();
    };
    AttachWidget.prototype.showDialog = function () {
        this.setupFileBrowser();
        this.getExternalContentNodes();
        if (this.dialog) {
            if (!this.dialog.nativeElement.showModal) {
                dialogPolyfill.registerDialog(this.dialog.nativeElement);
            }
            this.dialog.nativeElement.showModal();
            return true;
        }
        return false;
    };
    AttachWidget.prototype.closeDialog = function () {
        if (this.dialog) {
            this.dialog.nativeElement.close();
        }
    };
    AttachWidget.prototype.cancel = function () {
        this.closeDialog();
    };
    AttachWidget.prototype.reset = function () {
        this.field.value = null;
        this.field.json.value = null;
    };
    AttachWidget.prototype.hasFile = function () {
        return this.field && this.field.value;
    };
    return AttachWidget;
}(widget_component_1.WidgetComponent));
__decorate([
    core_1.Input(),
    __metadata("design:type", form_field_model_1.FormFieldModel)
], AttachWidget.prototype, "field", void 0);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], AttachWidget.prototype, "fieldChanged", void 0);
__decorate([
    core_1.ViewChild('dialog'),
    __metadata("design:type", Object)
], AttachWidget.prototype, "dialog", void 0);
AttachWidget = __decorate([
    core_1.Component({
        moduleId: module.id,
        selector: 'attach-widget',
        template: "<div class=\"attach-widget\">      <label [attr.for]=\"field.id\">{{field.name}}</label>     <div>         <span *ngIf=\"hasFile()\" class=\"attach-widget__file mdl-chip\"><span class=\"mdl-chip__text\">{{getLinkedFileName()}}</span></span>         <button #browseFile (click)=\"showDialog();\" class=\"mdl-button mdl-js-button mdl-js-ripple-effect attach-widget__browser\">             <i class=\"material-icons\">image</i>             Browse {{selectedFolderSiteName}}         </button>         <button *ngIf=\"hasFile\" (click)=\"reset(file);\" class=\"mdl-button mdl-js-button mdl-js-ripple-effect attach-widget__reset\">Clear</button>     </div> </div>  <dialog class=\"mdl-dialog\" #dialog>     <h4 class=\"mdl-dialog__title\">Select content</h4>     <div class=\"mdl-dialog__content\">         <ul class='mdl-list'>             <li class=\"mdl-list__item\" *ngFor=\"let node of selectedFolderNodes\">             <span class=\"mdl-list__item-primary-content\" *ngIf=\"node.folder\">             <i class=\"material-icons mdl-list__item-icon\">folder</i>             <a (click)=\"selectFolder(node, $event)\">{{node.title}}</a>             </span>             <span class=\"mdl-list__item-primary-content\" *ngIf=\"!node.folder\">             <i class=\"material-icons mdl-list__item-icon\">description</i>             <a (click)=\"selectFile(node, $event)\">{{node.title}}</a>             </span>             </li>         </ul>     </div>     <div class=\"mdl-dialog__actions\">         <button type=\"button\" (click)=\"cancel()\" class=\"mdl-button close\">Cancel</button>     </div> </dialog>",
        styles: [".attach-widget {     width:100% }  .attach-widget__icon {     float: left; }  .attach-widget__file {     margin-top: 4px; }  .attach-widget__reset {     margin-top: 4px; }"]
    }),
    __metadata("design:paramtypes", [activiti_alfresco_service_1.ActivitiAlfrescoContentService,
        ng2_alfresco_core_1.LogService])
], AttachWidget);
exports.AttachWidget = AttachWidget;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvd2lkZ2V0cy9hdHRhY2gvYXR0YWNoLndpZGdldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFSCxzQ0FBMEY7QUFDMUYsdURBQStDO0FBQy9DLDBEQUF3RDtBQUN4RCx5RkFBNkY7QUFHN0YsNkRBQTBEO0FBVTFELElBQWEsWUFBWTtJQUFTLGdDQUFlO0lBbUI3QyxzQkFBb0IsY0FBOEMsRUFDOUMsVUFBc0I7UUFEMUMsWUFFSSxpQkFBTyxTQUNWO1FBSG1CLG9CQUFjLEdBQWQsY0FBYyxDQUFnQztRQUM5QyxnQkFBVSxHQUFWLFVBQVUsQ0FBWTtRQU4xQyxrQkFBWSxHQUFpQyxJQUFJLG1CQUFZLEVBQWtCLENBQUM7O0lBUWhGLENBQUM7SUFFRCwrQkFBUSxHQUFSO1FBQ0ksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDYixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztZQUUvQixFQUFFLENBQUMsQ0FBQyxNQUFNO2dCQUNOLE1BQU0sQ0FBQyxVQUFVO2dCQUNqQixNQUFNLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7Z0JBQ25DLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUM7Z0JBQ3BFLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUM7Z0JBQ3BFLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO2dCQUN4QixJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztZQUNuQyxDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7SUFFRCx1Q0FBZ0IsR0FBaEI7UUFDSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZ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QztxQ0FvQnNDLDBEQUE4QjtRQUNsQyw4QkFBVTtHQXBCakMsWUFBWSxDQTJIeEI7QUEzSFksb0NBQVkiLCJmaWxlIjoiY29tcG9uZW50cy93aWRnZXRzL2F0dGFjaC9hdHRhY2gud2lkZ2V0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTYgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBMb2dTZXJ2aWNlIH0gZnJvbSAnbmcyLWFsZnJlc2NvLWNvcmUnO1xuaW1wb3J0IHsgV2lkZ2V0Q29tcG9uZW50IH0gZnJvbSAnLi8uLi93aWRnZXQuY29tcG9uZW50JztcbmltcG9ydCB7IEFjdGl2aXRpQWxmcmVzY29Db250ZW50U2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL2FjdGl2aXRpLWFsZnJlc2NvLnNlcnZpY2UnO1xuaW1wb3J0IHsgRXh0ZXJuYWxDb250ZW50IH0gZnJvbSAnLi4vY29yZS9leHRlcm5hbC1jb250ZW50JztcbmltcG9ydCB7IEV4dGVybmFsQ29udGVudExpbmsgfSBmcm9tICcuLi9jb3JlL2V4dGVybmFsLWNvbnRlbnQtbGluayc7XG5pbXBvcnQgeyBGb3JtRmllbGRNb2RlbCB9IGZyb20gJy4uL2NvcmUvZm9ybS1maWVsZC5tb2RlbCc7XG5cbmRlY2xhcmUgbGV0IGRpYWxvZ1BvbHlmaWxsOiBhbnk7XG5cbkBDb21wb25lbnQoe1xuICAgIG1vZHVsZUlkOiBtb2R1bGUuaWQsXG4gICAgc2VsZWN0b3I6ICdhdHRhY2gtd2lkZ2V0JyxcbiAgICB0ZW1wbGF0ZTogXCI8ZGl2IGNsYXNzPVxcXCJhdHRhY2gtd2lkZ2V0XFxcIj4gICAgICA8bGFiZWwgW2F0dHIuZm9yXT1cXFwiZmllbGQuaWRcXFwiPnt7ZmllbGQubmFtZX19PC9sYWJlbD4gICAgIDxkaXY+ICAgICAgICAgPHNwYW4gKm5nSWY9XFxcImhhc0ZpbGUoKVxcXCIgY2xhc3M9XFxcImF0dGFjaC13aWRnZXRfX2ZpbGUgbWRsLWNoaXBcXFwiPjxzcGFuIGNsYXNzPVxcXCJtZGwtY2hpcF9fdGV4dFxcXCI+e3tnZXRMaW5rZWRGaWxlTmFtZSgpfX08L3NwYW4+PC9zcGFuPiAgICAgICAgIDxidXR0b24gI2Jyb3dzZUZpbGUgKGNsaWNrKT1cXFwic2hvd0RpYWxvZygpO1xcXCIgY2xhc3M9XFxcIm1kbC1idXR0b24gbWRsLWpzLWJ1dHRvbiBtZGwtanMtcmlwcGxlLWVmZmVjdCBhdHRhY2gtd2lkZ2V0X19icm93c2VyXFxcIj4gICAgICAgICAgICAgPGkgY2xhc3M9XFxcIm1hdGVyaWFsLWljb25zXFxcIj5pbWFnZTwvaT4gICAgICAgICAgICAgQnJvd3NlIHt7c2VsZWN0ZWRGb2xkZXJTaXRlTmFtZX19ICAgICAgICAgPC9idXR0b24+ICAgICAgICAgPGJ1dHRvbiAqbmdJZj1cXFwiaGFzRmlsZVxcXCIgKGNsaWNrKT1cXFwicmVzZXQoZmlsZSk7XFxcIiBjbGFzcz1cXFwibWRsLWJ1dHRvbiBtZGwtanMtYnV0dG9uIG1kbC1qcy1yaXBwbGUtZWZmZWN0IGF0dGFjaC13aWRnZXRfX3Jlc2V0XFxcIj5DbGVhcjwvYnV0dG9uPiAgICAgPC9kaXY+IDwvZGl2PiAgPGRpYWxvZyBjbGFzcz1cXFwibWRsLWRpYWxvZ1xcXCIgI2RpYWxvZz4gICAgIDxoNCBjbGFzcz1cXFwibWRsLWRpYWxvZ19fdGl0bGVcXFwiPlNlbGVjdCBjb250ZW50PC9oND4gICAgIDxkaXYgY2xhc3M9XFxcIm1kbC1kaWFsb2dfX2NvbnRlbnRcXFwiPiAgICAgICAgIDx1bCBjbGFzcz0nbWRsLWxpc3QnPiAgICAgICAgICAgICA8bGkgY2xhc3M9XFxcIm1kbC1saXN0X19pdGVtXFxcIiAqbmdGb3I9XFxcImxldCBub2RlIG9mIHNlbGVjdGVkRm9sZGVyTm9kZXNcXFwiPiAgICAgICAgICAgICA8c3BhbiBjbGFzcz1cXFwibWRsLWxpc3RfX2l0ZW0tcHJpbWFyeS1jb250ZW50XFxcIiAqbmdJZj1cXFwibm9kZS5mb2xkZXJcXFwiPiAgICAgICAgICAgICA8aSBjbGFzcz1cXFwibWF0ZXJpYWwtaWNvbnMgbWRsLWxpc3RfX2l0ZW0taWNvblxcXCI+Zm9sZGVyPC9pPiAgICAgICAgICAgICA8YSAoY2xpY2spPVxcXCJzZWxlY3RGb2xkZXIobm9kZSwgJGV2ZW50KVxcXCI+e3tub2RlLnRpdGxlfX08L2E+ICAgICAgICAgICAgIDwvc3Bhbj4gICAgICAgICAgICAgPHNwYW4gY2xhc3M9XFxcIm1kbC1saXN0X19pdGVtLXByaW1hcnktY29udGVudFxcXCIgKm5nSWY9XFxcIiFub2RlLmZvbGRlclxcXCI+ICAgICAgICAgICAgIDxpIGNsYXNzPVxcXCJtYXRlcmlhbC1pY29ucyBtZGwtbGlzdF9faXRlbS1pY29uXFxcIj5kZXNjcmlwdGlvbjwvaT4gICAgICAgICAgICAgPGEgKGNsaWNrKT1cXFwic2VsZWN0RmlsZShub2RlLCAkZXZlbnQpXFxcIj57e25vZGUudGl0bGV9fTwvYT4gICAgICAgICAgICAgPC9zcGFuPiAgICAgICAgICAgICA8L2xpPiAgICAgICAgIDwvdWw+ICAgICA8L2Rpdj4gICAgIDxkaXYgY2xhc3M9XFxcIm1kbC1kaWFsb2dfX2FjdGlvbnNcXFwiPiAgICAgICAgIDxidXR0b24gdHlwZT1cXFwiYnV0dG9uXFxcIiAoY2xpY2spPVxcXCJjYW5jZWwoKVxcXCIgY2xhc3M9XFxcIm1kbC1idXR0b24gY2xvc2VcXFwiPkNhbmNlbDwvYnV0dG9uPiAgICAgPC9kaXY+IDwvZGlhbG9nPlwiLFxuICAgIHN0eWxlczogW1wiLmF0dGFjaC13aWRnZXQgeyAgICAgd2lkdGg6MTAwJSB9ICAuYXR0YWNoLXdpZGdldF9faWNvbiB7ICAgICBmbG9hdDogbGVmdDsgfSAgLmF0dGFjaC13aWRnZXRfX2ZpbGUgeyAgICAgbWFyZ2luLXRvcDogNHB4OyB9ICAuYXR0YWNoLXdpZGdldF9fcmVzZXQgeyAgICAgbWFyZ2luLXRvcDogNHB4OyB9XCJdXG59KVxuZXhwb3J0IGNsYXNzIEF0dGFjaFdpZGdldCBleHRlbmRzIFdpZGdldENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG5cbiAgICBzZWxlY3RlZEZvbGRlclBhdGhJZDogc3RyaW5nO1xuICAgIHNlbGVjdGVkRm9sZGVyU2l0ZUlkOiBzdHJpbmc7XG4gICAgc2VsZWN0ZWRGb2xkZXJTaXRlTmFtZTogc3RyaW5nO1xuICAgIHNlbGVjdGVkRm9sZGVyQWNjb3VudElkOiBzdHJpbmc7XG4gICAgZmlsZU5hbWU6IHN0cmluZztcbiAgICBzZWxlY3RlZEZvbGRlck5vZGVzOiBbRXh0ZXJuYWxDb250ZW50XTtcbiAgICBzZWxlY3RlZEZpbGU6IEV4dGVybmFsQ29udGVudDtcblxuICAgIEBJbnB1dCgpXG4gICAgZmllbGQ6IEZvcm1GaWVsZE1vZGVsO1xuXG4gICAgQE91dHB1dCgpXG4gICAgZmllbGRDaGFuZ2VkOiBFdmVudEVtaXR0ZXI8Rm9ybUZpZWxkTW9kZWw+ID0gbmV3IEV2ZW50RW1pdHRlcjxGb3JtRmllbGRNb2RlbD4oKTtcblxuICAgIEBWaWV3Q2hpbGQoJ2RpYWxvZycpXG4gICAgZGlhbG9nOiBhbnk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbnRlbnRTZXJ2aWNlOiBBY3Rpdml0aUFsZnJlc2NvQ29udGVudFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIGlmICh0aGlzLmZpZWxkKSB7XG4gICAgICAgICAgICBsZXQgcGFyYW1zID0gdGhpcy5maWVsZC5wYXJhbXM7XG5cbiAgICAgICAgICAgIGlmIChwYXJhbXMgJiZcbiAgICAgICAgICAgICAgICBwYXJhbXMuZmlsZVNvdXJjZSAmJlxuICAgICAgICAgICAgICAgIHBhcmFtcy5maWxlU291cmNlLnNlbGVjdGVkRm9sZGVyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEZvbGRlclNpdGVJZCA9IHBhcmFtcy5maWxlU291cmNlLnNlbGVjdGVkRm9sZGVyLnNpdGVJZDtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkRm9sZGVyU2l0ZU5hbWUgPSBwYXJhbXMuZmlsZVNvdXJjZS5zZWxlY3RlZEZvbGRlci5zaXRlO1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0dXBGaWxlQnJvd3NlcigpO1xuICAgICAgICAgICAgICAgIHRoaXMuZ2V0RXh0ZXJuYWxDb250ZW50Tm9kZXMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNldHVwRmlsZUJyb3dzZXIoKSB7XG4gICAgICAgIGlmICh0aGlzLmZpZWxkKSB7XG4gICAgICAgICAgICBsZXQgcGFyYW1zID0gdGhpcy5maWVsZC5wYXJhbXM7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkRm9sZGVyUGF0aElkID0gcGFyYW1zLmZpbGVTb3VyY2Uuc2VsZWN0ZWRGb2xkZXIucGF0aElkO1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEZvbGRlckFjY291bnRJZCA9IHBhcmFtcy5maWxlU291cmNlLnNlbGVjdGVkRm9sZGVyLmFjY291bnRJZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldExpbmtlZEZpbGVOYW1lKCk6IHN0cmluZyB7XG4gICAgICAgIGxldCByZXN1bHQgPSB0aGlzLmZpbGVOYW1lO1xuXG4gICAgICAgIGlmICh0aGlzLnNlbGVjdGVkRmlsZSAmJlxuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEZpbGUudGl0bGUpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMuc2VsZWN0ZWRGaWxlLnRpdGxlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmZpZWxkICYmXG4gICAgICAgICAgICB0aGlzLmZpZWxkLnZhbHVlICYmXG4gICAgICAgICAgICB0aGlzLmZpZWxkLnZhbHVlLmxlbmd0aCA+IDAgJiZcbiAgICAgICAgICAgIHRoaXMuZmllbGQudmFsdWVbMF0ubmFtZSkge1xuICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5maWVsZC52YWx1ZVswXS5uYW1lO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBnZXRFeHRlcm5hbENvbnRlbnROb2RlcygpIHtcbiAgICAgICAgdGhpcy5jb250ZW50U2VydmljZS5nZXRBbGZyZXNjb05vZGVzKHRoaXMuc2VsZWN0ZWRGb2xkZXJBY2NvdW50SWQsIHRoaXMuc2VsZWN0ZWRGb2xkZXJQYXRoSWQpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIG5vZGVzID0+IHRoaXMuc2VsZWN0ZWRGb2xkZXJOb2RlcyA9IG5vZGVzLFxuICAgICAgICAgICAgICAgIGVycm9yID0+IHRoaXMubG9nU2VydmljZS5lcnJvcihlcnJvcilcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgc2VsZWN0RmlsZShub2RlOiBFeHRlcm5hbENvbnRlbnQsICRldmVudDogYW55KSB7XG4gICAgICAgIHRoaXMuY29udGVudFNlcnZpY2UubGlua0FsZnJlc2NvTm9kZSh0aGlzLnNlbGVjdGVkRm9sZGVyQWNjb3VudElkLCBub2RlLCB0aGlzLnNlbGVjdGVkRm9sZGVyU2l0ZUlkKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAobGluazogRXh0ZXJuYWxDb250ZW50TGluaykgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRGaWxlID0gbm9kZTtcbiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLnZhbHVlID0gW2xpbmtdO1xuICAgICAgICAgICAgICAgIHRoaXMuZmllbGQuanNvbi52YWx1ZSA9IFtsaW5rXTtcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlRGlhbG9nKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5maWVsZENoYW5nZWQuZW1pdCh0aGlzLmZpZWxkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBzZWxlY3RGb2xkZXIobm9kZTogRXh0ZXJuYWxDb250ZW50LCAkZXZlbnQ6IGFueSkge1xuICAgICAgICB0aGlzLnNlbGVjdGVkRm9sZGVyUGF0aElkID0gbm9kZS5pZDtcbiAgICAgICAgdGhpcy5nZXRFeHRlcm5hbENvbnRlbnROb2RlcygpO1xuICAgIH1cblxuICAgIHNob3dEaWFsb2coKTogYm9vbGVhbiB7XG4gICAgICAgIHRoaXMuc2V0dXBGaWxlQnJvd3NlcigpO1xuICAgICAgICB0aGlzLmdldEV4dGVybmFsQ29udGVudE5vZGVzKCk7XG5cbiAgICAgICAgaWYgKHRoaXMuZGlhbG9nKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZGlhbG9nLm5hdGl2ZUVsZW1lbnQuc2hvd01vZGFsKSB7XG4gICAgICAgICAgICAgICAgZGlhbG9nUG9seWZpbGwucmVnaXN0ZXJEaWFsb2codGhpcy5kaWFsb2cubmF0aXZlRWxlbWVudCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZGlhbG9nLm5hdGl2ZUVsZW1lbnQuc2hvd01vZGFsKCk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjbG9zZURpYWxvZygpIHtcbiAgICAgICAgaWYgKHRoaXMuZGlhbG9nKSB7XG4gICAgICAgICAgICB0aGlzLmRpYWxvZy5uYXRpdmVFbGVtZW50LmNsb3NlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjYW5jZWwoKSB7XG4gICAgICAgIHRoaXMuY2xvc2VEaWFsb2coKTtcbiAgICB9XG5cbiAgICByZXNldCgpIHtcbiAgICAgICAgdGhpcy5maWVsZC52YWx1ZSA9IG51bGw7XG4gICAgICAgIHRoaXMuZmllbGQuanNvbi52YWx1ZSA9IG51bGw7XG4gICAgfVxuXG4gICAgaGFzRmlsZSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmllbGQgJiYgdGhpcy5maWVsZC52YWx1ZTtcbiAgICB9XG5cbn1cbiJdfQ==
