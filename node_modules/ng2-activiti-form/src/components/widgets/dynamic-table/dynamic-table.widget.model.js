/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var form_widget_model_1 = require("./../core/form-widget.model");
var form_field_model_1 = require("./../core/form-field.model");
var moment = require("moment");
var DynamicTableModel = (function (_super) {
    __extends(DynamicTableModel, _super);
    function DynamicTableModel(form, json) {
        var _this = _super.call(this, form, json) || this;
        _this.columns = [];
        _this.visibleColumns = [];
        _this.rows = [];
        _this._validators = [];
        if (json) {
            _this.field = new form_field_model_1.FormFieldModel(form, json);
            if (json.columnDefinitions) {
                _this.columns = json.columnDefinitions.map(function (obj) { return obj; });
                _this.visibleColumns = _this.columns.filter(function (col) { return col.visible; });
            }
            if (json.value) {
                _this.rows = json.value.map(function (obj) { return ({ selected: false, value: obj }); });
            }
        }
        _this._validators = [
            new RequiredCellValidator(),
            new DateCellValidator(),
            new NumberCellValidator()
        ];
        return _this;
    }
    Object.defineProperty(DynamicTableModel.prototype, "selectedRow", {
        get: function () {
            return this._selectedRow;
        },
        set: function (value) {
            if (this._selectedRow && this._selectedRow === value) {
                this._selectedRow.selected = false;
                this._selectedRow = null;
                return;
            }
            this.rows.forEach(function (row) { return row.selected = false; });
            this._selectedRow = value;
            if (value) {
                this._selectedRow.selected = true;
            }
        },
        enumerable: true,
        configurable: true
    });
    DynamicTableModel.prototype.flushValue = function () {
        if (this.field) {
            this.field.value = this.rows.map(function (r) { return r.value; });
            this.field.updateForm();
        }
    };
    DynamicTableModel.prototype.moveRow = function (row, offset) {
        var oldIndex = this.rows.indexOf(row);
        if (oldIndex > -1) {
            var newIndex = (oldIndex + offset);
            if (newIndex < 0) {
                newIndex = 0;
            }
            else if (newIndex >= this.rows.length) {
                newIndex = this.rows.length;
            }
            var arr = this.rows.slice();
            arr.splice(oldIndex, 1);
            arr.splice(newIndex, 0, row);
            this.rows = arr;
            this.flushValue();
        }
    };
    DynamicTableModel.prototype.deleteRow = function (row) {
        if (row) {
            if (this.selectedRow === row) {
                this.selectedRow = null;
            }
            var idx = this.rows.indexOf(row);
            if (idx > -1) {
                this.rows.splice(idx, 1);
                this.flushValue();
            }
        }
    };
    DynamicTableModel.prototype.addRow = function (row) {
        if (row) {
            this.rows.push(row);
        }
    };
    DynamicTableModel.prototype.validateRow = function (row) {
        var summary = {
            isValid: true,
            text: null
        };
        if (row) {
            for (var _i = 0, _a = this.columns; _i < _a.length; _i++) {
                var col = _a[_i];
                for (var _b = 0, _c = this._validators; _b < _c.length; _b++) {
                    var validator = _c[_b];
                    if (!validator.validate(row, col, summary)) {
                        return summary;
                    }
                }
            }
        }
        return summary;
    };
    DynamicTableModel.prototype.getCellValue = function (row, column) {
        var result = row.value[column.id];
        if (column.type === 'Dropdown') {
            if (result) {
                return result.name;
            }
        }
        if (column.type === 'Boolean') {
            return result ? true : false;
        }
        if (column.type === 'Date') {
            if (result) {
                return moment(result.split('T')[0], 'YYYY-MM-DD').format('DD-MM-YYYY');
            }
        }
        return result || '';
    };
    DynamicTableModel.prototype.getDisplayText = function (column) {
        var result = column.name;
        if (column.type === 'Amount') {
            var currency = column.amountCurrency || '$';
            result = column.name + " (" + currency + ")";
        }
        return result;
    };
    return DynamicTableModel;
}(form_widget_model_1.FormWidgetModel));
exports.DynamicTableModel = DynamicTableModel;
var RequiredCellValidator = (function () {
    function RequiredCellValidator() {
        this.supportedTypes = [
            'String',
            'Number',
            'Amount',
            'Date',
            'Dropdown'
        ];
    }
    RequiredCellValidator.prototype.isSupported = function (column) {
        return column && column.required && this.supportedTypes.indexOf(column.type) > -1;
    };
    RequiredCellValidator.prototype.validate = function (row, column, summary) {
        if (this.isSupported(column)) {
            var value = row.value[column.id];
            if (column.required) {
                if (value === null || value === undefined || value === '') {
                    if (summary) {
                        summary.isValid = false;
                        summary.text = "Field '" + column.name + "' is required.";
                    }
                    return false;
                }
            }
        }
        return true;
    };
    return RequiredCellValidator;
}());
exports.RequiredCellValidator = RequiredCellValidator;
var DateCellValidator = (function () {
    function DateCellValidator() {
        this.supportedTypes = [
            'Date'
        ];
    }
    DateCellValidator.prototype.isSupported = function (column) {
        return column && column.editable && this.supportedTypes.indexOf(column.type) > -1;
    };
    DateCellValidator.prototype.validate = function (row, column, summary) {
        if (this.isSupported(column)) {
            var value = row.value[column.id];
            var dateValue = moment(value, 'D-M-YYYY');
            if (!dateValue.isValid()) {
                if (summary) {
                    summary.isValid = false;
                    summary.text = "Invalid '" + column.name + "' format.";
                }
                return false;
            }
        }
        return true;
    };
    return DateCellValidator;
}());
exports.DateCellValidator = DateCellValidator;
var NumberCellValidator = (function () {
    function NumberCellValidator() {
        this.supportedTypes = [
            'Number',
            'Amount'
        ];
    }
    NumberCellValidator.prototype.isSupported = function (column) {
        return column && column.required && this.supportedTypes.indexOf(column.type) > -1;
    };
    NumberCellValidator.prototype.isNumber = function (value) {
        if (value === null || value === undefined || value === '') {
            return false;
        }
        return !isNaN(+value);
    };
    NumberCellValidator.prototype.validate = function (row, column, summary) {
        if (this.isSupported(column)) {
            var value = row.value[column.id];
            if (value === null ||
                value === undefined ||
                value === '' ||
                this.isNumber(value)) {
                return true;
            }
            if (summary) {
                summary.isValid = false;
                summary.text = "Field '" + column.name + "' must be a number.";
            }
            return false;
        }
        return true;
    };
    return NumberCellValidator;
}());
exports.NumberCellValidator = NumberCellValidator;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvd2lkZ2V0cy9keW5hbWljLXRhYmxlL2R5bmFtaWMtdGFibGUud2lkZ2V0Lm1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRzs7Ozs7OztBQUVILGlFQUE4RDtBQUU5RCwrREFBNEQ7QUFDNUQsK0JBQWlDO0FBRWpDO0lBQXVDLHFDQUFlO0lBOEJsRCwyQkFBWSxJQUFlLEVBQUUsSUFBVTtRQUF2QyxZQUNJLGtCQUFNLElBQUksRUFBRSxJQUFJLENBQUMsU0FvQnBCO1FBaERELGFBQU8sR0FBeUIsRUFBRSxDQUFDO1FBQ25DLG9CQUFjLEdBQXlCLEVBQUUsQ0FBQztRQUMxQyxVQUFJLEdBQXNCLEVBQUUsQ0FBQztRQUdyQixpQkFBVyxHQUFvQixFQUFFLENBQUM7UUF5QnRDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDUCxLQUFJLENBQUMsS0FBSyxHQUFHLElBQUksaUNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFFNUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztnQkFDekIsS0FBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQXFCLEdBQUcsRUFBeEIsQ0FBd0IsQ0FBQyxDQUFDO2dCQUMzRSxLQUFJLENBQUMsY0FBYyxHQUFHLEtBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLE9BQU8sRUFBWCxDQUFXLENBQUMsQ0FBQztZQUNsRSxDQUFDO1lBRUQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ2IsS0FBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLENB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QUFDLElBQUksR0FBRyxZQUFVLE1BQU0sQ0FBQyxJQUFJLHdCQUFxQixDQUFDO1lBQzlELENBQUM7WUFDRCxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2pCLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFDTCwwQkFBQztBQUFELENBdENBLEFBc0NDLElBQUE7QUF0Q1ksa0RBQW1CIiwiZmlsZSI6ImNvbXBvbmVudHMvd2lkZ2V0cy9keW5hbWljLXRhYmxlL2R5bmFtaWMtdGFibGUud2lkZ2V0Lm1vZGVsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTYgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgRm9ybVdpZGdldE1vZGVsIH0gZnJvbSAnLi8uLi9jb3JlL2Zvcm0td2lkZ2V0Lm1vZGVsJztcbmltcG9ydCB7IEZvcm1Nb2RlbCB9IGZyb20gJy4vLi4vY29yZS9mb3JtLm1vZGVsJztcbmltcG9ydCB7IEZvcm1GaWVsZE1vZGVsIH0gZnJvbSAnLi8uLi9jb3JlL2Zvcm0tZmllbGQubW9kZWwnO1xuaW1wb3J0ICogYXMgbW9tZW50IGZyb20gJ21vbWVudCc7XG5cbmV4cG9ydCBjbGFzcyBEeW5hbWljVGFibGVNb2RlbCBleHRlbmRzIEZvcm1XaWRnZXRNb2RlbCB7XG5cbiAgICBmaWVsZDogRm9ybUZpZWxkTW9kZWw7XG4gICAgY29sdW1uczogRHluYW1pY1RhYmxlQ29sdW1uW10gPSBbXTtcbiAgICB2aXNpYmxlQ29sdW1uczogRHluYW1pY1RhYmxlQ29sdW1uW10gPSBbXTtcbiAgICByb3dzOiBEeW5hbWljVGFibGVSb3dbXSA9IFtdO1xuXG4gICAgcHJpdmF0ZSBfc2VsZWN0ZWRSb3c6IER5bmFtaWNUYWJsZVJvdztcbiAgICBwcml2YXRlIF92YWxpZGF0b3JzOiBDZWxsVmFsaWRhdG9yW10gPSBbXTtcblxuICAgIGdldCBzZWxlY3RlZFJvdygpOiBEeW5hbWljVGFibGVSb3cge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2VsZWN0ZWRSb3c7XG4gICAgfVxuXG4gICAgc2V0IHNlbGVjdGVkUm93KHZhbHVlOiBEeW5hbWljVGFibGVSb3cpIHtcbiAgICAgICAgaWYgKHRoaXMuX3NlbGVjdGVkUm93ICYmIHRoaXMuX3NlbGVjdGVkUm93ID09PSB2YWx1ZSkge1xuICAgICAgICAgICAgdGhpcy5fc2VsZWN0ZWRSb3cuc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMuX3NlbGVjdGVkUm93ID0gbnVsbDtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucm93cy5mb3JFYWNoKHJvdyA9PiByb3cuc2VsZWN0ZWQgPSBmYWxzZSk7XG5cbiAgICAgICAgdGhpcy5fc2VsZWN0ZWRSb3cgPSB2YWx1ZTtcblxuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMuX3NlbGVjdGVkUm93LnNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGZvcm06IEZvcm1Nb2RlbCwganNvbj86IGFueSkge1xuICAgICAgICBzdXBlcihmb3JtLCBqc29uKTtcblxuICAgICAgICBpZiAoanNvbikge1xuICAgICAgICAgICAgdGhpcy5maWVsZCA9IG5ldyBGb3JtRmllbGRNb2RlbChmb3JtLCBqc29uKTtcblxuICAgICAgICAgICAgaWYgKGpzb24uY29sdW1uRGVmaW5pdGlvbnMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbHVtbnMgPSBqc29uLmNvbHVtbkRlZmluaXRpb25zLm1hcChvYmogPT4gPER5bmFtaWNUYWJsZUNvbHVtbj4gb2JqKTtcbiAgICAgICAgICAgICAgICB0aGlzLnZpc2libGVDb2x1bW5zID0gdGhpcy5jb2x1bW5zLmZpbHRlcihjb2wgPT4gY29sLnZpc2libGUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoanNvbi52YWx1ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMucm93cyA9IGpzb24udmFsdWUubWFwKG9iaiA9PiA8RHluYW1pY1RhYmxlUm93PiB7c2VsZWN0ZWQ6IGZhbHNlLCB2YWx1ZTogb2JqfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl92YWxpZGF0b3JzID0gW1xuICAgICAgICAgICAgbmV3IFJlcXVpcmVkQ2VsbFZhbGlkYXRvcigpLFxuICAgICAgICAgICAgbmV3IERhdGVDZWxsVmFsaWRhdG9yKCksXG4gICAgICAgICAgICBuZXcgTnVtYmVyQ2VsbFZhbGlkYXRvcigpXG4gICAgICAgIF07XG4gICAgfVxuXG4gICAgZmx1c2hWYWx1ZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuZmllbGQpIHtcbiAgICAgICAgICAgIHRoaXMuZmllbGQudmFsdWUgPSB0aGlzLnJvd3MubWFwKHIgPT4gci52YWx1ZSk7XG4gICAgICAgICAgICB0aGlzLmZpZWxkLnVwZGF0ZUZvcm0oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG1vdmVSb3cocm93OiBEeW5hbWljVGFibGVSb3csIG9mZnNldDogbnVtYmVyKSB7XG4gICAgICAgIGxldCBvbGRJbmRleCA9IHRoaXMucm93cy5pbmRleE9mKHJvdyk7XG4gICAgICAgIGlmIChvbGRJbmRleCA+IC0xKSB7XG4gICAgICAgICAgICBsZXQgbmV3SW5kZXggPSAob2xkSW5kZXggKyBvZmZzZXQpO1xuXG4gICAgICAgICAgICBpZiAobmV3SW5kZXggPCAwKSB7XG4gICAgICAgICAgICAgICAgbmV3SW5kZXggPSAwO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChuZXdJbmRleCA+PSB0aGlzLnJvd3MubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgbmV3SW5kZXggPSB0aGlzLnJvd3MubGVuZ3RoO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgYXJyID0gdGhpcy5yb3dzLnNsaWNlKCk7XG4gICAgICAgICAgICBhcnIuc3BsaWNlKG9sZEluZGV4LCAxKTtcbiAgICAgICAgICAgIGFyci5zcGxpY2UobmV3SW5kZXgsIDAsIHJvdyk7XG4gICAgICAgICAgICB0aGlzLnJvd3MgPSBhcnI7XG5cbiAgICAgICAgICAgIHRoaXMuZmx1c2hWYWx1ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZGVsZXRlUm93KHJvdzogRHluYW1pY1RhYmxlUm93KSB7XG4gICAgICAgIGlmIChyb3cpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdGVkUm93ID09PSByb3cpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkUm93ID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBpZHggPSB0aGlzLnJvd3MuaW5kZXhPZihyb3cpO1xuICAgICAgICAgICAgaWYgKGlkeCA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yb3dzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgICAgIHRoaXMuZmx1c2hWYWx1ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgYWRkUm93KHJvdzogRHluYW1pY1RhYmxlUm93KSB7XG4gICAgICAgIGlmIChyb3cpIHtcbiAgICAgICAgICAgIHRoaXMucm93cy5wdXNoKHJvdyk7XG4gICAgICAgICAgICAvLyB0aGlzLnNlbGVjdGVkUm93ID0gcm93O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdmFsaWRhdGVSb3cocm93OiBEeW5hbWljVGFibGVSb3cpOiBEeW5hbWljUm93VmFsaWRhdGlvblN1bW1hcnkge1xuICAgICAgICBsZXQgc3VtbWFyeSA9IDxEeW5hbWljUm93VmFsaWRhdGlvblN1bW1hcnk+IHtcbiAgICAgICAgICAgIGlzVmFsaWQ6IHRydWUsXG4gICAgICAgICAgICB0ZXh0OiBudWxsXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKHJvdykge1xuICAgICAgICAgICAgZm9yIChsZXQgY29sIG9mIHRoaXMuY29sdW1ucykge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IHZhbGlkYXRvciBvZiB0aGlzLl92YWxpZGF0b3JzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRhdG9yLnZhbGlkYXRlKHJvdywgY29sLCBzdW1tYXJ5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN1bW1hcnk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc3VtbWFyeTtcbiAgICB9XG5cbiAgICBnZXRDZWxsVmFsdWUocm93OiBEeW5hbWljVGFibGVSb3csIGNvbHVtbjogRHluYW1pY1RhYmxlQ29sdW1uKTogYW55IHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IHJvdy52YWx1ZVtjb2x1bW4uaWRdO1xuXG4gICAgICAgIGlmIChjb2x1bW4udHlwZSA9PT0gJ0Ryb3Bkb3duJykge1xuICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQubmFtZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb2x1bW4udHlwZSA9PT0gJ0Jvb2xlYW4nKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0ID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbHVtbi50eXBlID09PSAnRGF0ZScpIHtcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbW9tZW50KHJlc3VsdC5zcGxpdCgnVCcpWzBdLCAnWVlZWS1NTS1ERCcpLmZvcm1hdCgnREQtTU0tWVlZWScpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdCB8fCAnJztcbiAgICB9XG5cbiAgICBnZXREaXNwbGF5VGV4dChjb2x1bW46IER5bmFtaWNUYWJsZUNvbHVtbik6IHN0cmluZyB7XG4gICAgICAgIGxldCByZXN1bHQgPSBjb2x1bW4ubmFtZTtcbiAgICAgICAgaWYgKGNvbHVtbi50eXBlID09PSAnQW1vdW50Jykge1xuICAgICAgICAgICAgbGV0IGN1cnJlbmN5ID0gY29sdW1uLmFtb3VudEN1cnJlbmN5IHx8ICckJztcbiAgICAgICAgICAgIHJlc3VsdCA9IGAke2NvbHVtbi5uYW1lfSAoJHtjdXJyZW5jeX0pYDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBEeW5hbWljUm93VmFsaWRhdGlvblN1bW1hcnkge1xuXG4gICAgaXNWYWxpZDogYm9vbGVhbjtcbiAgICB0ZXh0OiBzdHJpbmc7XG5cbn1cblxuZXhwb3J0IGludGVyZmFjZSBDZWxsVmFsaWRhdG9yIHtcblxuICAgIGlzU3VwcG9ydGVkKGNvbHVtbjogRHluYW1pY1RhYmxlQ29sdW1uKTogYm9vbGVhbjtcbiAgICB2YWxpZGF0ZShyb3c6IER5bmFtaWNUYWJsZVJvdywgY29sdW1uOiBEeW5hbWljVGFibGVDb2x1bW4sIHN1bW1hcnk/OiBEeW5hbWljUm93VmFsaWRhdGlvblN1bW1hcnkpOiBib29sZWFuO1xuXG59XG5cbmV4cG9ydCBjbGFzcyBSZXF1aXJlZENlbGxWYWxpZGF0b3IgaW1wbGVtZW50cyBDZWxsVmFsaWRhdG9yIHtcblxuICAgIHByaXZhdGUgc3VwcG9ydGVkVHlwZXM6IHN0cmluZ1tdID0gW1xuICAgICAgICAnU3RyaW5nJyxcbiAgICAgICAgJ051bWJlcicsXG4gICAgICAgICdBbW91bnQnLFxuICAgICAgICAnRGF0ZScsXG4gICAgICAgICdEcm9wZG93bidcbiAgICBdO1xuXG4gICAgaXNTdXBwb3J0ZWQoY29sdW1uOiBEeW5hbWljVGFibGVDb2x1bW4pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGNvbHVtbiAmJiBjb2x1bW4ucmVxdWlyZWQgJiYgdGhpcy5zdXBwb3J0ZWRUeXBlcy5pbmRleE9mKGNvbHVtbi50eXBlKSA+IC0xO1xuICAgIH1cblxuICAgIHZhbGlkYXRlKHJvdzogRHluYW1pY1RhYmxlUm93LCBjb2x1bW46IER5bmFtaWNUYWJsZUNvbHVtbiwgc3VtbWFyeT86IER5bmFtaWNSb3dWYWxpZGF0aW9uU3VtbWFyeSk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAodGhpcy5pc1N1cHBvcnRlZChjb2x1bW4pKSB7XG4gICAgICAgICAgICBsZXQgdmFsdWUgPSByb3cudmFsdWVbY29sdW1uLmlkXTtcbiAgICAgICAgICAgIGlmIChjb2x1bW4ucmVxdWlyZWQpIHtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gJycpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN1bW1hcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1bW1hcnkuaXNWYWxpZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3VtbWFyeS50ZXh0ID0gYEZpZWxkICcke2NvbHVtbi5uYW1lfScgaXMgcmVxdWlyZWQuYDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgRGF0ZUNlbGxWYWxpZGF0b3IgaW1wbGVtZW50cyBDZWxsVmFsaWRhdG9yIHtcblxuICAgIHByaXZhdGUgc3VwcG9ydGVkVHlwZXM6IHN0cmluZ1tdID0gW1xuICAgICAgICAnRGF0ZSdcbiAgICBdO1xuXG4gICAgaXNTdXBwb3J0ZWQoY29sdW1uOiBEeW5hbWljVGFibGVDb2x1bW4pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGNvbHVtbiAmJiBjb2x1bW4uZWRpdGFibGUgJiYgdGhpcy5zdXBwb3J0ZWRUeXBlcy5pbmRleE9mKGNvbHVtbi50eXBlKSA+IC0xO1xuICAgIH1cblxuICAgIHZhbGlkYXRlKHJvdzogRHluYW1pY1RhYmxlUm93LCBjb2x1bW46IER5bmFtaWNUYWJsZUNvbHVtbiwgc3VtbWFyeT86IER5bmFtaWNSb3dWYWxpZGF0aW9uU3VtbWFyeSk6IGJvb2xlYW4ge1xuXG4gICAgICAgIGlmICh0aGlzLmlzU3VwcG9ydGVkKGNvbHVtbikpIHtcbiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHJvdy52YWx1ZVtjb2x1bW4uaWRdO1xuICAgICAgICAgICAgbGV0IGRhdGVWYWx1ZSA9IG1vbWVudCh2YWx1ZSwgJ0QtTS1ZWVlZJyk7XG4gICAgICAgICAgICBpZiAoIWRhdGVWYWx1ZS5pc1ZhbGlkKCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoc3VtbWFyeSkge1xuICAgICAgICAgICAgICAgICAgICBzdW1tYXJ5LmlzVmFsaWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgc3VtbWFyeS50ZXh0ID0gYEludmFsaWQgJyR7Y29sdW1uLm5hbWV9JyBmb3JtYXQuYDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgTnVtYmVyQ2VsbFZhbGlkYXRvciBpbXBsZW1lbnRzIENlbGxWYWxpZGF0b3Ige1xuXG4gICAgcHJpdmF0ZSBzdXBwb3J0ZWRUeXBlczogc3RyaW5nW10gPSBbXG4gICAgICAgICdOdW1iZXInLFxuICAgICAgICAnQW1vdW50J1xuICAgIF07XG5cbiAgICBpc1N1cHBvcnRlZChjb2x1bW46IER5bmFtaWNUYWJsZUNvbHVtbik6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gY29sdW1uICYmIGNvbHVtbi5yZXF1aXJlZCAmJiB0aGlzLnN1cHBvcnRlZFR5cGVzLmluZGV4T2YoY29sdW1uLnR5cGUpID4gLTE7XG4gICAgfVxuXG4gICAgaXNOdW1iZXIodmFsdWU6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gJycpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAhaXNOYU4oK3ZhbHVlKTtcbiAgICB9XG5cbiAgICB2YWxpZGF0ZShyb3c6IER5bmFtaWNUYWJsZVJvdywgY29sdW1uOiBEeW5hbWljVGFibGVDb2x1bW4sIHN1bW1hcnk/OiBEeW5hbWljUm93VmFsaWRhdGlvblN1bW1hcnkpOiBib29sZWFuIHtcblxuICAgICAgICBpZiAodGhpcy5pc1N1cHBvcnRlZChjb2x1bW4pKSB7XG4gICAgICAgICAgICBsZXQgdmFsdWUgPSByb3cudmFsdWVbY29sdW1uLmlkXTtcbiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fFxuICAgICAgICAgICAgICAgIHZhbHVlID09PSB1bmRlZmluZWQgfHxcbiAgICAgICAgICAgICAgICB2YWx1ZSA9PT0gJycgfHxcbiAgICAgICAgICAgICAgICB0aGlzLmlzTnVtYmVyKHZhbHVlKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoc3VtbWFyeSkge1xuICAgICAgICAgICAgICAgIHN1bW1hcnkuaXNWYWxpZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHN1bW1hcnkudGV4dCA9IGBGaWVsZCAnJHtjb2x1bW4ubmFtZX0nIG11c3QgYmUgYSBudW1iZXIuYDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG59XG5cbi8vIG1hcHMgdG86IGNvbS5hY3Rpdml0aS5tb2RlbC5lZGl0b3IuZm9ybS5Db2x1bW5EZWZpbml0aW9uUmVwcmVzZW50YXRpb25cbmV4cG9ydCBpbnRlcmZhY2UgRHluYW1pY1RhYmxlQ29sdW1uIHtcblxuICAgIGlkOiBzdHJpbmc7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIHR5cGU6IHN0cmluZztcbiAgICB2YWx1ZTogYW55O1xuICAgIG9wdGlvblR5cGU6IHN0cmluZztcbiAgICBvcHRpb25zOiBEeW5hbWljVGFibGVDb2x1bW5PcHRpb25bXTtcbiAgICByZXN0UmVzcG9uc2VQYXRoOiBzdHJpbmc7XG4gICAgcmVzdFVybDogc3RyaW5nO1xuICAgIHJlc3RJZFByb3BlcnR5OiBzdHJpbmc7XG4gICAgcmVzdExhYmVsUHJvcGVydHk6IHN0cmluZztcbiAgICBhbW91bnRDdXJyZW5jeTogc3RyaW5nO1xuICAgIGFtb3VudEVuYWJsZUZyYWN0aW9uczogYm9vbGVhbjtcbiAgICByZXF1aXJlZDogYm9vbGVhbjtcbiAgICBlZGl0YWJsZTogYm9vbGVhbjtcbiAgICBzb3J0YWJsZTogYm9vbGVhbjtcbiAgICB2aXNpYmxlOiBib29sZWFuO1xuXG4gICAgLy8gVE9ETzogY29tLmFjdGl2aXRpLmRvbWFpbi5pZG0uRW5kcG9pbnRDb25maWd1cmF0aW9uLkVuZHBvaW50Q29uZmlndXJhdGlvblJlcHJlc2VudGF0aW9uXG4gICAgZW5kcG9pbnQ6IGFueTtcbiAgICAvLyBUT0RPOiBjb20uYWN0aXZpdGkubW9kZWwuZWRpdG9yLmZvcm0uUmVxdWVzdEhlYWRlclJlcHJlc2VudGF0aW9uXG4gICAgcmVxdWVzdEhlYWRlcnM6IGFueTtcbn1cblxuLy8gbWFwcyB0bzogY29tLmFjdGl2aXRpLm1vZGVsLmVkaXRvci5mb3JtLk9wdGlvblJlcHJlc2VudGF0aW9uXG5leHBvcnQgaW50ZXJmYWNlIER5bmFtaWNUYWJsZUNvbHVtbk9wdGlvbiB7XG4gICAgaWQ6IHN0cmluZztcbiAgICBuYW1lOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRHluYW1pY1RhYmxlUm93IHtcbiAgICBpc05ldzogYm9vbGVhbjtcbiAgICBzZWxlY3RlZDogYm9vbGVhbjtcbiAgICB2YWx1ZTogYW55O1xufVxuIl19
