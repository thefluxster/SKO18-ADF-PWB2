/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var widget_component_1 = require("./../widget.component");
var form_service_1 = require("../../../services/form.service");
var FunctionalGroupWidget = (function (_super) {
    __extends(FunctionalGroupWidget, _super);
    function FunctionalGroupWidget(formService, elementRef) {
        var _this = _super.call(this) || this;
        _this.formService = formService;
        _this.elementRef = elementRef;
        _this.popupVisible = false;
        _this.groups = [];
        _this.minTermLength = 1;
        return _this;
    }
    FunctionalGroupWidget.prototype.ngOnInit = function () {
        var _this = this;
        if (this.field) {
            var group = this.field.value;
            if (group) {
                this.value = group.name;
            }
            var params = this.field.params;
            if (params && params['restrictWithGroup']) {
                var restrictWithGroup = params['restrictWithGroup'];
                this.groupId = restrictWithGroup.id;
            }
            if (this.value) {
                this.formService
                    .getWorkflowGroups(this.value, this.groupId)
                    .subscribe(function (result) { return _this.groups = result || []; });
            }
        }
    };
    FunctionalGroupWidget.prototype.onKeyUp = function (event) {
        var _this = this;
        if (this.value && this.value.length >= this.minTermLength) {
            this.formService.getWorkflowGroups(this.value, this.groupId)
                .subscribe(function (result) {
                _this.groups = result || [];
                _this.popupVisible = _this.groups.length > 0;
            });
        }
        else {
            this.popupVisible = false;
        }
    };
    FunctionalGroupWidget.prototype.onBlur = function () {
        var _this = this;
        setTimeout(function () {
            _this.flushValue();
        }, 200);
    };
    FunctionalGroupWidget.prototype.flushValue = function () {
        var _this = this;
        this.popupVisible = false;
        var option = this.groups.find(function (item) { return item.name.toLocaleLowerCase() === _this.value.toLocaleLowerCase(); });
        if (option) {
            this.field.value = option;
            this.value = option.name;
        }
        else {
            this.field.value = null;
            this.value = null;
        }
        this.field.updateForm();
    };
    FunctionalGroupWidget.prototype.onItemClick = function (item, event) {
        if (item) {
            this.field.value = item;
            this.value = item.name;
        }
        if (event) {
            event.preventDefault();
        }
    };
    FunctionalGroupWidget.prototype.setupMaterialComponents = function (handler) {
        _super.prototype.setupMaterialComponents.call(this, handler);
        if (handler) {
            if (this.elementRef && this.value) {
                this.setupMaterialTextField(this.elementRef, handler, this.value);
                return true;
            }
        }
        return false;
    };
    return FunctionalGroupWidget;
}(widget_component_1.WidgetComponent));
FunctionalGroupWidget = __decorate([
    core_1.Component({
        moduleId: module.id,
        selector: 'functional-group-widget',
        template: "<div class=\"mdl-textfield mdl-js-textfield functional-group-widget\"      [class.functional-group-widget__invalid]=\"!field.isValid\">     <label [attr.for]=\"field.id\">{{field.name}}</label>     <input class=\"mdl-textfield__input\"            type=\"text\"            [attr.id]=\"field.id\"            [(ngModel)]=\"value\"            (ngModelChange)=\"checkVisibility(field)\"            (keyup)=\"onKeyUp($event)\"            (blur)=\"onBlur()\"            [disabled]=\"field.readOnly\"            placeholder=\"{{field.placeholder}}\">     <span *ngIf=\"field.validationSummary\" class=\"mdl-textfield__error\">{{field.validationSummary}}</span> </div> <div class=\"functional-group-widget--autocomplete mdl-shadow--2dp\" *ngIf=\"popupVisible && groups.length > 0\">     <ul>         <li *ngFor=\"let item of groups\"             class=\"mdl-menu__item\"             (click)=\"onItemClick(item, $event)\">             {{item.name}}         </li>     </ul> </div>",
        styles: [".functional-group-widget {     width: 100%; }  .functional-group-widget--autocomplete {     background-color: #fff;     position: absolute;     z-index: 5;     color: #555;     margin: -15px 0 0 0; }  .functional-group-widget--autocomplete > ul {     list-style-type: none;     position: static;      height: auto;     width: auto;     min-width: 124px;     padding: 8px 0;     margin: 0;      box-shadow: 0 2px 2px 0 rgba(0,0,0,.14),0 3px 1px -2px rgba(0,0,0,.2),0 1px 5px 0 rgba(0,0,0,.12);     border-radius: 2px; }  .functional-group-widget--autocomplete > ul > li {     opacity: 1; }  .people-widget--autocomplete > ul > li {     opacity: 1; }  .functional-group-widget__invalid .mdl-textfield__input {     border-color: #d50000; }  .functional-group-widget__invalid .mdl-textfield__label {     color: #d50000; }  .functional-group-widget__invalid .mdl-textfield__label:after {     background-color: #d50000; }  .functional-group-widget__invalid .mdl-textfield__error {     visibility: visible !important; }"]
    }),
    __metadata("design:paramtypes", [form_service_1.FormService,
        core_1.ElementRef])
], FunctionalGroupWidget);
exports.FunctionalGroupWidget = FunctionalGroupWidget;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvd2lkZ2V0cy9mdW5jdGlvbmFsLWdyb3VwL2Z1bmN0aW9uYWwtZ3JvdXAud2lkZ2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRzs7Ozs7Ozs7Ozs7Ozs7OztBQUVILHNDQUE4RDtBQUM5RCwwREFBd0Q7QUFDeEQsK0RBQTZEO0FBUzdELElBQWEscUJBQXFCO0lBQVMseUNBQWU7SUFRdEQsK0JBQW9CLFdBQXdCLEVBQ3hCLFVBQXNCO1FBRDFDLFlBRUksaUJBQU8sU0FDVjtRQUhtQixpQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixnQkFBVSxHQUFWLFVBQVUsQ0FBWTtRQU4xQyxrQkFBWSxHQUFZLEtBQUssQ0FBQztRQUM5QixZQUFNLEdBQWlCLEVBQUUsQ0FBQztRQUMxQixtQkFBYSxHQUFXLENBQUMsQ0FBQzs7SUFNMUIsQ0FBQztJQUlELHdDQUFRLEdBQVI7UUFBQSxpQkFvQkM7UUFuQkcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDYixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztZQUM3QixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNSLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQztZQUM1QixDQUFDO1lBRUQsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7WUFDL0IsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDeEMsSUFBSSxpQkFBaUIsR0FBZ0IsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7Z0JBQ2pFLElBQUksQ0FBQyxPQUFPLEdBQUcsaUJBQWlCLENBQUMsRUFBRSxDQUFDO1lBQ3hDLENBQUM7WUFHRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDYixJQUFJLENBQUMsV0FBVztxQkFDWCxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUM7cUJBQzNDLFNBQVMsQ0FBQyxVQUFDLE1BQW9CLElBQUssT0FBQSxLQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sSUFBSSxFQUFFLEVBQTFCLENBQTBCLENBQUMsQ0FBQztZQUN6RSxDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7SUFFRCx1Q0FBTyxHQUFQLFVBQVEsS0FBb0I7UUFBNUIsaUJBVUM7UUFURyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBQ3hELElBQUksQ0FBQyxXQUFXLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDO2lCQUN2RCxTQUFTLENBQUMsVUFBQyxNQUFvQjtnQkFDNUIsS0FBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLElBQUksRUFBRSxDQUFDO2dCQUMzQixLQUFJLENBQUMsWUFBWSxHQUFHLEtBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztZQUMvQyxDQUFDLENBQUMsQ0FBQztRQUNYLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO1FBQzlCLENBQUM7SUFDTCxDQUFDO0lBRUQsc0NBQU0sR0FBTjtRQUFBLGlCQUlDO1FBSEcsVUFBVSxDQUFDO1lBQ1AsS0FBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ3RCLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNaLENBQUM7SUFFRCwwQ0FBVSxHQUFWO1FBQUEsaUJBY0M7UUFiRyxJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztRQUUxQixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxLQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixFQUFFLEVBQWhFLENBQWdFLENBQUMsQ0FBQztRQUV4RyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1QsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDO1lBQzFCLElBQUksQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUM3QixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7WUFDeEIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDdEIsQ0FBQztRQUVELElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUdELDJDQUFXLEdBQVgsVUFBWSxJQUFnQixFQUFFLEtBQVk7UUFDdEMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNQLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztZQUN4QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDM0IsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDUixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDM0IsQ0FBQztJQUNMLENBQUM7SUFFRCx1REFBdUIsR0FBdkIsVUFBd0IsT0FBWTtRQUNoQyxpQkFBTSx1QkFBdUIsWUFBQyxPQUFPLENBQUMsQ0FBQztRQUN2QyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ1YsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDaEMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDbEUsTUFBTSxDQUFDLElBQUksQ0FBQztZQUNoQixDQUFDO1FBQ0wsQ0FBQztRQUNELE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUNMLDRCQUFDO0FBQUQsQ0E1RkEsQUE0RkMsQ0E1RjBDLGtDQUFlLEdBNEZ6RDtBQTVGWSxxQkFBcUI7SUFOakMsZ0JBQVMsQ0FBQztRQUNQLFFBQVEsRUFBRSxNQUFNLENBQUMsRUFBRTtRQUNuQixRQUFRLEVBQUUseUJBQXlCO1FBQ25DLFFBQVEsRUFBRSwyOEJBQTI4QjtRQUNyOUIsTUFBTSxFQUFFLENBQUMscy9CQUFzL0IsQ0FBQztLQUNuZ0MsQ0FBQztxQ0FTbUMsMEJBQVc7UUFDWixpQkFBVTtHQVRqQyxxQkFBcUIsQ0E0RmpDO0FBNUZZLHNEQUFxQiIsImZpbGUiOiJjb21wb25lbnRzL3dpZGdldHMvZnVuY3Rpb25hbC1ncm91cC9mdW5jdGlvbmFsLWdyb3VwLndpZGdldC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE2IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBXaWRnZXRDb21wb25lbnQgfSBmcm9tICcuLy4uL3dpZGdldC5jb21wb25lbnQnO1xuaW1wb3J0IHsgRm9ybVNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9mb3JtLnNlcnZpY2UnO1xuaW1wb3J0IHsgR3JvdXBNb2RlbCB9IGZyb20gJy4vLi4vY29yZS9ncm91cC5tb2RlbCc7XG5cbkBDb21wb25lbnQoe1xuICAgIG1vZHVsZUlkOiBtb2R1bGUuaWQsXG4gICAgc2VsZWN0b3I6ICdmdW5jdGlvbmFsLWdyb3VwLXdpZGdldCcsXG4gICAgdGVtcGxhdGU6IFwiPGRpdiBjbGFzcz1cXFwibWRsLXRleHRmaWVsZCBtZGwtanMtdGV4dGZpZWxkIGZ1bmN0aW9uYWwtZ3JvdXAtd2lkZ2V0XFxcIiAgICAgIFtjbGFzcy5mdW5jdGlvbmFsLWdyb3VwLXdpZGdldF9faW52YWxpZF09XFxcIiFmaWVsZC5pc1ZhbGlkXFxcIj4gICAgIDxsYWJlbCBbYXR0ci5mb3JdPVxcXCJmaWVsZC5pZFxcXCI+e3tmaWVsZC5uYW1lfX08L2xhYmVsPiAgICAgPGlucHV0IGNsYXNzPVxcXCJtZGwtdGV4dGZpZWxkX19pbnB1dFxcXCIgICAgICAgICAgICB0eXBlPVxcXCJ0ZXh0XFxcIiAgICAgICAgICAgIFthdHRyLmlkXT1cXFwiZmllbGQuaWRcXFwiICAgICAgICAgICAgWyhuZ01vZGVsKV09XFxcInZhbHVlXFxcIiAgICAgICAgICAgIChuZ01vZGVsQ2hhbmdlKT1cXFwiY2hlY2tWaXNpYmlsaXR5KGZpZWxkKVxcXCIgICAgICAgICAgICAoa2V5dXApPVxcXCJvbktleVVwKCRldmVudClcXFwiICAgICAgICAgICAgKGJsdXIpPVxcXCJvbkJsdXIoKVxcXCIgICAgICAgICAgICBbZGlzYWJsZWRdPVxcXCJmaWVsZC5yZWFkT25seVxcXCIgICAgICAgICAgICBwbGFjZWhvbGRlcj1cXFwie3tmaWVsZC5wbGFjZWhvbGRlcn19XFxcIj4gICAgIDxzcGFuICpuZ0lmPVxcXCJmaWVsZC52YWxpZGF0aW9uU3VtbWFyeVxcXCIgY2xhc3M9XFxcIm1kbC10ZXh0ZmllbGRfX2Vycm9yXFxcIj57e2ZpZWxkLnZhbGlkYXRpb25TdW1tYXJ5fX08L3NwYW4+IDwvZGl2PiA8ZGl2IGNsYXNzPVxcXCJmdW5jdGlvbmFsLWdyb3VwLXdpZGdldC0tYXV0b2NvbXBsZXRlIG1kbC1zaGFkb3ctLTJkcFxcXCIgKm5nSWY9XFxcInBvcHVwVmlzaWJsZSAmJiBncm91cHMubGVuZ3RoID4gMFxcXCI+ICAgICA8dWw+ICAgICAgICAgPGxpICpuZ0Zvcj1cXFwibGV0IGl0ZW0gb2YgZ3JvdXBzXFxcIiAgICAgICAgICAgICBjbGFzcz1cXFwibWRsLW1lbnVfX2l0ZW1cXFwiICAgICAgICAgICAgIChjbGljayk9XFxcIm9uSXRlbUNsaWNrKGl0ZW0sICRldmVudClcXFwiPiAgICAgICAgICAgICB7e2l0ZW0ubmFtZX19ICAgICAgICAgPC9saT4gICAgIDwvdWw+IDwvZGl2PlwiLFxuICAgIHN0eWxlczogW1wiLmZ1bmN0aW9uYWwtZ3JvdXAtd2lkZ2V0IHsgICAgIHdpZHRoOiAxMDAlOyB9ICAuZnVuY3Rpb25hbC1ncm91cC13aWRnZXQtLWF1dG9jb21wbGV0ZSB7ICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmOyAgICAgcG9zaXRpb246IGFic29sdXRlOyAgICAgei1pbmRleDogNTsgICAgIGNvbG9yOiAjNTU1OyAgICAgbWFyZ2luOiAtMTVweCAwIDAgMDsgfSAgLmZ1bmN0aW9uYWwtZ3JvdXAtd2lkZ2V0LS1hdXRvY29tcGxldGUgPiB1bCB7ICAgICBsaXN0LXN0eWxlLXR5cGU6IG5vbmU7ICAgICBwb3NpdGlvbjogc3RhdGljOyAgICAgIGhlaWdodDogYXV0bzsgICAgIHdpZHRoOiBhdXRvOyAgICAgbWluLXdpZHRoOiAxMjRweDsgICAgIHBhZGRpbmc6IDhweCAwOyAgICAgbWFyZ2luOiAwOyAgICAgIGJveC1zaGFkb3c6IDAgMnB4IDJweCAwIHJnYmEoMCwwLDAsLjE0KSwwIDNweCAxcHggLTJweCByZ2JhKDAsMCwwLC4yKSwwIDFweCA1cHggMCByZ2JhKDAsMCwwLC4xMik7ICAgICBib3JkZXItcmFkaXVzOiAycHg7IH0gIC5mdW5jdGlvbmFsLWdyb3VwLXdpZGdldC0tYXV0b2NvbXBsZXRlID4gdWwgPiBsaSB7ICAgICBvcGFjaXR5OiAxOyB9ICAucGVvcGxlLXdpZGdldC0tYXV0b2NvbXBsZXRlID4gdWwgPiBsaSB7ICAgICBvcGFjaXR5OiAxOyB9ICAuZnVuY3Rpb25hbC1ncm91cC13aWRnZXRfX2ludmFsaWQgLm1kbC10ZXh0ZmllbGRfX2lucHV0IHsgICAgIGJvcmRlci1jb2xvcjogI2Q1MDAwMDsgfSAgLmZ1bmN0aW9uYWwtZ3JvdXAtd2lkZ2V0X19pbnZhbGlkIC5tZGwtdGV4dGZpZWxkX19sYWJlbCB7ICAgICBjb2xvcjogI2Q1MDAwMDsgfSAgLmZ1bmN0aW9uYWwtZ3JvdXAtd2lkZ2V0X19pbnZhbGlkIC5tZGwtdGV4dGZpZWxkX19sYWJlbDphZnRlciB7ICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZDUwMDAwOyB9ICAuZnVuY3Rpb25hbC1ncm91cC13aWRnZXRfX2ludmFsaWQgLm1kbC10ZXh0ZmllbGRfX2Vycm9yIHsgICAgIHZpc2liaWxpdHk6IHZpc2libGUgIWltcG9ydGFudDsgfVwiXVxufSlcbmV4cG9ydCBjbGFzcyBGdW5jdGlvbmFsR3JvdXBXaWRnZXQgZXh0ZW5kcyBXaWRnZXRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuXG4gICAgdmFsdWU6IHN0cmluZztcbiAgICBwb3B1cFZpc2libGU6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBncm91cHM6IEdyb3VwTW9kZWxbXSA9IFtdO1xuICAgIG1pblRlcm1MZW5ndGg6IG51bWJlciA9IDE7XG4gICAgZ3JvdXBJZDogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBmb3JtU2VydmljZTogRm9ybVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgfVxuXG4gICAgLy8gVE9ETzogaW52ZXN0aWdhdGUsIGNhbGxlZCAyIHRpbWVzXG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci9pc3N1ZXMvNjc4MlxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICBpZiAodGhpcy5maWVsZCkge1xuICAgICAgICAgICAgbGV0IGdyb3VwID0gdGhpcy5maWVsZC52YWx1ZTtcbiAgICAgICAgICAgIGlmIChncm91cCkge1xuICAgICAgICAgICAgICAgIHRoaXMudmFsdWUgPSBncm91cC5uYW1lO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgcGFyYW1zID0gdGhpcy5maWVsZC5wYXJhbXM7XG4gICAgICAgICAgICBpZiAocGFyYW1zICYmIHBhcmFtc1sncmVzdHJpY3RXaXRoR3JvdXAnXSkge1xuICAgICAgICAgICAgICAgIGxldCByZXN0cmljdFdpdGhHcm91cCA9IDxHcm91cE1vZGVsPiBwYXJhbXNbJ3Jlc3RyaWN0V2l0aEdyb3VwJ107XG4gICAgICAgICAgICAgICAgdGhpcy5ncm91cElkID0gcmVzdHJpY3RXaXRoR3JvdXAuaWQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIExvYWQgYXV0by1jb21wbGV0aW9uIGZvciBwcmV2aW91c2x5IHNhdmVkIHZhbHVlXG4gICAgICAgICAgICBpZiAodGhpcy52YWx1ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9ybVNlcnZpY2VcbiAgICAgICAgICAgICAgICAgICAgLmdldFdvcmtmbG93R3JvdXBzKHRoaXMudmFsdWUsIHRoaXMuZ3JvdXBJZClcbiAgICAgICAgICAgICAgICAgICAgLnN1YnNjcmliZSgocmVzdWx0OiBHcm91cE1vZGVsW10pID0+IHRoaXMuZ3JvdXBzID0gcmVzdWx0IHx8IFtdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uS2V5VXAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgICAgaWYgKHRoaXMudmFsdWUgJiYgdGhpcy52YWx1ZS5sZW5ndGggPj0gdGhpcy5taW5UZXJtTGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmZvcm1TZXJ2aWNlLmdldFdvcmtmbG93R3JvdXBzKHRoaXMudmFsdWUsIHRoaXMuZ3JvdXBJZClcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKChyZXN1bHQ6IEdyb3VwTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmdyb3VwcyA9IHJlc3VsdCB8fCBbXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cFZpc2libGUgPSB0aGlzLmdyb3Vwcy5sZW5ndGggPiAwO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wb3B1cFZpc2libGUgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uQmx1cigpIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmZsdXNoVmFsdWUoKTtcbiAgICAgICAgfSwgMjAwKTtcbiAgICB9XG5cbiAgICBmbHVzaFZhbHVlKCkge1xuICAgICAgICB0aGlzLnBvcHVwVmlzaWJsZSA9IGZhbHNlO1xuXG4gICAgICAgIGxldCBvcHRpb24gPSB0aGlzLmdyb3Vwcy5maW5kKGl0ZW0gPT4gaXRlbS5uYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09IHRoaXMudmFsdWUudG9Mb2NhbGVMb3dlckNhc2UoKSk7XG5cbiAgICAgICAgaWYgKG9wdGlvbikge1xuICAgICAgICAgICAgdGhpcy5maWVsZC52YWx1ZSA9IG9wdGlvbjtcbiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBvcHRpb24ubmFtZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZmllbGQudmFsdWUgPSBudWxsO1xuICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmZpZWxkLnVwZGF0ZUZvcm0oKTtcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBzdGlsbCBjYXVzZXMgb25CbHVyIGV4ZWN1dGlvblxuICAgIG9uSXRlbUNsaWNrKGl0ZW06IEdyb3VwTW9kZWwsIGV2ZW50OiBFdmVudCkge1xuICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgICAgdGhpcy5maWVsZC52YWx1ZSA9IGl0ZW07XG4gICAgICAgICAgICB0aGlzLnZhbHVlID0gaXRlbS5uYW1lO1xuICAgICAgICB9XG4gICAgICAgIGlmIChldmVudCkge1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNldHVwTWF0ZXJpYWxDb21wb25lbnRzKGhhbmRsZXI6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICBzdXBlci5zZXR1cE1hdGVyaWFsQ29tcG9uZW50cyhoYW5kbGVyKTtcbiAgICAgICAgaWYgKGhhbmRsZXIpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRSZWYgJiYgdGhpcy52YWx1ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0dXBNYXRlcmlhbFRleHRGaWVsZCh0aGlzLmVsZW1lbnRSZWYsIGhhbmRsZXIsIHRoaXMudmFsdWUpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG59XG4iXX0=
