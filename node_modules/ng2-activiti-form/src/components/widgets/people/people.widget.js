/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var widget_component_1 = require("./../widget.component");
var form_service_1 = require("../../../services/form.service");
var PeopleWidget = (function (_super) {
    __extends(PeopleWidget, _super);
    function PeopleWidget(formService, elementRef) {
        var _this = _super.call(this) || this;
        _this.formService = formService;
        _this.elementRef = elementRef;
        _this.popupVisible = false;
        _this.minTermLength = 1;
        _this.users = [];
        return _this;
    }
    PeopleWidget.prototype.ngOnInit = function () {
        var _this = this;
        if (this.field) {
            var user = this.field.value;
            if (user) {
                this.value = this.getDisplayName(user);
            }
            var params = this.field.params;
            if (params && params['restrictWithGroup']) {
                var restrictWithGroup = params['restrictWithGroup'];
                this.groupId = restrictWithGroup.id;
            }
            if (this.value) {
                this.formService
                    .getWorkflowUsers(this.value, this.groupId)
                    .subscribe(function (result) { return _this.users = result || []; });
            }
        }
    };
    PeopleWidget.prototype.onKeyUp = function (event) {
        var _this = this;
        if (this.value && this.value.length >= this.minTermLength) {
            this.formService.getWorkflowUsers(this.value, this.groupId)
                .subscribe(function (result) {
                _this.users = result || [];
                _this.popupVisible = _this.users.length > 0;
            });
        }
        else {
            this.popupVisible = false;
        }
    };
    PeopleWidget.prototype.onBlur = function () {
        var _this = this;
        setTimeout(function () {
            _this.flushValue();
        }, 200);
    };
    PeopleWidget.prototype.flushValue = function () {
        var _this = this;
        this.popupVisible = false;
        var option = this.users.find(function (item) {
            var fullName = _this.getDisplayName(item).toLocaleLowerCase();
            return fullName === _this.value.toLocaleLowerCase();
        });
        if (option) {
            this.field.value = option;
            this.value = this.getDisplayName(option);
        }
        else {
            this.field.value = null;
            this.value = null;
        }
        this.field.updateForm();
    };
    PeopleWidget.prototype.getDisplayName = function (model) {
        if (model) {
            var displayName = (model.firstName || '') + " " + (model.lastName || '');
            return displayName.trim();
        }
        return '';
    };
    PeopleWidget.prototype.onItemClick = function (item, event) {
        if (item) {
            this.field.value = item;
            this.value = this.getDisplayName(item);
        }
        if (event) {
            event.preventDefault();
        }
    };
    PeopleWidget.prototype.setupMaterialComponents = function (handler) {
        _super.prototype.setupMaterialComponents.call(this, handler);
        if (handler) {
            if (this.elementRef && this.value) {
                this.setupMaterialTextField(this.elementRef, handler, this.value);
                return true;
            }
        }
        return false;
    };
    return PeopleWidget;
}(widget_component_1.WidgetComponent));
PeopleWidget = __decorate([
    core_1.Component({
        moduleId: module.id,
        selector: 'people-widget',
        template: "<div class=\"mdl-textfield mdl-js-textfield people-widget\"      [class.people-widget__invalid]=\"!field.isValid\">     <label [attr.for]=\"field.id\">{{field.name}}</label>     <input class=\"mdl-textfield__input\"            type=\"text\"            [attr.id]=\"field.id\"            [(ngModel)]=\"value\"            (ngModelChange)=\"checkVisibility(field)\"            (keyup)=\"onKeyUp($event)\"            (blur)=\"onBlur()\"            [disabled]=\"field.readOnly\"            placeholder=\"{{field.placeholder}}\">     <span *ngIf=\"field.validationSummary\" class=\"mdl-textfield__error\">{{field.validationSummary}}</span> </div> <div class=\"people-widget--autocomplete mdl-shadow--2dp\" *ngIf=\"popupVisible && users.length > 0\">     <ul>         <li *ngFor=\"let item of users\"             class=\"mdl-menu__item\"             (click)=\"onItemClick(item, $event)\">             {{getDisplayName(item)}}         </li>     </ul> </div>",
        styles: [".people-widget {     width: 100%; }  .people-widget--autocomplete {     background-color: #fff;     position: absolute;     z-index: 5;     color: #555;     margin: -15px 0 0 0; }  .people-widget--autocomplete > ul {     list-style-type: none;     position: static;      height: auto;     width: auto;     min-width: 124px;     padding: 8px 0;     margin: 0;      box-shadow: 0 2px 2px 0 rgba(0,0,0,.14),0 3px 1px -2px rgba(0,0,0,.2),0 1px 5px 0 rgba(0,0,0,.12);     border-radius: 2px; }  .people-widget--autocomplete > ul > li {     opacity: 1; }  .people-widget__invalid .mdl-textfield__input {     border-color: #d50000; }  .people-widget__invalid .mdl-textfield__label {     color: #d50000; }  .people-widget__invalid .mdl-textfield__label:after {     background-color: #d50000; }  .people-widget__invalid .mdl-textfield__error {     visibility: visible !important; }"]
    }),
    __metadata("design:paramtypes", [form_service_1.FormService,
        core_1.ElementRef])
], PeopleWidget);
exports.PeopleWidget = PeopleWidget;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvd2lkZ2V0cy9wZW9wbGUvcGVvcGxlLndpZGdldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFSCxzQ0FBOEQ7QUFDOUQsMERBQXdEO0FBQ3hELCtEQUE2RDtBQVU3RCxJQUFhLFlBQVk7SUFBUyxnQ0FBZTtJQVE3QyxzQkFBb0IsV0FBd0IsRUFDeEIsVUFBc0I7UUFEMUMsWUFFSSxpQkFBTyxTQUNWO1FBSG1CLGlCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLGdCQUFVLEdBQVYsVUFBVSxDQUFZO1FBUDFDLGtCQUFZLEdBQVksS0FBSyxDQUFDO1FBQzlCLG1CQUFhLEdBQVcsQ0FBQyxDQUFDO1FBRTFCLFdBQUssR0FBcUIsRUFBRSxDQUFDOztJQU03QixDQUFDO0lBSUQsK0JBQVEsR0FBUjtRQUFBLGlCQW9CQztRQW5CRyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNiLElBQUksSUFBSSxHQUFtQixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztZQUM1QyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNQLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMzQyxDQUFDO1lBRUQsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7WUFDL0IsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDeEMsSUFBSSxpQkFBaUIsR0FBZ0IsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7Z0JBQ2pFLElBQUksQ0FBQyxPQUFPLEdBQUcsaUJBQWlCLENBQUMsRUFBRSxDQUFDO1lBQ3hDLENBQUM7WUFHRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMs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SUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQyxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNSLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUMzQixDQUFDO0lBQ0wsQ0FBQztJQUVELDhDQUF1QixHQUF2QixVQUF3QixPQUFZO1FBQ2hDLGlCQUFNLHVCQUF1QixZQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDVixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNoQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNsRSxNQUFNLENBQUMsSUFBSSxDQUFDO1lBQ2hCLENBQUM7UUFDTCxDQUFDO1FBQ0QsTUFBTSxDQUFDLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBQ0wsbUJBQUM7QUFBRCxDQXhHQSxBQXdHQyxDQXhHaUMsa0NBQWUsR0F3R2hEO0FBeEdZLFlBQVk7SUFOeEIsZ0JBQVMsQ0FBQztRQUNQLFFBQVEsRUFBRSxNQUFNLENBQUMsRUFBRTtRQUNuQixRQUFRLEVBQUUsZUFBZTtRQUN6QixRQUFRLEVBQUUsczdCQUFzN0I7UUFDaDhCLE1BQU0sRUFBRSxDQUFDLDAyQkFBMDJCLENBQUM7S0FDdjNCLENBQUM7cUNBU21DLDBCQUFXO1FBQ1osaUJBQVU7R0FUakMsWUFBWSxDQXdHeEI7QUF4R1ksb0NBQVkiLCJmaWxlIjoiY29tcG9uZW50cy93aWRnZXRzL3Blb3BsZS9wZW9wbGUud2lkZ2V0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTYgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIEVsZW1lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFdpZGdldENvbXBvbmVudCB9IGZyb20gJy4vLi4vd2lkZ2V0LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBGb3JtU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL2Zvcm0uc2VydmljZSc7XG5pbXBvcnQgeyBHcm91cE1vZGVsIH0gZnJvbSAnLi4vY29yZS9ncm91cC5tb2RlbCc7XG5pbXBvcnQgeyBHcm91cFVzZXJNb2RlbCB9IGZyb20gJy4uL2NvcmUvZ3JvdXAtdXNlci5tb2RlbCc7XG5cbkBDb21wb25lbnQoe1xuICAgIG1vZHVsZUlkOiBtb2R1bGUuaWQsXG4gICAgc2VsZWN0b3I6ICdwZW9wbGUtd2lkZ2V0JyxcbiAgICB0ZW1wbGF0ZTogXCI8ZGl2IGNsYXNzPVxcXCJtZGwtdGV4dGZpZWxkIG1kbC1qcy10ZXh0ZmllbGQgcGVvcGxlLXdpZGdldFxcXCIgICAgICBbY2xhc3MucGVvcGxlLXdpZGdldF9faW52YWxpZF09XFxcIiFmaWVsZC5pc1ZhbGlkXFxcIj4gICAgIDxsYWJlbCBbYXR0ci5mb3JdPVxcXCJmaWVsZC5pZFxcXCI+e3tmaWVsZC5uYW1lfX08L2xhYmVsPiAgICAgPGlucHV0IGNsYXNzPVxcXCJtZGwtdGV4dGZpZWxkX19pbnB1dFxcXCIgICAgICAgICAgICB0eXBlPVxcXCJ0ZXh0XFxcIiAgICAgICAgICAgIFthdHRyLmlkXT1cXFwiZmllbGQuaWRcXFwiICAgICAgICAgICAgWyhuZ01vZGVsKV09XFxcInZhbHVlXFxcIiAgICAgICAgICAgIChuZ01vZGVsQ2hhbmdlKT1cXFwiY2hlY2tWaXNpYmlsaXR5KGZpZWxkKVxcXCIgICAgICAgICAgICAoa2V5dXApPVxcXCJvbktleVVwKCRldmVudClcXFwiICAgICAgICAgICAgKGJsdXIpPVxcXCJvbkJsdXIoKVxcXCIgICAgICAgICAgICBbZGlzYWJsZWRdPVxcXCJmaWVsZC5yZWFkT25seVxcXCIgICAgICAgICAgICBwbGFjZWhvbGRlcj1cXFwie3tmaWVsZC5wbGFjZWhvbGRlcn19XFxcIj4gICAgIDxzcGFuICpuZ0lmPVxcXCJmaWVsZC52YWxpZGF0aW9uU3VtbWFyeVxcXCIgY2xhc3M9XFxcIm1kbC10ZXh0ZmllbGRfX2Vycm9yXFxcIj57e2ZpZWxkLnZhbGlkYXRpb25TdW1tYXJ5fX08L3NwYW4+IDwvZGl2PiA8ZGl2IGNsYXNzPVxcXCJwZW9wbGUtd2lkZ2V0LS1hdXRvY29tcGxldGUgbWRsLXNoYWRvdy0tMmRwXFxcIiAqbmdJZj1cXFwicG9wdXBWaXNpYmxlICYmIHVzZXJzLmxlbmd0aCA+IDBcXFwiPiAgICAgPHVsPiAgICAgICAgIDxsaSAqbmdGb3I9XFxcImxldCBpdGVtIG9mIHVzZXJzXFxcIiAgICAgICAgICAgICBjbGFzcz1cXFwibWRsLW1lbnVfX2l0ZW1cXFwiICAgICAgICAgICAgIChjbGljayk9XFxcIm9uSXRlbUNsaWNrKGl0ZW0sICRldmVudClcXFwiPiAgICAgICAgICAgICB7e2dldERpc3BsYXlOYW1lKGl0ZW0pfX0gICAgICAgICA8L2xpPiAgICAgPC91bD4gPC9kaXY+XCIsXG4gICAgc3R5bGVzOiBbXCIucGVvcGxlLXdpZGdldCB7ICAgICB3aWR0aDogMTAwJTsgfSAgLnBlb3BsZS13aWRnZXQtLWF1dG9jb21wbGV0ZSB7ICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmOyAgICAgcG9zaXRpb246IGFic29sdXRlOyAgICAgei1pbmRleDogNTsgICAgIGNvbG9yOiAjNTU1OyAgICAgbWFyZ2luOiAtMTVweCAwIDAgMDsgfSAgLnBlb3BsZS13aWRnZXQtLWF1dG9jb21wbGV0ZSA+IHVsIHsgICAgIGxpc3Qtc3R5bGUtdHlwZTogbm9uZTsgICAgIHBvc2l0aW9uOiBzdGF0aWM7ICAgICAgaGVpZ2h0OiBhdXRvOyAgICAgd2lkdGg6IGF1dG87ICAgICBtaW4td2lkdGg6IDEyNHB4OyAgICAgcGFkZGluZzogOHB4IDA7ICAgICBtYXJnaW46IDA7ICAgICAgYm94LXNoYWRvdzogMCAycHggMnB4IDAgcmdiYSgwLDAsMCwuMTQpLDAgM3B4IDFweCAtMnB4IHJnYmEoMCwwLDAsLjIpLDAgMXB4IDVweCAwIHJnYmEoMCwwLDAsLjEyKTsgICAgIGJvcmRlci1yYWRpdXM6IDJweDsgfSAgLnBlb3BsZS13aWRnZXQtLWF1dG9jb21wbGV0ZSA+IHVsID4gbGkgeyAgICAgb3BhY2l0eTogMTsgfSAgLnBlb3BsZS13aWRnZXRfX2ludmFsaWQgLm1kbC10ZXh0ZmllbGRfX2lucHV0IHsgICAgIGJvcmRlci1jb2xvcjogI2Q1MDAwMDsgfSAgLnBlb3BsZS13aWRnZXRfX2ludmFsaWQgLm1kbC10ZXh0ZmllbGRfX2xhYmVsIHsgICAgIGNvbG9yOiAjZDUwMDAwOyB9ICAucGVvcGxlLXdpZGdldF9faW52YWxpZCAubWRsLXRleHRmaWVsZF9fbGFiZWw6YWZ0ZXIgeyAgICAgYmFja2dyb3VuZC1jb2xvcjogI2Q1MDAwMDsgfSAgLnBlb3BsZS13aWRnZXRfX2ludmFsaWQgLm1kbC10ZXh0ZmllbGRfX2Vycm9yIHsgICAgIHZpc2liaWxpdHk6IHZpc2libGUgIWltcG9ydGFudDsgfVwiXVxufSlcbmV4cG9ydCBjbGFzcyBQZW9wbGVXaWRnZXQgZXh0ZW5kcyBXaWRnZXRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuXG4gICAgcG9wdXBWaXNpYmxlOiBib29sZWFuID0gZmFsc2U7XG4gICAgbWluVGVybUxlbmd0aDogbnVtYmVyID0gMTtcbiAgICB2YWx1ZTogc3RyaW5nO1xuICAgIHVzZXJzOiBHcm91cFVzZXJNb2RlbFtdID0gW107XG4gICAgZ3JvdXBJZDogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBmb3JtU2VydmljZTogRm9ybVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgfVxuXG4gICAgLy8gVE9ETzogaW52ZXN0aWdhdGUsIGNhbGxlZCAyIHRpbWVzXG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci9pc3N1ZXMvNjc4MlxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICBpZiAodGhpcy5maWVsZCkge1xuICAgICAgICAgICAgbGV0IHVzZXI6IEdyb3VwVXNlck1vZGVsID0gdGhpcy5maWVsZC52YWx1ZTtcbiAgICAgICAgICAgIGlmICh1c2VyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMuZ2V0RGlzcGxheU5hbWUodXNlcik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBwYXJhbXMgPSB0aGlzLmZpZWxkLnBhcmFtcztcbiAgICAgICAgICAgIGlmIChwYXJhbXMgJiYgcGFyYW1zWydyZXN0cmljdFdpdGhHcm91cCddKSB7XG4gICAgICAgICAgICAgICAgbGV0IHJlc3RyaWN0V2l0aEdyb3VwID0gPEdyb3VwTW9kZWw+IHBhcmFtc1sncmVzdHJpY3RXaXRoR3JvdXAnXTtcbiAgICAgICAgICAgICAgICB0aGlzLmdyb3VwSWQgPSByZXN0cmljdFdpdGhHcm91cC5pZDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gTG9hZCBhdXRvLWNvbXBsZXRpb24gZm9yIHByZXZpb3VzbHkgc2F2ZWQgdmFsdWVcbiAgICAgICAgICAgIGlmICh0aGlzLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb3JtU2VydmljZVxuICAgICAgICAgICAgICAgICAgICAuZ2V0V29ya2Zsb3dVc2Vycyh0aGlzLnZhbHVlLCB0aGlzLmdyb3VwSWQpXG4gICAgICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoKHJlc3VsdDogR3JvdXBVc2VyTW9kZWxbXSkgPT4gdGhpcy51c2VycyA9IHJlc3VsdCB8fCBbXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvbktleVVwKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG4gICAgICAgIGlmICh0aGlzLnZhbHVlICYmIHRoaXMudmFsdWUubGVuZ3RoID49IHRoaXMubWluVGVybUxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5mb3JtU2VydmljZS5nZXRXb3JrZmxvd1VzZXJzKHRoaXMudmFsdWUsIHRoaXMuZ3JvdXBJZClcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKChyZXN1bHQ6IEdyb3VwVXNlck1vZGVsW10pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51c2VycyA9IHJlc3VsdCB8fCBbXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cFZpc2libGUgPSB0aGlzLnVzZXJzLmxlbmd0aCA+IDA7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVwVmlzaWJsZSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25CbHVyKCkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZmx1c2hWYWx1ZSgpO1xuICAgICAgICB9LCAyMDApO1xuICAgIH1cblxuICAgIGZsdXNoVmFsdWUoKSB7XG4gICAgICAgIHRoaXMucG9wdXBWaXNpYmxlID0gZmFsc2U7XG5cbiAgICAgICAgbGV0IG9wdGlvbiA9IHRoaXMudXNlcnMuZmluZChpdGVtID0+IHtcbiAgICAgICAgICAgIGxldCBmdWxsTmFtZSA9IHRoaXMuZ2V0RGlzcGxheU5hbWUoaXRlbSkudG9Mb2NhbGVMb3dlckNhc2UoKTtcbiAgICAgICAgICAgIHJldHVybiBmdWxsTmFtZSA9PT0gdGhpcy52YWx1ZS50b0xvY2FsZUxvd2VyQ2FzZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAob3B0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLmZpZWxkLnZhbHVlID0gb3B0aW9uO1xuICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMuZ2V0RGlzcGxheU5hbWUob3B0aW9uKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZmllbGQudmFsdWUgPSBudWxsO1xuICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmZpZWxkLnVwZGF0ZUZvcm0oKTtcbiAgICB9XG5cbiAgICBnZXREaXNwbGF5TmFtZShtb2RlbDogR3JvdXBVc2VyTW9kZWwpIHtcbiAgICAgICAgaWYgKG1vZGVsKSB7XG4gICAgICAgICAgICBsZXQgZGlzcGxheU5hbWUgPSBgJHttb2RlbC5maXJzdE5hbWUgfHwgJyd9ICR7bW9kZWwubGFzdE5hbWUgfHwgJyd9YDtcbiAgICAgICAgICAgIHJldHVybiBkaXNwbGF5TmFtZS50cmltKCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgLy8gVE9ETzogc3RpbGwgY2F1c2VzIG9uQmx1ciBleGVjdXRpb25cbiAgICBvbkl0ZW1DbGljayhpdGVtOiBHcm91cFVzZXJNb2RlbCwgZXZlbnQ6IEV2ZW50KSB7XG4gICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgICB0aGlzLmZpZWxkLnZhbHVlID0gaXRlbTtcbiAgICAgICAgICAgIHRoaXMudmFsdWUgPSB0aGlzLmdldERpc3BsYXlOYW1lKGl0ZW0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChldmVudCkge1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNldHVwTWF0ZXJpYWxDb21wb25lbnRzKGhhbmRsZXI6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICBzdXBlci5zZXR1cE1hdGVyaWFsQ29tcG9uZW50cyhoYW5kbGVyKTtcbiAgICAgICAgaWYgKGhhbmRsZXIpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRSZWYgJiYgdGhpcy52YWx1ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0dXBNYXRlcmlhbFRleHRGaWVsZCh0aGlzLmVsZW1lbnRSZWYsIGhhbmRsZXIsIHRoaXMudmFsdWUpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG59XG4iXX0=
