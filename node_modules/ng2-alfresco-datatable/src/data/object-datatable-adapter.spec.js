/*!
 * @license
 * Copyright 2016 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var datatable_adapter_1 = require("./datatable-adapter");
var object_datatable_adapter_1 = require("./object-datatable-adapter");
describe('ObjectDataTableAdapter', function () {
    it('should init with empty row collection', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter(null, []);
        expect(adapter.getRows()).toBeDefined();
        expect(adapter.getRows().length).toBe(0);
    });
    it('should init with empty column collection', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], null);
        expect(adapter.getColumns()).toBeDefined();
        expect(adapter.getColumns().length).toBeDefined();
    });
    it('should map rows', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([{}, {}], null);
        var rows = adapter.getRows();
        expect(rows.length).toBe(2);
        expect(rows[0] instanceof object_datatable_adapter_1.ObjectDataRow).toBe(true);
        expect(rows[1] instanceof object_datatable_adapter_1.ObjectDataRow).toBe(true);
    });
    it('should map columns without rows', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter(null, [
            {},
            {}
        ]);
        var columns = adapter.getColumns();
        expect(columns.length).toBe(2);
        expect(columns[0] instanceof object_datatable_adapter_1.ObjectDataColumn).toBe(true);
        expect(columns[1] instanceof object_datatable_adapter_1.ObjectDataColumn).toBe(true);
    });
    it('should sort by first column if column is available', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter(null, null);
        expect(adapter.getSorting()).toBeUndefined();
    });
    it('should apply new rows array', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], []);
        var newRows = [
            {},
            {}
        ];
        adapter.setRows(newRows);
        expect(adapter.getRows()).toBe(newRows);
    });
    it('should accept null for new rows array', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], []);
        expect(adapter.getRows()).toBeDefined();
        expect(adapter.getRows().length).toBe(0);
        adapter.setRows(null);
        expect(adapter.getRows()).toBeDefined();
        expect(adapter.getRows().length).toBe(0);
    });
    it('should reset rows by null value', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([{}, {}], []);
        expect(adapter.getRows()).toBeDefined();
        expect(adapter.getRows().length).toBe(2);
        adapter.setRows(null);
        expect(adapter.getRows()).toBeDefined();
        expect(adapter.getRows().length).toBe(0);
    });
    it('should sort new row collection', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], []);
        spyOn(adapter, 'sort').and.callThrough();
        adapter.setRows([]);
        expect(adapter.sort).toHaveBeenCalled();
    });
    it('should apply new columns array', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], []);
        var columns = [
            {},
            {}
        ];
        adapter.setColumns(columns);
        expect(adapter.getColumns()).toBe(columns);
    });
    it('should accept null for new columns array', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], []);
        expect(adapter.getColumns()).toBeDefined();
        expect(adapter.getColumns().length).toBe(0);
        adapter.setColumns(null);
        expect(adapter.getColumns()).toBeDefined();
        expect(adapter.getColumns().length).toBe(0);
    });
    it('should reset columns by null value', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], [
            {},
            {}
        ]);
        expect(adapter.getColumns()).toBeDefined();
        expect(adapter.getColumns().length).toBe(2);
        adapter.setColumns(null);
        expect(adapter.getColumns()).toBeDefined();
        expect(adapter.getColumns().length).toBe(0);
    });
    it('should fail getting value with row not defined', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], []);
        expect(function () { adapter.getValue(null, null); }).toThrowError('Row not found');
    });
    it('should fail getting value with column not defined', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], []);
        expect(function () { adapter.getValue({}, null); }).toThrowError('Column not found');
    });
    it('should get value from row with column key', function () {
        var value = 'hello world';
        var row = jasmine.createSpyObj('row', ['getValue']);
        row.getValue.and.returnValue(value);
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], []);
        var result = adapter.getValue(row, { key: 'col1' });
        expect(row.getValue).toHaveBeenCalledWith('col1');
        expect(result).toBe(value);
    });
    it('should set new sorting', function () {
        var sorting = new datatable_adapter_1.DataSorting('key', 'direction');
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], []);
        adapter.setSorting(sorting);
        expect(adapter.getSorting()).toBe(sorting);
        adapter.setSorting(null);
        expect(adapter.getSorting()).toBe(null);
    });
    it('should sort rows with new sorting value', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([{}, {}], []);
        spyOn(adapter.getRows(), 'sort').and.stub();
        adapter.setSorting(new datatable_adapter_1.DataSorting('key', 'direction'));
        expect(adapter.getRows().sort).toHaveBeenCalled();
    });
    it('should sort rows only when sorting key provided', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([{}, {}], []);
        spyOn(adapter.getRows(), 'sort').and.stub();
        adapter.setSorting(new datatable_adapter_1.DataSorting());
        expect(adapter.getRows().sort).not.toHaveBeenCalled();
    });
    it('should sort by first column by default', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([
            { id: 2, name: 'abs' },
            { id: 1, name: 'xyz' }
        ], [
            new object_datatable_adapter_1.ObjectDataColumn({ key: 'id', sortable: true })
        ]);
        var rows = adapter.getRows();
        expect(rows[0].getValue('id')).toBe(1);
        expect(rows[1].getValue('id')).toBe(2);
    });
    it('should take first sortable column by default', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], [
            { key: 'icon' },
            new object_datatable_adapter_1.ObjectDataColumn({ key: 'id', sortable: true })
        ]);
        expect(adapter.getSorting()).toEqual(jasmine.objectContaining({
            key: 'id',
            direction: 'asc'
        }));
    });
    it('should sort by dates', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([
            { id: 1, created: new Date(2016, 7, 6, 15, 7, 2) },
            { id: 2, created: new Date(2016, 7, 6, 15, 7, 1) }
        ], [
            { key: 'id' },
            { key: 'created' }
        ]);
        adapter.setSorting(new datatable_adapter_1.DataSorting('created', 'asc'));
        var rows = adapter.getRows();
        expect(rows[0].getValue('id')).toBe(2);
        expect(rows[1].getValue('id')).toBe(1);
    });
    it('should be sorting undefined if no sortable found', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([
            { id: 2, name: 'abs' },
            { id: 1, name: 'xyz' }
        ], [
            new object_datatable_adapter_1.ObjectDataColumn({ key: 'id' }),
            new object_datatable_adapter_1.ObjectDataColumn({ key: 'name' })
        ]);
        expect(adapter.getSorting()).toBeUndefined();
    });
    it('should sort asc and desc', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([
            { id: 2, name: 'abs' },
            { id: 1, name: 'xyz' }
        ], [
            new object_datatable_adapter_1.ObjectDataColumn({ key: 'id', sortable: true })
        ]);
        adapter.setSorting(new datatable_adapter_1.DataSorting('id', 'asc'));
        expect(adapter.getRows()[0].getValue('id')).toBe(1);
        expect(adapter.getRows()[1].getValue('id')).toBe(2);
        adapter.setSorting(new datatable_adapter_1.DataSorting('id', 'desc'));
        expect(adapter.getRows()[0].getValue('id')).toBe(2);
        expect(adapter.getRows()[1].getValue('id')).toBe(1);
    });
    it('should use asc for sort command by default', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], []);
        adapter.setSorting(null);
        expect(adapter.getSorting()).toBe(null);
        adapter.sort('id', null);
        expect(adapter.getSorting()).toEqual(jasmine.objectContaining({
            key: 'id',
            direction: 'asc'
        }));
    });
    it('should use direction for sort command', function () {
        var adapter = new object_datatable_adapter_1.ObjectDataTableAdapter([], []);
        adapter.setSorting(null);
        expect(adapter.getSorting()).toBe(null);
        adapter.sort('id', 'desc');
        expect(adapter.getSorting()).toEqual(jasmine.objectContaining({
            key: 'id',
            direction: 'desc'
        }));
    });
});
describe('ObjectDataRow', function () {
    it('should require object source', function () {
        expect(function () { return new object_datatable_adapter_1.ObjectDataRow(null); }).toThrowError('Object source not found');
    });
    it('should get top level property value', function () {
        var row = new object_datatable_adapter_1.ObjectDataRow({
            id: 1
        });
        expect(row.getValue('id')).toBe(1);
    });
    it('should not get top level property value', function () {
        var row = new object_datatable_adapter_1.ObjectDataRow({});
        expect(row.getValue('missing')).toBeUndefined();
    });
    it('should get nested property value', function () {
        var row = new object_datatable_adapter_1.ObjectDataRow({
            name: {
                firstName: 'John',
                lastName: 'Doe'
            }
        });
        expect(row.getValue('name.lastName')).toBe('Doe');
    });
    it('should not get nested property value', function () {
        var row = new object_datatable_adapter_1.ObjectDataRow({});
        expect(row.getValue('some.missing.property')).toBeUndefined();
    });
    it('should check top level value exists', function () {
        var row = new object_datatable_adapter_1.ObjectDataRow({ id: 1 });
        expect(row.hasValue('id')).toBeTruthy();
        expect(row.hasValue('other')).toBeFalsy();
    });
    it('should check nested value exists', function () {
        var row = new object_datatable_adapter_1.ObjectDataRow({
            name: {
                firstName: 'John',
                lastName: 'Doe'
            }
        });
        expect(row.hasValue('name')).toBeTruthy();
        expect(row.hasValue('name.firstName')).toBeTruthy();
        expect(row.hasValue('some.other.prop')).toBeFalsy();
    });
    it('should generateSchema generate a schema from data', function () {
        var data = [
            { id: 2, name: 'abs' },
            { id: 1, name: 'xyz' }
        ];
        var schema = object_datatable_adapter_1.ObjectDataTableAdapter.generateSchema(data);
        expect(schema.length).toBe(2);
        expect(schema[0].title).toBe('id');
        expect(schema[1].title).toBe('name');
    });
});
//# sourceMappingURL=object-datatable-adapter.spec.js.map